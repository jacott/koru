#!/usr/bin/env node
// -*- js2 -*-
const path = require('path');
const fs = require('fs');
let program = require('commander');

global.isServer = true;
global.isClient = false;

const koruPackage = JSON.parse(fs.readFileSync(path.resolve(__dirname, '../package.json')));

const match = process.argv[2] && /^(db-)/.exec(process.argv[2]);

let loadded = false;


const load = (command)=> function () {
  this.koruVersion = koruPackage.version;
  this.koruPackage = koruPackage;
  program = null;
  require('../lib/'+command).apply(this, arguments);
};

switch (match ? match[1] : process.argv[2]) {

case 'generate': case 'g':
  load('generate')(program);
  break;

case 'db-':
  load('db-commands')(program);
  break;

default:
  program
    .command('new [name]')
    .option('--link', 'link to global koru instead of local install')
    .option('-p, --pretend', 'Run but do not make any changes')
    .option('--force', 'overwrite existing files')
    .description('create a new (or update an existing) application called name')
    .action(load('new'));

  program
    .command('generate', null)
    .alias('g')
    .usage('GENERATOR [args] [options]')
    .description(`create things in you project`);

  program
    .command('test')
    .usage('[--isolated] [--port=number] [-s] [-c] [testModule] [testNamePrefix]')
    .option('--isolated', 'Start up server and headless browser to run the tests')
    .option('--port <number>', 'Start up server on specified port '+
            '(defaults to env KORU_PORT or; 3001 for isolated; otherwise 3000)')
    .option('-s, --server', 'Only run server tests')
    .option('-c, --client', 'Only run client tests')
    .description('run tests. Unless --isolated is used the tests expect the server and browser to already be started and connected')
    .action(load('test'));

  program.parse(process.argv);

  if (program) {
    if (program.rawArgs.length > 2) {
      console.error("Unexpected command: ", program.rawArgs[2]);
      process.exit(1);
    }
    load('db-commands')(program);
  }
}
