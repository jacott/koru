<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Koru API</title>

    <link rel="stylesheet" href="api.css">
  </head>
  <body>
    <header>
      <div>
        <div class="page-header" data-api="header">
          Koru API
        </div>
        <div id="search">
          <input name="search" placeholder="Search [/]">
        </div>
      </div>
    </header>
    <section>
      <div class="menu">
        <span class="">Modules</span>
        <nav id="jsdoc-index" class="" data-api="links">
        <div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/main">koru</a><nav><a href="#koru/main.buildPath">buildPath</a><a href="#koru/main.onunload">onunload</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/btree"><span><span class="jsdoc-nav-spacer">&nbsp;</span>btree</span></a><nav><a href="#koru/btree.constructor">constructor</a><a href="#koru/btree#[Symbol.iterator]">#[Symbol.iterator]</a><a href="#koru/btree#clear">#clear</a><a href="#koru/btree#find">#find</a><a href="#koru/btree#findNode">#findNode</a><a href="#koru/btree#nodeFrom">#nodeFrom</a><a href="#koru/btree#nodeTo">#nodeTo</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/changes"><span><span class="jsdoc-nav-spacer">&nbsp;</span>changes</span></a><nav><a href="#koru/changes.applyAll">applyAll</a><a href="#koru/changes.applyOne">applyOne</a><a href="#koru/changes.fieldDiff">fieldDiff</a><a href="#koru/changes.has">has</a><a href="#koru/changes.merge">merge</a><a href="#koru/changes.nestedDiff">nestedDiff</a><a href="#koru/changes.original">original</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/client/mock-cache-storage"><span><span class="jsdoc-nav-spacer">&nbsp;</span>client/mock-cache-storage</span></a><nav><a href="#koru/client/mock-cache-storage.constructor">constructor</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/client/uncache"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>uncache</span></a><nav><a href="#koru/client/uncache.start">start</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/crypto/acc-sha256"><span><span class="jsdoc-nav-spacer">&nbsp;</span>crypto/acc-sha256</span></a><nav><a href="#koru/crypto/acc-sha256.add">add</a><a href="#koru/crypto/acc-sha256.toHex">toHex</a><a href="#koru/crypto/acc-sha256.toId">toId</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/css/loader"><span><span class="jsdoc-nav-spacer">&nbsp;</span>css/loader</span></a><nav><a href="#koru/css/loader.constructor">constructor</a><a href="#koru/css/loader#loadAll">#loadAll</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/dir-watcher"><span><span class="jsdoc-nav-spacer">&nbsp;</span>dir-watcher</span></a><nav><a href="#koru/dir-watcher.constructor">constructor</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/dlinked-list"><span><span class="jsdoc-nav-spacer">&nbsp;</span>dlinked-list</span></a><nav><a href="#koru/dlinked-list.constructor">constructor</a><a href="#koru/dlinked-list#add">#add</a><a href="#koru/dlinked-list#addFront">#addFront</a><a href="#koru/dlinked-list#clear">#clear</a><a href="#koru/dlinked-list#forEach">#forEach</a><a href="#koru/dlinked-list#nodes">#nodes</a><a href="#koru/dlinked-list#values">#values</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/dom"><span><span class="jsdoc-nav-spacer">&nbsp;</span>dom</span></a><nav><a href="#koru/dom.closestChildOf">closestChildOf</a><a href="#koru/dom.endMarker">endMarker</a><a href="#koru/dom.ensureInView">ensureInView</a><a href="#koru/dom.getBoundingClientRect">getBoundingClientRect</a><a href="#koru/dom.getClosest">getClosest</a><a href="#koru/dom.getClosestCtx">getClosestCtx</a><a href="#koru/dom.insertStartEndMarkers">insertStartEndMarkers</a><a href="#koru/dom.isAboveBottom">isAboveBottom</a><a href="#koru/dom.isInView">isInView</a><a href="#koru/dom.loadScript">loadScript</a><a href="#koru/dom.makeMenustartCallback">makeMenustartCallback</a><a href="#koru/dom.remove">remove</a><a href="#koru/dom.removeInserts">removeInserts</a><a href="#koru/dom.reposition">reposition</a><a href="#koru/dom.setCtx">setCtx</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/dom/ctx"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>ctx</span></a><nav><a href="#koru/dom/ctx#addEventListener">#addEventListener</a><a href="#koru/dom/ctx#autoUpdate">#autoUpdate</a><a href="#koru/dom/ctx#stopAutoUpdate">#stopAutoUpdate</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/dom/html"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>html</span></a><nav><a href="#koru/dom/html.escapeHTML">escapeHTML</a><a href="#koru/dom/html.html">html</a><a href="#koru/dom/html.htmlToJson">htmlToJson</a><a href="#koru/dom/html.svgUse">svgUse</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/dom/template"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>template</span></a><nav><a href="#koru/dom/template.addTemplates">addTemplates</a><a href="#koru/dom/template.newTemplate">newTemplate</a><a href="#koru/dom/template#$render">#$render</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/enumerable"><span><span class="jsdoc-nav-spacer">&nbsp;</span>enumerable</span></a><nav><a href="#koru/enumerable.constructor">constructor</a><a href="#koru/enumerable.count">count</a><a href="#koru/enumerable.mapObjectIter">mapObjectIter</a><a href="#koru/enumerable.mapObjectToArray">mapObjectToArray</a><a href="#koru/enumerable.mapToArray">mapToArray</a><a href="#koru/enumerable.propertyValues">propertyValues</a><a href="#koru/enumerable.reverseValues">reverseValues</a><a href="#koru/enumerable#every">#every</a><a href="#koru/enumerable#filter">#filter</a><a href="#koru/enumerable#find">#find</a><a href="#koru/enumerable#map">#map</a><a href="#koru/enumerable#reduce">#reduce</a><a href="#koru/enumerable#some">#some</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/format"><span><span class="jsdoc-nav-spacer">&nbsp;</span>format</span></a><nav><a href="#koru/format.format">format</a><a href="#koru/format.compile">compile</a><a href="#koru/format.translate">translate</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/fs-tools"><span><span class="jsdoc-nav-spacer">&nbsp;</span>fs-tools</span></a><nav><a href="#koru/fs-tools.appendData">appendData</a><a href="#koru/fs-tools.readlinkIfExists">readlinkIfExists</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/future"><span><span class="jsdoc-nav-spacer">&nbsp;</span>future</span></a><nav><a href="#koru/future.constructor">constructor</a><a href="#koru/future#promiseAndReset">#promiseAndReset</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/geometry"><span><span class="jsdoc-nav-spacer">&nbsp;</span>geometry</span></a><nav><a href="#koru/geometry.bezierBox">bezierBox</a><a href="#koru/geometry.closestT">closestT</a><a href="#koru/geometry.combineBox">combineBox</a><a href="#koru/geometry.combineBoxPoint">combineBoxPoint</a><a href="#koru/geometry.rotatePoints">rotatePoints</a><a href="#koru/geometry.splitBezier">splitBezier</a><a href="#koru/geometry.tPoint">tPoint</a><a href="#koru/geometry.tTangent">tTangent</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/idle-check"><span><span class="jsdoc-nav-spacer">&nbsp;</span>idle-check</span></a><nav><a href="#koru/idle-check.constructor">constructor</a><a href="#koru/idle-check#waitIdle">#waitIdle</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/koru-error"><span><span class="jsdoc-nav-spacer">&nbsp;</span>koru-error</span></a><nav><a href="#koru/koru-error.constructor">constructor</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/linked-list"><span><span class="jsdoc-nav-spacer">&nbsp;</span>linked-list</span></a><nav><a href="#koru/linked-list#addBack">#addBack</a><a href="#koru/linked-list#clear">#clear</a><a href="#koru/linked-list#forEach">#forEach</a><a href="#koru/linked-list#nodes">#nodes</a><a href="#koru/linked-list#pop">#pop</a><a href="#koru/linked-list#popNode">#popNode</a><a href="#koru/linked-list#push">#push</a><a href="#koru/linked-list#removeNode">#removeNode</a><a href="#koru/linked-list#values">#values</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/make-subject"><span><span class="jsdoc-nav-spacer">&nbsp;</span>make-subject</span></a><nav><a href="#koru/make-subject.makeSubject">makeSubject</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/match"><span><span class="jsdoc-nav-spacer">&nbsp;</span>match</span></a><nav><a href="#koru/match.equal">equal</a><a href="#koru/match.is">is</a><a href="#koru/match.match">match</a><a href="#koru/match.not">not</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/match::Match">::Match</a><nav><a href="#koru/match::Match#$throwTest">#$throwTest</a><a href="#koru/match::Match#test">#test</a></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/math-util"><span><span class="jsdoc-nav-spacer">&nbsp;</span>math-util</span></a><nav><a href="#koru/math-util.normDist">normDist</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/migrate/migration"><span><span class="jsdoc-nav-spacer">&nbsp;</span>migrate/migration</span></a><nav><a href="#koru/migrate/migration#migrateTo">#migrateTo</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/migrate/migration::Commander">::Commander</a><nav><a href="#koru/migrate/migration::Commander#addColumns">#addColumns</a><a href="#koru/migrate/migration::Commander#addIndex">#addIndex</a><a href="#koru/migrate/migration::Commander#createTable">#createTable</a><a href="#koru/migrate/migration::Commander#reversible">#reversible</a></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/main"><span><span class="jsdoc-nav-spacer">&nbsp;</span>model</span></a><nav></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/base-model"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>base-model</span></a><nav><a href="#koru/model/base-model.onChange">onChange</a><a href="#koru/model/base-model.assertFound">assertFound</a><a href="#koru/model/base-model.build">build</a><a href="#koru/model/base-model.define">define</a><a href="#koru/model/base-model.defineFields">defineFields</a><a href="#koru/model/base-model.findById">findById</a><a href="#koru/model/base-model.isIdLocked">isIdLocked</a><a href="#koru/model/base-model.lockId">lockId</a><a href="#koru/model/base-model.remote">remote</a><a href="#koru/model/base-model.remoteGet">remoteGet</a><a href="#koru/model/base-model#$$save">#$$save</a><a href="#koru/model/base-model#$assertValid">#$assertValid</a><a href="#koru/model/base-model#$isValid">#$isValid</a><a href="#koru/model/base-model#$save">#$save</a><a href="#koru/model/base-model#$withChanges">#$withChanges</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/db-broker-client"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>db-broker-client</span></a><nav><a href="#koru/model/db-broker-client.makeFactory">makeFactory</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/db-broker-server"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>db-broker-server</span></a><nav><a href="#koru/model/db-broker-server.makeFactory">makeFactory</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/doc-change"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>doc-change</span></a><nav><a href="#koru/model/doc-change.add">add</a><a href="#koru/model/doc-change.change">change</a><a href="#koru/model/doc-change.delete">delete</a><a href="#koru/model/doc-change#clone">#clone</a><a href="#koru/model/doc-change#hasField">#hasField</a><a href="#koru/model/doc-change#hasSomeFields">#hasSomeFields</a><a href="#koru/model/doc-change#subDocKeys">#subDocKeys</a><a href="#koru/model/doc-change#subDocs">#subDocs</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/main-client"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>main-client</span></a><nav></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/mq-factory"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>mq-factory</span></a><nav><a href="#koru/model/mq-factory#getQueue">#getQueue</a><a href="#koru/model/mq-factory#registerQueue">#registerQueue</a><a href="#koru/model/mq-factory#start">#start</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/mq-factory::MQ">::MQ</a><nav><a href="#koru/model/mq-factory::MQ#add">#add</a><a href="#koru/model/mq-factory::MQ#peek">#peek</a><a href="#koru/model/mq-factory::MQ#remove">#remove</a><a href="#koru/model/mq-factory::MQ#sendNow">#sendNow</a></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/ps-sql"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>ps-sql</span></a><nav><a href="#koru/model/ps-sql.constructor">constructor</a><a href="#koru/model/ps-sql#execute">#execute</a><a href="#koru/model/ps-sql#fetch">#fetch</a><a href="#koru/model/ps-sql#fetchOne">#fetchOne</a><a href="#koru/model/ps-sql#value">#value</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/query"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>query</span></a><nav><a href="#koru/model/query.notify">notify</a><a href="#koru/model/query.onAnyChange">onAnyChange</a><a href="#koru/model/query#exists">#exists</a><a href="#koru/model/query#notExists">#notExists</a><a href="#koru/model/query#onChange">#onChange</a><a href="#koru/model/query#where">#where</a><a href="#koru/model/query#whereNot">#whereNot</a><a href="#koru/model/query#whereSql">#whereSql</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/query-idb"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>query-idb</span></a><nav><a href="#koru/model/query-idb.constructor">constructor</a><a href="#koru/model/query-idb.deleteDatabase">deleteDatabase</a><a href="#koru/model/query-idb#close">#close</a><a href="#koru/model/query-idb#count">#count</a><a href="#koru/model/query-idb#cursor">#cursor</a><a href="#koru/model/query-idb#delete">#delete</a><a href="#koru/model/query-idb#deleteObjectStore">#deleteObjectStore</a><a href="#koru/model/query-idb#get">#get</a><a href="#koru/model/query-idb#getAll">#getAll</a><a href="#koru/model/query-idb#index">#index</a><a href="#koru/model/query-idb#loadDoc">#loadDoc</a><a href="#koru/model/query-idb#loadDocs">#loadDocs</a><a href="#koru/model/query-idb#promisify">#promisify</a><a href="#koru/model/query-idb#put">#put</a><a href="#koru/model/query-idb#queueChange">#queueChange</a><a href="#koru/model/query-idb#transaction">#transaction</a><a href="#koru/model/query-idb#whenIdle">#whenIdle</a><a href="#koru/model/query-idb#whenReady">#whenReady</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/rich-text-validator"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>rich-text-validator</span></a><nav><a href="#koru/model/rich-text-validator.richText">richText</a><a href="#koru/model/rich-text-validator.richTextMarkup">richTextMarkup</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/sql-query"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>sql-query</span></a><nav><a href="#koru/model/sql-query.constructor">constructor</a><a href="#koru/model/sql-query#fetch">#fetch</a><a href="#koru/model/sql-query#fetchOne">#fetchOne</a><a href="#koru/model/sql-query#forEach">#forEach</a><a href="#koru/model/sql-query#values">#values</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/test-factory"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>test-factory</span></a><nav><a href="#koru/model/test-factory.defines">defines</a><a href="#koru/model/test-factory.generateSeq">generateSeq</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/test-factory::Builder">::Builder</a><nav><a href="#koru/model/test-factory::Builder.constructor">constructor</a><a href="#koru/model/test-factory::Builder#addField">#addField</a><a href="#koru/model/test-factory::Builder#addPromise">#addPromise</a><a href="#koru/model/test-factory::Builder#addRef">#addRef</a><a href="#koru/model/test-factory::Builder#build">#build</a><a href="#koru/model/test-factory::Builder#create">#create</a><a href="#koru/model/test-factory::Builder#genSeq">#genSeq</a><a href="#koru/model/test-factory::Builder#useSave">#useSave</a><a href="#koru/model/test-factory::Builder#waitPromises">#waitPromises</a></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/trans-queue"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>trans-queue</span></a><nav><a href="#koru/model/trans-queue.finally">finally</a><a href="#koru/model/trans-queue.isInTransaction">isInTransaction</a><a href="#koru/model/trans-queue.nonNested">nonNested</a><a href="#koru/model/trans-queue.onAbort">onAbort</a><a href="#koru/model/trans-queue.onSuccess">onSuccess</a><a href="#koru/model/trans-queue.transaction">transaction</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/validation"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>validation</span></a><nav><a href="#koru/model/validation.addError">addError</a><a href="#koru/model/validation.assertDocChanges">assertDocChanges</a><a href="#koru/model/validation.register">register</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/validation::Error">::Error</a><nav><a href="#koru/model/validation::Error.msgFor">msgFor</a><a href="#koru/model/validation::Error.toString">toString</a></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/validators/main"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>validators</span></a><nav></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/validators/associated-validator"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>associated-validator</span></a><nav><a href="#koru/model/validators/associated-validator.associated">associated</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/validators/length-validator"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>length-validator</span></a><nav><a href="#koru/model/validators/length-validator.maxLength">maxLength</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/validators/text-validator"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>text-validator</span></a><nav><a href="#koru/model/validators/text-validator.boolean">boolean</a><a href="#koru/model/validators/text-validator.normalize">normalize</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/model/validators/validate-validator"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>validate-validator</span></a><nav><a href="#koru/model/validators/validate-validator.validate">validate</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/module-graph"><span><span class="jsdoc-nav-spacer">&nbsp;</span>module-graph</span></a><nav><a href="#koru/module-graph.findPath">findPath</a><a href="#koru/module-graph.isRequiredBy">isRequiredBy</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/mutex"><span><span class="jsdoc-nav-spacer">&nbsp;</span>mutex</span></a><nav><a href="#koru/mutex.constructor">constructor</a><a href="#koru/mutex#lock">#lock</a><a href="#koru/mutex#unlock">#unlock</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/observable"><span><span class="jsdoc-nav-spacer">&nbsp;</span>observable</span></a><nav><a href="#koru/observable.constructor">constructor</a><a href="#koru/observable#add">#add</a><a href="#koru/observable#forEach">#forEach</a><a href="#koru/observable#notify">#notify</a><a href="#koru/observable#stopAll">#stopAll</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/parse/html-parser"><span><span class="jsdoc-nav-spacer">&nbsp;</span>parse/html-parser</span></a><nav><a href="#koru/parse/html-parser.parse">parse</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/parse/js-printer"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>js-printer</span></a><nav><a href="#koru/parse/js-printer.constructor">constructor</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pg/driver"><span><span class="jsdoc-nav-spacer">&nbsp;</span>pg/driver</span></a><nav><a href="#koru/pg/driver.connect">connect</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pg/driver::Client">::Client</a><nav><a href="#koru/pg/driver::Client.constructor">constructor</a><a href="#koru/pg/driver::Client#explainQuery">#explainQuery</a><a href="#koru/pg/driver::Client#jsFieldToPg">#jsFieldToPg</a><a href="#koru/pg/driver::Client#query">#query</a><a href="#koru/pg/driver::Client#timeLimitQuery">#timeLimitQuery</a></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pg/sql-statement"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>sql-statement</span></a><nav><a href="#koru/pg/sql-statement.constructor">constructor</a><a href="#koru/pg/sql-statement#append">#append</a><a href="#koru/pg/sql-statement#appendText">#appendText</a><a href="#koru/pg/sql-statement#clone">#clone</a><a href="#koru/pg/sql-statement#convertArgs">#convertArgs</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/promise-queue"><span><span class="jsdoc-nav-spacer">&nbsp;</span>promise-queue</span></a><nav><a href="#koru/promise-queue.constructor">constructor</a><a href="#koru/promise-queue#add">#add</a><a href="#koru/promise-queue#empty">#empty</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pubsub/main"><span><span class="jsdoc-nav-spacer">&nbsp;</span>pubsub</span></a><nav></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pubsub/all-pub"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>all-pub</span></a><nav><a href="#koru/pubsub/all-pub.excludeModel">excludeModel</a><a href="#koru/pubsub/all-pub.includeModel">includeModel</a><a href="#koru/pubsub/all-pub.includedModels">includedModels</a><a href="#koru/pubsub/all-pub#init">#init</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pubsub/all-sub"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>all-sub</span></a><nav><a href="#koru/pubsub/all-sub.excludeModel">excludeModel</a><a href="#koru/pubsub/all-sub.includeModel">includeModel</a><a href="#koru/pubsub/all-sub.includedModels">includedModels</a><a href="#koru/pubsub/all-sub.subscribe">subscribe</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pubsub/model-match"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>model-match</span></a><nav><a href="#koru/pubsub/model-match.constructor">constructor</a><a href="#koru/pubsub/model-match#has">#has</a><a href="#koru/pubsub/model-match#register">#register</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pubsub/preload-subscription"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>preload-subscription</span></a><nav><a href="#koru/pubsub/preload-subscription.constructor">constructor</a><a href="#koru/pubsub/preload-subscription#getQueryIDB">#getQueryIDB</a><a href="#koru/pubsub/preload-subscription#preload">#preload</a><a href="#koru/pubsub/preload-subscription#serverResponse">#serverResponse</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pubsub/publication"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>publication</span></a><nav><a href="#koru/pubsub/publication.constructor">constructor</a><a href="#koru/pubsub/publication.discreteLastSubscribed">discreteLastSubscribed</a><a href="#koru/pubsub/publication#init">#init</a><a href="#koru/pubsub/publication#onMessage">#onMessage</a><a href="#koru/pubsub/publication#postMessage">#postMessage</a><a href="#koru/pubsub/publication#stop">#stop</a><a href="#koru/pubsub/publication#userIdChanged">#userIdChanged</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pubsub/subscription"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>subscription</span></a><nav><a href="#koru/pubsub/subscription.constructor">constructor</a><a href="#koru/pubsub/subscription.markForRemove">markForRemove</a><a href="#koru/pubsub/subscription.subscribe">subscribe</a><a href="#koru/pubsub/subscription#connect">#connect</a><a href="#koru/pubsub/subscription#filterDoc">#filterDoc</a><a href="#koru/pubsub/subscription#filterModels">#filterModels</a><a href="#koru/pubsub/subscription#match">#match</a><a href="#koru/pubsub/subscription#onConnect">#onConnect</a><a href="#koru/pubsub/subscription#onMessage">#onMessage</a><a href="#koru/pubsub/subscription#postMessage">#postMessage</a><a href="#koru/pubsub/subscription#reconnecting">#reconnecting</a><a href="#koru/pubsub/subscription#stop">#stop</a><a href="#koru/pubsub/subscription#stopped">#stopped</a><a href="#koru/pubsub/subscription#unmatch">#unmatch</a><a href="#koru/pubsub/subscription#userIdChanged">#userIdChanged</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/pubsub/union"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>union</span></a><nav><a href="#koru/pubsub/union.constructor">constructor</a><a href="#koru/pubsub/union#addSub">#addSub</a><a href="#koru/pubsub/union#addSubByToken">#addSubByToken</a><a href="#koru/pubsub/union#batchUpdate">#batchUpdate</a><a href="#koru/pubsub/union#buildBatchUpdate">#buildBatchUpdate</a><a href="#koru/pubsub/union#buildUpdate">#buildUpdate</a><a href="#koru/pubsub/union#encodeUpdate">#encodeUpdate</a><a href="#koru/pubsub/union#initObservers">#initObservers</a><a href="#koru/pubsub/union#loadByToken">#loadByToken</a><a href="#koru/pubsub/union#loadInitial">#loadInitial</a><a href="#koru/pubsub/union#onEmpty">#onEmpty</a><a href="#koru/pubsub/union#removeSub">#removeSub</a><a href="#koru/pubsub/union#sendEncoded">#sendEncoded</a><a href="#koru/pubsub/union#sendEncodedWhenIdle">#sendEncodedWhenIdle</a><a href="#koru/pubsub/union#subs">#subs</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/random"><span><span class="jsdoc-nav-spacer">&nbsp;</span>random</span></a><nav><a href="#koru/random.constructor">constructor</a><a href="#koru/random.hexString">hexString</a><a href="#koru/random.id">id</a><a href="#koru/random#fraction">#fraction</a><a href="#koru/random#hexString">#hexString</a><a href="#koru/random#id">#id</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/server-pages/main"><span><span class="jsdoc-nav-spacer">&nbsp;</span>server-pages</span></a><nav><a href="#koru/server-pages/main.build">build</a><a href="#koru/server-pages/main#stop">#stop</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/server-pages/base-controller"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>base-controller</span></a><nav><a href="#koru/server-pages/base-controller.aroundFilter">aroundFilter</a><a href="#koru/server-pages/base-controller.create">create</a><a href="#koru/server-pages/base-controller.destroy">destroy</a><a href="#koru/server-pages/base-controller.edit">edit</a><a href="#koru/server-pages/base-controller.index">index</a><a href="#koru/server-pages/base-controller.new">new</a><a href="#koru/server-pages/base-controller.show">show</a><a href="#koru/server-pages/base-controller.update">update</a><a href="#koru/server-pages/base-controller#$parser">#$parser</a><a href="#koru/server-pages/base-controller#error">#error</a><a href="#koru/server-pages/base-controller#redirect">#redirect</a><a href="#koru/server-pages/base-controller#render">#render</a><a href="#koru/server-pages/base-controller#renderHTML">#renderHTML</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/server-pages/inline-script"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>inline-script</span></a><nav><a href="#koru/server-pages/inline-script.constructor">constructor</a><a href="#koru/server-pages/inline-script#add">#add</a><a href="#koru/server-pages/inline-script#generate">#generate</a><a href="#koru/server-pages/inline-script#require">#require</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/main"><span><span class="jsdoc-nav-spacer">&nbsp;</span>session</span></a><nav><a href="#koru/session/main.defineRpc">defineRpc</a><a href="#koru/session/main.defineRpcGet">defineRpcGet</a><a href="#koru/session/main.openBatch">openBatch</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/client-rpc-base"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>client-rpc-base</span></a><nav><a href="#koru/session/client-rpc-base.init">init</a><a href="#koru/session/client-rpc-base#cancelRpc">#cancelRpc</a><a href="#koru/session/client-rpc-base#checkMsgId">#checkMsgId</a><a href="#koru/session/client-rpc-base#replaceRpcQueue">#replaceRpcQueue</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/conn-th-server"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>conn-th-server</span></a><nav><a href="#koru/session/conn-th-server.assert.encodedCall">assert.encodedCall</a><a href="#koru/session/conn-th-server.decodeEncodedCall">decodeEncodedCall</a><a href="#koru/session/conn-th-server.mockConnection">mockConnection</a><a href="#koru/session/conn-th-server.stopAllSubs">stopAllSubs</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/reverse-rpc-receiver"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>reverse-rpc-receiver</span></a><nav><a href="#koru/session/reverse-rpc-receiver.constructor">constructor</a><a href="#koru/session/reverse-rpc-receiver#define">#define</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/reverse-rpc-sender"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>reverse-rpc-sender</span></a><nav><a href="#koru/session/reverse-rpc-sender.constructor">constructor</a><a href="#koru/session/reverse-rpc-sender.configureSession">configureSession</a><a href="#koru/session/reverse-rpc-sender#rpc">#rpc</a><a href="#koru/session/reverse-rpc-sender#setConn">#setConn</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/rpc-idb-queue"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>rpc-idb-queue</span></a><nav><a href="#koru/session/rpc-idb-queue.constructor">constructor</a><a href="#koru/session/rpc-idb-queue#reload">#reload</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/rpc-queue"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>rpc-queue</span></a><nav><a href="#koru/session/rpc-queue.constructor">constructor</a><a href="#koru/session/rpc-queue#resend">#resend</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/server-connection"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>server-connection</span></a><nav><a href="#koru/session/server-connection.buildUpdate">buildUpdate</a><a href="#koru/session/server-connection.filterDoc">filterDoc</a><a href="#koru/session/server-connection#added">#added</a><a href="#koru/session/server-connection#batchMessage">#batchMessage</a><a href="#koru/session/server-connection#changed">#changed</a><a href="#koru/session/server-connection#removed">#removed</a><a href="#koru/session/server-connection#send">#send</a><a href="#koru/session/server-connection#sendBinary">#sendBinary</a><a href="#koru/session/server-connection#sendEncoded">#sendEncoded</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/session/web-socket-sender-factory"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>web-socket-sender-factory</span></a><nav><a href="#koru/session/web-socket-sender-factory.webSocketSenderFactory">webSocketSenderFactory</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/stacktrace"><span><span class="jsdoc-nav-spacer">&nbsp;</span>stacktrace</span></a><nav><a href="#koru/stacktrace.elideFrames">elideFrames</a><a href="#koru/stacktrace.normalize">normalize</a><a href="#koru/stacktrace.replaceStack">replaceStack</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/symbols"><span><span class="jsdoc-nav-spacer">&nbsp;</span>symbols</span></a><nav></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/api"><span><span class="jsdoc-nav-spacer">&nbsp;</span>test/api</span></a><nav><a href="#koru/test/api.class">class</a><a href="#koru/test/api.comment">comment</a><a href="#koru/test/api.custom">custom</a><a href="#koru/test/api.customIntercept">customIntercept</a><a href="#koru/test/api.example">example</a><a href="#koru/test/api.innerSubject">innerSubject</a><a href="#koru/test/api.method">method</a><a href="#koru/test/api.module">module</a><a href="#koru/test/api.property">property</a><a href="#koru/test/api.protoMethod">protoMethod</a><a href="#koru/test/api.protoProperty">protoProperty</a><a href="#koru/test/api.topic">topic</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/core"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>core</span></a><nav><a href="#koru/test/core.elide">elide</a><a href="#koru/test/core.fail">fail</a><a href="#koru/test/core.assert">assert</a><a href="#koru/test/core.deepEqual">deepEqual</a><a href="#koru/test/core.refute">refute</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/core::AssertionError">::AssertionError</a><nav><a href="#koru/test/core::AssertionError.constructor">constructor</a></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/mock-promise"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>mock-promise</span></a><nav><a href="#koru/test/mock-promise._poll">_poll</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/stubber"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>stubber</span></a><nav><a href="#koru/test/stubber.intercept">intercept</a><a href="#koru/test/stubber.isStubbed">isStubbed</a><a href="#koru/test/stubber.spy">spy</a><a href="#koru/test/stubber.stub">stub</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/stubber::Stub">::Stub</a><nav><a href="#koru/test/stubber::Stub.restore">restore</a><a href="#koru/test/stubber::Stub#calledAfter">#calledAfter</a><a href="#koru/test/stubber::Stub#calledBefore">#calledBefore</a><a href="#koru/test/stubber::Stub#calledWith">#calledWith</a><a href="#koru/test/stubber::Stub#calledWithExactly">#calledWithExactly</a><a href="#koru/test/stubber::Stub#cancelYields">#cancelYields</a><a href="#koru/test/stubber::Stub#getCall">#getCall</a><a href="#koru/test/stubber::Stub#invokes">#invokes</a><a href="#koru/test/stubber::Stub#onCall">#onCall</a><a href="#koru/test/stubber::Stub#removeSelected">#removeSelected</a><a href="#koru/test/stubber::Stub#returns">#returns</a><a href="#koru/test/stubber::Stub#withArgs">#withArgs</a><a href="#koru/test/stubber::Stub#yield">#yield</a><a href="#koru/test/stubber::Stub#yieldAll">#yieldAll</a><a href="#koru/test/stubber::Stub#yieldAndRemoveSelected">#yieldAndRemoveSelected</a><a href="#koru/test/stubber::Stub#yieldAndReset">#yieldAndReset</a><a href="#koru/test/stubber::Stub#yields">#yields</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/stubber::Stub::Call">::Call</a><nav><a href="#koru/test/stubber::Stub::Call#calledWith">#calledWith</a><a href="#koru/test/stubber::Stub::Call#yield">#yield</a></nav></div></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/test-case"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>test-case</span></a><nav><a href="#koru/test/test-case#fullName">#fullName</a><a href="#koru/test/test-case#topTestCase">#topTestCase</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test/test-case::Test">::Test</a><nav></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test-helper"><span><span class="jsdoc-nav-spacer">&nbsp;</span>test-helper</span></a><nav><a href="#koru/test-helper.after">after</a><a href="#koru/test-helper.intercept">intercept</a><a href="#koru/test-helper.spy">spy</a><a href="#koru/test-helper.stub">stub</a><a href="#koru/test-helper.stubProperty">stubProperty</a><a href="#koru/test-helper.testCase">testCase</a></nav><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/test-helper::MockModule">::MockModule</a><nav><a href="#koru/test-helper::MockModule.constructor">constructor</a></nav></div></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/ui/app"><span><span class="jsdoc-nav-spacer">&nbsp;</span>ui/app</span></a><nav><a href="#koru/ui/app.flashUncaughtErrors">flashUncaughtErrors</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/ui/auto-list"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>auto-list</span></a><nav><a href="#koru/ui/auto-list.constructor">constructor</a><a href="#koru/ui/auto-list#changeOptions">#changeOptions</a><a href="#koru/ui/auto-list#elm">#elm</a><a href="#koru/ui/auto-list#nodeElm">#nodeElm</a><a href="#koru/ui/auto-list#stop">#stop</a><a href="#koru/ui/auto-list#thisElm">#thisElm</a><a href="#koru/ui/auto-list#thisNode">#thisNode</a><a href="#koru/ui/auto-list#updateEntry">#updateEntry</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/ui/list-selector"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>list-selector</span></a><nav><a href="#koru/ui/list-selector.attach">attach</a><a href="#koru/ui/list-selector.keydownHandler">keydownHandler</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/ui/ripple"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>ripple</span></a><nav><a href="#koru/ui/ripple.start">start</a><a href="#koru/ui/ripple.stop">stop</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/ui/route"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>route</span></a><nav><a href="#koru/ui/route.gotoPage">gotoPage</a><a href="#koru/ui/route.pathToPage">pathToPage</a><a href="#koru/ui/route.replacePage">replacePage</a><a href="#koru/ui/route.setTitle">setTitle</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/ui/svg-icons"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>svg-icons</span></a><nav><a href="#koru/ui/svg-icons.svgIcon">svgIcon</a><a href="#koru/ui/svg-icons.add">add</a><a href="#koru/ui/svg-icons.createIcon">createIcon</a><a href="#koru/ui/svg-icons.selectMenuDecorator">selectMenuDecorator</a><a href="#koru/ui/svg-icons.setIcon">setIcon</a><a href="#koru/ui/svg-icons.use">use</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/ui/time"><span><span class="jsdoc-nav-spacer">&nbsp;&nbsp;&nbsp;</span>time</span></a><nav><a href="#koru/ui/time.fromNow">fromNow</a><a href="#koru/ui/time.relTime">relTime</a><a href="#koru/ui/time.startDynTime">startDynTime</a><a href="#koru/ui/time.stopDynTime">stopDynTime</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/uint8-array-builder"><span><span class="jsdoc-nav-spacer">&nbsp;</span>uint8-array-builder</span></a><nav><a href="#koru/uint8-array-builder.constructor">constructor</a><a href="#koru/uint8-array-builder#append">#append</a><a href="#koru/uint8-array-builder#get">#get</a><a href="#koru/uint8-array-builder#push">#push</a><a href="#koru/uint8-array-builder#set">#set</a><a href="#koru/uint8-array-builder#setArray">#setArray</a><a href="#koru/uint8-array-builder#subarray">#subarray</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/util"><span><span class="jsdoc-nav-spacer">&nbsp;</span>util</span></a><nav><a href="#koru/util.addItem">addItem</a><a href="#koru/util.arrayToMap">arrayToMap</a><a href="#koru/util.assignOption">assignOption</a><a href="#koru/util.asyncArrayFrom">asyncArrayFrom</a><a href="#koru/util.binarySearch">binarySearch</a><a href="#koru/util.compareNumber">compareNumber</a><a href="#koru/util.createDictionary">createDictionary</a><a href="#koru/util.diff">diff</a><a href="#koru/util.diffString">diffString</a><a href="#koru/util.diffStringLength">diffStringLength</a><a href="#koru/util.extractError">extractError</a><a href="#koru/util.extractKeys">extractKeys</a><a href="#koru/util.extractNotKeys">extractNotKeys</a><a href="#koru/util.firstParam">firstParam</a><a href="#koru/util.forEach">forEach</a><a href="#koru/util.hasOnly">hasOnly</a><a href="#koru/util.ifPromise">ifPromise</a><a href="#koru/util.indexOfRegex">indexOfRegex</a><a href="#koru/util.indexTolineColumn">indexTolineColumn</a><a href="#koru/util.inspect">inspect</a><a href="#koru/util.intersectp">intersectp</a><a href="#koru/util.isObjEmpty">isObjEmpty</a><a href="#koru/util.isPromise">isPromise</a><a href="#koru/util.itemIndex">itemIndex</a><a href="#koru/util.keyMatches">keyMatches</a><a href="#koru/util.keyStartsWith">keyStartsWith</a><a href="#koru/util.merge">merge</a><a href="#koru/util.mergeExclude">mergeExclude</a><a href="#koru/util.mergeInclude">mergeInclude</a><a href="#koru/util.mergeNoEnum">mergeNoEnum</a><a href="#koru/util.mergeOwnDescriptors">mergeOwnDescriptors</a><a href="#koru/util.pc">pc</a><a href="#koru/util.qlabel">qlabel</a><a href="#koru/util.qstr">qstr</a><a href="#koru/util.removeItem">removeItem</a><a href="#koru/util.reverseForEach">reverseForEach</a><a href="#koru/util.sansPc">sansPc</a><a href="#koru/util.sansPx">sansPx</a><a href="#koru/util.splitKeys">splitKeys</a><a href="#koru/util.symDiff">symDiff</a><a href="#koru/util.titleize">titleize</a><a href="#koru/util.toDp">toDp</a><a href="#koru/util.toHex">toHex</a><a href="#koru/util.toMap">toMap</a><a href="#koru/util.trimMatchingSeq">trimMatchingSeq</a><a href="#koru/util.union">union</a><a href="#koru/util.values">values</a><a href="#koru/util.voidToNull">voidToNull</a><a href="#koru/util.withId">withId</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/util-date"><span><span class="jsdoc-nav-spacer">&nbsp;</span>util-date</span></a><nav><a href="#koru/util-date.atUTCDowHour">atUTCDowHour</a><a href="#koru/util-date.compileFormat">compileFormat</a><a href="#koru/util-date.format">format</a><a href="#koru/util-date.parse">parse</a><a href="#koru/util-date.relative">relative</a><a href="#koru/util-date.shiftToLocale">shiftToLocale</a><a href="#koru/util-date.shiftToUTC">shiftToUTC</a><a href="#koru/util-date.toDiscrete">toDiscrete</a><a href="#koru/util-date.toSunday">toSunday</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/web-server"><span><span class="jsdoc-nav-spacer">&nbsp;</span>web-server</span></a><nav><a href="#koru/web-server.start">start</a></nav></div><div class="jsdoc-nav-module"><a class="jsdoc-idLink" href="#koru/web-server-factory"><span><span class="jsdoc-nav-spacer">&nbsp;</span>web-server-factory</span></a><nav><a href="#koru/web-server-factory.WebServerFactory">WebServerFactory</a><a href="#koru/web-server-factory#start">#start</a><a href="#koru/web-server-factory#stop">#stop</a></nav></div></nav>
      </div>
      <main>
        <div class="page-content" data-api="pages">
        <section id="koru/main" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/main">koru/main</a><h1 class="jsdoc-module-title searchable">koru</h1><abstract><div><p>Main koru module. Responsible for:</p>
<ul>
<li>Thread local storage</li>
<li>Logging</li>
<li>Dependency tracking and load/unload manager</li>
<li>AppDir location</li>
</ul>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/main.buildPath" tabindex="-1" name="buildPath" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">koru.<span class="highlight"><span class="nf">buildPath</span>(<span class="nv">path</span>)</span></h1><abstract><div><p>Converts path to related build path of compiled resource.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>path</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>source path of resource.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>build path for resource.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">koru</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/main"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">koru</span>.<span class="na">buildPath</span>(<span class="s">"models/library/book"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"models/library/.build/book"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">koru</span>.<span class="na">buildPath</span>(<span class="s">"helper"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">".build/helper"</span></span></div></pre></div></section><section id="koru/main.onunload" tabindex="-1" name="onunload" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">koru.<span class="highlight"><span class="nf">onunload</span>(<span class="nv">moduleOrId</span>, <span class="nv">callback</span>)</span></h1><abstract><div><p>A wrapper around <code>module#onUnload</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>moduleOrId</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">koru</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/main"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">myModule</span> <span class="o">=</span> {<span class="na">id</span>: <span class="s">'myModule'</span>, <span class="na">onUnload</span>: <span class="nx">stub</span>()};
<span class="kd">const</span> <span class="no">callback</span> <span class="o">=</span> {<span class="nf">stop</span>() {}};
<span class="nx">koru</span>.<span class="na">onunload</span>(<span class="nx">myModule</span>, <span class="nx">callback</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">myModule</span>.<span class="na">onUnload</span>, <span class="nx">callback</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/btree" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/btree">koru/btree</a><h1 class="jsdoc-module-title searchable">BTree</h1><abstract><div><p>A Balanced Tree. Implemented using a
<a href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree" target="_blank">Red-black tree</a>.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/btree.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">compare</span><span class="o">=</span><span class="nx">simpleCompare</span>, <span class="nv">unique</span><span class="o">=</span><span class="kc">false</span>)</span></h1><abstract><div><p>Create an instance of BTree.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[compare]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>Function to test order of two keys (like <code>Array#sort</code>) defaults to</p>
<pre><code class="language-js"><div class="highlight">(<span class="nv">a</span>, <span class="nv">b</span>) <span class="o">=&gt;</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span> <span class="o">?</span> <span class="m">0</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="o">-</span><span class="m">1</span> <span class="o">:</span> <span class="m">1</span></div>
</code></pre></div></td></tr><tr class="jsdoc-arg"><td>[unique]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p>if <code>true</code> do not add entry if <a class="jsdoc-link" href="#koru/btree#add">add</a> called with key already in tree;</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BTree</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/btree"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">simple</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTree</span>();
<span class="nx">simple</span>.<span class="na">add</span>(<span class="m">5</span>); <span class="nx">simple</span>.<span class="na">add</span>(<span class="m">5</span>); <span class="nx">simple</span>.<span class="na">add</span>(<span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">simple</span>), [<span class="m">1</span>, <span class="m">5</span>, <span class="m">5</span>]);

<span class="kd">const</span> <span class="no">compCompare</span> <span class="o">=</span> (<span class="nv">a</span>, <span class="nv">b</span>) <span class="o">=&gt;</span> {
  <span class="k">if</span> (<span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span>) <span class="k">return</span> <span class="m">0</span>;
  <span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">a</span>.<span class="na">k1</span> <span class="o">-</span> <span class="nx">b</span>.<span class="na">k1</span>;
  <span class="k">return</span> <span class="nx">ans</span> <span class="o">==</span> <span class="m">0</span> <span class="o">?</span> <span class="nx">a</span>.<span class="na">k2</span> <span class="o">-</span> <span class="nx">b</span>.<span class="na">k2</span> <span class="o">:</span> <span class="nx">ans</span>;
};

<span class="kd">const</span> <span class="no">composite</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTree</span>(<span class="nx">compCompare</span>, <span class="kc">true</span>);
<span class="nx">composite</span>.<span class="na">add</span>({<span class="na">k1</span>: <span class="m">4</span>, <span class="na">k2</span>: <span class="m">5</span>, <span class="na">name</span>: <span class="s">'45'</span>});
<span class="nx">composite</span>.<span class="na">add</span>({<span class="na">k1</span>: <span class="m">4</span>, <span class="na">k2</span>: <span class="m">3</span>, <span class="na">name</span>: <span class="s">'43'</span>});
<span class="nx">assert</span>.<span class="na">same</span>(
  <span class="nx">composite</span>.<span class="na">add</span>({<span class="na">k1</span>: <span class="m">4</span>, <span class="na">k2</span>: <span class="m">3</span>, <span class="na">name</span>: <span class="s">'rep'</span>}).<span class="na">value</span>.<span class="na">name</span>,
  <span class="s">'43'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">composite</span>).<span class="na">map</span>((<span class="nv">v</span>) <span class="o">=&gt;</span> <span class="nx">v</span>.<span class="na">name</span>), [<span class="s">'43'</span>, <span class="s">'45'</span>]);</div></div></pre></div></section><section id="koru/btree#[Symbol.iterator]" tabindex="-1" name="#[Symbol.iterator]" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BTree#*[Symbol.iterator]()</h1><abstract><div><p>iterate the tree in order</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BTree</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/btree"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">tree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTree</span>();
<span class="nx">insertNodes</span>(<span class="nx">tree</span>, [<span class="m">123</span>, <span class="m">456</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">tree</span>), [<span class="m">123</span>, <span class="m">456</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">tree</span>), [<span class="m">123</span>, <span class="m">456</span>]);
<span class="kd">const</span> <span class="no">i</span> <span class="o">=</span> <span class="nx">tree</span>[<span class="nx">Symbol</span>.<span class="na">iterator</span>]();
<span class="nx">tree</span>.<span class="na">add</span>(<span class="m">53</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">i</span>.<span class="na">next</span>().<span class="na">value</span>, <span class="m">53</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">tree</span>), [<span class="m">53</span>, <span class="m">123</span>, <span class="m">456</span>]);</div></div></pre></div></section><section id="koru/btree#clear" tabindex="-1" name="#clear" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BTree#<span class="highlight"><span class="nf">clear</span>()</span></h1><abstract><div><p>Remove all entries</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BTree</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/btree"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">tree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTree</span>();
<span class="nx">tree</span>.<span class="na">add</span>(<span class="m">1</span>);
<span class="nx">tree</span>.<span class="na">add</span>(<span class="m">2</span>);
<span class="nx">tree</span>.<span class="na">add</span>(<span class="m">3</span>);
<span class="nx">tree</span>.<span class="na">clear</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">firstNode</span>, <span class="kc">null</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">size</span>, <span class="m">0</span>);</div></div></pre></div></section><section id="koru/btree#find" tabindex="-1" name="#find" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BTree#<span class="highlight"><span class="nf">find</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Find a value in the tree.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>find entry with same keys as <code>value</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>undefined</code> if not found otherwise the value <a class="jsdoc-link" href="#koru/btree#add">added</a> to the
tree</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BTree</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/btree"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">tree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTree</span>();
<span class="nx">insertNodes</span>(<span class="nx">tree</span>, [<span class="m">100</span>, <span class="m">200</span>, <span class="m">50</span>, <span class="m">150</span>, <span class="m">250</span>]);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">find</span>(<span class="m">50</span>), <span class="m">50</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">find</span>(<span class="m">49</span>), <span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">find</span>(<span class="m">150</span>), <span class="m">150</span>);</div></div></pre></div></section><section id="koru/btree#findNode" tabindex="-1" name="#findNode" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BTree#<span class="highlight"><span class="nf">findNode</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Find a <code>node</code> in the tree that matches <code>value</code>. Be careful with the node; don't insert it
into another tree or change its keys; call <a class="jsdoc-link" href="#koru/btree#deleteNode">deleteNode</a> first.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>contains the keys to find.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>undefined</code> if <code>node</code> can't be found otherwise the matching
<code>node</code>.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BTree</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/btree"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">tree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTree</span>();
<span class="nx">insertNodes</span>(<span class="nx">tree</span>, [<span class="m">100</span>, <span class="m">200</span>, <span class="m">50</span>, <span class="m">150</span>, <span class="m">250</span>]);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">findNode</span>(<span class="m">50</span>).<span class="na">value</span>, <span class="m">50</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">findNode</span>(<span class="m">49</span>), <span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">findNode</span>(<span class="m">150</span>).<span class="na">value</span>, <span class="m">150</span>);</div></div></pre></div></section><section id="koru/btree#nodeFrom" tabindex="-1" name="#nodeFrom" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BTree#<span class="highlight"><span class="nf">nodeFrom</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>find node equal or greater than value</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BTree</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/btree"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">tree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTree</span>();
<span class="nx">insertNodes</span>(<span class="nx">tree</span>, [<span class="m">100</span>, <span class="m">50</span>, <span class="m">20</span>, <span class="m">110</span>, <span class="m">120</span>, <span class="m">130</span>, <span class="m">95</span>]);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeFrom</span>(<span class="m">35</span>).<span class="na">value</span>, <span class="m">50</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeFrom</span>(<span class="m">95</span>).<span class="na">value</span>, <span class="m">95</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeFrom</span>(<span class="m">5</span>).<span class="na">value</span>, <span class="m">20</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeFrom</span>(<span class="m">200</span>), <span class="kc">null</span>);</div></div></pre></div></section><section id="koru/btree#nodeTo" tabindex="-1" name="#nodeTo" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BTree#<span class="highlight"><span class="nf">nodeTo</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>find node equal or less than value</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BTree</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/btree"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">tree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BTree</span>();
<span class="nx">insertNodes</span>(<span class="nx">tree</span>, [<span class="m">100</span>, <span class="m">50</span>, <span class="m">20</span>, <span class="m">110</span>, <span class="m">120</span>, <span class="m">130</span>, <span class="m">95</span>]);
<span class="kd">const</span> <span class="no">n130</span> <span class="o">=</span> <span class="nx">tree</span>.<span class="na">lastNode</span>;
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">n130</span>.<span class="na">value</span>, <span class="m">130</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeTo</span>(<span class="m">51</span>).<span class="na">value</span>, <span class="m">50</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeTo</span>(<span class="m">200</span>), <span class="nx">n130</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeTo</span>(<span class="m">10</span>), <span class="kc">null</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeTo</span>(<span class="m">95</span>).<span class="na">value</span>, <span class="m">95</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">tree</span>.<span class="na">nodeTo</span>(<span class="m">105</span>).<span class="na">value</span>, <span class="m">100</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/changes" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/changes">koru/changes</a><h1 class="jsdoc-module-title searchable">Changes</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/changes.applyAll" tabindex="-1" name="applyAll" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Changes.<span class="highlight"><span class="nf">applyAll</span>(<span class="nv">attrs</span>, <span class="nv">changes</span>)</span></h1><abstract><div><p>Apply all commands to an attributes object. Commands can have:</p>
<ol>
<li>a $match object which assert the supplied fields match the attribute</li>
<li>a $partial object which calls applyPartial for each field; OR</li>
<li>be a top level replacement value</li>
</ol>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>attrs</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>changes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>undo</code> command which when applied to the updated attributes reverts it to its
original content. Calling <a class="jsdoc-link" href="#koru/changes.original">original</a> on undo will return the original commands
object</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Changes</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/changes"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// matches top level</span>
<span class="kd">const</span> <span class="no">attrs</span> <span class="o">=</span> {<span class="na">foo</span>: <span class="m">1</span>, <span class="na">bar</span>: <span class="s">'two'</span>};
<span class="kd">const</span> <span class="no">changes</span> <span class="o">=</span> {<span class="na">$match</span>: {<span class="na">foo</span>: <span class="m">1</span>, <span class="na">bar</span>: {<span class="na">md5</span>: <span class="s">'b8a9'</span>}}};
<span class="nx">refute</span>.<span class="na">exception</span>(() <span class="o">=&gt;</span> {<span class="nx">Changes</span>.<span class="na">applyAll</span>(<span class="nx">attrs</span>, <span class="nx">changes</span>)});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">attrs</span>, {<span class="na">foo</span>: <span class="m">1</span>, <span class="na">bar</span>: <span class="s">'two'</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">changes</span>, {<span class="na">$match</span>: {<span class="na">foo</span>: <span class="m">1</span>, <span class="na">bar</span>: {<span class="na">md5</span>: <span class="s">'b8a9'</span>}}});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// bad checksum</span>
<span class="kd">const</span> <span class="no">attrs</span> <span class="o">=</span> {<span class="na">foo</span>: <span class="m">1</span>, <span class="na">bar</span>: {<span class="na">md5</span>: <span class="s">'bad'</span>}};
<span class="kd">const</span> <span class="no">changes</span> <span class="o">=</span> {<span class="na">$match</span>: {<span class="na">foo</span>: <span class="m">1</span>, <span class="na">bar</span>: <span class="s">'two'</span>}};
<span class="nx">assert</span>.<span class="na">exception</span>(
  () <span class="o">=&gt;</span> {<span class="nx">Changes</span>.<span class="na">applyAll</span>(<span class="nx">attrs</span>, <span class="nx">changes</span>)},
  {<span class="na">error</span>: <span class="m">409</span>, <span class="na">reason</span>: {<span class="na">bar</span>: <span class="s">'not_match'</span>}},
);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// can apply undo</span>
<span class="kd">const</span> <span class="no">attrs</span> <span class="o">=</span> {
  <span class="na">foo</span>: <span class="m">1</span>, <span class="na">bar</span>: <span class="m">2</span>, <span class="na">baz</span>: {<span class="na">bif</span>: [<span class="m">1</span>, <span class="m">2</span>, {<span class="na">bob</span>: <span class="s">'text'</span>}]},
  <span class="na">simple</span>: [<span class="m">123</span>],
};
<span class="kd">const</span> <span class="no">changes</span> <span class="o">=</span> {
  <span class="na">foo</span>: <span class="m">2</span>,
  <span class="na">$partial</span>: {
    <span class="na">bar</span>: [<span class="s">'$replace'</span>, <span class="m">4</span>],
    <span class="na">simple</span>: <span class="m">456</span>,
    <span class="na">baz</span>: [
      <span class="s">'bif.2.$partial'</span>, [
        <span class="s">'bip'</span>, <span class="s">'new'</span>,
        <span class="s">'bob.$partial'</span>, [
          <span class="s">'$append'</span>, <span class="s">' appended'</span>,
        ],
      ],
    ],
  },
};
<span class="kd">const</span> <span class="no">undo</span> <span class="o">=</span> <span class="nx">Changes</span>.<span class="na">applyAll</span>(<span class="nx">attrs</span>, <span class="nx">changes</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Changes</span>.<span class="na">original</span>(<span class="nx">undo</span>), <span class="nx">changes</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">attrs</span>, {
  <span class="na">foo</span>: <span class="m">2</span>, <span class="na">bar</span>: <span class="m">4</span>, <span class="na">baz</span>: {
    <span class="na">bif</span>: [<span class="m">1</span>, <span class="m">2</span>, {<span class="na">bob</span>: <span class="s">'text appended'</span>, <span class="na">bip</span>: <span class="s">'new'</span>}],
  },
  <span class="na">simple</span>: <span class="m">456</span>,
});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">undo</span>, {
  <span class="na">foo</span>: <span class="m">1</span>,
  <span class="na">simple</span>: [<span class="m">123</span>],
  <span class="na">$partial</span>: {
    <span class="na">bar</span>: [<span class="s">'$replace'</span>, <span class="m">2</span>],
    <span class="na">baz</span>: [
      <span class="s">'bif.2.$partial'</span>, [
        <span class="s">'bob.$partial'</span>, [
          <span class="s">'$patch'</span>, [<span class="o">-</span><span class="m">9</span>, <span class="m">9</span>, <span class="kc">null</span>],
        ],
        <span class="s">'bip'</span>, <span class="kc">null</span>,
      ],
    ],
  },
});

<span class="nx">Changes</span>.<span class="na">applyAll</span>(<span class="nx">attrs</span>, <span class="nx">undo</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">attrs</span>, {
  <span class="na">foo</span>: <span class="m">1</span>, <span class="na">bar</span>: <span class="m">2</span>, <span class="na">baz</span>: {<span class="na">bif</span>: [<span class="m">1</span>, <span class="m">2</span>, {<span class="na">bob</span>: <span class="s">'text'</span>}]},
  <span class="na">simple</span>: [<span class="m">123</span>],
});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ary</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>], <span class="no">aa</span> <span class="o">=</span> {<span class="na">aa</span>: <span class="m">1</span>, <span class="na">ary</span>};
<span class="kd">const</span> <span class="no">b</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">2</span>];
<span class="kd">const</span> <span class="no">orig</span> <span class="o">=</span> {<span class="na">a</span>: <span class="nx">aa</span>, <span class="na">b</span>, <span class="na">c</span>: <span class="m">3</span>, <span class="na">nest</span>: {<span class="na">foo</span>: <span class="s">'foo'</span>}};
<span class="kd">const</span> <span class="no">changes</span> <span class="o">=</span> {
  <span class="na">a</span>: {<span class="na">aa</span>: <span class="m">1</span>, <span class="na">ab</span>: <span class="m">2</span>, <span class="na">ary</span>: [<span class="m">1</span>, <span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>, <span class="m">3</span>]},
  <span class="na">b</span>: [<span class="m">1</span>, <span class="m">2</span>], <span class="na">c</span>: <span class="m">4</span>, <span class="na">nest</span>: {<span class="na">foo</span>: <span class="s">'foo'</span>}};

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Changes</span>.<span class="na">applyAll</span>(<span class="nx">orig</span>, <span class="nx">changes</span>), {<span class="na">$partial</span>: {
  <span class="na">a</span>: [<span class="s">'ary.$partial'</span>, [<span class="s">'$patch'</span>, [<span class="m">1</span>, <span class="m">3</span>, [<span class="m">2</span>]]], <span class="s">'ab'</span>, <span class="kc">null</span>]}, <span class="na">c</span>: <span class="m">3</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">aa</span>, {<span class="na">aa</span>: <span class="m">1</span>, <span class="na">ab</span>: <span class="m">2</span>, <span class="na">ary</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ary</span>, [<span class="m">1</span>, <span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>, <span class="m">3</span>]);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">orig</span>.<span class="na">a</span>, <span class="nx">aa</span>);</div></div></pre></div></section><section id="koru/changes.applyOne" tabindex="-1" name="applyOne" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Changes.<span class="highlight"><span class="nf">applyOne</span>(<span class="nv">attrs</span>, <span class="nv">key</span>, <span class="nv">changes</span>)</span></h1><abstract><div><p>Apply only one attribute from changes</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>attrs</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>key</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>changes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Changes</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/changes"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">attrs</span> <span class="o">=</span> {<span class="na">bar</span>: <span class="m">1</span>, <span class="na">foo</span>: <span class="m">2</span>, <span class="na">fuz</span>: <span class="m">3</span>, <span class="na">fiz</span>: <span class="m">4</span>};
<span class="kd">const</span> <span class="no">changes</span> <span class="o">=</span> {<span class="na">foo</span>: <span class="kc">null</span>, <span class="na">fuz</span>: <span class="kc">undefined</span>, <span class="na">fiz</span>: <span class="m">5</span>, <span class="na">nit</span>: <span class="m">6</span>};
<span class="nx">Changes</span>.<span class="na">applyOne</span>(<span class="nx">attrs</span>, <span class="s">'foo'</span>, <span class="nx">changes</span>);
<span class="nx">Changes</span>.<span class="na">applyOne</span>(<span class="nx">attrs</span>, <span class="s">'fuz'</span>, <span class="nx">changes</span>);
<span class="nx">Changes</span>.<span class="na">applyOne</span>(<span class="nx">attrs</span>, <span class="s">'fiz'</span>, <span class="nx">changes</span>);
<span class="nx">Changes</span>.<span class="na">applyOne</span>(<span class="nx">attrs</span>, <span class="s">'nit'</span>, <span class="nx">changes</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">attrs</span>, {<span class="na">bar</span>: <span class="m">1</span>, <span class="na">fiz</span>: <span class="m">5</span>, <span class="na">nit</span>: <span class="m">6</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">changes</span>, {<span class="na">foo</span>: <span class="m">2</span>, <span class="na">fuz</span>: <span class="m">3</span>, <span class="na">fiz</span>: <span class="m">4</span>, <span class="na">nit</span>: <span class="nx">m</span>.<span class="na">null</span>});</div></div></pre></div></section><section id="koru/changes.fieldDiff" tabindex="-1" name="fieldDiff" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Changes.<span class="highlight"><span class="nf">fieldDiff</span>(<span class="nv">field</span>, <span class="nv">from</span>, <span class="nv">to</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>from</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>to</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Changes</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/changes"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Changes</span>.<span class="na">fieldDiff</span>(<span class="s">"foo"</span>, <span class="ge nx">{_id: "t123"}</span>, <span class="ge nx">{fuz: "123"}</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">Changes</span>.<span class="na">fieldDiff</span>(<span class="s">"foo"</span>, <span class="ge nx">{_id: "t123", foo: {one: 123, three: true, two: 'a string'}}</span>, <span class="ge nx">{foo: {one: 123, three: true, two: 'a string'}}</span>);</div><div></div></div></pre></div></section><section id="koru/changes.has" tabindex="-1" name="has" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Changes.<span class="highlight"><span class="nf">has</span>(<span class="nv">changes</span>, <span class="nv">field</span>)</span></h1><abstract><div><p>test if undo has changed field</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>changes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Changes</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/changes"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Changes</span>.<span class="na">has</span>(<span class="ge nx">{foo: undefined}</span>, <span class="s">"foo"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Changes</span>.<span class="na">has</span>(<span class="ge nx">{foo: false}</span>, <span class="s">"foo"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Changes</span>.<span class="na">has</span>(<span class="ge nx">{foo: undefined}</span>, <span class="s">"bar"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Changes</span>.<span class="na">has</span>(<span class="ge nx">{$partial: {foo: undefined}}</span>, <span class="s">"foo"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Changes</span>.<span class="na">has</span>(<span class="ge nx">{$partial: {foo: undefined}}</span>, <span class="s">"bar"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div></pre></div></section><section id="koru/changes.merge" tabindex="-1" name="merge" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Changes.<span class="highlight"><span class="nf">merge</span>(<span class="nv">to</span>, <span class="nv">from</span>)</span></h1><abstract><div><p>Merge one set of changes into another.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>to</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the destination for the merges</p>
</div></td></tr><tr class="jsdoc-arg"><td>from</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the source of the merges. Values may be assignment (not copied) to <code>to</code> so use
<a class="jsdoc-link" href="#koru/util/deepCopy">deepCopy</a> if that is not intended.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>to</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Changes</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/changes"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">current</span> <span class="o">=</span> {<span class="na">title</span>: <span class="s">'The Bone'</span>, <span class="na">author</span>: <span class="s">'Kery Hulme'</span>, <span class="na">genre</span>: [<span class="s">'Romance'</span>, <span class="s">'Mystery'</span>]};
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Changes</span>.<span class="na">merge</span>(<span class="nx">current</span>, {<span class="na">$partial</span>: {
  <span class="na">title</span>: [<span class="s">'$append'</span>, <span class="s">' People'</span>],
  <span class="na">author</span>: [<span class="s">'$patch'</span>, [<span class="m">3</span>, <span class="m">1</span>, <span class="s">'i'</span>]],
  <span class="na">genre</span>: [<span class="s">'$remove'</span>, [<span class="s">'Romance'</span>], <span class="s">'$add'</span>, [<span class="s">'Drama'</span>]],
}}), <span class="nx">current</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">current</span>, {
  <span class="na">title</span>: <span class="s">'The Bone People'</span>,
  <span class="na">author</span>: <span class="s">'Keri Hulme'</span>,
  <span class="na">genre</span>: [<span class="s">'Mystery'</span>, <span class="s">'Drama'</span>],
});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">current</span> <span class="o">=</span> {<span class="na">$partial</span>: {
  <span class="na">title</span>: [<span class="s">'$append'</span>, <span class="s">'The Bone'</span>],
  <span class="na">author</span>: [<span class="s">'$prepend'</span>, <span class="s">'Kery'</span>],
}};
<span class="nx">Changes</span>.<span class="na">merge</span>(<span class="nx">current</span>, {<span class="na">$partial</span>: {
  <span class="na">title</span>: [<span class="s">'$append'</span>, <span class="s">' People'</span>],
  <span class="na">author</span>: [<span class="s">'$patch'</span>, [<span class="m">3</span>, <span class="m">1</span>, <span class="s">'i'</span>]],
  <span class="na">genre</span>: [<span class="s">'$add'</span>, [<span class="s">'Mystery'</span>]],
}});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">current</span>, {<span class="na">$partial</span>: {
  <span class="na">title</span>: [<span class="s">'$append'</span>, <span class="s">'The Bone'</span>, <span class="s">'$append'</span>, <span class="s">' People'</span>],
  <span class="na">author</span>: [<span class="s">'$prepend'</span>, <span class="s">'Kery'</span>, <span class="s">'$patch'</span>, [<span class="m">3</span>, <span class="m">1</span>, <span class="s">'i'</span>]],
  <span class="na">genre</span>: [<span class="s">'$add'</span>, [<span class="s">'Mystery'</span>]],
}});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">current</span> <span class="o">=</span> {<span class="na">$partial</span>: {
  <span class="na">title</span>: [<span class="s">'$append'</span>, <span class="s">'The Bone'</span>],
  <span class="na">author</span>: [<span class="s">'$prepend'</span>, <span class="s">'Kery'</span>],
}};
<span class="nx">Changes</span>.<span class="na">merge</span>(<span class="nx">current</span>, {
  <span class="na">title</span>: <span class="s">'The Bone People'</span>,
  <span class="na">genre</span>: [<span class="s">'Mystery'</span>],
});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">current</span>, {
  <span class="na">title</span>: <span class="s">'The Bone People'</span>,
  <span class="na">genre</span>: [<span class="s">'Mystery'</span>],
  <span class="na">$partial</span>: {<span class="na">author</span>: [<span class="s">'$prepend'</span>, <span class="s">'Kery'</span>]}});</div></div></pre></div></section><section id="koru/changes.nestedDiff" tabindex="-1" name="nestedDiff" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Changes.<span class="highlight"><span class="nf">nestedDiff</span>(<span class="nv">from</span>, <span class="nv">to</span>, <span class="nv">depth</span><span class="o">=</span><span class="m">0</span>)</span></h1><abstract><div><p>Create diff in partial format to the specified depth.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>from</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>to</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[depth]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>How deep to recurse subfields defaults to 0</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>diff in partial format</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Changes</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/changes"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">was</span> <span class="o">=</span> {<span class="na">level1</span>: {<span class="na">level2</span>: {<span class="na">iLike</span>: <span class="s">'I like three'</span>, <span class="na">numbers</span>: [<span class="m">2</span>, <span class="m">9</span>, <span class="m">11</span>]}}};
<span class="kd">const</span> <span class="no">now</span> <span class="o">=</span> <span class="nx">deepCopy</span>(<span class="nx">was</span>);
<span class="nx">now</span>.<span class="na">level1</span>.<span class="na">level2</span>.<span class="na">iLike</span> <span class="o">=</span> <span class="s">'I like the rimu tree'</span>;
<span class="nx">now</span>.<span class="na">level1</span>.<span class="na">level2</span>.<span class="na">iAlsoLike</span> <span class="o">=</span> <span class="s">'Tuis'</span>;
<span class="kd">let</span> <span class="nv">changes</span> <span class="o">=</span> <span class="nx">Changes</span>.<span class="na">nestedDiff</span>(<span class="nx">was</span>, <span class="nx">now</span>, <span class="m">5</span>);

<span class="cm">/** depth 5 **/</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">changes</span>, [
  <span class="s">'level1.$partial'</span>, [
    <span class="s">'level2.$partial'</span>, [
      <span class="s">'iLike.$partial'</span>, [<span class="s">'$patch'</span>, [<span class="m">9</span>, <span class="m">0</span>, <span class="s">'e rimu t'</span>]],
      <span class="s">'iAlsoLike'</span>, <span class="s">'Tuis'</span>,
    ]]]);

<span class="kd">const</span> <span class="no">wasCopy</span> <span class="o">=</span> <span class="nx">deepCopy</span>(<span class="nx">was</span>);
<span class="nx">Changes</span>.<span class="na">applyAll</span>({<span class="na">likes</span>: <span class="nx">wasCopy</span>}, {<span class="na">$partial</span>: {<span class="na">likes</span>: <span class="nx">changes</span>}});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">wasCopy</span>, <span class="nx">now</span>);

<span class="cm">/** depth 2 **/</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Changes</span>.<span class="na">nestedDiff</span>(<span class="nx">was</span>, <span class="nx">now</span>, <span class="m">2</span>), [
  <span class="s">'level1.$partial'</span>, [<span class="s">'level2.$partial'</span>, [
    <span class="s">'iLike'</span>, <span class="s">'I like the rimu tree'</span>, <span class="s">'iAlsoLike'</span>, <span class="s">'Tuis'</span>,
  ]]]);

<span class="cm">/** depth 0 **/</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Changes</span>.<span class="na">nestedDiff</span>(<span class="nx">was</span>, <span class="nx">now</span>), [
  <span class="s">'level1'</span>, {<span class="na">level2</span>: {
    <span class="na">iLike</span>: <span class="s">'I like the rimu tree'</span>, <span class="na">iAlsoLike</span>: <span class="s">'Tuis'</span>, <span class="na">numbers</span>: [<span class="m">2</span>, <span class="m">9</span>, <span class="m">11</span>]}}]);

{ <span class="cm">/** arrays and multiple entries **/</span>
  <span class="kd">const</span> <span class="no">now</span> <span class="o">=</span> <span class="nx">deepCopy</span>(<span class="nx">was</span>);
  <span class="nx">now</span>.<span class="na">level1</span>.<span class="na">level2</span>.<span class="na">numbers</span> <span class="o">=</span> [<span class="m">2</span>, <span class="m">3</span>, <span class="m">5</span>, <span class="m">7</span>, <span class="m">11</span>];
  <span class="nx">now</span>.<span class="na">level1</span>.<span class="na">level2a</span> <span class="o">=</span> <span class="s">'Another branch'</span>;

  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Changes</span>.<span class="na">nestedDiff</span>(<span class="nx">was</span>, <span class="nx">now</span>, <span class="m">5</span>), [
    <span class="s">'level1.$partial'</span>, [
      <span class="s">'level2.$partial'</span>, [
        <span class="s">'numbers.$partial'</span>, [<span class="s">'$patch'</span>, [<span class="m">1</span>, <span class="m">1</span>, [<span class="m">3</span>, <span class="m">5</span>, <span class="m">7</span>]]],
      ],
      <span class="s">'level2a'</span>, <span class="s">'Another branch'</span>,
    ]]);
}</div></div></pre></div></section><section id="koru/changes.original" tabindex="-1" name="original" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Changes.<span class="highlight"><span class="nf">original</span>(<span class="nv">undo</span>)</span></h1><abstract><div><p>Reteries the original set of changes from an <code>undo</code>. See <a class="jsdoc-link" href="#koru/changes.applyAll">applyAll</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>undo</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Changes</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/changes"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Changes</span>.<span class="na">original</span>(<span class="ge nx">{foo: 123}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{foo: 456}</span></span></div></pre></div></section></div></div></div></section><section id="koru/client/mock-cache-storage" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/client/mock-cache-storage">koru/client/mock-cache-storage</a><h1 class="jsdoc-module-title searchable">MockCacheStorage</h1><abstract><div><p>A Mock version of <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage" target="_blank">CacheStorage</a></p>
<h2 id="limitations">Limitations</h2>
<p><code>match</code> only supports strictly checking the url.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/client/mock-cache-storage.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>()</span></h1><abstract><div><p>Create an instance suitable for replacing <code>window.caches</code></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MockCacheStorage</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/client/mock-cache-storage"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">caches</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockCacheStorage</span>;
<span class="nx">refute</span>(<span class="k">await</span> <span class="nx">caches</span>.<span class="na">match</span>(<span class="k">new</span> <span class="nx">Request</span>(<span class="s">'/index.js'</span>)));</div></div></pre></div></section></div></div></div></section><section id="koru/client/uncache" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/client/uncache">koru/client/uncache</a><h1 class="jsdoc-module-title searchable">Uncache</h1><abstract><div><p>Uncache is used for development to uncache fixed assets or the service-worker and reload app if
they are modified.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/client/uncache.start" tabindex="-1" name="start" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Uncache.<span class="highlight"><span class="nf">start</span>(<span class="nv">assets</span><span class="o">=</span>{
      <span class="s">'.build/index.html'</span>: <span class="s">'/'</span>,
      <span class="s">'manifest.json'</span>: <span class="s">'/manifest.json'</span>,
      <span class="s">'index.css'</span>: <span class="s">'/index.css'</span>,
    })</span></h1><abstract><div><p>Start tracking fixed asset changes and service-worker.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[assets]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Uncache</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/client/uncache"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Uncache</span>.<span class="na">start</span>();

<span class="k">await</span> <span class="nx">cache</span>.<span class="na">put</span>(<span class="k">new</span> <span class="nx">Request</span>(<span class="s">'/'</span>), {<span class="na">status</span>: <span class="m">200</span>, <span class="na">body</span>: <span class="s">'code...'</span>});
<span class="k">await</span> <span class="nx">koru</span>.<span class="na">unload</span>(<span class="s">'i_do_not_exist'</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">koru</span>.<span class="na">reload</span>);

<span class="nx">assert</span>(<span class="k">await</span> <span class="nx">caches</span>.<span class="na">match</span>(<span class="s">'/'</span>));

<span class="k">await</span> <span class="nx">koru</span>.<span class="na">unload</span>(<span class="s">'.build/index.html'</span>); <span class="cs">// simulate server sending unload to client</span>
<span class="nx">refute</span>(<span class="k">await</span> <span class="nx">caches</span>.<span class="na">match</span>(<span class="s">'/'</span>));
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">koru</span>.<span class="na">reload</span>);

<span class="nx">Uncache</span>.<span class="na">stop</span>();</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Uncache</span>.<span class="na">start</span>({<span class="s">'public/my.css'</span>: <span class="s">'/public/my.css'</span>});

<span class="k">await</span> <span class="nx">cache</span>.<span class="na">put</span>(<span class="k">new</span> <span class="nx">Request</span>(<span class="s">'/public/my.css'</span>), {<span class="na">status</span>: <span class="m">200</span>, <span class="na">body</span>: <span class="s">'css...'</span>});
<span class="k">await</span> <span class="nx">koru</span>.<span class="na">unload</span>(<span class="s">'public/my.css'</span>); <span class="cs">// simulate server sending unload to client</span>
<span class="nx">refute</span>(<span class="k">await</span> <span class="nx">caches</span>.<span class="na">match</span>(<span class="s">'/public/my.css'</span>));

<span class="nx">Uncache</span>.<span class="na">stop</span>();</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// service-worker</span>
<span class="nx">Uncache</span>.<span class="na">start</span>();

<span class="nx">stub</span>(<span class="nx">koru</span>, <span class="s">'unregisterServiceWorker'</span>);

<span class="k">await</span> <span class="nx">koru</span>.<span class="na">unload</span>(<span class="s">'service-worker'</span>);

<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">koru</span>.<span class="na">unregisterServiceWorker</span>);

<span class="k">await</span> <span class="nx">koru</span>.<span class="na">unload</span>(<span class="s">'sw'</span>); <span class="cs">// this works as well</span>

<span class="nx">assert</span>.<span class="na">calledTwice</span>(<span class="nx">koru</span>.<span class="na">unregisterServiceWorker</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/crypto/acc-sha256" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/crypto/acc-sha256">koru/crypto/acc-sha256</a><h1 class="jsdoc-module-title searchable">AccSha256</h1><abstract><div><p>This is useful for building a hash in small increments; it is not the same as hashing the
entire string in one go.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/crypto/acc-sha256.add" tabindex="-1" name="add" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">AccSha256.<span class="highlight"><span class="nf">add</span>(
    <span class="nv">text</span>,
    <span class="nv">hash</span> <span class="o">=</span> [<span class="m">0x6A09E667</span>, <span class="m">0xBB67AE85</span>, <span class="m">0x3C6EF372</span>, <span class="m">0xA54FF53A</span>, <span class="m">0x510E527F</span>, <span class="m">0x9B05688C</span>, <span class="m">0x1F83D9AB</span>, <span class="m">0x5BE0CD19</span>],
  )</span></h1><abstract><div><p>Modify <code>hash</code> using <code>text</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>text</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The message to add to <code>hash</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>[hash]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>should be an array of 8 32bit integers. The default is the standard sha256
initial hash values.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the modified <code>hash</code>; not a copy.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AccSha256</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/crypto/acc-sha256"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">h</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>];
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sut</span>.<span class="na">add</span>(<span class="s">'hello world'</span>, <span class="nx">h</span>), <span class="nx">h</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">h</span>, [<span class="m">4138495084</span>, <span class="m">3973010320</span>, <span class="m">2777164054</span>, <span class="m">2207796612</span>, <span class="m">615005229</span>, <span class="m">3241153105</span>, <span class="m">1397076350</span>, <span class="m">2212452408</span>]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">sut</span>.<span class="na">add</span>(<span class="s">'secret'</span>), [
  <span class="m">733482323</span>,
  <span class="m">2065540067</span>,
  <span class="m">2345861985</span>,
  <span class="m">2860865158</span>,
  <span class="m">3185633997</span>,
  <span class="m">1902313206</span>,
  <span class="m">2724194683</span>,
  <span class="m">4113015387</span>,
]);</div></div></pre></div></section><section id="koru/crypto/acc-sha256.toHex" tabindex="-1" name="toHex" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">AccSha256.<span class="highlight"><span class="nf">toHex</span>(<span class="nv">hash</span>)</span></h1><abstract><div><p>Convert a <code>hash</code> to a hex string.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>hash</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>an array of 32bit integers. Usually produced from <a class="jsdoc-link" href="#koru/crypto/acc-sha256.add">add</a>.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the hex equivalent of the <code>hash</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AccSha256</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/crypto/acc-sha256"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(
  <span class="nx">sut</span>.<span class="na">toHex</span>([<span class="m">65535</span>, <span class="m">1</span>, <span class="m">15</span>, <span class="m">256</span>, <span class="m">0xffffffff</span>, <span class="m">10</span>, <span class="m">0</span>, <span class="m">0</span>]),
  <span class="s">'0000ffff000000010000000f00000100ffffffff0000000a0000000000000000'</span>,
);

<span class="kd">const</span> <span class="no">h</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>];
<span class="nx">sut</span>.<span class="na">add</span>(<span class="s">'hello world'</span>, <span class="nx">h</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sut</span>.<span class="na">toHex</span>(<span class="nx">h</span>), <span class="s">'f6ac6c6ceccf5390a588291683984d8424a83c2dc13012515345b17e83df5838'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(
  <span class="nx">sut</span>.<span class="na">toHex</span>(<span class="nx">sut</span>.<span class="na">add</span>(<span class="s">'\na bit more text\n\u{1}÷\0\n\n\n'</span>, <span class="nx">h</span>)),
  <span class="s">'4cb301ea6c1e975ad8130be3e660b5a9ccf9e28e514a73c63533f2690c866255'</span>,
);</div></div></pre></div></section><section id="koru/crypto/acc-sha256.toId" tabindex="-1" name="toId" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">AccSha256.<span class="highlight"><span class="nf">toId</span>(<span class="nv">text</span>, <span class="nv">hash</span>)</span></h1><abstract><div><p>Convert a string into an id hash</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>text</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array" target="_blank">Uint8Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint32Array" target="_blank">Uint32Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[hash]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AccSha256</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/crypto/acc-sha256"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sut</span>.<span class="na">toId</span>(<span class="s">'hello'</span> <span class="o">+</span> <span class="s">'goodbye'</span>), <span class="s">'hef112kz6HMarjX36'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sut</span>.<span class="na">toId</span>(<span class="s">''</span>), <span class="s">'5aQFks5seW4uAZNtG'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sut</span>.<span class="na">toId</span>(<span class="s">'1'</span>), <span class="s">'RSaJD5Q8g5Jxp2s8M'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sut</span>.<span class="na">toId</span>(<span class="s">'hello'</span>), <span class="s">'1fUIeDQxGXKCyEZbu'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/css/loader" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/css/loader">koru/css/loader</a><h1 class="jsdoc-module-title searchable">CssLoader</h1><abstract><div><p>css/loader allows dynamic replacement of css and less files when
their contents change.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/css/loader.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">session</span>)</span></h1><abstract><div><p>Construct a css loader</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>session</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>listen for load messages from this session</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">CssLoader</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/css/loader"</span>);</div><div><div class="highlight"><span class="k">new</span> <span class="nx">CssLoader</span>(<span class="nx">SessionBase</span>(<span class="nx">loader</span>));</div></div></pre></div></section><section id="koru/css/loader#loadAll" tabindex="-1" name="#loadAll" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">CssLoader#<span class="highlight"><span class="nf">loadAll</span>(<span class="nv">dir</span>)</span></h1><abstract><div><p>Load all css and less files under <code>dir</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dir</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">CssLoader</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/css/loader"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">cssLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CssLoader</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">cssLoader</span>.<span class="na">loadAll</span>(<span class="s">"koru/css"</span>);</div><div></div></div></pre></div></section></div></div></div></section><section id="koru/dir-watcher" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/dir-watcher">koru/dir-watcher</a><h1 class="jsdoc-module-title searchable">DirWatcher</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/dir-watcher.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">dir</span>, <span class="nv">callback</span>, <span class="nv">callOnInit</span><span class="o">=</span><span class="kc">false</span>)</span></h1><abstract><div><p>Watch recursively for file and directory changes</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dir</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the top level directory to watch</p>
</div></td></tr><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called with the path that changed and a <code>fs.Stats</code> object or <code>undefined</code> if</p>
</div></td></tr><tr class="jsdoc-arg"><td>callOnInit</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p>if true run the callback for every existing path found.
unlinked.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DirWatcher</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dir-watcher"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">callback</span> <span class="o">=</span> <span class="nx">stub</span>((<span class="nv">pathname</span>, <span class="nv">st</span>) <span class="o">=&gt;</span> {
  <span class="k">if</span> (<span class="nx">path</span>.<span class="na">basename</span>(<span class="nx">pathname</span>) <span class="o">===</span> <span class="s">'f1'</span>) {
    <span class="nx">future</span>.<span class="na">resolve</span>();
  }
});
<span class="nx">after</span>(<span class="k">new</span> <span class="nx">DirWatcher</span>(<span class="nx">liveDir</span>, <span class="nx">callback</span>, <span class="kc">true</span>));

<span class="k">await</span> <span class="nx">future</span>.<span class="na">promise</span>;
<span class="nx">assert</span>.<span class="na">calledTwice</span>(<span class="nx">callback</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">callback</span>, <span class="nx">m</span>(<span class="sr">/^\/.*\.build\/test-watch-dir\/live\/d1$/</span>), <span class="nx">m</span>((<span class="nv">st</span>) <span class="o">=&gt;</span> <span class="nx">st</span>.<span class="na">isDirectory</span>()));
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">callback</span>, <span class="nx">m</span>(<span class="sr">/test-watch-dir.*f1$/</span>), <span class="nx">m</span>((<span class="nv">st</span>) <span class="o">=&gt;</span> <span class="o">!</span> <span class="nx">st</span>.<span class="na">isDirectory</span>()));</div></div></pre></div></section></div></div></div></section><section id="koru/dlinked-list" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/dlinked-list">koru/dlinked-list</a><h1 class="jsdoc-module-title searchable">DLinkedList</h1><abstract><div><p>A double linked list. The list is iterable. Nodes can be deleted without needing this list.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#head</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>Retrieve the node that is the head of the list</p>
</div></td></tr><tr><td class="searchable">#tail</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>Retrieve the node that is the tail of the list</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/dlinked-list.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">listEmpty</span>)</span></h1><abstract><div><p>Make an instance of DLinkedList</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[listEmpty]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>method will be called when the list becomes empty.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DLinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dlinked-list"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">listEmpty</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DLinkedList</span>(<span class="nx">listEmpty</span>);

<span class="kd">const</span> <span class="no">node1</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="s">'value1'</span>);
<span class="kd">const</span> <span class="no">node2</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="s">'value2'</span>);

<span class="nx">node1</span>.<span class="na">delete</span>();

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">listEmpty</span>);
<span class="nx">node2</span>.<span class="na">delete</span>();
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">listEmpty</span>);</div></div></pre></div></section><section id="koru/dlinked-list#add" tabindex="-1" name="#add" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DLinkedList#<span class="highlight"><span class="nf">add</span>(<span class="nv">value</span><span class="o">=</span><span class="kc">null</span>)</span></h1><abstract><div><p>add <code>value</code> to the end of the list.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[value]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>to add to the list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a node that has the methods</p>
<ul>
<li><code>value</code> the object passed to <code>add</code></li>
<li><code>delete</code> a function to delete the entry</li>
</ul>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DLinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dlinked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DLinkedList</span>();

<span class="kd">const</span> <span class="no">node1</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="m">1</span>);
<span class="kd">const</span> <span class="no">node2</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">node1</span>.<span class="na">value</span>, <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">node1</span>, <span class="nx">subject</span>.<span class="na">head</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">node2</span>, <span class="nx">subject</span>.<span class="na">tail</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), [<span class="m">1</span>, <span class="m">2</span>]);

<span class="nx">node1</span>.<span class="na">delete</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), [<span class="m">2</span>]);

<span class="nx">subject</span>.<span class="na">add</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), [<span class="m">2</span>, <span class="kc">null</span>]);

<span class="nx">node2</span>.<span class="na">value</span> <span class="o">=</span> <span class="o">void</span> <span class="m">0</span>; <span class="cs">// undefined is coerced to null</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), [<span class="kc">null</span>, <span class="kc">null</span>]);</div></div></pre></div></section><section id="koru/dlinked-list#addFront" tabindex="-1" name="#addFront" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DLinkedList#<span class="highlight"><span class="nf">addFront</span>(<span class="nv">value</span><span class="o">=</span><span class="kc">null</span>)</span></h1><abstract><div><p>add <code>value</code> to the front of the list.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[value]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>to add to the list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a node that has the methods</p>
<ul>
<li><code>value</code> the object passed to <code>add</code></li>
<li><code>delete</code> a function to delete the entry</li>
</ul>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DLinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dlinked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DLinkedList</span>();

<span class="kd">const</span> <span class="no">node1</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="m">1</span>);
<span class="kd">const</span> <span class="no">node2</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">addFront</span>(<span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">node1</span>.<span class="na">value</span>, <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">node1</span>, <span class="nx">subject</span>.<span class="na">tail</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">node2</span>, <span class="nx">subject</span>.<span class="na">head</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), [<span class="m">2</span>, <span class="m">1</span>]);

<span class="nx">node1</span>.<span class="na">delete</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), [<span class="m">2</span>]);

<span class="nx">subject</span>.<span class="na">addFront</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), [<span class="kc">null</span>, <span class="m">2</span>]);</div></div></pre></div></section><section id="koru/dlinked-list#clear" tabindex="-1" name="#clear" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DLinkedList#<span class="highlight"><span class="nf">clear</span>()</span></h1><abstract><div><p>clear all entries. (calls <code>listEmpty</code> if present)</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DLinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dlinked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DLinkedList</span>();

<span class="nx">subject</span>.<span class="na">add</span>(<span class="m">1</span>);
<span class="nx">subject</span>.<span class="na">add</span>(<span class="m">2</span>);

<span class="nx">subject</span>.<span class="na">clear</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), []);</div></div></pre></div></section><section id="koru/dlinked-list#forEach" tabindex="-1" name="#forEach" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DLinkedList#<span class="highlight"><span class="nf">forEach</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>visit each entry</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DLinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dlinked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DLinkedList</span>();

<span class="nx">subject</span>.<span class="na">add</span>(<span class="s">'a'</span>);
<span class="nx">subject</span>.<span class="na">add</span>(<span class="s">'b'</span>);

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> [];

<span class="nx">subject</span>.<span class="na">forEach</span>((<span class="nv">v</span>) <span class="o">=&gt;</span> {<span class="nx">ans</span>.<span class="na">push</span>(<span class="nx">v</span>)});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, [<span class="s">'a'</span>, <span class="s">'b'</span>]);</div></div></pre></div></section><section id="koru/dlinked-list#nodes" tabindex="-1" name="#nodes" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DLinkedList#<span class="highlight"><span class="nf">*nodes</span>()</span></h1><abstract><div><p>Return an iterator over the nodes added to the list. (<a class="jsdoc-link" href="#koru/dlinked-list#add">add</a> returns the <code>node</code>)</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DLinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dlinked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DLinkedList</span>();

<span class="kd">const</span> <span class="no">f</span> <span class="o">=</span> () <span class="o">=&gt;</span> {};
<span class="kd">const</span> <span class="no">exp</span> <span class="o">=</span> [
  <span class="nx">m</span>.<span class="na">is</span>(<span class="nx">subject</span>.<span class="na">add</span>(<span class="m">1</span>)),
  <span class="nx">m</span>.<span class="na">is</span>(<span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">f</span>)),
];
<span class="nx">subject</span>.<span class="na">add</span>(<span class="s">'a'</span>);

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> [];

<span class="k">for</span> (<span class="kd">const</span> <span class="no">h</span> <span class="k">of</span> <span class="nx">subject</span>.<span class="na">nodes</span>()) {
  <span class="nx">ans</span>.<span class="na">push</span>(<span class="nx">h</span>);
  <span class="k">if</span> (<span class="nx">h</span>.<span class="na">value</span> <span class="o">===</span> <span class="nx">f</span>) <span class="k">break</span>;
}

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, <span class="nx">exp</span>);</div></div></pre></div></section><section id="koru/dlinked-list#values" tabindex="-1" name="#values" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DLinkedList#<span class="highlight"><span class="nf">*values</span>()</span></h1><abstract><div><p>Return an iterator over the values added to the list.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DLinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dlinked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DLinkedList</span>();

<span class="kd">const</span> <span class="no">f</span> <span class="o">=</span> () <span class="o">=&gt;</span> {};
<span class="nx">subject</span>.<span class="na">add</span>(<span class="m">1</span>),
<span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">f</span>),
<span class="nx">subject</span>.<span class="na">add</span>(<span class="s">'a'</span>);

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> [];

<span class="k">for</span> (<span class="kd">const</span> <span class="no">v</span> <span class="k">of</span> <span class="nx">subject</span>.<span class="na">values</span>()) {
  <span class="nx">ans</span>.<span class="na">push</span>(<span class="nx">v</span>);
  <span class="k">if</span> (<span class="nx">v</span> <span class="o">===</span> <span class="nx">f</span>) <span class="k">break</span>;
}

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, [<span class="m">1</span>, <span class="nx">m</span>.<span class="na">is</span>(<span class="nx">f</span>)]);</div></div></pre></div></section></div></div></div></section><section id="koru/dom" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/dom">koru/dom</a><h1 class="jsdoc-module-title searchable">Dom</h1><abstract><div><p>Utilities for interacting with the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model" target="_blank">Document&nbsp;Object&nbsp;Model</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/dom.closestChildOf" tabindex="-1" name="closestChildOf" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">closestChildOf</span>(<span class="nv">elm</span><span class="o">=</span><span class="kc">null</span>, <span class="nv">parent</span>)</span></h1><abstract><div><p>Search up <code>parent</code>'s child which is <code>elm</code> or a ancestor of <code>elm</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Node</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the node to start the search from</p>
</div></td></tr><tr class="jsdoc-arg"><td>parent</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the parent of the node being looked for.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div><p><code>null</code> if <code>elm</code> is not a descendant of <code>parent</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">child</span> <span class="o">=</span> <span class="nx">document</span>.<span class="na">createTextNode</span>(<span class="s">'child'</span>), <span class="no">otherChild</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});
<span class="kd">const</span> <span class="no">topChild</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: {<span class="na">div</span>: <span class="nx">child</span>}});
<span class="kd">const</span> <span class="no">parent</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: <span class="nx">topChild</span>});
<span class="kd">const</span> <span class="no">tree</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: [<span class="nx">parent</span>, {<span class="na">div</span>: {<span class="na">div</span>: <span class="nx">otherChild</span>}}]});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">closestChildOf</span>(<span class="nx">child</span>, <span class="nx">parent</span>), <span class="nx">topChild</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">closestChildOf</span>(<span class="nx">otherChild</span>, <span class="nx">parent</span>), <span class="kc">null</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">closestChildOf</span>(<span class="nx">topChild</span>, <span class="nx">parent</span>), <span class="nx">topChild</span>);</div></div></pre></div></section><section id="koru/dom.endMarker" tabindex="-1" name="endMarker" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">endMarker</span>(<span class="nv">startMarker</span>)</span></h1><abstract><div><p>Return the end marker for a start marker.</p>
<p>See <a class="jsdoc-link" href="#koru/dom.insertStartEndMarkers">insertStartEndMarkers</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>startMarker</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Node</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Node</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">parent</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});
<span class="kd">const</span> <span class="no">startMarker</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">insertStartEndMarkers</span>(<span class="nx">parent</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">endMarker</span>(<span class="nx">startMarker</span>), <span class="nx">startMarker</span>.<span class="na">nextSibling</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">endMarker</span>(<span class="nx">startMarker</span>).<span class="na">nodeType</span>, <span class="nx">document</span>.<span class="na">COMMENT_NODE</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">endMarker</span>(<span class="nx">startMarker</span>).<span class="na">data</span>, <span class="s">'end'</span>);</div></div></pre></div></section><section id="koru/dom.ensureInView" tabindex="-1" name="ensureInView" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">ensureInView</span>(<span class="nv">elm</span>)</span></h1><abstract><div><p>Ensure that <code>elm</code> is as visible as possible with minimal scrolling.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// horizontal scroll</span>
<span class="kd">const</span> <span class="no">block</span> <span class="o">=</span> (<span class="nv">text</span>) <span class="o">=&gt;</span> <span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">style</span>: <span class="s">'flex:0 0 50px'</span>, <span class="na">div</span>: [<span class="nx">text</span>]});

<span class="kd">const</span> <span class="no">divs</span> <span class="o">=</span> <span class="s">'one two three four five'</span>.<span class="na">split</span>(<span class="s">' '</span>).<span class="na">map</span>((<span class="nv">t</span>) <span class="o">=&gt;</span> <span class="nx">block</span>(<span class="nx">t</span>));
<span class="kd">const</span> <span class="no">container</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">style</span>: <span class="s">'margin:30px;width:75px;height:30px;overflow:scroll;'</span>,
  <span class="na">div</span>: {
    <span class="na">style</span>: <span class="s">'display:flex;width:300px'</span>,
    <span class="na">div</span>: <span class="nx">divs</span>,
  },
});

<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">container</span>);
<span class="nx">Dom</span>.<span class="na">ensureInView</span>(<span class="nx">divs</span>[<span class="m">1</span>]);
<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">container</span>.<span class="na">scrollLeft</span>, <span class="m">39</span>, <span class="m">2</span>);

<span class="nx">Dom</span>.<span class="na">ensureInView</span>(<span class="nx">divs</span>[<span class="m">0</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">container</span>.<span class="na">scrollLeft</span>, <span class="m">0</span>, <span class="m">2</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// vertical scroll</span>
<span class="kd">const</span> <span class="no">block</span> <span class="o">=</span> (<span class="nv">text</span>) <span class="o">=&gt;</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">style</span>: <span class="s">'width:50px;height:20px'</span>, <span class="na">div</span>: [<span class="nx">text</span>]});

<span class="kd">const</span> <span class="no">divs</span> <span class="o">=</span> <span class="s">'one two three four five'</span>.<span class="na">split</span>(<span class="s">' '</span>).<span class="na">map</span>((<span class="nv">t</span>) <span class="o">=&gt;</span> <span class="nx">block</span>(<span class="nx">t</span>));
<span class="kd">const</span> <span class="no">container</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">style</span>: <span class="s">'margin:30px;width:150px;height:30px;overflow:scroll'</span>,
  <span class="na">div</span>: <span class="nx">divs</span>,
});

<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">container</span>);
<span class="nx">Dom</span>.<span class="na">ensureInView</span>(<span class="nx">divs</span>[<span class="m">1</span>]);
<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">container</span>.<span class="na">scrollTop</span>, <span class="m">20</span>);

<span class="nx">Dom</span>.<span class="na">ensureInView</span>(<span class="nx">divs</span>[<span class="m">0</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">container</span>.<span class="na">scrollTop</span>, <span class="m">0</span>);</div></div></pre></div></section><section id="koru/dom.getBoundingClientRect" tabindex="-1" name="getBoundingClientRect" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">getBoundingClientRect</span>(<span class="nv">object</span>)</span></h1><abstract><div><p>Get the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect" target="_blank">boundingClientRect</a>
for different types of objects namely: <code>Range</code> and <code>Element</code>. For a collapsed range the result
is calculated around caret position otherwise the object's <code>getBoundingClientRect</code> is
used. Also if an existing client rect can be passed it will be returned.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>The object to calculate for.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">Object</a></td><td class="jsdoc-info"><div><p>the rect parameters contains <code>left, top, width, height</code> and aliases.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">div</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">style</span>: <span class="s">'position:absolute;left:25px;top:50px;width:150px;height:80px;'</span> <span class="o">+</span>
    <span class="s">'font-size:16px;font-family:monospace'</span>,
  <span class="na">contenteditable</span>: <span class="kc">true</span>,
  <span class="na">div</span>: [<span class="s">'Hello '</span>, <span class="s">'world'</span>, {<span class="na">br</span>: <span class="s">''</span>}, {<span class="na">br</span>: <span class="s">''</span>}, <span class="s">''</span>]});
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">div</span>);

<span class="kd">const</span> <span class="no">keys</span> <span class="o">=</span> <span class="s">'left top width height'</span>.<span class="na">split</span>(<span class="s">' '</span>);
<span class="kd">const</span> <span class="no">rect</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">extractKeys</span>(<span class="nx">div</span>.<span class="na">getBoundingClientRect</span>(), <span class="nx">keys</span>);

<span class="cs">// an Element</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">extractKeys</span>(<span class="nx">Dom</span>.<span class="na">getBoundingClientRect</span>(<span class="nx">div</span>), <span class="nx">keys</span>), <span class="nx">rect</span>);

<span class="cs">// a selection</span>
<span class="kd">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="nx">document</span>.<span class="na">createRange</span>();
<span class="nx">range</span>.<span class="na">selectNode</span>(<span class="nx">div</span>);
<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">util</span>.<span class="na">extractKeys</span>(<span class="nx">Dom</span>.<span class="na">getBoundingClientRect</span>(<span class="nx">range</span>), <span class="nx">keys</span>), <span class="nx">rect</span>);

<span class="cs">// a position</span>
<span class="nx">range</span>.<span class="na">setStart</span>(<span class="nx">div</span>.<span class="na">firstChild</span>, <span class="m">4</span>); <span class="nx">range</span>.<span class="na">collapse</span>(<span class="kc">true</span>);
<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">util</span>.<span class="na">extractKeys</span>(<span class="nx">Dom</span>.<span class="na">getBoundingClientRect</span>(<span class="nx">range</span>), <span class="nx">keys</span>), {
  <span class="na">left</span>: <span class="m">64</span>, <span class="na">top</span>: <span class="m">50</span>, <span class="na">width</span>: <span class="m">0</span>, <span class="na">height</span>: <span class="m">19</span>}, <span class="m">2</span>);

<span class="cs">// a client rect</span>
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">getBoundingClientRect</span>(<span class="nx">rect</span>), <span class="nx">rect</span>);</div></div></pre></div></section><section id="koru/dom.getClosest" tabindex="-1" name="getClosest" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">getClosest</span>(<span class="nv">elm</span><span class="o">=</span><span class="kc">null</span>, <span class="nv">selector</span>)</span></h1><abstract><div><p>search up for element that matches selector</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Node</a></td><td class="jsdoc-info"><div><p>the element to start from. Text elements start from their parent node.</p>
</div></td></tr><tr class="jsdoc-arg"><td>selector</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">div</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});
<span class="nx">div</span>.<span class="na">innerHTML</span> <span class="o">=</span> <span class="s">`
&lt;div class="foo"&gt;
  &lt;div class="bar"&gt;
    &lt;button type="button" id="sp"&gt;text&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;`</span>;
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">div</span>);
<span class="kd">const</span> <span class="no">button</span> <span class="o">=</span> <span class="nx">document</span>.<span class="na">getElementById</span>(<span class="s">'sp'</span>);

<span class="kd">const</span> <span class="no">foobar</span> <span class="o">=</span> <span class="nx">Dom</span>(<span class="s">'.foo&gt;.bar'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">getClosest</span>(<span class="nx">button</span>, <span class="s">'.foo&gt;.bar'</span>), <span class="nx">foobar</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">getClosest</span>(<span class="nx">foobar</span>, <span class="s">'.foo&gt;.bar'</span>), <span class="nx">foobar</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">getClosest</span>(<span class="nx">button</span>.<span class="na">firstChild</span>, <span class="s">'.foo'</span>), <span class="nx">foobar</span>.<span class="na">parentNode</span>);</div></div></pre></div></section><section id="koru/dom.getClosestCtx" tabindex="-1" name="getClosestCtx" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">getClosestCtx</span>(<span class="nv">elm</span>, <span class="nv">selector</span>)</span></h1><abstract><div><p>search up for element that matches selector</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the element to start from. Text elements start from their parent node.</p>
</div></td></tr><tr class="jsdoc-arg"><td>selector</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/dom/ctx">Ctx</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">getClosestCtx</span>(<span class="ge nx">Node`&lt;button type="button" id="sp"&gt;text&lt;/button&gt;`</span>, <span class="s">".foo&gt;.bar"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{attrEvals: [], evals: [], firstElement: Node`&lt;div class="bar"&gt;
    &lt;button type="button" id="sp"&gt;text&lt;/button&gt;
  &lt;/div&gt;`, parentCtx: Ctx({template: nu}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">getClosestCtx</span>(<span class="ge nx">Node`&lt;button type="button" id="sp"&gt;text&lt;/button&gt;`</span>, <span class="s">".foo"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{attrEvals: [], evals: [], firstElement: Node`&lt;div&gt;
&lt;div class="foo"&gt;
  &lt;div class="bar"&gt;
    &lt;button type="button" id="sp"&gt;text&lt;/button&gt;
  &lt;/div&gt;
&lt;/di}</span></span></div></pre></div></section><section id="koru/dom.insertStartEndMarkers" tabindex="-1" name="insertStartEndMarkers" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">insertStartEndMarkers</span>(<span class="nv">parent</span>, <span class="nv">before</span><span class="o">=</span><span class="kc">null</span>)</span></h1><abstract><div><p>Insert a pair of comments into <code>parent</code> that can be used for start and end markers.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>parent</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the parent node to insert comments into</p>
</div></td></tr><tr class="jsdoc-arg"><td>[before]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the node to insert the comments before. Comments are appended if before is
missing or null.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Node</a></td><td class="jsdoc-info"><div><p>the start comment. end comment can be found by calling <a class="jsdoc-link" href="#koru/dom.endMarker">endMarker</a></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">footer</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">footer</span>: <span class="s">'footer'</span>});
<span class="kd">const</span> <span class="no">parent</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: <span class="nx">footer</span>});
<span class="kd">const</span> <span class="no">startMarker</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">insertStartEndMarkers</span>(<span class="nx">parent</span>, <span class="nx">footer</span>);</div></div></pre></div></section><section id="koru/dom.isAboveBottom" tabindex="-1" name="isAboveBottom" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">isAboveBottom</span>(<span class="nv">elm</span>, <span class="nv">region</span>)</span></h1><abstract><div><p>Determine if an element is above the bottom of a region.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>region</td><td><a href="#koru/dom/html-doc::Element">html-doc::Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>either a
Dom <code>Element</code> or a <code>boundingClientRect</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isAboveBottom</span>(<span class="ge nx">Node`&lt;div style="position:absolute;left:-12px;width:20px;height:30px"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">Node`&lt;body&gt;&lt;div style="position:absolute;left:-12px;width:20px;height:30px"&gt;x&lt;/div&gt;&lt;/body&gt;`</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isAboveBottom</span>(<span class="ge nx">Node`&lt;div style="position: absolute; left: -12px; width: 20px; height: 30px; bottom: -9px;"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">Node`&lt;body&gt;&lt;div style="position: absolute; left: -12px; width: 20px; height: 30px; bottom: -9px;"&gt;x&lt;/div&gt;&lt;/body&gt;`</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isAboveBottom</span>(<span class="ge nx">Node`&lt;div style="position: absolute; left: -12px; width: 20px; height: 30px; top: 110%;"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">Node`&lt;body&gt;&lt;div style="position: absolute; left: -12px; width: 20px; height: 30px; top: 110%;"&gt;x&lt;/div&gt;&lt;/body&gt;`</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isAboveBottom</span>(<span class="ge nx">Node`&lt;div style="position: absolute; left: -12px; width: 20px; height: 30px; bottom: -17px;"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">{top: 0, bottom: 50, left: 0, right: 40}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isAboveBottom</span>(<span class="ge nx">Node`&lt;div style="position: absolute; left: -12px; width: 20px; height: 30px; bottom: -17px;"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">{top: 0, bottom: 2000, left: 0, right: 40}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div></pre></div></section><section id="koru/dom.isInView" tabindex="-1" name="isInView" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">isInView</span>(<span class="nv">elm</span>, <span class="nv">regionOrNode</span>)</span></h1><abstract><div><p>Determine if an element is within the viewable area of a
<code>region</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>regionOrNode</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isInView</span>(<span class="ge nx">Node`&lt;div style="position:absolute;left:-12px;width:20px;height:30px"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">Node`&lt;body&gt;&lt;div style="position:absolute;left:-12px;width:20px;height:30px"&gt;x&lt;/div&gt;&lt;/body&gt;`</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isInView</span>(<span class="ge nx">Node`&lt;div style="position: absolute; left: -9px; width: 20px; height: 30px;"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">Node`&lt;body&gt;&lt;div style="position: absolute; left: -9px; width: 20px; height: 30px;"&gt;x&lt;/div&gt;&lt;/body&gt;`</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isInView</span>(<span class="ge nx">Node`&lt;div style="position: absolute; left: -9px; width: 20px; height: 30px; bottom: -17px;"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">{top: 0, bottom: 50, left: 0, right: 40}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">isInView</span>(<span class="ge nx">Node`&lt;div style="position: absolute; left: -9px; width: 20px; height: 30px; bottom: -17px;"&gt;x&lt;/div&gt;`</span>, <span class="ge nx">{top: 0, bottom: 2000, left: 0, right: 40}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div></pre></div></section><section id="koru/dom.loadScript" tabindex="-1" name="loadScript" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">loadScript</span>(<span class="nv">opts</span>)</span></h1><abstract><div><p>Dynamically load a script and wait for it to load</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>opts</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Promise(Element)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">assert</span>.<span class="na">exception</span>(
  () <span class="o">=&gt;</span> <span class="nx">Dom</span>.<span class="na">loadScript</span>({<span class="na">src</span>: <span class="s">'/koru/dom/example-test-script-missing.js'</span>, <span class="na">id</span>: <span class="s">'example-script'</span>}),
  {<span class="na">type</span>: <span class="s">'error'</span>},
);

<span class="nx">document</span>.<span class="na">getElementById</span>(<span class="s">'example-script'</span>).<span class="na">remove</span>();

<span class="kd">const</span> <span class="no">scriptElm</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Dom</span>.<span class="na">loadScript</span>({<span class="na">src</span>: <span class="s">'/koru/dom/example-test-script.js'</span>, <span class="na">id</span>: <span class="s">'example-script'</span>});

<span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'#example-script'</span>, (<span class="nv">elm</span>) <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">scriptElm</span>, <span class="nx">elm</span>);
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">elm</span>.<span class="na">getAttribute</span>(<span class="s">'testing'</span>), <span class="s">'loaded'</span>);
});</div></div></pre></div></section><section id="koru/dom.makeMenustartCallback" tabindex="-1" name="makeMenustartCallback" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">makeMenustartCallback</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Creates a function suitable for event listeners wanting to open a menu.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">button</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">button</span>: <span class="s">'menu start'</span>});
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">button</span>);
<span class="kd">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="m">0</span>;
<span class="kd">const</span> <span class="no">menuStart</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">makeMenustartCallback</span>((<span class="nv">event</span>, <span class="nv">type</span>) <span class="o">=&gt;</span> {
  <span class="k">if</span> (<span class="nx">type</span> <span class="o">===</span> <span class="s">'menustart'</span>) {
    <span class="o">++</span><span class="nx">count</span>;
  }
});
<span class="nx">button</span>.<span class="na">addEventListener</span>(<span class="s">'pointerdown'</span>, <span class="nx">menuStart</span>);
<span class="nx">button</span>.<span class="na">addEventListener</span>(<span class="s">'click'</span>, <span class="nx">menuStart</span>);

<span class="cs">// using mouse</span>
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'pointerdown'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">count</span>, <span class="m">1</span>);
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'click'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">count</span>, <span class="m">2</span>);

<span class="cs">// using touch</span>
<span class="nx">count</span> <span class="o">=</span> <span class="m">0</span>;
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'pointerdown'</span>, {<span class="na">pointerType</span>: <span class="s">'touch'</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">count</span>, <span class="m">0</span>);

<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'click'</span>, {<span class="na">pointerType</span>: <span class="s">'touch'</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">count</span>, <span class="m">1</span>);</div></div></pre></div></section><section id="koru/dom.remove" tabindex="-1" name="remove" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">remove</span>(<span class="nv">elm</span>)</span></h1><abstract><div><p>Remove element and descontruct its <a class="jsdoc-link" href="#koru/dom/ctx">Ctx</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">elm</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});
<span class="nx">Dom</span>.<span class="na">setCtx</span>(<span class="nx">elm</span>, <span class="k">new</span> <span class="nx">Dom</span>.<span class="na">Ctx</span>());
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">elm</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">remove</span>(<span class="nx">elm</span>), <span class="kc">true</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">myCtx</span>(<span class="nx">elm</span>), <span class="kc">null</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">elm</span>.<span class="na">parentNode</span>, <span class="kc">null</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">remove</span>(<span class="nx">elm</span>), <span class="kc">false</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">remove</span>(<span class="kc">null</span>), <span class="kc">undefined</span>);</div></div></pre></div></section><section id="koru/dom.removeInserts" tabindex="-1" name="removeInserts" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">removeInserts</span>(<span class="nv">start</span>)</span></h1><abstract><div><p>remove inserts between start end markers.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>start</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Node</a></td><td class="jsdoc-info"><div><p>the start marker; see <a class="jsdoc-link" href="#koru/dom.insertStartEndMarkers">insertStartEndMarkers</a></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Dom</span>.<span class="na">removeInserts</span>(<span class="ge nx">{}</span>);</div><div></div></div></pre></div></section><section id="koru/dom.reposition" tabindex="-1" name="reposition" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">reposition</span>(<span class="nv">pos</span><span class="o">=</span><span class="s">'below'</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Align element with an origin</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>pos</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>options</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">popup</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">class</span>: <span class="s">'popup'</span>, <span class="na">$style</span>: <span class="s">'position:absolute;width:200px;height:10px'</span>});
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">popup</span>);

<span class="cs">// default align is left</span>
<span class="nx">Dom</span>.<span class="na">reposition</span>(<span class="s">'above'</span>, {<span class="na">popup</span>, <span class="na">boundingClientRect</span>: {<span class="na">left</span>: <span class="m">50</span>, <span class="na">top</span>: <span class="m">100</span>, <span class="na">right</span>: <span class="m">90</span>}});

<span class="kd">const</span> <span class="no">rect</span> <span class="o">=</span> <span class="nx">popup</span>.<span class="na">getBoundingClientRect</span>();

<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">util</span>.<span class="na">extractKeys</span>(<span class="nx">rect</span>, [<span class="s">'left'</span>, <span class="s">'top'</span>]), {<span class="na">left</span>: <span class="m">50</span>, <span class="na">top</span>: <span class="m">90</span>});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">popup</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">class</span>: <span class="s">'popup'</span>,
  <span class="na">style</span>: <span class="s">'position:absolute;width:80px;height:10px'</span>});
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">popup</span>);

<span class="cs">// set align justify</span>
<span class="nx">Dom</span>.<span class="na">reposition</span>(<span class="s">'above'</span>, {
  <span class="na">align</span>: <span class="s">'justify'</span>,
  <span class="na">popup</span>, <span class="na">boundingClientRect</span>: {<span class="na">left</span>: <span class="m">50</span>, <span class="na">top</span>: <span class="m">100</span>, <span class="na">right</span>: <span class="m">120</span>},
});

<span class="kd">const</span> <span class="no">rect</span> <span class="o">=</span> <span class="nx">popup</span>.<span class="na">getBoundingClientRect</span>();

<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">util</span>.<span class="na">extractKeys</span>(<span class="nx">rect</span>, [<span class="s">'right'</span>, <span class="s">'top'</span>, <span class="s">'left'</span>]), {<span class="na">right</span>: <span class="m">130</span>, <span class="na">top</span>: <span class="m">90</span>, <span class="na">left</span>: <span class="m">50</span>});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">popup</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">class</span>: <span class="s">'popup'</span>,
  <span class="na">style</span>: <span class="s">'position:absolute;width:80px;height:10px'</span>});
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">popup</span>);

<span class="cs">// set align right</span>
<span class="nx">Dom</span>.<span class="na">reposition</span>(<span class="s">'above'</span>, {
  <span class="na">align</span>: <span class="s">'right'</span>,
  <span class="na">popup</span>, <span class="na">boundingClientRect</span>: {<span class="na">left</span>: <span class="m">50</span>, <span class="na">top</span>: <span class="m">100</span>, <span class="na">right</span>: <span class="m">120</span>},
});

<span class="kd">const</span> <span class="no">rect</span> <span class="o">=</span> <span class="nx">popup</span>.<span class="na">getBoundingClientRect</span>();

<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">util</span>.<span class="na">extractKeys</span>(<span class="nx">rect</span>, [<span class="s">'right'</span>, <span class="s">'top'</span>]), {<span class="na">right</span>: <span class="m">120</span>, <span class="na">top</span>: <span class="m">90</span>});</div></div></pre></div></section><section id="koru/dom.setCtx" tabindex="-1" name="setCtx" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Dom.<span class="highlight"><span class="nf">setCtx</span>(<span class="nv">elm</span>, <span class="nv">ctx</span><span class="o">=</span><span class="k">new</span> <span class="nx">Ctx</span>(<span class="kc">null</span>, <span class="nx">Dom</span>.<span class="na">ctx</span>(<span class="nx">elm</span>)))</span></h1><abstract><div><p>Attach a <a class="jsdoc-link" href="#koru/dom/ctx">Ctx</a> to an <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the element to attache the <code>ctx</code> to.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[ctx]</td><td><a href="#koru/dom/ctx">Ctx</a></td><td class="jsdoc-info"><div><p>the context to attach. By default will create a new <code>ctx</code> with no template and a
parent ctx of the element.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/dom/ctx">Ctx</a></td><td class="jsdoc-info"><div><p>the ctx attached</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Dom</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">elm1</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});
<span class="kd">const</span> <span class="no">ctx1</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">setCtx</span>(<span class="nx">elm1</span>);

<span class="kd">const</span> <span class="no">elm3</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});

<span class="kd">const</span> <span class="no">elm2</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: <span class="nx">elm3</span>});
<span class="kd">const</span> <span class="no">ctx2</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">setCtx</span>(<span class="nx">elm2</span>, <span class="k">new</span> <span class="nx">Ctx</span>(<span class="kc">null</span>, <span class="nx">ctx1</span>));

<span class="kd">const</span> <span class="no">ctx3</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">setCtx</span>(<span class="nx">elm3</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ctx1</span>.<span class="na">firstElement</span>, <span class="nx">elm1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ctx1</span>.<span class="na">template</span>, <span class="kc">null</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ctx2</span>.<span class="na">firstElement</span>, <span class="nx">elm2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ctx2</span>.<span class="na">parentCtx</span>, <span class="nx">ctx1</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ctx3</span>.<span class="na">parentCtx</span>, <span class="nx">ctx2</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/dom/ctx" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/dom/ctx">koru/dom/ctx</a><h1 class="jsdoc-module-title searchable">Ctx</h1><abstract><div><p>Ctx (Context) is used to track
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">DOM&nbsp;elements</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#data</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="client"><div><p>The data associated with an element via this context</p>
</div></td></tr><tr><td class="searchable">#parentCtx</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="#koru/dom/ctx">Ctx</a></td><td class="jsdoc-info" data-env="client"><div><p>The associated parent Ctx</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/dom/ctx#addEventListener" tabindex="-1" name="#addEventListener" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Ctx#<span class="highlight"><span class="nf">addEventListener</span>(<span class="nv">elm</span>, <span class="nv">type</span>, <span class="nv">callback</span>, <span class="nv">opts</span>)</span></h1><abstract><div><p>This is like the <code>Node#addEventListener</code> except that it will call
<code>Node#removeEventListener</code> when the <code>ctx</code> is destroyed. Also handle the koru event type
<code>'menustart'</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>type</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[opts]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Ctx</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/ctx"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ctx</span>();
<span class="kd">const</span> <span class="no">button</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">button</span>: [], <span class="na">type</span>: <span class="s">'button'</span>});
<span class="nx">Dom</span>.<span class="na">setCtx</span>(<span class="nx">button</span>, <span class="nx">ctx</span>);
<span class="kd">const</span> <span class="no">callback</span> <span class="o">=</span> <span class="nx">stub</span>(), <span class="no">callback2</span> <span class="o">=</span> <span class="nx">stub</span>(), <span class="no">opts</span> <span class="o">=</span> {<span class="na">capture</span>: <span class="kc">true</span>};
<span class="nx">ctx</span>.<span class="na">addEventListener</span>(<span class="nx">button</span>, <span class="s">'menustart'</span>, <span class="nx">callback</span>, <span class="nx">opts</span>);
<span class="nx">ctx</span>.<span class="na">addEventListener</span>(<span class="nx">button</span>, <span class="s">'mouseover'</span>, <span class="nx">callback2</span>);

<span class="cs">// touch</span>
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'pointerdown'</span>, {<span class="na">pointerType</span>: <span class="s">'touch'</span>});
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">callback</span>);
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'click'</span>, {<span class="na">pointerType</span>: <span class="s">'touch'</span>});
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">callback</span>);

<span class="cs">// mouse</span>
<span class="nx">callback</span>.<span class="na">reset</span>();
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'pointerdown'</span>);
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">callback</span>);
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'click'</span>);
<span class="nx">assert</span>.<span class="na">calledTwice</span>(<span class="nx">callback</span>);

<span class="cs">// mouseover</span>
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'mouseover'</span>);
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">callback2</span>);

<span class="cs">// destroy</span>
<span class="nx">Dom</span>.<span class="na">destroyData</span>(<span class="nx">button</span>);
<span class="nx">callback</span>.<span class="na">reset</span>();
<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'pointerdown'</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">callback</span>);

<span class="nx">Dom</span>.<span class="na">triggerEvent</span>(<span class="nx">button</span>, <span class="s">'mouseover'</span>);
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">callback2</span>);</div></div></pre></div></section><section id="koru/dom/ctx#autoUpdate" tabindex="-1" name="#autoUpdate" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Ctx#<span class="highlight"><span class="nf">autoUpdate</span>(<span class="nv">observe</span>)</span></h1><abstract><div><p>Update template contents whenever the <code>ctx.data</code> contents changes or the <code>ctx.data</code> object
itself changes.</p>
<p><code>ctx.data</code> must have either an <code>observeId</code> method or an <code>onChange</code>
method in its class otherwise no observation will occur. <code>observeId</code> is used in
preference to <code>onChange</code>. <a class="jsdoc-link" href="#koru/model/base-model">BaseModel</a> is such a class.</p>
<p>The <code>observeId</code> or <code>onChange</code> handler will be stopped when the <code>ctx</code> is destroyed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[observe]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a optional function that will be called for each update of the subject.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Ctx</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/ctx"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">compileTemplate</span>(<span class="s">`&lt;div&gt;{{name}}{{_id}}&lt;/div&gt;`</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">stop</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="k">class</span> <span class="nc">Custom</span> {
  <span class="kt">static</span> <span class="nf">onChange</span>(<span class="nv">onChange</span>) {
    <span class="k">this</span>.<span class="na">_onChange</span> <span class="o">=</span> <span class="nx">onChange</span>;
    <span class="k">return</span> {<span class="na">stop</span>};
  }
}

<span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Custom</span>();
<span class="nx">doc</span>.<span class="na">name</span> <span class="o">=</span> <span class="s">'old name'</span>;
<span class="kd">const</span> <span class="no">foo</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">tpl</span>.<span class="na">Foo</span>.<span class="na">$render</span>(<span class="nx">doc</span>);
<span class="kd">const</span> <span class="no">ctx</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">myCtx</span>(<span class="nx">foo</span>);

<span class="kd">const</span> <span class="no">observer</span> <span class="o">=</span> <span class="nx">stub</span>();

<span class="nx">ctx</span>.<span class="na">autoUpdate</span>(<span class="nx">observer</span>);
<span class="nx">doc</span>.<span class="na">name</span> <span class="o">=</span> <span class="s">'new name'</span>;
<span class="kd">const</span> <span class="no">docChange</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">doc</span>, {<span class="na">name</span>: <span class="s">'old name'</span>});
<span class="nx">Custom</span>.<span class="na">_onChange</span>(<span class="nx">docChange</span>); <span class="cs">// change</span>

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>.<span class="na">textContent</span>, <span class="s">'new name'</span>);

<span class="nx">assert</span>.<span class="na">calledOnceWith</span>(<span class="nx">observer</span>, <span class="nx">docChange</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">observer</span>.<span class="na">firstCall</span>.<span class="na">thisValue</span>, <span class="nx">ctx</span>);</div></div></pre></div></section><section id="koru/dom/ctx#stopAutoUpdate" tabindex="-1" name="#stopAutoUpdate" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Ctx#<span class="highlight"><span class="nf">stopAutoUpdate</span>()</span></h1><abstract><div><p>Stop an <a class="jsdoc-link" href="#koru/dom/ctx#autoUpdate">autoUpdate</a>. Note that the autoUpdate will automatically stop when the <code>ctx</code> is destroyed.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Ctx</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/ctx"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">Tpl</span> <span class="o">=</span> <span class="nx">compileTemplate</span>(<span class="s">`&lt;div&gt;{{name}}&lt;/div&gt;`</span>);

<span class="kd">const</span> <span class="no">elm</span> <span class="o">=</span> <span class="nx">Tpl</span>.<span class="na">$render</span>(<span class="k">new</span> <span class="nx">Foo</span>(<span class="s">'name1'</span>));
<span class="kd">const</span> <span class="no">ctx</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">myCtx</span>(<span class="nx">elm</span>);

<span class="nx">ctx</span>.<span class="na">autoUpdate</span>();
<span class="nx">ctx</span>.<span class="na">stopAutoUpdate</span>();

<span class="nx">ctx</span>.<span class="na">data</span>.<span class="na">name</span> <span class="o">=</span> <span class="s">'name2'</span>;
<span class="nx">Foo</span>.<span class="na">notify</span>(<span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">ctx</span>.<span class="na">data</span>, {<span class="na">name</span>: <span class="s">'name1'</span>}));
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">elm</span>.<span class="na">textContent</span>, <span class="s">'name1'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/dom/html" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/dom/html">koru/dom/html</a><h1 class="jsdoc-module-title searchable">Html</h1><abstract><div><p>Utilities for building and converting <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Nodes</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/dom/html.escapeHTML" tabindex="-1" name="escapeHTML" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Html.<span class="highlight"><span class="nf">escapeHTML</span>(<span class="nv">text</span>)</span></h1><abstract><div><p>Escape special html characters</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>text</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Html</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/html"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Html</span>.<span class="na">escapeHTML</span>(<span class="s">'&lt;Testing&gt;&amp;nbsp;'</span>), <span class="s">'&amp;lt;Testing&amp;gt;&amp;amp;nbsp;'</span>);</div></div></pre></div></section><section id="koru/dom/html.html" tabindex="-1" name="html" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Html.<span class="highlight"><span class="nf">html</span>(<span class="nv">body</span>, <span class="nv">xmlns</span>)</span></h1><abstract><div><p>Convert an <code>object</code> into a html node.</p>
<p>The tagName is determined by either its content not being a string or the other keys are
<code>id</code>, <code>class</code>, <code>style</code>, <code>xmlns</code> or start with a <code>$</code> (the $ is stripped).</p>
<p>Array is used when multiple children. Comments have a key of <code>$comment$</code>. The tagName will
default to "div" if none is given.
When a tag is svg, itself and its children will be in the svg namespace (Client only).</p>
<section class="jsdoc-alias"><h1>Aliases</h1><div><code class="jsdoc-alias-term">h</code></div></section></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>body</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object to convert to a Dom node</p>
</div></td></tr><tr class="jsdoc-arg"><td>[xmlns]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>use xmlns instead of html</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>A Dom node</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Html</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/html"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">body</span> <span class="o">=</span> {<span class="na">class</span>: <span class="s">'greeting'</span>, <span class="na">id</span>: <span class="s">'gId'</span>, <span class="na">section</span>: {
  <span class="na">ul</span>: [{<span class="na">li</span>: {<span class="na">span</span>: <span class="s">'Hello'</span>}}, {<span class="na">$comment$</span>: <span class="s">'a comment'</span>}, {<span class="na">li</span>: <span class="s">'two'</span>},
       {<span class="na">li</span>: {<span class="na">width</span>: <span class="m">500</span>, <span class="na">svg</span>: [], <span class="na">viewBox</span>: <span class="s">'0 0 100 100'</span>}}],
}, <span class="s">'data-lang'</span>: <span class="s">'en'</span>};

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">deepCopy</span>(<span class="nx">body</span>);
<span class="nx">ans</span>.<span class="na">section</span>.<span class="na">ul</span>[<span class="m">3</span>].<span class="na">li</span>.<span class="na">width</span> <span class="o">=</span> <span class="s">'500'</span>; <span class="cs">// gets converted back to string</span>

<span class="kd">const</span> <span class="no">section</span> <span class="o">=</span> <span class="nx">Html</span>.<span class="na">html</span>(<span class="nx">body</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Html</span>.<span class="na">htmlToJson</span>(<span class="nx">section</span>), <span class="nx">ans</span>);

<span class="kd">const</span> <span class="no">path</span> <span class="o">=</span> <span class="nx">Html</span>.<span class="na">html</span>({<span class="na">path</span>: [], <span class="na">d</span>: <span class="s">'M0,0 10,10Z'</span>}, <span class="nx">Html</span>.<span class="na">SVGNS</span>);
<span class="nx">assert</span>(<span class="nx">path</span> <span class="o">instanceof</span> (<span class="nx">isClient</span> <span class="o">?</span> <span class="nx">window</span>.<span class="na">SVGPathElement</span> <span class="o">:</span> <span class="nx">global</span>.<span class="na">Element</span>));

<span class="kd">const</span> <span class="no">br</span> <span class="o">=</span> <span class="nx">Html</span>.<span class="na">h</span>({<span class="na">br</span>: <span class="s">''</span>});
<span class="nx">assert</span>.<span class="na">isNull</span>(<span class="nx">br</span>.<span class="na">firstChild</span>);</div></div></pre></div></section><section id="koru/dom/html.htmlToJson" tabindex="-1" name="htmlToJson" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Html.<span class="highlight"><span class="nf">htmlToJson</span>(<span class="nv">node</span>, <span class="nv">ns</span><span class="o">=</span><span class="nx">XHTMLNS</span>)</span></h1><abstract><div><p>Convert an <code>Element</code> to a plain <code>object</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>node</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[ns]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Html</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/html"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> {<span class="na">class</span>: <span class="s">'greeting'</span>, <span class="na">id</span>: <span class="s">'gId'</span>, <span class="na">section</span>: {
  <span class="na">ul</span>: [{<span class="na">li</span>: {<span class="na">span</span>: <span class="s">'Hello'</span>}}, {<span class="na">li</span>: <span class="s">'two'</span>}],
}, <span class="s">'data-lang'</span>: <span class="s">'en'</span>};

<span class="nx">api</span>.<span class="na">method</span>(<span class="s">'htmlToJson'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Html</span>.<span class="na">htmlToJson</span>(<span class="nx">Html</span>.<span class="na">h</span>(<span class="nx">obj</span>)), <span class="nx">obj</span>);

<span class="kd">const</span> <span class="no">assertConvert</span> <span class="o">=</span> (<span class="nv">json</span>) <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">elide</span>(() <span class="o">=&gt;</span> {<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Html</span>.<span class="na">htmlToJson</span>(<span class="nx">Html</span>.<span class="na">h</span>(<span class="nx">json</span>)), <span class="nx">json</span>)});
};

<span class="nx">assertConvert</span>({<span class="na">div</span>: <span class="s">'simple'</span>});
<span class="nx">assertConvert</span>({});
<span class="nx">assertConvert</span>({<span class="na">id</span>: <span class="s">'Spinner'</span>, <span class="na">class</span>: <span class="s">'spinner dark'</span>});
<span class="nx">assertConvert</span>({<span class="na">ol</span>: [
  {<span class="na">li</span>: <span class="s">'one'</span>}, {<span class="na">style</span>: <span class="s">'width:10px'</span>, <span class="na">name</span>: <span class="s">'li2'</span>, <span class="na">li</span>: [<span class="s">'two'</span>], <span class="na">myattr</span>: <span class="s">'attr3'</span>}]});
<span class="nx">assertConvert</span>([<span class="s">'one'</span>, <span class="s">'two'</span>, <span class="s">'three'</span>]);
<span class="nx">assertConvert</span>({<span class="na">input</span>: [], <span class="na">name</span>: <span class="s">'email'</span>});
<span class="nx">assertConvert</span>({<span class="na">input</span>: <span class="s">''</span>});
<span class="nx">assertConvert</span>({<span class="na">div</span>: [<span class="s">''</span>]});
<span class="nx">assertConvert</span>({<span class="na">style</span>: <span class="s">'width:123px'</span>});
<span class="nx">assertConvert</span>({<span class="na">style</span>: [<span class="s">'.foo {width:123px}'</span>]});</div></div></pre></div></section><section id="koru/dom/html.svgUse" tabindex="-1" name="svgUse" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Html.<span class="highlight"><span class="nf">svgUse</span>(<span class="nv">href</span>, <span class="nv">attrs</span>)</span></h1><abstract><div><p>create an svg use link to a ref</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>href</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[attrs]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Html</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/html"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">circle</span> <span class="o">=</span> <span class="nx">Html</span>.<span class="na">svgUse</span>(<span class="s">'#icon-circle'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">circle</span>.<span class="na">getAttributeNS</span>(<span class="nx">Html</span>.<span class="na">XLINKNS</span>, <span class="s">'href'</span>), <span class="s">'#icon-circle'</span>);

<span class="kd">const</span> <span class="no">menu</span> <span class="o">=</span> <span class="nx">Html</span>.<span class="na">svgUse</span>(<span class="s">'#icon-hamburger-menu'</span>, {<span class="na">x</span>: <span class="m">3</span>, <span class="na">y</span>: <span class="m">2</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">menu</span>.<span class="na">namespaceURI</span>, <span class="nx">Html</span>.<span class="na">SVGNS</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">menu</span>.<span class="na">getAttributeNS</span>(<span class="nx">Html</span>.<span class="na">XLINKNS</span>, <span class="s">'href'</span>), <span class="s">'#icon-hamburger-menu'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">menu</span>.<span class="na">getAttribute</span>(<span class="s">'x'</span>), <span class="s">'3'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">menu</span>.<span class="na">getAttribute</span>(<span class="s">'y'</span>), <span class="s">'2'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/dom/template" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/dom/template">koru/dom/template</a><h1 class="jsdoc-module-title searchable">Template</h1><abstract><div><p>Template is used to create interactive <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Dom&nbsp;Trees</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/dom/template.addTemplates" tabindex="-1" name="addTemplates" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Template.<span class="highlight"><span class="nf">addTemplates</span>(<span class="nv">parent</span>, <span class="nv">blueprint</span>)</span></h1><abstract><div><p>Add nested templates to parent. This is automatically called but is exposed so that it can
be overwritten in a sub class.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>parent</td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>blueprint</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Template</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/template"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">Tpl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Template</span>(<span class="s">'MyTemplate'</span>);
<span class="nx">Template</span>.<span class="na">addTemplates</span>(<span class="nx">Tpl</span>, {
  <span class="na">name</span>: <span class="s">'Sub1'</span>, <span class="na">nodes</span>: [<span class="s">'sub 1'</span>],
  <span class="na">nested</span>: [{<span class="na">name</span>: <span class="s">'Sub'</span>, <span class="na">nodes</span>: [<span class="s">'sub 1 sub'</span>]}]});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Tpl</span>.<span class="na">Sub1</span>.<span class="na">Sub</span>.<span class="na">$render</span>({}).<span class="na">textContent</span>, <span class="s">'sub 1 sub'</span>);</div></div></pre></div></section><section id="koru/dom/template.newTemplate" tabindex="-1" name="newTemplate" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Template.<span class="highlight"><span class="nf">newTemplate</span>(<span class="nv">module</span>, <span class="nv">blueprint</span>, <span class="nv">parent</span><span class="o">=</span><span class="k">this</span>.<span class="na">root</span>)</span></h1><abstract><div><p>Create a new <code>Template</code> from an html blueprint.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[module]</td><td><a href="#Module">Module</a></td><td class="jsdoc-info"><div><p>if supplied the template will be deleted if
<code>module</code> is unloaded</p>
</div></td></tr><tr class="jsdoc-arg"><td>blueprint</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>A blue print is usually built by
<a class="jsdoc-link" href="#koru/dom/template-compiler">template-compiler</a> which is called automatically
on html files loaded using
<code>require('koru/html!path/to/my-template.html')</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>[parent]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Template</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/template"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Template</span>.<span class="na">newTemplate</span>(<span class="ge nx">{Module:myMod}</span>, <span class="ge nx">{name: "Foo", nodes: [{name: 'div'}]}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Template(Foo)</span></span></div></pre></div></section><section id="koru/dom/template#$render" tabindex="-1" name="#$render" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Template#<span class="highlight"><span class="nf">$render</span>(<span class="nv">data</span>, <span class="nv">parentCtx</span>)</span></h1><abstract><div><p>Render a template without events</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>data</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[parentCtx]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Node</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Template</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/dom/template"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Template</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">template</span>.<span class="na">$render</span>(<span class="ge nx">{}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Node`&lt;div&gt;&lt;/div&gt;`</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">template</span>.<span class="na">$render</span>(<span class="ge nx">{}</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">template</span>.<span class="na">$render</span>(<span class="ge nx">{}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Node`&lt;div&gt;&lt;/div&gt;`</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">template</span>.<span class="na">$render</span>(<span class="ge nx">{}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">template</span>.<span class="na">$render</span>(<span class="ge nx">{id: "foo", user: {_id: '123'}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Node`&lt;div id="foo" class="the classes" data-id="123" draggable="true"&gt;&lt;/div&gt;`</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">template</span>.<span class="na">$render</span>(<span class="ge nx">{user: {initial: 'fb', name: 'Foo', nameFunc(){}}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">template</span>.<span class="na">$render</span>(<span class="ge nx">{name: "foo"}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Node`&lt;div&gt;foo&lt;p&gt;foo&lt;/p&gt;&lt;/div&gt;`</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">template</span>.<span class="na">$render</span>(<span class="ge nx">{user: {initials: 'fb'}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Node`&lt;div&gt;fb&lt;/div&gt;`</span></span></div></pre></div></section></div></div></div></section><section id="koru/enumerable" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/enumerable">koru/enumerable</a><h1 class="jsdoc-module-title searchable">Enumerable</h1><abstract><div><p>Enumerable wraps iterables with Array like methods.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/enumerable.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">iter</span>)</span></h1><abstract><div><p>Create new Enumerable instance</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>iter</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">iter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Enumerable</span>({*[<span class="nx">Symbol</span>.<span class="na">iterator</span>]() {<span class="k">yield</span> <span class="m">1</span>; <span class="k">yield</span> <span class="m">3</span>}});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">iter</span>.<span class="na">count</span>(), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">iter</span>), [<span class="m">1</span>, <span class="m">3</span>]);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">iter</span>.<span class="na">count</span>(), <span class="m">2</span>);

<span class="kd">const</span> <span class="no">iter2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Enumerable</span>(<span class="kd">function</span> *() {<span class="k">yield</span> <span class="m">1</span>; <span class="k">yield</span> <span class="m">3</span>; <span class="k">yield</span> <span class="m">5</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">iter2</span>.<span class="na">filter</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">!=</span> <span class="m">3</span>).<span class="na">count</span>(), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">iter2</span>), [<span class="m">1</span>, <span class="m">3</span>, <span class="m">5</span>]);</div></div></pre></div></section><section id="koru/enumerable.count" tabindex="-1" name="count" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable.<span class="highlight"><span class="nf">count</span>(<span class="nv">to</span>, <span class="nv">from</span><span class="o">=</span><span class="m">1</span>, <span class="nv">step</span><span class="o">=</span><span class="m">1</span>)</span></h1><abstract><div><p>Create an iterator that counts</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>to</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[from]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[step]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/enumerable">Enumerable</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">Enumerable</span>.<span class="na">count</span>(<span class="m">3</span>)), [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">Enumerable</span>.<span class="na">count</span>(<span class="m">20</span>, <span class="m">13</span>, <span class="m">3</span>)), [<span class="m">13</span>, <span class="m">16</span>, <span class="m">19</span>]);</div></div></pre></div></section><section id="koru/enumerable.mapObjectIter" tabindex="-1" name="mapObjectIter" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable.<span class="highlight"><span class="nf">*mapObjectIter</span>(<span class="nv">object</span>, <span class="nv">mapper</span>)</span></h1><abstract><div><p>return an iterator over an object while mapping (and filtering). If the <code>mapper</code> returns
<code>undefined</code> then the value is filtered out of the iterator results</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>mapper</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> {<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">2</span>, <span class="na">c</span>: <span class="m">3</span>, <span class="na">d</span>: <span class="m">4</span>};
<span class="kd">const</span> <span class="no">names</span> <span class="o">=</span> [], <span class="no">values</span> <span class="o">=</span> [];
<span class="k">for</span> (<span class="kd">const</span> [<span class="no">n</span>, <span class="no">v</span>] <span class="k">of</span> <span class="nx">Enumerable</span>.<span class="na">mapObjectIter</span>(<span class="nx">obj</span>, (<span class="nv">n</span>, <span class="nv">v</span>, <span class="nv">i</span>) <span class="o">=&gt;</span> (<span class="nx">i</span> <span class="o">==</span> <span class="m">2</span>) <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="m">2</span> <span class="o">*</span> <span class="nx">v</span>)) {
  <span class="nx">names</span>.<span class="na">push</span>(<span class="nx">n</span>);
  <span class="nx">values</span>.<span class="na">push</span>(<span class="nx">v</span>);
}
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">names</span>, [<span class="s">'a'</span>, <span class="s">'b'</span>, <span class="s">'d'</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">values</span>, [<span class="m">2</span>, <span class="m">4</span>, <span class="m">8</span>]);</div></div></pre></div></section><section id="koru/enumerable.mapObjectToArray" tabindex="-1" name="mapObjectToArray" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable.<span class="highlight"><span class="nf">mapObjectToArray</span>(<span class="nv">object</span>, <span class="nv">mapper</span>)</span></h1><abstract><div><p>Map (and filter) an object to array. If the <code>mapper</code> returns <code>undefined</code> then the
value is filtered out of the results</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>mapper</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> {<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">2</span>, <span class="na">c</span>: <span class="m">3</span>, <span class="na">d</span>: <span class="m">4</span>};
<span class="kd">const</span> <span class="no">mapped</span> <span class="o">=</span> <span class="nx">Enumerable</span>.<span class="na">mapObjectToArray</span>(<span class="nx">obj</span>, (<span class="nv">n</span>, <span class="nv">v</span>, <span class="nv">i</span>) <span class="o">=&gt;</span> (<span class="nx">i</span> <span class="o">==</span> <span class="m">2</span>) <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="m">2</span> <span class="o">*</span> <span class="nx">v</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">mapped</span>.<span class="na">length</span>, <span class="m">3</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">mapped</span>, [<span class="m">2</span>, <span class="m">4</span>, <span class="m">8</span>]);</div></div></pre></div></section><section id="koru/enumerable.mapToArray" tabindex="-1" name="mapToArray" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable.<span class="highlight"><span class="nf">mapToArray</span>(<span class="nv">iter</span>, <span class="nv">mapper</span>)</span></h1><abstract><div><p>Map (and filter) an iterator to another value. If the <code>mapper</code> returns <code>undefined</code> then the
value is filtered out of the results</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>iter</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>mapper</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">mapped</span> <span class="o">=</span> <span class="nx">Enumerable</span>.<span class="na">mapToArray</span>({*[<span class="nx">Symbol</span>.<span class="na">iterator</span>]() {<span class="k">yield</span> <span class="m">1</span>; <span class="k">yield</span> <span class="m">5</span>; <span class="k">yield</span> <span class="m">3</span>}}, (<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">==</span> <span class="m">5</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="m">2</span> <span class="o">*</span> <span class="nx">i</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">mapped</span>.<span class="na">length</span>, <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">mapped</span>, [<span class="m">2</span>, <span class="m">6</span>]);</div></div></pre></div></section><section id="koru/enumerable.propertyValues" tabindex="-1" name="propertyValues" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable.<span class="highlight"><span class="nf">propertyValues</span>(<span class="nv">object</span>)</span></h1><abstract><div><p>Create an iterator over an object's property values</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/enumerable">Enumerable</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">Enumerable</span>.<span class="na">propertyValues</span>({<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">2</span>})), [<span class="m">1</span>, <span class="m">2</span>]);</div></div></pre></div></section><section id="koru/enumerable.reverseValues" tabindex="-1" name="reverseValues" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable.<span class="highlight"><span class="nf">*reverseValues</span>(<span class="nv">object</span>)</span></h1><abstract><div><p>Return an iterator for the reverse values of an array like structure</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">Enumerable</span>.<span class="na">reverseValues</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>])), [<span class="m">3</span>, <span class="m">2</span>, <span class="m">1</span>]);</div></div></pre></div></section><section id="koru/enumerable#every" tabindex="-1" name="#every" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable#<span class="highlight"><span class="nf">every</span>(<span class="nv">test</span>)</span></h1><abstract><div><p>Return <code>true</code> if and only if the <code>test</code> returns a <code>truthy</code> value for every iteration.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>test</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a function called for each iteration with the argument: <code>currentValue</code> - the
current value of the iterator. Should return <code>true</code> or <code>false</code>.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">iter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Enumerable</span>({*[<span class="nx">Symbol</span>.<span class="na">iterator</span>]() {<span class="k">yield</span> <span class="m">1</span>; <span class="k">yield</span> <span class="m">5</span>; <span class="k">yield</span> <span class="m">3</span>}});
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">iter</span>.<span class="na">every</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">iter</span>.<span class="na">every</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">!=</span> <span class="m">5</span>));</div></div></pre></div></section><section id="koru/enumerable#filter" tabindex="-1" name="#filter" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable#<span class="highlight"><span class="nf">filter</span>(<span class="nv">test</span>)</span></h1><abstract><div><p>Filter an iterator.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>test</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a function called for each iteration with the argument: <code>currentValue</code> - the
current value of the iterator. Return <code>true</code> to keep the element, otherwise <code>false</code>.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/enumerable">Enumerable</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">iter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Enumerable</span>({*[<span class="nx">Symbol</span>.<span class="na">iterator</span>]() {<span class="k">yield</span> <span class="m">1</span>; <span class="k">yield</span> <span class="m">5</span>; <span class="k">yield</span> <span class="m">3</span>}});
<span class="kd">const</span> <span class="no">mapped</span> <span class="o">=</span> <span class="nx">iter</span>.<span class="na">filter</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">!=</span> <span class="m">5</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">mapped</span>.<span class="na">count</span>(), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">mapped</span>), [<span class="m">1</span>, <span class="m">3</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iter</span>.<span class="na">filter</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="kc">false</span>)[<span class="nx">Symbol</span>.<span class="na">iterator</span>]().<span class="na">next</span>(), {<span class="na">done</span>: <span class="kc">true</span>, <span class="na">value</span>: <span class="o">void</span> <span class="m">0</span>});</div></div></pre></div></section><section id="koru/enumerable#find" tabindex="-1" name="#find" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable#<span class="highlight"><span class="nf">find</span>(<span class="nv">test</span>)</span></h1><abstract><div><p>Return first iterated element that <code>test</code> returns a <code>truthy</code> value for.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>test</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a function called for each iteration with the argument: <code>currentValue</code> - the
current value of the iterator. Should return <code>true</code> or <code>false</code>.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">iter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Enumerable</span>({*[<span class="nx">Symbol</span>.<span class="na">iterator</span>]() {<span class="k">yield</span> <span class="m">2</span>; <span class="k">yield</span> <span class="m">5</span>; <span class="k">yield</span> <span class="m">3</span>}});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iter</span>.<span class="na">find</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">1</span>), <span class="m">5</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">iter</span>.<span class="na">find</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">==</span> <span class="m">7</span>), <span class="o">void</span> <span class="m">0</span>);</div></div></pre></div></section><section id="koru/enumerable#map" tabindex="-1" name="#map" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable#<span class="highlight"><span class="nf">map</span>(<span class="nv">mapper</span>)</span></h1><abstract><div><p>Map (and filter) an iterator to another value. If the <code>mapper</code> returns <code>undefined</code> then the
value is filtered out of the results</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>mapper</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/enumerable">Enumerable</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">iter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Enumerable</span>({*[<span class="nx">Symbol</span>.<span class="na">iterator</span>]() {<span class="k">yield</span> <span class="m">1</span>; <span class="k">yield</span> <span class="m">5</span>; <span class="k">yield</span> <span class="m">3</span>}});
<span class="kd">const</span> <span class="no">mapped</span> <span class="o">=</span> <span class="nx">iter</span>.<span class="na">map</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">==</span> <span class="m">5</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="m">2</span> <span class="o">*</span> <span class="nx">i</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">mapped</span>.<span class="na">count</span>(), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">mapped</span>), [<span class="m">2</span>, <span class="m">6</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iter</span>.<span class="na">map</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="m">2</span> <span class="o">*</span> <span class="nx">i</span>)[<span class="nx">Symbol</span>.<span class="na">iterator</span>]().<span class="na">next</span>(), {<span class="na">done</span>: <span class="kc">false</span>, <span class="na">value</span>: <span class="m">2</span>});</div></div></pre></div></section><section id="koru/enumerable#reduce" tabindex="-1" name="#reduce" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable#<span class="highlight"><span class="nf">reduce</span>(<span class="nv">reducer</span>, <span class="nv">seed</span>)</span></h1><abstract><div><p>Run <code>reducer</code> on each member returning a single value</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>reducer</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[seed]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">iter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Enumerable</span>({*[<span class="nx">Symbol</span>.<span class="na">iterator</span>]() {<span class="k">yield</span> <span class="m">1</span>; <span class="k">yield</span> <span class="m">3</span>}});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">iter</span>.<span class="na">reduce</span>((<span class="nv">sum</span>, <span class="nv">value</span>) <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">value</span>, <span class="m">5</span>), <span class="m">9</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">iter</span>.<span class="na">reduce</span>((<span class="nv">sum</span>, <span class="nv">value</span>) <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">-</span> <span class="nx">value</span>), <span class="o">-</span><span class="m">2</span>);</div></div></pre></div></section><section id="koru/enumerable#some" tabindex="-1" name="#some" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Enumerable#<span class="highlight"><span class="nf">some</span>(<span class="nv">test</span>)</span></h1><abstract><div><p>Return <code>true</code> if <code>test</code> returns a <code>truthy</code> value for at least one iteration.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>test</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a function called for each iteration with the argument: <code>currentValue</code> - the
current value of the iterator. Should return <code>true</code> or <code>false</code>.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Enumerable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/enumerable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">iter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Enumerable</span>({*[<span class="nx">Symbol</span>.<span class="na">iterator</span>]() {<span class="k">yield</span> <span class="m">1</span>; <span class="k">yield</span> <span class="m">5</span>; <span class="k">yield</span> <span class="m">3</span>}});
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">iter</span>.<span class="na">some</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">==</span> <span class="m">5</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">iter</span>.<span class="na">some</span>((<span class="nv">i</span>) <span class="o">=&gt;</span> <span class="kc">false</span>));</div></div></pre></div></section></div></div></div></section><section id="koru/format" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/format">koru/format</a><h1 class="jsdoc-module-title searchable">format</h1><abstract><div><p>Text formatter with language translation</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/format.format" tabindex="-1" name="format" data-env="both" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">format</span>(<span class="nv">fmt</span>, ...<span class="nv">args</span>)</span></h1><abstract><div><p>Format a string with parameters</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>fmt</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[args]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">format</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/format"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"no args"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"no args"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{i0}, {i1} {i2}"</span>, <span class="s">"foo"</span>, <span class="ge nx">{a: [3, 4, function bar(){}]}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"'foo', {a: [3, 4, function bar(){}]} undefined"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"abc {1} de\nf {0}"</span>, <span class="s">"00"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"abc  de\nf 00"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"abc {1} de\nf {0}"</span>, <span class="s">"00"</span>, <span class="m">11</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"abc 11 de\nf 00"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{1}edge{} args{2}"</span>, <span class="s">"ww"</span>, <span class="s">"xx"</span>, <span class="s">"yy"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"xxedge{ argsyy"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"abc{e0}"</span>, <span class="s">"&lt;'he llo\"`&amp;&gt;"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"abc&amp;lt;&amp;#x27;he llo&amp;quot;&amp;#x60;&amp;amp;&amp;gt;"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="ge nx">['abc ', 's1', ' def ', 's0']</span>, <span class="s">"00"</span>, <span class="m">11</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"abc 11 def 00"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{1}abc{e$foo.bar.baz}"</span>, <span class="m">1</span>, <span class="m">2</span>, <span class="ge nx">{foo: {bar: {baz: '&lt;fnord&gt;'}}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"2abc&amp;lt;fnord&amp;gt;"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{$foo}"</span>, <span class="m">1</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"bar"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{$foo}"</span>, <span class="ge nx">{foo: "fuz"}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"fuz"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{f0,.2}"</span>, <span class="m">39.99999999999999</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"40.00"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"hello {f0,.2}"</span>, <span class="m">-23.4544</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"hello -23.45"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{f0,.1}"</span>, <span class="m">0</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"0.0"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{f0,.2}"</span>, <span class="ge nx">undefined</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">""</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{f0,.2z}"</span>, <span class="m">1.3</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"1.3"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{f0,.2z}"</span>, <span class="m">-4</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"-4"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">format</span>(<span class="s">"{f0,.2z}"</span>, <span class="m">-4.55555</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"-4.56"</span></span></div></pre></div></section><section id="koru/format.compile" tabindex="-1" name="compile" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">format.<span class="highlight"><span class="nf">compile</span>(<span class="nv">fmt</span>)</span></h1><abstract><div><p>Compile a string of text for faster translating and formatting</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>fmt</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">format</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/format"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">compile</span>(<span class="s">"no args"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">['no args']</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">compile</span>(<span class="s">"abc {1} de\nf {0}"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">['abc ', 's1', ' de\nf ', 's0', '']</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">compile</span>(<span class="s">"{3}edge args{4}"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">['', 's3', 'edge args', 's4', '']</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">compile</span>(<span class="s">"abc {}1} de\nf {0}}"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">['abc {1} de\nf ', 's0', '}']</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">compile</span>(<span class="s">"abc{e1}"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">['abc', 'e1', '']</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">compile</span>(<span class="s">"abc{e$foo.bar.baz}"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">['abc', 'e$foo.bar.baz', '']</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">compile</span>(<span class="s">"abc{f1,.2}"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">['abc', 'f1', '.2', '']</span></span></div></pre></div></section><section id="koru/format.translate" tabindex="-1" name="translate" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">format.<span class="highlight"><span class="nf">translate</span>(<span class="nv">text</span>, <span class="nv">lang</span><span class="o">=</span><span class="s">'en'</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>text</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[lang]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">format</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/format"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">translate</span>(<span class="kc">null</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">null</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">translate</span>(<span class="s">"is_invalid"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"is not valid"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">translate</span>(<span class="s">"is_invalid"</span>, <span class="s">"no"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"er ikke gyldig"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">translate</span>(<span class="s">"cant_be_less_than:5"</span>, <span class="s">"de"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"darf nicht kleiner als 5 sein"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">translate</span>(<span class="ge nx">['cant_be_less_than', 20]</span>, <span class="s">"de"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"darf nicht kleiner als 20 sein"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">translate</span>(<span class="ge nx">['cant_be_less_than', 20]</span>, <span class="s">"zu"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"can't be less than 20"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">translate</span>(<span class="s">"no translation:123"</span>, <span class="s">"zu"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"no translation:123"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">format</span>.<span class="na">translate</span>(<span class="ge nx">['test_message', 'one', 'two', 'three']</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"testing one and two and three"</span></span></div></pre></div></section></div></div></div></section><section id="koru/fs-tools" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/fs-tools">koru/fs-tools</a><h1 class="jsdoc-module-title searchable">FsTools</h1><abstract><div><p>Convenience wrapper around some node <code>fs</code> functions</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/fs-tools.appendData" tabindex="-1" name="appendData" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">FsTools.<span class="highlight"><span class="nf">appendData</span>(<span class="nv">path</span>, <span class="nv">data</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>path</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>data</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">Promise(string)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">FsTools</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/fs-tools"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">fst</span>.<span class="na">appendData</span>(<span class="s">'/my/file.txt'</span>, <span class="s">'extra data'</span>);</div></div></pre></div></section><section id="koru/fs-tools.readlinkIfExists" tabindex="-1" name="readlinkIfExists" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">FsTools.<span class="highlight"><span class="nf">readlinkIfExists</span>(<span class="nv">path</span>, <span class="nv">options</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>path</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[options]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">Promise(string)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">FsTools</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/fs-tools"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">stub</span>(<span class="nx">fsp</span>, <span class="s">'readlink'</span>);
<span class="nx">fsp</span>.<span class="na">readlink</span>.<span class="na">withArgs</span>(<span class="s">'idontexist'</span>).<span class="na">invokes</span>(<span class="k">async</span> (<span class="nv">c</span>) <span class="o">=&gt;</span> {<span class="k">throw</span> {<span class="na">code</span>: <span class="s">'ENOENT'</span>}});
<span class="nx">fsp</span>.<span class="na">readlink</span>.<span class="na">withArgs</span>(<span class="s">'accessdenied'</span>).<span class="na">invokes</span>(<span class="k">async</span> (<span class="nv">c</span>) <span class="o">=&gt;</span> {<span class="k">throw</span> {<span class="na">code</span>: <span class="s">'EACCESS'</span>}});
<span class="nx">fsp</span>.<span class="na">readlink</span>.<span class="na">withArgs</span>(<span class="s">'iamasymlink'</span>).<span class="na">returns</span>(<span class="nx">Promise</span>.<span class="na">resolve</span>(<span class="s">'pointinghere'</span>));

<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="nx">fst</span>.<span class="na">readlinkIfExists</span>(<span class="s">'idontexist'</span>), <span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="nx">fst</span>.<span class="na">readlinkIfExists</span>(<span class="s">'iamasymlink'</span>), <span class="s">'pointinghere'</span>);
<span class="k">await</span> <span class="nx">assert</span>.<span class="na">exception</span>(() <span class="o">=&gt;</span> <span class="nx">fst</span>.<span class="na">readlinkIfExists</span>(<span class="s">'accessdenied'</span>), {<span class="na">code</span>: <span class="s">'EACCESS'</span>});</div></div></pre></div></section></div></div></div></section><section id="koru/future" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/future">koru/future</a><h1 class="jsdoc-module-title searchable">Future</h1><abstract><div><p>Future is a utility class for waiting and resolving promises.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">isResolved</td><td></td><td class="jsdoc-info" data-env="both"><div><p><code>true</code> when promise is resolved</p>
</div></td></tr><tr><td class="searchable">#promise</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">Promise(number)</a></td><td class="jsdoc-info" data-env="both"><div><p>The promise to await for</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/future.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>()</span></h1><abstract><div></div></abstract><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Future</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/future"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">future</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Future</span>();
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">future</span>.<span class="na">isResolved</span>);
<span class="nx">future</span>.<span class="na">resolve</span>(<span class="m">123</span>);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">future</span>.<span class="na">isResolved</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="nx">future</span>.<span class="na">promise</span>, <span class="m">123</span>);</div></div></pre></div></section><section id="koru/future#promiseAndReset" tabindex="-1" name="#promiseAndReset" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Future#<span class="highlight"><span class="nf">promiseAndReset</span>()</span></h1><abstract><div><p>After waiting for the promise; reinitialize so it can be waited for again;</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">Promise(number)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Future</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/future"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">future</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Future</span>();
<span class="nx">future</span>.<span class="na">reject</span>(<span class="k">new</span> <span class="nx">Error</span>(<span class="s">'reject'</span>));
<span class="k">await</span> <span class="nx">assert</span>.<span class="na">exception</span>(() <span class="o">=&gt;</span> <span class="nx">future</span>.<span class="na">promiseAndReset</span>(), {<span class="na">message</span>: <span class="s">'reject'</span>});
<span class="nx">future</span>.<span class="na">resolve</span>(<span class="m">456</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="nx">future</span>.<span class="na">promiseAndReset</span>(), <span class="m">456</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">future</span>.<span class="na">isResolved</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/geometry" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/geometry">koru/geometry</a><h1 class="jsdoc-module-title searchable">Geometry</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/geometry.bezierBox" tabindex="-1" name="bezierBox" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Geometry.<span class="highlight"><span class="nf">bezierBox</span>(<span class="nv">ps</span>, <span class="nv">curve</span>)</span></h1><abstract><div><p>Calculate the boundry box for a cubic bezier curve</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>ps</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>start point</p>
</div></td></tr><tr class="jsdoc-arg"><td>curve</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>of the form <code>[csx,csy, cex,cey, pex,pey]</code> where:</p>
<ul>
<li><code>csx,csy</code> is the control point for the start</li>
<li><code>cex,cey</code> is the control point for the end</li>
<li><code>pex,pey</code> is the end point</li>
</ul>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>boundryBox in format <code>{left, top, right, bottom}</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Geometry</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/geometry"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">sut</span>.<span class="na">bezierBox</span>([<span class="m">0</span>,<span class="m">0</span>], [<span class="m">0</span>,<span class="m">0</span>, <span class="m">20</span>,<span class="m">25</span>, <span class="m">20</span>,<span class="m">25</span>]),
              {<span class="na">left</span>: <span class="m">0</span>, <span class="na">top</span>: <span class="m">0</span>, <span class="na">right</span>: <span class="m">20</span>, <span class="na">bottom</span>: <span class="m">25</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">sut</span>.<span class="na">bezierBox</span>([<span class="m">0</span>,<span class="m">0</span>], [<span class="m">0</span>,<span class="m">0</span>, <span class="o">-</span><span class="m">20</span>,<span class="o">-</span><span class="m">25</span>, <span class="o">-</span><span class="m">20</span>,<span class="o">-</span><span class="m">25</span>]),
              {<span class="na">left</span>: <span class="o">-</span><span class="m">20</span>, <span class="na">top</span>: <span class="o">-</span><span class="m">25</span>, <span class="na">right</span>: <span class="m">0</span>, <span class="na">bottom</span>: <span class="m">0</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">sut</span>.<span class="na">bezierBox</span>([<span class="m">0</span>,<span class="m">0</span>], [<span class="m">0</span>,<span class="m">0</span>, <span class="o">-</span><span class="m">20</span>,<span class="o">-</span><span class="m">25</span>, <span class="o">-</span><span class="m">20</span>,<span class="o">-</span><span class="m">25</span>]),
              {<span class="na">left</span>: <span class="o">-</span><span class="m">20</span>, <span class="na">top</span>: <span class="o">-</span><span class="m">25</span>, <span class="na">right</span>: <span class="m">0</span>, <span class="na">bottom</span>: <span class="m">0</span>});

<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">sut</span>.<span class="na">bezierBox</span>([<span class="m">10000</span>,<span class="m">20000</span>], [<span class="o">-</span><span class="m">5000</span>,<span class="o">-</span><span class="m">10000</span>, <span class="m">57500</span>,<span class="m">70000</span>, <span class="m">40000</span>,<span class="m">30000</span>]),
            {<span class="na">left</span>: <span class="m">7653</span>, <span class="na">top</span>: <span class="m">13101</span>, <span class="na">right</span>: <span class="m">43120</span>, <span class="na">bottom</span>: <span class="m">41454</span>});</div></div></pre></div></section><section id="koru/geometry.closestT" tabindex="-1" name="closestT" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Geometry.<span class="highlight"><span class="nf">closestT</span>(<span class="nv">point</span>, <span class="nv">ps</span>, <span class="nv">curve</span>, <span class="nv">tol</span><span class="o">=</span><span class="m">0.00001</span>)</span></h1><abstract><div><p>Calculate t along a line or a bezier curve closes to point</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>point</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the point to project on to curve</p>
</div></td></tr><tr class="jsdoc-arg"><td>ps</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>start point</p>
</div></td></tr><tr class="jsdoc-arg"><td>curve</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>bezier curve (See <a class="jsdoc-link" href="#koru/geometry.bezierBox">bezierBox</a>) or end point for line</p>
</div></td></tr><tr class="jsdoc-arg"><td>[tol]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>t along the curve</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Geometry</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/geometry"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[300, 30]</span>, <span class="ge nx">[300, 30]</span>, <span class="ge nx">[100, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[100, 70]</span>, <span class="ge nx">[300, 30]</span>, <span class="ge nx">[100, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">1</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[-15, 50]</span>, <span class="ge nx">[300, 30]</span>, <span class="ge nx">[100, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">1</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[230, 150]</span>, <span class="ge nx">[300, 30]</span>, <span class="ge nx">[100, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0.4519230769230769</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[-1000, -3000]</span>, <span class="ge nx">[300, 30]</span>, <span class="ge nx">[100, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">1</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[2500, 43]</span>, <span class="ge nx">[300, 30]</span>, <span class="ge nx">[100, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[300, 130]</span>, <span class="ge nx">[300, 130]</span>, <span class="ge nx">[-400, -200, 1140, 500, 200, 100]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[200, 100]</span>, <span class="ge nx">[300, 130]</span>, <span class="ge nx">[-400, -200, 1140, 500, 200, 100]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">1</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[-15, 50]</span>, <span class="ge nx">[300, 130]</span>, <span class="ge nx">[-400, -200, 1140, 500, 200, 100]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0.1970015204601111</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[195, 100]</span>, <span class="ge nx">[300, 130]</span>, <span class="ge nx">[-400, -200, 1140, 500, 200, 100]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">1</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[600, 200]</span>, <span class="ge nx">[300, 130]</span>, <span class="ge nx">[-400, -200, 1140, 500, 200, 100]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0.7498621750479387</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[-1000, -3000]</span>, <span class="ge nx">[300, 130]</span>, <span class="ge nx">[-400, -200, 1140, 500, 200, 100]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0.20026090643926941</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[-14, 0]</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[10, 12.5]</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0.49999913899703097</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[20, 25]</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">1</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">closestT</span>(<span class="ge nx">[25978, 28790]</span>, <span class="ge nx">[10000, 20000]</span>, <span class="ge nx">[-5000, -10000, 57500, 70000, 40000, 30000]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="m">0.5005837534888542</span></span></div></pre></div></section><section id="koru/geometry.combineBox" tabindex="-1" name="combineBox" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Geometry.<span class="highlight"><span class="nf">combineBox</span>(<span class="nv">a</span>, <span class="nv">b</span>)</span></h1><abstract><div><p>Combine two boundry boxes</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>a</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the first boundry box which is modified to include the second</p>
</div></td></tr><tr class="jsdoc-arg"><td>b</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the second boundry box</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>a</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Geometry</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/geometry"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">combineBox</span>(<span class="ge nx">{left: 0, top: 0, right: 20, bottom: 25}</span>, <span class="ge nx">{left: -20, top: -25, right: 0, bottom: 0}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{left: -20, top: -25, right: 20, bottom: 25}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">combineBox</span>(<span class="ge nx">{left: -20, top: -25, right: 20, bottom: 25}</span>, <span class="ge nx">{left: -10, top: -15, right: 10, bottom: 15}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{left: -20, top: -25, right: 20, bottom: 25}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">combineBox</span>(<span class="ge nx">{left: -20, top: -25, right: 20, bottom: 25}</span>, <span class="ge nx">{left: -40, top: -55, right: 60, bottom: 95}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{left: -40, top: -55, right: 60, bottom: 95}</span></span></div></pre></div></section><section id="koru/geometry.combineBoxPoint" tabindex="-1" name="combineBoxPoint" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Geometry.<span class="highlight"><span class="nf">combineBoxPoint</span>(<span class="nv">box</span>, <span class="nv">x</span>, <span class="nv">y</span>)</span></h1><abstract><div><p>Combine a point into a boundy box</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>box</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the boundry box which is modified to include the point</p>
</div></td></tr><tr class="jsdoc-arg"><td>x</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the x coordinate of the point</p>
</div></td></tr><tr class="jsdoc-arg"><td>y</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the y coordinate of the point</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>box</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Geometry</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/geometry"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">combineBoxPoint</span>(<span class="ge nx">{left: 0, top: 0, right: 20, bottom: 25}</span>, <span class="m">-20</span>, <span class="m">-25</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{left: -20, top: -25, right: 20, bottom: 25}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">combineBoxPoint</span>(<span class="ge nx">{left: -20, top: -25, right: 20, bottom: 25}</span>, <span class="m">10</span>, <span class="m">15</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{left: -20, top: -25, right: 20, bottom: 25}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">combineBoxPoint</span>(<span class="ge nx">{left: -20, top: -25, right: 20, bottom: 25}</span>, <span class="m">100</span>, <span class="m">150</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{left: -20, top: -25, right: 100, bottom: 150}</span></span></div></pre></div></section><section id="koru/geometry.rotatePoints" tabindex="-1" name="rotatePoints" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Geometry.<span class="highlight"><span class="nf">rotatePoints</span>(<span class="nv">points</span>, <span class="nv">angle</span>)</span></h1><abstract><div><p>rotate points around (0,0)</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>points</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>angle</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Geometry</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/geometry"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">rotatePoints</span>(<span class="ge nx">[0, 0, -10, -20, 30, 40]</span>, <span class="m">180</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0, 0, 10, 20, -30, -40]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">rotatePoints</span>(<span class="ge nx">[0, 0, -10, -20, 30, 40]</span>, <span class="m">-180</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0, 0, 10, 20, -30, -40]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">rotatePoints</span>(<span class="ge nx">[0, 0, -10, -20, 30, 40]</span>, <span class="m">90</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0, 0, 20, -10, -40, 30]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">rotatePoints</span>(<span class="ge nx">[0, 0, -10, -20, 30, 40]</span>, <span class="m">-90</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0, 0, -20, 10, 40, -30]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">rotatePoints</span>(<span class="ge nx">[0, 0, -10, -20, 30, 40]</span>, <span class="m">45</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0, 0, 7.071067811865474, -21.213203435596427, -7.071067811865472, 49.49747468305833]</span></span></div></pre></div></section><section id="koru/geometry.splitBezier" tabindex="-1" name="splitBezier" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Geometry.<span class="highlight"><span class="nf">splitBezier</span>(<span class="nv">t</span>, <span class="nv">ps</span>, <span class="nv">curve</span>)</span></h1><abstract><div><p>Split a bezier curve into two at point t. The passed curve is modified and the second curve
is returned.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>t</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>0 &lt; t &lt; 1 where 0 is start point and 1 is end point</p>
</div></td></tr><tr class="jsdoc-arg"><td>ps</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>start point</p>
</div></td></tr><tr class="jsdoc-arg"><td>curve</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>bezier curve (See <a class="jsdoc-link" href="#koru/geometry.bezierBox">bezierBox</a>)</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the second curves in form <code>[cs, ce, pe]</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Geometry</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/geometry"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">splitBezier</span>(<span class="m">0.5</span>, <span class="ge nx">[10000, 20000]</span>, <span class="ge nx">[2500, 5000, 14375, 17500, 25937.5, 28750]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[37500, 40000, 48750, 50000, 40000, 30000]</span></span></div></pre></div></section><section id="koru/geometry.tPoint" tabindex="-1" name="tPoint" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Geometry.<span class="highlight"><span class="nf">tPoint</span>(<span class="nv">t</span>, <span class="nv">ps</span>, <span class="nv">curve</span>)</span></h1><abstract><div><p>Calculate the point at t along a line or a bezier curve</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>t</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>0 &lt; t &lt; 1 where 0 is start point and 1 is end point</p>
</div></td></tr><tr class="jsdoc-arg"><td>ps</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>start point</p>
</div></td></tr><tr class="jsdoc-arg"><td>curve</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>bezier curve (See <a class="jsdoc-link" href="#koru/geometry.bezierBox">bezierBox</a>) or end point for line</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the midpoint in form <code>[x, y]</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Geometry</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/geometry"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tPoint</span>(<span class="m">0</span>, <span class="ge nx">[10, 30]</span>, <span class="ge nx">[-40, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[10, 30]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tPoint</span>(<span class="m">0.5</span>, <span class="ge nx">[10, 30]</span>, <span class="ge nx">[-40, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[-15, 50]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tPoint</span>(<span class="m">1</span>, <span class="ge nx">[10, 30]</span>, <span class="ge nx">[-40, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[-40, 70]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tPoint</span>(<span class="m">0</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0, 0]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tPoint</span>(<span class="m">0.5</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[10, 12.5]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tPoint</span>(<span class="m">1</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[20, 25]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tPoint</span>(<span class="m">0.5</span>, <span class="ge nx">[10000, 20000]</span>, <span class="ge nx">[-5000, -10000, 57500, 70000, 40000, 30000]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[25937.5, 28750]</span></span></div></pre></div></section><section id="koru/geometry.tTangent" tabindex="-1" name="tTangent" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Geometry.<span class="highlight"><span class="nf">tTangent</span>(<span class="nv">t</span>, <span class="nv">ps</span>, <span class="nv">curve</span>)</span></h1><abstract><div><p>Calculate the tangent at t along a line or a bezier curve</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>t</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>0 &lt; t &lt; 1 where 0 is start point and 1 is end point</p>
</div></td></tr><tr class="jsdoc-arg"><td>ps</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>start point</p>
</div></td></tr><tr class="jsdoc-arg"><td>curve</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>bezier curve (See <a class="jsdoc-link" href="#koru/geometry.bezierBox">bezierBox</a>) or end point for line</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the tangent normalized vector in form <code>[xd, yd]</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Geometry</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/geometry"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">0</span>, <span class="ge nx">[10000, 20000]</span>, <span class="ge nx">[-5000, -10000, 57500, 70000, 40000, 30000]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[-0.4472135954999579, -0.8944271909999159]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">0.5</span>, <span class="ge nx">[10000, 20000]</span>, <span class="ge nx">[-5000, -10000, 57500, 70000, 40000, 30000]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0.7167259309091052, 0.6973549598034537]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">1</span>, <span class="ge nx">[10000, 20000]</span>, <span class="ge nx">[-5000, -10000, 57500, 70000, 40000, 30000]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[-0.40081883401970775, -0.9161573349021892]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">0</span>, <span class="ge nx">[10, 30]</span>, <span class="ge nx">[-40, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[-0.7808688094430304, 0.6246950475544243]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">1</span>, <span class="ge nx">[10, 30]</span>, <span class="ge nx">[-40, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[-0.7808688094430304, 0.6246950475544243]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">0.3</span>, <span class="ge nx">[10, 30]</span>, <span class="ge nx">[-40, 70]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[-0.7808688094430304, 0.6246950475544243]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">0</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0.6246950475544243, 0.7808688094430304]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">0</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0.6246950475544243, 0.7808688094430304]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">0.5</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0.6246950475544243, 0.7808688094430304]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">0</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0.6246950475544243, 0.7808688094430304]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">1</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[0, 0, 20, 25, 20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0.6246950475544243, 0.7808688094430304]</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Geometry</span>.<span class="na">tTangent</span>(<span class="m">1</span>, <span class="ge nx">[0, 0]</span>, <span class="ge nx">[20, 25]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[0.6246950475544243, 0.7808688094430304]</span></span></div></pre></div></section></div></div></div></section><section id="koru/idle-check" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/idle-check">koru/idle-check</a><h1 class="jsdoc-module-title searchable">IdleCheck</h1><abstract><div><p>IdleCheck keeps count of usage and notifies when idle.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">singleton</td><td><a href="#koru/idle-check">IdleCheck</a></td><td class="jsdoc-info" data-env="server"><div><p>The default <code>IdleCheck</code>. It is used by
<a class="jsdoc-link" href="#koru/web-server-factory">WebServerFactory</a> and
<a class="jsdoc-link" href="#koru/session/server-connection-factory">server-connection-factory</a></p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/idle-check.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>()</span></h1><abstract><div></div></abstract><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">IdleCheck</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/idle-check"</span>);</div><div><div class="highlight"><span class="k">new</span> <span class="nx">IdleCheck</span>();</div></div></pre></div></section><section id="koru/idle-check#waitIdle" tabindex="-1" name="#waitIdle" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">IdleCheck#<span class="highlight"><span class="nf">waitIdle</span>(<span class="nv">func</span>)</span></h1><abstract><div><p>waitIdle waits until <code>this.count</code> drops to zero.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>func</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">IdleCheck</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/idle-check"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">check</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IdleCheck</span>();
<span class="kd">const</span> <span class="no">callback</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">check</span>.<span class="na">waitIdle</span>(<span class="nx">callback</span>);
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">callback</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/koru-error" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/koru-error">koru/koru-error</a><h1 class="jsdoc-module-title searchable">koru.Error</h1><abstract><div><p>Main error class for koru errors.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#error</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><p>The http error code for the error</p>
</div></td></tr><tr><td class="searchable">#reason</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>The textual reason or an <code>object</code> with specific details</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/koru-error.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">error</span>, <span class="nv">reason</span>)</span></h1><abstract><div><p>Create a new koru.Error</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>error</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>an http error code</p>
</div></td></tr><tr class="jsdoc-arg"><td>reason</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the reason for the error or an object such as <a class="jsdoc-link" href="#koru/model/validation">Val</a>
results.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">koru.Error</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/koru-error"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">koru</span>.<span class="na">Error</span>(<span class="m">500</span>, <span class="s">'the reason'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">error</span>.<span class="na">name</span>, <span class="s">'KoruError'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">error</span>.<span class="function toString() { [native code] }">toString</span>(), <span class="s">'the reason [500]'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">error</span>.<span class="na">error</span>, <span class="m">500</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">error</span>.<span class="na">reason</span>, <span class="s">'the reason'</span>);

<span class="kd">const</span> <span class="no">err2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">koru</span>.<span class="na">Error</span>(<span class="m">400</span>, {<span class="na">name</span>: [[<span class="s">'is_invalid'</span>]]});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">err2</span>.<span class="function toString() { [native code] }">toString</span>(), <span class="s">`{name: [['is_invalid']]} [400]`</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">err2</span>.<span class="na">reason</span>, {<span class="na">name</span>: [[<span class="s">'is_invalid'</span>]]});</div></div></pre></div></section></div></div></div></section><section id="koru/linked-list" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/linked-list">koru/linked-list</a><h1 class="jsdoc-module-title searchable">LinkedList</h1><abstract><div><p>A single linked list. The list is iterable.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#back</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>the back node in the list</p>
</div></td></tr><tr><td class="searchable">#backValue</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><p>the back value in the list</p>
</div></td></tr><tr><td class="searchable">#front</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>the front node in the list</p>
</div></td></tr><tr><td class="searchable">#frontValue</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><p>the front value in the list</p>
</div></td></tr><tr><td class="searchable">#size</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><p>The number of nodes in the list</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/linked-list#addBack" tabindex="-1" name="#addBack" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">addBack</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Add <code>value</code> to back of list.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedList</span>;

<span class="nx">ll</span>.<span class="na">addBack</span>(<span class="m">1</span>);
<span class="nx">ll</span>.<span class="na">addBack</span>(<span class="m">2</span>);
<span class="nx">ll</span>.<span class="na">addBack</span>(<span class="m">3</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">listToString</span>(<span class="nx">ll</span>), <span class="s">"1 2 3"</span>);</div></div></pre></div></section><section id="koru/linked-list#clear" tabindex="-1" name="#clear" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">clear</span>()</span></h1><abstract><div><p>clear all entries. (calls <code>listEmpty</code> if present)</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedList</span>();

<span class="nx">subject</span>.<span class="na">push</span>(<span class="m">1</span>);
<span class="nx">subject</span>.<span class="na">push</span>(<span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">subject</span>.<span class="na">size</span>, <span class="m">2</span>);

<span class="nx">subject</span>.<span class="na">clear</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">subject</span>.<span class="na">size</span>, <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">subject</span>), []);</div></div></pre></div></section><section id="koru/linked-list#forEach" tabindex="-1" name="#forEach" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">forEach</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>visit each entry from front to back</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedList</span>();

<span class="nx">subject</span>.<span class="na">push</span>(<span class="s">'b'</span>);
<span class="nx">subject</span>.<span class="na">push</span>(<span class="s">'a'</span>);

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> [];

<span class="nx">subject</span>.<span class="na">forEach</span>(<span class="nv">v</span> <span class="o">=&gt;</span> {<span class="nx">ans</span>.<span class="na">push</span>(<span class="nx">v</span>)});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, [<span class="s">'a'</span>, <span class="s">'b'</span>]);</div></div></pre></div></section><section id="koru/linked-list#nodes" tabindex="-1" name="#nodes" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">*nodes</span>()</span></h1><abstract><div><p>Return an iterator over the nodes from font to back. (<a class="jsdoc-link" href="#koru/linked-list#add">add</a> returns the <code>node</code>)</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedList</span>();

<span class="kd">const</span> <span class="no">f</span> <span class="o">=</span> ()<span class="o">=&gt;</span>{};
<span class="kd">const</span> <span class="no">exp</span> <span class="o">=</span> [
  <span class="nx">m</span>.<span class="na">is</span>(<span class="nx">subject</span>.<span class="na">addBack</span>(<span class="m">1</span>)),
  <span class="nx">m</span>.<span class="na">is</span>(<span class="nx">subject</span>.<span class="na">addBack</span>(<span class="nx">f</span>))
];
<span class="nx">subject</span>.<span class="na">addBack</span>(<span class="s">'a'</span>);

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> [];

<span class="k">for</span> (<span class="kd">const</span> <span class="no">h</span> <span class="k">of</span> <span class="nx">subject</span>.<span class="na">nodes</span>()) {
  <span class="nx">ans</span>.<span class="na">push</span>(<span class="nx">h</span>);
  <span class="k">if</span> (<span class="nx">h</span>.<span class="na">value</span> <span class="o">===</span> <span class="nx">f</span>) <span class="k">break</span>;
}

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, <span class="nx">exp</span>);</div></div></pre></div></section><section id="koru/linked-list#pop" tabindex="-1" name="#pop" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">pop</span>()</span></h1><abstract><div><p>Remove and return <code>value</code> from front of list.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedList</span>;

<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">1</span>);
<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">2</span>);
<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">3</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ll</span>.<span class="na">pop</span>(), <span class="m">3</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ll</span>.<span class="na">pop</span>(), <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">listToString</span>(<span class="nx">ll</span>), <span class="s">"1"</span>);</div></div></pre></div></section><section id="koru/linked-list#popNode" tabindex="-1" name="#popNode" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">popNode</span>()</span></h1><abstract><div><p>Remove and return <code>node</code> from front of list.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedList</span>;

<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">1</span>);
<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">2</span>);
<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">3</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ll</span>.<span class="na">popNode</span>(), {<span class="na">value</span>: <span class="m">3</span>, <span class="na">next</span>: <span class="nx">m</span>.<span class="na">object</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">listToString</span>(<span class="nx">ll</span>), <span class="s">"2 1"</span>);</div></div></pre></div></section><section id="koru/linked-list#push" tabindex="-1" name="#push" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">push</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Push <code>value</code> to front of list.</p>
<section class="jsdoc-alias"><h1>Aliases</h1><div><code class="jsdoc-alias-term">addFront</code></div></section></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedList</span>;

<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">1</span>);
<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">2</span>);
<span class="nx">ll</span>.<span class="na">push</span>(<span class="m">3</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">listToString</span>(<span class="nx">ll</span>), <span class="s">"3 2 1"</span>);</div></div></pre></div></section><section id="koru/linked-list#removeNode" tabindex="-1" name="#removeNode" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">removeNode</span>(<span class="nv">node</span>, <span class="nv">prev</span>)</span></h1><abstract><div><p>Search for and remove <code>node</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>node</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the  node to remove</p>
</div></td></tr><tr class="jsdoc-arg"><td>[prev]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>where to start the search from. Defaults to <code>front</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the node removed or void 0 if not found</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">add</span>(<span class="nx">ll</span>, <span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>);

<span class="kd">let</span> <span class="nv">prev</span>;
<span class="k">for</span> (<span class="kd">let</span> <span class="nv">node</span> <span class="o">=</span> <span class="nx">ll</span>.<span class="na">front</span>; <span class="nx">node</span> <span class="o">!==</span> <span class="o">void</span> <span class="m">0</span>; <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span>.<span class="na">next</span>) {
  <span class="k">if</span> (<span class="nx">node</span>.<span class="na">value</span> <span class="o">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">1</span>)
    <span class="nx">ll</span>.<span class="na">removeNode</span>(<span class="nx">node</span>, <span class="nx">prev</span>);
  <span class="k">else</span>
    <span class="nx">prev</span> <span class="o">=</span> <span class="nx">node</span>;
}

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">listToString</span>(<span class="nx">ll</span>), <span class="s">"2 4"</span>);

<span class="nx">ll</span>.<span class="na">removeNode</span>(<span class="nx">ll</span>.<span class="na">back</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">listToString</span>(<span class="nx">ll</span>), <span class="s">"2"</span>);</div></div></pre></div></section><section id="koru/linked-list#values" tabindex="-1" name="#values" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LinkedList#<span class="highlight"><span class="nf">*values</span>()</span></h1><abstract><div><p>Return an iterator over the values from front to back.</p>
<section class="jsdoc-alias"><h1>Aliases</h1><div><code class="jsdoc-alias-term">[symbol.iterator]</code></div></section></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LinkedList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/linked-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedList</span>();

<span class="kd">const</span> <span class="no">f</span> <span class="o">=</span> ()<span class="o">=&gt;</span>{};
<span class="nx">subject</span>.<span class="na">push</span>(<span class="s">'a'</span>);
<span class="nx">subject</span>.<span class="na">push</span>(<span class="nx">f</span>);
<span class="nx">subject</span>.<span class="na">push</span>(<span class="m">1</span>);

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> [];

<span class="k">for</span> (<span class="kd">const</span> <span class="no">v</span> <span class="k">of</span> <span class="nx">subject</span>.<span class="na">values</span>()) {
  <span class="nx">ans</span>.<span class="na">push</span>(<span class="nx">v</span>);
  <span class="k">if</span> (<span class="nx">v</span> <span class="o">===</span> <span class="nx">f</span>) <span class="k">break</span>;
}

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, [<span class="m">1</span>, <span class="nx">m</span>.<span class="na">is</span>(<span class="nx">f</span>)]);</div></div></pre></div></section></div></div></div></section><section id="koru/make-subject" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/make-subject">koru/make-subject</a><h1 class="jsdoc-module-title searchable">makeSubject</h1><abstract><div><p>Make an object observable</p>
<p>See also <a class="jsdoc-link" href="#koru/observable">Observable</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/make-subject.makeSubject" tabindex="-1" name="makeSubject" data-env="both" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">makeSubject</span>(
    <span class="nv">subject</span><span class="o">=</span>{}, <span class="nv">observeName</span><span class="o">=</span><span class="s">'onChange'</span>, <span class="nv">notifyName</span><span class="o">=</span><span class="s">'notify'</span>,
    {<span class="nv">allStopped</span>, <span class="nv">init</span>, <span class="nv">stopAllName</span>}<span class="o">=</span>{}
  )</span></h1><abstract><div><p>Make an object observable by adding observe and notify
methods to it.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>subject</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the object observe</p>
</div></td></tr><tr class="jsdoc-arg"><td>[observeName]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>method name to call to start observing
<code>subject</code> (defaults to OnChange)</p>
</div></td></tr><tr class="jsdoc-arg"><td>[notifyName]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>method name to tell observers of a change
(defaults to notify)</p>
</div></td></tr><tr class="jsdoc-arg"><td>[allStopped]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>method will be called with subject when all observers have
stopped.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[init]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[stopAllName]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>adorned <a class="jsdoc-link" href="#koru/make-subject::subject">makeSubject::subject</a> parameter</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">makeSubject</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/make-subject"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">eg1</span> <span class="o">=</span> {<span class="na">eg</span>: <span class="m">1</span>};
<span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="nx">makeSubject</span>(<span class="nx">eg1</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">subject</span>, <span class="nx">eg1</span>);
<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">subject</span>.<span class="na">onChange</span>);
<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">subject</span>.<span class="na">notify</span>);

<span class="kd">const</span> <span class="no">subject2</span> <span class="o">=</span> <span class="nx">makeSubject</span>({<span class="na">eg</span>: <span class="m">2</span>}, <span class="s">'onUpdate'</span>, <span class="s">'updated'</span>);

<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">subject2</span>.<span class="na">onUpdate</span>);
<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">subject2</span>.<span class="na">updated</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/match" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/match">koru/match</a><h1 class="jsdoc-module-title searchable">match</h1><abstract><div><p>Match allows objects to be tested for equality against a range of pre-built or custom matchers.
The <a class="jsdoc-link" href="#koru/util.deepEqual">util.deepEqual</a> function will honour any matchers found in the <code>expected</code> (second)
argument.</p>
<p>Note when testing <a class="jsdoc-link" href="#koru/test/core">Core.match</a> is a separate clone of this match framework. This
ensures any stubbing of match properties will not interfere with the test asserts.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">any</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match anything (or nothing)</p>
</div></td></tr><tr><td class="searchable">array</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any object that is true for <code>Array.isArray</code></p>
</div></td></tr><tr><td class="searchable">baseObject</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any object where constructor is Object</p>
</div></td></tr><tr><td class="searchable">date</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any date</p>
</div></td></tr><tr><td class="searchable">error</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any error</p>
</div></td></tr><tr><td class="searchable">func</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any function</p>
</div></td></tr><tr><td class="searchable">id</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match a valid model <code>_id</code></p>
</div></td></tr><tr><td class="searchable">integer</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any integer</p>
</div></td></tr><tr><td class="searchable">match</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any matcher</p>
</div></td></tr><tr><td class="searchable">nil</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match undefined or null</p>
</div></td></tr><tr><td class="searchable">null</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match null</p>
</div></td></tr><tr><td class="searchable">object</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match anything of type <code>object</code> except null</p>
</div></td></tr><tr><td class="searchable">optional</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info" data-env="both"><div><p>match a standard matcher or <code>null</code> or <code>undefined</code>; <code>match.optional.date</code></p>
</div></td></tr><tr><td class="searchable">string</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any string</p>
</div></td></tr><tr><td class="searchable">symbol</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match any symbol</p>
</div></td></tr><tr><td class="searchable">undefined</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info" data-env="both"><div><p>match undefined</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/match.equal" tabindex="-1" name="equal" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">match.<span class="highlight"><span class="nf">equal</span>(<span class="nv">expected</span>, <span class="nv">name</span><span class="o">=</span><span class="s">'match.equal'</span>)</span></h1><abstract><div><p>Match <code>expected</code> using <a class="jsdoc-link" href="#koru/util.deepEqual">util.deepEqual</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>expected</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[name]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">match</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/match"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">me</span> <span class="o">=</span> <span class="nx">match</span>.<span class="na">equal</span>([<span class="m">1</span>,<span class="nx">match</span>.<span class="na">any</span>]);

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">me</span>.<span class="na">test</span>([<span class="m">1</span>,<span class="s">'x'</span>]));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">me</span>.<span class="na">test</span>([<span class="m">1</span>, <span class="kc">null</span>]));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">me</span>.<span class="na">test</span>([<span class="m">1</span>]));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">me</span>.<span class="na">test</span>([<span class="m">1</span>, <span class="m">1</span>, <span class="kc">null</span>]));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">me</span>.<span class="na">test</span>([<span class="m">2</span>, <span class="m">1</span>]));</div></div></pre></div></section><section id="koru/match.is" tabindex="-1" name="is" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">match.<span class="highlight"><span class="nf">is</span>(<span class="nv">expected</span>, <span class="nv">name</span><span class="o">=</span>() <span class="o">=&gt;</span> <span class="s">`match.is(${</span><span class="nx">util</span>.<span class="na">inspect</span>(<span class="nx">expected</span>)<span class="s">})`</span>)</span></h1><abstract><div><p>Match exactly; like <code>Object.is</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>expected</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[name]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">match</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/match"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">match</span>.<span class="na">is</span>(<span class="ge nx">{foo: 123}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">match.is({foo: 123})</span></span></div></pre></div></section><section id="koru/match.match" tabindex="-1" name="match" data-env="both" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">match</span>(<span class="nv">test</span>, <span class="nv">name</span>)</span></h1><abstract><div><p>Build a custom matcher.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>test</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp" target="_blank">RegExp</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>used to test for truthfulness</p>
</div></td></tr><tr class="jsdoc-arg"><td>[name]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>override the default name for the matcher.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">match</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/match"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">match5</span> <span class="o">=</span> <span class="nx">match</span>(<span class="nv">arg</span> <span class="o">=&gt;</span> <span class="nx">arg</span> <span class="o">==</span> <span class="m">5</span>);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">match5</span>.<span class="na">test</span>(<span class="m">5</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">match5</span>.<span class="na">test</span>(<span class="s">"5"</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">match5</span>.<span class="na">test</span>(<span class="m">4</span>));
<span class="nx">assert</span>.<span class="na">same</span>(<span class="s">''</span><span class="o">+</span><span class="nx">match</span>(()<span class="o">=&gt;</span><span class="kc">true</span>, <span class="s">'my message'</span>), <span class="s">'my message'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>(<span class="nx">match</span>(<span class="sr">/abc/</span>).<span class="na">test</span>(<span class="s">'aabcc'</span>));
<span class="nx">refute</span>(<span class="nx">match</span>(<span class="sr">/abc/</span>).<span class="na">test</span>(<span class="s">'aabbcc'</span>));
<span class="nx">assert</span>(<span class="nx">match</span>([<span class="m">1</span>, <span class="nx">match</span>.<span class="na">any</span>]).<span class="na">test</span>([<span class="m">1</span>, <span class="s">'foo'</span>]));
<span class="nx">refute</span>(<span class="nx">match</span>([<span class="m">2</span>, <span class="nx">match</span>.<span class="na">any</span>]).<span class="na">test</span>([<span class="m">1</span>, <span class="s">'foo'</span>]));</div></div></pre></div></section><section id="koru/match.not" tabindex="-1" name="not" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">match.<span class="highlight"><span class="nf">not</span>(<span class="nv">arg</span>)</span></h1><abstract><div><p>Match not. Invert the result of <code>arg</code> matcher.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>arg</td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info"><div><p>the matcher to invert.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/match::Match">Match</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">match</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/match"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">match</span>.<span class="na">not</span>(<span class="nx">match</span>.<span class="na">string</span>).<span class="na">test</span>(<span class="m">1</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">match</span>.<span class="na">not</span>(<span class="nx">match</span>.<span class="na">number</span>).<span class="na">test</span>(<span class="m">1</span>));</div></div></pre></div></section></div></div></div></section><section id="koru/match::Match" data-env="both" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/match::Match">koru/match::Match</a><h1 class="jsdoc-module-title searchable">Match</h1><abstract><div><p>Class of matchers.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/match::Match#$throwTest" tabindex="-1" name="#$throwTest" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Match#<span class="highlight"><span class="nf">$throwTest</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Throw if test fails</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">match</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/match"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">try</span> {
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">match</span>.<span class="na">any</span>.<span class="na">$throwTest</span>(<span class="kc">null</span>));
} <span class="k">catch</span>(<span class="nv">ex</span>) {
  <span class="nx">assert</span>.<span class="na">fail</span>(<span class="s">"did not expect "</span><span class="o">+</span><span class="nx">ex</span>);
}
<span class="k">try</span> {
  <span class="nx">match</span>.<span class="na">func</span>.<span class="na">$throwTest</span>(<span class="m">123</span>);
  <span class="nx">assert</span>.<span class="na">fail</span>(<span class="s">"expected expection"</span>);
} <span class="k">catch</span>(<span class="nv">ex</span>) {
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ex</span>, <span class="s">'match.func'</span>);
}</div></div></pre></div></section><section id="koru/match::Match#test" tabindex="-1" name="#test" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Match#<span class="highlight"><span class="nf">test</span>(<span class="nv">actual</span>, <span class="nv">$throwTest</span>)</span></h1><abstract><div><p>Test if matcher matches.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>actual</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[$throwTest]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">match</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/match"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">match</span>.<span class="na">any</span>.<span class="na">test</span>(<span class="kc">null</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">match</span>.<span class="na">func</span>.<span class="na">test</span>(<span class="m">123</span>));</div></div></pre></div></section></div></div></div></section><section id="koru/math-util" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/math-util">koru/math-util</a><h1 class="jsdoc-module-title searchable">MathUtil</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/math-util.normDist" tabindex="-1" name="normDist" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">MathUtil.<span class="highlight"><span class="nf">normDist</span>(<span class="nv">rng</span><span class="o">=</span><span class="nx">Math</span>.<span class="na">random</span>, <span class="nv">mean</span><span class="o">=</span><span class="m">0</span>, <span class="nv">stdDev</span><span class="o">=</span><span class="m">1</span>)</span></h1><abstract><div><p>Make a function that generates a normal distribution of random numbers. Uses the
<a href="https://en.wikipedia.org/wiki/Marsaglia_polar_method" target="_blank">Marsaglia polar method</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[rng]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the random number generation; needs to generate a uniform real distribution
between 0 and 1.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[mean]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[stdDev]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the standard deviation</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MathUtil</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/math-util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="o">typeof</span> <span class="nx">MathUtil</span>.<span class="na">normDist</span>(), <span class="s">'function'</span>);

<span class="kd">const</span> <span class="no">rng</span> <span class="o">=</span> <span class="nx">Random</span>.<span class="na">prototype</span>.<span class="na">fraction</span>.<span class="na">bind</span>(<span class="k">new</span> <span class="nx">Random</span>(<span class="m">1</span>));
<span class="kd">const</span> <span class="no">ndg</span> <span class="o">=</span> <span class="nx">MathUtil</span>.<span class="na">normDist</span>(<span class="nx">rng</span>, <span class="m">4</span>, <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">ndg</span>(), <span class="m">4.904</span>, <span class="m">0.001</span>);
<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">ndg</span>(), <span class="m">2.093</span>, <span class="m">0.001</span>);
<span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">ndg</span>(), <span class="m">5.344</span>, <span class="m">0.001</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/migrate/migration" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/migrate/migration">koru/migrate/migration</a><h1 class="jsdoc-module-title searchable">Migration</h1><abstract><div><p>Run Database migrations to apply or revert changes to a database in order to align the DB with
the expectations of the source code.</p>
<p>Files are executed in alphanumeric order and are conventionally named:</p>
<p><code>yyyy-mm-ddThh-mm-ss-usage.js</code> where <code>usage</code> is like <code>create-user</code>, <code>add-index-to-book</code></p>
<p>Example: <code>2018-12-20T05-38-09-add-author_id-to-book.js</code>
Migrations also adds a table called "Migration" to the db which has one column <code>name</code>
containing all the successfully run migrations.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/migrate/migration#migrateTo" tabindex="-1" name="#migrateTo" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Migration#async migrateTo(dirPath, pos, verbose)</h1><abstract><div><p>Migrate the DB to a position. Each migration is run within a transaction so that it only
modifies the DB if it succeeds. If a migration fails no further migrations are run.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dirPath</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the directory containing the migration files</p>
</div></td></tr><tr class="jsdoc-arg"><td>pos</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>Migration files contained in the <code>dirPath</code> directory which have not yet been
processed and their names are <code>&lt;= pos</code> are applied; names <code>&gt; pos</code> which have already been
applied are reverted.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[verbose]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p>print messages to <code>console.log</code> as files are processed.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Migration</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/migrate/migration"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">migration</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Migration</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">migration</span>.<span class="na">migrateTo</span>(<span class="s">"koru/migrate/test-migrations"</span>, <span class="s">"2015-06-19T17-57-32"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">undefined</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">migration</span>.<span class="na">migrateTo</span>(<span class="s">"koru/migrate/test-migrations"</span>, <span class="s">"2015-06-19T17-49-31~"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">undefined</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">migration</span>.<span class="na">migrateTo</span>(<span class="s">"koru/migrate/test-migrations"</span>, <span class="s">" "</span>, <span class="kc">true</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">undefined</span></span></div></pre></div></section></div></div></div></section><section id="koru/migrate/migration::Commander" data-env="server" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/migrate/migration::Commander">koru/migrate/migration::Commander</a><h1 class="jsdoc-module-title searchable">Commander</h1><abstract><div><p>The facilitator of a migration. An instance is passed to a migration file and is used to
define the actions to apply or revert for this migration entry.</p>
<h1 id="example">Example</h1>
<pre><code class="language-js"><div class="highlight"><span class="nx">define</span>(()<span class="o">=&gt;</span> <span class="nv">mig</span> <span class="o">=&gt;</span>{
  <span class="nx">mig</span>.<span class="na">addColumns</span>(<span class="s">"Book"</span>, <span class="s">"topic_id:id"</span>);
});</div>
</code></pre></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/migrate/migration::Commander#addColumns" tabindex="-1" name="#addColumns" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Commander#<span class="highlight"><span class="nf">addColumns</span>(<span class="nv">tableName</span>, ...<span class="nv">args</span>)</span></h1><abstract><div><p>Add columns to a DB table.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>tableName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the table to add the columns to.</p>
</div></td></tr><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>either a list of <code>column:type</code> strings or an object with column keys and
either; type as values; or an object value containing a <code>type</code> key and optional <code>default</code>
key.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Migration</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/migrate/migration"</span>);</div><div class="highlight jsdoc-inst-init"><span class="cs">// file contents</span></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">define</span>(() <span class="o">=&gt;</span> (<span class="nv">mig</span>) <span class="o">=&gt;</span> {
  <span class="nx">mig</span>.<span class="na">addColumns</span>(<span class="s">'Book'</span>, {
    <span class="na">pageCount</span>: {<span class="na">type</span>: <span class="s">'int8'</span>, <span class="na">default</span>: <span class="m">0</span>},
    <span class="na">author_id</span>: <span class="s">'id'</span>,
  });
});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">define</span>(() <span class="o">=&gt;</span> (<span class="nv">mig</span>) <span class="o">=&gt;</span> {
  <span class="nx">mig</span>.<span class="na">addColumns</span>(<span class="s">'Book'</span>, <span class="s">'pageCount:int8'</span>, <span class="s">'title'</span>);
});</div></div></pre></div></section><section id="koru/migrate/migration::Commander#addIndex" tabindex="-1" name="#addIndex" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Commander#<span class="highlight"><span class="nf">addIndex</span>(<span class="nv">tableName</span>, <span class="nv">spec</span>)</span></h1><abstract><div><p>Add an index to a table.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>tableName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The name of the table to add the index to.</p>
</div></td></tr><tr class="jsdoc-arg"><td>spec</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>The specification of the index containing:</p>
<table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">type</th>
<th align="left">desc</th>
</tr>
</thead>
<tbody><tr>
<td align="left">columns</td>
<td align="left"><code>Array</code></td>
<td align="left">a list of column names with optional <code>' DESC'</code> suffix.</td>
</tr>
<tr>
<td align="left">[name]</td>
<td align="left"><code>String</code></td>
<td align="left">The name of index. default is made from table name and column names.</td>
</tr>
<tr>
<td align="left">[unique]</td>
<td align="left"><code>Boolean</code></td>
<td align="left"><code>true</code> if index entries are unique.</td>
</tr>
<tr>
<td align="left">[where]</td>
<td align="left"><code>String</code></td>
<td align="left">An SQL expression to determine if a record is included in the index.</td>
</tr>
</tbody></table>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Migration</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/migrate/migration"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">define</span>(() <span class="o">=&gt;</span> (<span class="nv">mig</span>) <span class="o">=&gt;</span> {
  <span class="nx">mig</span>.<span class="na">addIndex</span>(<span class="s">'Book'</span>, {
    <span class="na">columns</span>: [<span class="s">'title DESC'</span>, <span class="s">'_id'</span>],
    <span class="na">unique</span>: <span class="kc">true</span>,
    <span class="na">where</span>: <span class="s">'"pageCount" &gt; 50'</span>,
  });

  <span class="nx">mig</span>.<span class="na">addIndex</span>(<span class="s">'Book'</span>, {
    <span class="na">name</span>: <span class="s">'short_books'</span>,
    <span class="na">columns</span>: [<span class="s">'title DESC'</span>],
    <span class="na">where</span>: <span class="s">'"pageCount" &lt; 50'</span>,
  });
});</div></div></pre></div></section><section id="koru/migrate/migration::Commander#createTable" tabindex="-1" name="#createTable" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Commander#<span class="highlight"><span class="nf">createTable</span>(<span class="nv">name</span>, <span class="nv">fields</span>, <span class="nv">indexes</span>)</span></h1><abstract><div><p>Create a table in the database. Arguments may also be named (<code>{name, fields, indexes}</code>)</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the table</p>
</div></td></tr><tr class="jsdoc-arg"><td>fields</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>name-value entries describing the fields of the table. The value for each
field can be a string containing the type or a object containing:</p>
</div></td></tr><tr class="jsdoc-arg"><td>indexes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a list of index specifications to add to the table. See <a class="jsdoc-link" href="#koru/migrate/migration::Commander#addIndex">addIndex</a></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Migration</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/migrate/migration"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">define</span>(() <span class="o">=&gt;</span> (<span class="nv">mig</span>) <span class="o">=&gt;</span> {
  <span class="nx">mig</span>.<span class="na">createTable</span>(
    <span class="s">'Label'</span>,
    {
      <span class="na">name</span>: <span class="s">'text'</span>,
      <span class="na">backgroundColor</span>: {<span class="na">type</span>: <span class="s">'color'</span>, <span class="na">default</span>: <span class="s">'#ffffff'</span>},
    },
    [
      {<span class="na">columns</span>: [<span class="s">'name DESC'</span>, <span class="s">'_id'</span>], <span class="na">unique</span>: <span class="kc">true</span>},
      [<span class="s">'backgroundColor'</span>]]); <span class="cs">//  columns</span>
});
        

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Label</span>.<span class="na">_colMap</span>.<span class="na">_id</span>.<span class="na">oid</span>, <span class="m">25</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Label</span>.<span class="na">_colMap</span>.<span class="na">_id</span>.<span class="na">collation_name</span>, <span class="s">'C'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Label</span>.<span class="na">_colMap</span>.<span class="na">name</span>.<span class="na">oid</span>, <span class="m">25</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Label</span>.<span class="na">_colMap</span>.<span class="na">name</span>.<span class="na">collation_name</span>, <span class="o">void</span> <span class="m">0</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Label</span>.<span class="na">_colMap</span>.<span class="na">backgroundColor</span>.<span class="na">oid</span>, <span class="m">25</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Label</span>.<span class="na">_colMap</span>.<span class="na">backgroundColor</span>.<span class="na">collation_name</span>, <span class="s">'C'</span>);

<span class="k">await</span> <span class="nx">client</span>.<span class="na">query</span>(<span class="s">'INSERT INTO "Label" (_id, "name") values ($1,$2)'</span>, [
  <span class="s">'12345670123456789'</span>, <span class="s">'Bug'</span>]);
<span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> (<span class="k">await</span> <span class="nx">client</span>.<span class="na">query</span>(<span class="s">'SELECT * from "Label"'</span>))[<span class="m">0</span>];
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">_id</span>, <span class="s">'12345670123456789'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">name</span>, <span class="s">'Bug'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">backgroundColor</span>, <span class="s">'#ffffff'</span>);</div></div></pre></div></section><section id="koru/migrate/migration::Commander#reversible" tabindex="-1" name="#reversible" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Commander#<span class="highlight"><span class="nf">reversible</span>({<span class="nv">add</span>, <span class="nv">revert</span>, <span class="nv">resetTables</span>})</span></h1><abstract><div><p>Execute reversible database instructions.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>add</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div><p>a function to call when adding a migration (migrate up) to the DB. Is passed a
<a class="jsdoc-link" href="#koru/pg/driver::Client">pg::Client</a> instance.</p>
</div></td></tr><tr class="jsdoc-arg"><td>revert</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div><p>a function to call when reverting a migration (migrate down) to the DB. Is
passed a <a class="jsdoc-link" href="#koru/pg/driver::Client">pg::Client</a> instance.</p>
</div></td></tr><tr class="jsdoc-arg"><td>resetTables</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a List of tables to reset the schema definition for</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Migration</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/migrate/migration"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">define</span>(() <span class="o">=&gt;</span> (<span class="nv">mig</span>) <span class="o">=&gt;</span> {
  <span class="nx">mig</span>.<span class="na">reversible</span>({
    async <span class="nf">add</span>(<span class="nv">client</span>) {
      <span class="k">await</span> <span class="nx">client</span>.<span class="na">query</span>(<span class="s">`alter table "Book" rename column name to title`</span>);
      <span class="k">await</span> <span class="nx">client</span>.<span class="na">query</span>(<span class="s">`insert into "Book" (_id, title) values ('book123', 'Emma')`</span>);
    },
    async <span class="nf">revert</span>(<span class="nv">client</span>) {
      <span class="k">await</span> <span class="nx">client</span>.<span class="na">query</span>(<span class="s">`delete from "Book"`</span>);
      <span class="k">await</span> <span class="nx">client</span>.<span class="na">query</span>(<span class="s">`alter table "Book" rename column title to name`</span>);
    },
    <span class="na">resetTables</span>: [<span class="s">'Book'</span>],
  });
});</div></div></pre></div></section></div></div></div></section><section id="koru/model/main" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/main">koru/model/main</a><h1 class="jsdoc-module-title searchable">Model</h1><abstract><div><p>Object persistence manager. Defines application models.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div></div></div></section><section id="koru/model/base-model" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/base-model">koru/model/base-model</a><h1 class="jsdoc-module-title searchable">BaseModel</h1><abstract><div><p>The base class for all models</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/base-model.onChange" tabindex="-1" name="onChange" data-env="both" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">onChange</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Observe changes to model records.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>is called with a <a class="jsdoc-link" href="#koru/model/doc-change">DocChange</a> instance.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>contains a stop method to stop observering</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">observer</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">after</span>(<span class="nx">Book</span>.<span class="na">onChange</span>(<span class="nx">observer</span>));

<span class="kd">const</span> <span class="no">Oasis</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'m123'</span>, <span class="na">title</span>: <span class="s">'Oasis'</span>, <span class="na">pageCount</span>: <span class="m">425</span>});
<span class="kd">const</span> <span class="no">matchOasis</span> <span class="o">=</span> <span class="nx">m</span>.<span class="na">field</span>(<span class="s">'_id'</span>, <span class="nx">Oasis</span>.<span class="na">_id</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observer</span>, <span class="nx">DocChange</span>.<span class="na">add</span>(<span class="nx">Oasis</span>));

<span class="k">await</span> <span class="nx">Oasis</span>.<span class="na">$update</span>(<span class="s">'pageCount'</span>, <span class="m">420</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observer</span>, <span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">matchOasis</span>, {<span class="na">pageCount</span>: <span class="m">425</span>}));

<span class="k">await</span> <span class="nx">Oasis</span>.<span class="na">$remove</span>();
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observer</span>, <span class="nx">DocChange</span>.<span class="na">delete</span>(<span class="nx">matchOasis</span>));</div></div></pre></div></section><section id="koru/model/base-model.assertFound" tabindex="-1" name="assertFound" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.<span class="highlight"><span class="nf">assertFound</span>(<span class="nv">doc</span>)</span></h1><abstract><div><p>Assert model instance is found</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Book</span> <span class="k">extends</span> <span class="nx">BaseModel</span> {}
<span class="nx">Book</span>.<span class="na">define</span>({<span class="na">module</span>});
<span class="nx">assert</span>.<span class="na">exception</span>(() <span class="o">=&gt;</span> {
  <span class="nx">Book</span>.<span class="na">assertFound</span>(<span class="kc">null</span>);
}, {<span class="na">error</span>: <span class="m">404</span>, <span class="na">message</span>: <span class="s">'Book Not found'</span>});

<span class="nx">refute</span>.<span class="na">exception</span>(() <span class="o">=&gt;</span> {
  <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
  <span class="nx">Book</span>.<span class="na">assertFound</span>(<span class="nx">book</span>);
});</div></div></pre></div></section><section id="koru/model/base-model.build" tabindex="-1" name="build" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.<span class="highlight"><span class="nf">build</span>(<span class="nv">attributes</span>, <span class="nv">allow_id</span><span class="o">=</span><span class="kc">false</span>)</span></h1><abstract><div><p>Build a new model. Does not copy _id from attributes.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>attributes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[allow_id]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">copy</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>(<span class="nx">doc</span>.<span class="na">attributes</span>);

<span class="nx">refute</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">attributes</span>, <span class="nx">copy</span>.<span class="na">changes</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">title</span>, <span class="nx">copy</span>.<span class="na">title</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">copy</span>.<span class="na">_id</span>, <span class="kc">null</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">copy</span>.<span class="na">changes</span>.<span class="na">_id</span>, <span class="kc">null</span>);</div></div></pre></div></section><section id="koru/model/base-model.define" tabindex="-1" name="define" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.<span class="highlight"><span class="nf">define</span>({<span class="nv">module</span>, <span class="nv">inspectField</span><span class="o">=</span><span class="s">'name'</span>, <span class="nv">name</span><span class="o">=</span><span class="nx">moduleName</span>(<span class="nx">module</span>), <span class="nv">fields</span>})</span></h1><abstract><div><p>Define and register a model.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[module]</td><td><a href="#Module">Module</a></td><td class="jsdoc-info"><div><p>needed to auto unload module when file changed</p>
</div></td></tr><tr class="jsdoc-arg"><td>[inspectField]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[name]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>name of model. Defaults to derived from module name.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[fields]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>call <a class="jsdoc-link" href="#koru/model/base-model.defineFields">defineFields</a> with fields</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div><p>the model</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Book</span> <span class="k">extends</span> <span class="nx">BaseModel</span> {}
<span class="nx">Book</span>.<span class="na">define</span>({<span class="na">module</span>, <span class="na">fields</span>: {
  <span class="na">title</span>: <span class="s">'text'</span>,
  <span class="na">pages</span>: {<span class="na">type</span>: <span class="s">'number'</span>, <span class="na">number</span>: {<span class="s">'&gt;'</span>: <span class="m">0</span>}},
}});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Model</span>.<span class="na">Book</span>, <span class="nx">Book</span>);

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>();

<span class="nx">book</span>.<span class="na">title</span> <span class="o">=</span> <span class="s">'The Hedge Knight'</span>;
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">changes</span>, {<span class="na">title</span>: <span class="s">'The Hedge Knight'</span>});

<span class="nx">book</span>.<span class="na">pages</span> <span class="o">=</span> <span class="o">-</span><span class="m">1</span>;
<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>], {<span class="na">pages</span>: [[<span class="s">'must_be_greater_than'</span>, <span class="m">0</span>]]});</div></div></pre></div></section><section id="koru/model/base-model.defineFields" tabindex="-1" name="defineFields" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.<span class="highlight"><span class="nf">defineFields</span>(<span class="nv">fields</span>)</span></h1><abstract><div><p>Define the types and <a class="jsdoc-link" href="#koru/model/validators/main">validators</a> of the fields in a model. Usually
called with <a class="jsdoc-link" href="#koru/model/base-model.define">define</a></p>
<p>Valid types are:</p>
<table>
<thead>
<tr>
<th align="left">type</th>
<th align="left">javascript type</th>
<th align="left">DB type</th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">any</td>
<td align="left">object</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">auto_timestamp</td>
<td align="left">Date</td>
<td align="left">timestamp</td>
<td align="left">Set the timestamp on create; if field name contains <code>/create/i</code>; otherwise on update.</td>
</tr>
<tr>
<td align="left">baseObject</td>
<td align="left">object</td>
<td align="left">jsonb</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">belongs_to_dbId</td>
<td align="left">string</td>
<td align="left">text</td>
<td align="left"><p>A <code>pseudo_field</code> synced to the <a class="jsdoc-link" href="#koru/model/db-broker">db-broker.dbId</a>. It defines a model getter like
<code>belongs_to</code> does. It can only be defined once per model.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">publisher_id</span>: {<span class="na">type</span>: <span class="s">'belongs_to_dbId'</span>},
  <span class="na">title</span>: <span class="s">'text'</span>,
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">title</span>: <span class="s">'White Fang'</span>});
<span class="nx">assert</span>.<span class="na">equals</span>((<span class="k">await</span> <span class="nx">book</span>.<span class="na">$reload</span>(<span class="kc">true</span>)).<span class="na">attributes</span>, {<span class="na">title</span>: <span class="s">'White Fang'</span>, <span class="na">_id</span>: <span class="nx">m</span>.<span class="na">id</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">publisher_id</span>, <span class="nx">dbBroker</span>.<span class="na">dbId</span>);

<span class="k">await</span> <span class="nx">Publisher</span>.<span class="na">create</span>({<span class="na">name</span>: <span class="s">'Macmillan'</span>, <span class="na">_id</span>: <span class="s">'default'</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">publisher</span>.<span class="na">name</span>, <span class="s">'Macmillan'</span>);</div></pre><p></p>
</td>
</tr>
<tr>
<td align="left">belongs_to</td>
<td align="left">string</td>
<td align="left">text</td>
<td align="left">Associate this model belonging to another model. A getter is defined to retrieve the associated model using this fields name less the <code>_id</code> suffix.</td>
</tr>
<tr>
<td align="left">boolean</td>
<td align="left">boolean</td>
<td align="left">boolean</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">color</td>
<td align="left">string</td>
<td align="left">text</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">date</td>
<td align="left">Date</td>
<td align="left">date</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">has_many</td>
<td align="left">Array</td>
<td align="left">text[]</td>
<td align="left">Used with the <a class="jsdoc-link" href="#koru/model/validators/associated-validator">AssociatedValidator</a> to map to many ids.</td>
</tr>
<tr>
<td align="left">id</td>
<td align="left">string</td>
<td align="left">text</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">integer</td>
<td align="left">number</td>
<td align="left">integer</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">jsonb</td>
<td align="left">object</td>
<td align="left">jsonb</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">number</td>
<td align="left">number</td>
<td align="left">double precision</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">object</td>
<td align="left">object</td>
<td align="left">jsonb</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">string</td>
<td align="left">string</td>
<td align="left">text</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">text</td>
<td align="left">string</td>
<td align="left">text</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">user_id_on_create</td>
<td align="left">string</td>
<td align="left">text</td>
<td align="left">Like <code>belongs_to</code> but also sets the field on create to the logged in <code>user_id</code>.</td>
</tr>
</tbody></table>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>fields</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an key-value object with keys naming the fields and values defining the field
<code>type</code>, the <a class="jsdoc-link" href="#koru/model/validators/main">validators</a> and any of the following generic options:</p>
<table>
<thead>
<tr>
<th align="left">option</th>
<th align="left">usage</th>
</tr>
</thead>
<tbody><tr>
<td align="left">default</td>
<td align="left">The field's default value to assign in a new document</td>
</tr>
<tr>
<td align="left">pseudo_field</td>
<td align="left">The field does not have accessors and is not set in <code>&lt;Model&gt;.$fields</code> property</td>
</tr>
<tr>
<td align="left">accessor</td>
<td align="left">Use <code>accessor.get</code> and <code>accessor.set</code> for this field.<br>An accessor of <code>false</code> means no accessors</td>
</tr>
<tr>
<td align="left">readOnly</td>
<td align="left">Saving a change to the field should not be allowed</td>
</tr>
<tr>
<td align="left">changesOnly</td>
<td align="left"><p>Only changes to the field are validated</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">pages</span>: {<span class="na">type</span>: <span class="s">'number'</span>, <span class="na">number</span>: {<span class="s">'&gt;'</span>: <span class="m">0</span>}, <span class="na">changesOnly</span>: <span class="kc">true</span>},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
<span class="nx">book</span>.<span class="na">attributes</span>.<span class="na">pages</span> <span class="o">=</span> <span class="o">-</span><span class="m">1</span>;

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>()); <span class="cs">// wrong but no change</span>

<span class="nx">book</span>.<span class="na">pages</span> <span class="o">=</span> <span class="s">'alsoWrong'</span>;
<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>()); <span class="cs">// wrong and changed</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>], {<span class="na">pages</span>: [[<span class="s">'not_a_number'</span>]]});

<span class="nx">book</span>.<span class="na">pages</span> <span class="o">=</span> <span class="m">2</span>;
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>()); <span class="cs">// changed and okay</span></div></pre><p></p>
</td>
</tr>
<tr>
<td align="left">model</td>
<td align="left">An associated model for the field</td>
</tr>
</tbody></table>
<p>Types and validators may also make use of other specific options.</p>
<p>The field <code>_id</code> is added by default with a type of <code>id</code>. It can be given an option of
<code>auto</code> to specify that the DB will generate an id for this field if none is supplied.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div><p>the model</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Book</span> <span class="k">extends</span> <span class="nx">BaseModel</span> {}
<span class="nx">Book</span>.<span class="na">define</span>({<span class="na">module</span>});

<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">title</span>: <span class="s">'text'</span>,
  <span class="na">pages</span>: {<span class="na">type</span>: <span class="s">'number'</span>, <span class="na">number</span>: {<span class="s">'&gt;'</span>: <span class="m">0</span>}},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>();

<span class="nx">book</span>.<span class="na">title</span> <span class="o">=</span> <span class="s">'The Hedge Knight'</span>;
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">changes</span>, {<span class="na">title</span>: <span class="s">'The Hedge Knight'</span>});

<span class="nx">book</span>.<span class="na">pages</span> <span class="o">=</span> <span class="o">-</span><span class="m">1</span>;
<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>], {<span class="na">pages</span>: [[<span class="s">'must_be_greater_than'</span>, <span class="m">0</span>]]});</div></div></pre></div></section><section id="koru/model/base-model.findById" tabindex="-1" name="findById" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.<span class="highlight"><span class="nf">findById</span>(<span class="nv">id</span>)</span></h1><abstract><div><p>Find a document by its <code>_id</code>. Returns the same document each time if called from same
thread.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">title</span>: <span class="s">'Emma'</span>, <span class="na">pageCount</span>: <span class="m">342</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="nx">Book</span>.<span class="na">findById</span>(<span class="nx">doc</span>.<span class="na">_id</span>), <span class="nx">doc</span>);</div></div></pre></div></section><section id="koru/model/base-model.isIdLocked" tabindex="-1" name="isIdLocked" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.<span class="highlight"><span class="nf">isIdLocked</span>(<span class="nv">id</span>)</span></h1><abstract><div><p>Test if an id is locked.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>usally the id of a DB record.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">transaction</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="k">await</span> <span class="nx">Book</span>.<span class="na">lockId</span>(<span class="s">'bookid123'</span>);
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">Book</span>.<span class="na">isIdLocked</span>(<span class="s">'bookid123'</span>));
  <span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">Book</span>.<span class="na">isIdLocked</span>(<span class="s">'bookid456'</span>));
});
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">Book</span>.<span class="na">isIdLocked</span>(<span class="s">'bookid123'</span>));</div></div></pre></div></section><section id="koru/model/base-model.lockId" tabindex="-1" name="lockId" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.async lockId(id)</h1><abstract><div><p>Wait for a lock on an id in this model using a <a class="jsdoc-link" href="#koru/mutex">Mutex</a>. Must be used in a
<a class="jsdoc-link" href="#koru/model/trans-queue">TransQueue</a>. Locks until the transaction is finished.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>usally the id of a DB record.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">transaction</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="k">await</span> <span class="nx">Book</span>.<span class="na">lockId</span>(<span class="s">'bookid123'</span>);
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">Book</span>.<span class="na">isIdLocked</span>(<span class="s">'bookid123'</span>));
  <span class="k">await</span> <span class="nx">Book</span>.<span class="na">lockId</span>(<span class="s">'bookid123'</span>); <span class="cs">// does nothing if called more than once</span>
});
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">Book</span>.<span class="na">isIdLocked</span>(<span class="s">'bookid123'</span>));

<span class="k">await</span> <span class="nx">assert</span>.<span class="na">exception</span>(
  () <span class="o">=&gt;</span> <span class="nx">Book</span>.<span class="na">lockId</span>(<span class="s">'bookid123'</span>),
  {<span class="na">message</span>: <span class="s">'Attempt to lock while not in a transaction'</span>},
);</div></div></pre></div></section><section id="koru/model/base-model.remote" tabindex="-1" name="remote" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.<span class="highlight"><span class="nf">remote</span>(<span class="nv">funcs</span>)</span></h1><abstract><div><p>Define multiple Remote updating Procedure calls prefixed by model's
name.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>funcs</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">remote</span>({
  <span class="nf">read</span>() {},
  <span class="nf">catalog</span>() {},
});

<span class="nx">assert</span>(<span class="nx">session</span>.<span class="na">isRpc</span>(<span class="s">'Book.read'</span>));
<span class="nx">refute</span>(<span class="nx">session</span>.<span class="na">isRpcGet</span>(<span class="s">'Book.read'</span>));

<span class="nx">assert</span>(<span class="nx">session</span>.<span class="na">isRpc</span>(<span class="s">'Book.catalog'</span>));</div></div></pre></div></section><section id="koru/model/base-model.remoteGet" tabindex="-1" name="remoteGet" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel.<span class="highlight"><span class="nf">remoteGet</span>(<span class="nv">funcs</span>)</span></h1><abstract><div><p>Define multiple Remote inquiry Procedure calls prefixed by
model's name.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>funcs</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">remoteGet</span>({
  <span class="nf">list</span>() {},
  <span class="nf">about</span>() {},
});

<span class="nx">assert</span>(<span class="nx">session</span>.<span class="na">isRpc</span>(<span class="s">'Book.list'</span>));
<span class="nx">assert</span>(<span class="nx">session</span>.<span class="na">isRpcGet</span>(<span class="s">'Book.list'</span>));

<span class="nx">assert</span>(<span class="nx">session</span>.<span class="na">isRpcGet</span>(<span class="s">'Book.about'</span>));</div></div></pre></div></section><section id="koru/model/base-model#$$save" tabindex="-1" name="#$$save" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel#<span class="highlight"><span class="nf">$$save</span>()</span></h1><abstract><div><p>Is shorthand for <a class="jsdoc-link" href="#koru/model/base-model#$save">$save("assert")</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">Promise(BaseModel)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({<span class="na">author</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">required</span>: <span class="kc">true</span>}});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();

<span class="k">try</span> {
  <span class="k">await</span> <span class="nx">book</span>.<span class="na">$$save</span>();
  <span class="nx">assert</span>.<span class="na">fail</span>(<span class="s">'expect throw'</span>);
} <span class="k">catch</span> (<span class="nv">err</span>) {
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">err</span>.<span class="na">error</span>, <span class="m">400</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">err</span>.<span class="na">reason</span>, {<span class="na">author</span>: [[<span class="s">'is_required'</span>]]});
}

<span class="nx">book</span>.<span class="na">author</span> <span class="o">=</span> <span class="s">'T &amp; T'</span>;
<span class="k">await</span> <span class="nx">book</span>.<span class="na">$$save</span>();

<span class="nx">assert</span>.<span class="na">same</span>((<span class="k">await</span> <span class="nx">book</span>.<span class="na">$reload</span>(<span class="kc">true</span>)).<span class="na">author</span>, <span class="s">'T &amp; T'</span>);</div></div></pre></div></section><section id="koru/model/base-model#$assertValid" tabindex="-1" name="#$assertValid" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel#<span class="highlight"><span class="nf">$assertValid</span>()</span></h1><abstract><div><p>Validate the document and throw an error if invalid</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">Promise(boolean)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({<span class="na">author</span>: {
  <span class="na">type</span>: <span class="s">'text'</span>,
  async <span class="nf">validate</span>(<span class="nv">field</span>) {
    <span class="k">if</span> (<span class="o">!</span> <span class="k">this</span>[<span class="na">field</span>]) <span class="k">return</span> <span class="s">'is_required'</span>}}});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();

<span class="k">try</span> {
  <span class="k">await</span> <span class="nx">book</span>.<span class="na">$assertValid</span>();
  <span class="nx">assert</span>.<span class="na">fail</span>(<span class="s">'Should not have succeeded'</span>);
} <span class="k">catch</span> (<span class="nv">err</span>) {
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">err</span>.<span class="na">constructor</span>, <span class="nx">koru</span>.<span class="na">Error</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">err</span>.<span class="na">error</span>, <span class="m">400</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">err</span>.<span class="na">reason</span>, {<span class="na">author</span>: [[<span class="s">'is_required'</span>]]});
}

<span class="nx">book</span>.<span class="na">author</span> <span class="o">=</span> <span class="s">'T &amp; T'</span>;
<span class="k">await</span> <span class="nx">book</span>.<span class="na">$assertValid</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>[<span class="na">error$</span>], <span class="kc">undefined</span>);</div></div></pre></div></section><section id="koru/model/base-model#$isValid" tabindex="-1" name="#$isValid" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel#<span class="highlight"><span class="nf">$isValid</span>()</span></h1><abstract><div><p>Check if a document is valid</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">Promise(boolean)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Book</span> <span class="k">extends</span> <span class="nx">BaseModel</span> {}
<span class="nx">Book</span>.<span class="na">define</span>({
  <span class="na">module</span>,
  <span class="na">fields</span>: {
    <span class="na">pages</span>: {<span class="na">type</span>: <span class="s">'number'</span>, async <span class="nf">validate</span>(<span class="nv">field</span>) {
      <span class="k">await</span> <span class="m">1</span>;
      <span class="k">return</span> <span class="s">'is_invalid'</span>;
    }, <span class="na">changesOnly</span>: <span class="kc">true</span>},
  },
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>();
<span class="nx">book</span>.<span class="na">attributes</span>.<span class="na">pages</span> <span class="o">=</span> <span class="o">-</span><span class="m">1</span>;

<span class="cs">// original$ exists</span>
<span class="nx">book</span>[<span class="na">original$</span>] <span class="o">=</span> <span class="kc">undefined</span>;
<span class="nx">refute</span>(<span class="k">await</span> <span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>], {<span class="na">pages</span>: [[<span class="s">'is_invalid'</span>]]});</div></div></pre></div></section><section id="koru/model/base-model#$save" tabindex="-1" name="#$save" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel#<span class="highlight"><span class="nf">$save</span>(<span class="nv">mode</span>)</span></h1><abstract><div><p>Validate the document and persist to server DB. Runs <code>before</code>, <code>after</code> and <a class="jsdoc-link" href="#koru/model/base-model#onChange">onChange</a>
hooks.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[mode]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>If <code>"assert"</code> calls <a class="jsdoc-link" href="#koru/model/base-model#$assertValid">$assertValid</a> otherwise calls <a class="jsdoc-link" href="#koru/model/base-model#$isValid">$isValid</a>. If
<code>"force"</code> will save even if validation fails.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">baseModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseModel</span>();</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// normal (undefined) mode</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({<span class="na">author</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">required</span>: <span class="kc">true</span>}});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="k">await</span> <span class="nx">book</span>.<span class="na">$save</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>], {<span class="na">author</span>: [[<span class="s">'is_required'</span>]]});

<span class="nx">book</span>.<span class="na">author</span> <span class="o">=</span> <span class="s">'T &amp; T'</span>;
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="k">await</span> <span class="nx">book</span>.<span class="na">$save</span>());
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>[<span class="na">error$</span>], <span class="kc">undefined</span>);

<span class="nx">assert</span>.<span class="na">same</span>((<span class="k">await</span> <span class="nx">book</span>.<span class="na">$reload</span>(<span class="kc">true</span>)).<span class="na">author</span>, <span class="s">'T &amp; T'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// "force" mode</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({<span class="na">author</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">required</span>: <span class="kc">true</span>}});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author</span>: <span class="kc">null</span>});

<span class="nx">spy</span>(<span class="nx">book</span>, <span class="s">'$isValid'</span>);

<span class="k">await</span> <span class="nx">book</span>.<span class="na">$save</span>(<span class="s">'force'</span>);

<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">book</span>.<span class="na">$isValid</span>); <span class="cs">// assert validation methods were run</span>

<span class="nx">assert</span>(<span class="k">await</span> <span class="nx">Book</span>.<span class="na">findById</span>(<span class="nx">book</span>.<span class="na">_id</span>));</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// "assert" mode</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({<span class="na">author</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">required</span>: <span class="kc">true</span>}});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();

<span class="k">try</span> {
  <span class="k">await</span> <span class="nx">book</span>.<span class="na">$save</span>(<span class="s">'assert'</span>);
  <span class="nx">assert</span>.<span class="na">fail</span>(<span class="s">'Should not have saved'</span>);
} <span class="k">catch</span> (<span class="nv">err</span>) {
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">err</span>.<span class="na">constructor</span>, <span class="nx">koru</span>.<span class="na">Error</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">err</span>.<span class="na">error</span>, <span class="m">400</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">err</span>.<span class="na">reason</span>, {<span class="na">author</span>: [[<span class="s">'is_required'</span>]]});
}

<span class="nx">book</span>.<span class="na">author</span> <span class="o">=</span> <span class="s">'T &amp; T'</span>;
<span class="k">await</span> <span class="nx">book</span>.<span class="na">$save</span>(<span class="s">'assert'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>[<span class="na">error$</span>], <span class="kc">undefined</span>);

<span class="nx">assert</span>.<span class="na">same</span>((<span class="k">await</span> <span class="nx">book</span>.<span class="na">$reload</span>(<span class="kc">true</span>)).<span class="na">author</span>, <span class="s">'T &amp; T'</span>);</div></div></pre></div></section><section id="koru/model/base-model#$withChanges" tabindex="-1" name="#$withChanges" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">BaseModel#<span class="highlight"><span class="nf">$withChanges</span>(<span class="nv">changes</span><span class="o">=</span><span class="k">this</span>.<span class="na">changes</span>)</span></h1><abstract><div><p>Return a doc representing this doc with the supplied changes staged against it such that
calling <a class="jsdoc-link" href="#koru/model/base-model#$save">$save</a> will apply the changes.</p>
<p>If this method is called again with the same changes object
then a cached version of the before doc is returned.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[changes]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>defaults to <code>this.changes</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">BaseModel</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseModel</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/base-model"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>({
  <span class="na">_id</span>: <span class="s">'123'</span>, <span class="na">pages</span>: {<span class="na">bar</span>: {<span class="na">baz</span>: <span class="s">'new val'</span>, <span class="na">buzz</span>: <span class="m">5</span>}, <span class="na">fnord</span>: {<span class="na">a</span>: <span class="m">1</span>}}});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">$withChanges</span>(<span class="s">'add'</span>), <span class="nx">doc</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">$withChanges</span>(<span class="s">'del'</span>), <span class="kc">null</span>);

<span class="kd">let</span> <span class="nv">undo</span> <span class="o">=</span> {<span class="na">$partial</span>: {
  <span class="na">pages</span>: [
    <span class="s">'bar.baz.$partial'</span>, [<span class="s">'$match'</span>, <span class="s">'new val'</span>, <span class="s">'$patch'</span>, [<span class="m">0</span>, <span class="m">3</span>, <span class="s">'orig'</span>]],
    <span class="s">'bar.buzz'</span>, <span class="m">2</span>,
    <span class="s">'fnord.a'</span>, <span class="m">2</span>],
  <span class="na">author</span>: [<span class="s">'$replace'</span>, <span class="s">'H. G. Wells'</span>],
}};
<span class="kd">let</span> <span class="nv">old</span> <span class="o">=</span> <span class="nx">doc</span>.<span class="na">$withChanges</span>(<span class="nx">undo</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">old</span>.<span class="na">pages</span>.<span class="na">bar</span>.<span class="na">baz</span>, <span class="s">'orig val'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">old</span>.<span class="na">pages</span>.<span class="na">bar</span>.<span class="na">buzz</span>, <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">old</span>.<span class="na">author</span>, <span class="s">'H. G. Wells'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">pages</span>.<span class="na">bar</span>.<span class="na">baz</span>, <span class="s">'new val'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">pages</span>.<span class="na">bar</span>.<span class="na">buzz</span>, <span class="m">5</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">pages</span>.<span class="na">fnord</span>.<span class="na">a</span>, <span class="m">1</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">doc</span>.<span class="na">$withChanges</span>(<span class="nx">undo</span>), <span class="nx">old</span>);

<span class="nx">old</span> <span class="o">=</span> <span class="nx">doc</span>.<span class="na">$withChanges</span>({<span class="na">$partial</span>: {
  <span class="na">pages</span>: [
    <span class="s">'bar.baz'</span>, <span class="kc">null</span>,
    <span class="s">'bar.buzz'</span>, <span class="m">2</span>,
    <span class="s">'fnord.a'</span>, <span class="m">2</span>],
  <span class="na">author</span>: [<span class="s">'$replace'</span>, <span class="kc">null</span>],
}});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">old</span>.<span class="na">pages</span>.<span class="na">bar</span>.<span class="na">baz</span>, <span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">old</span>.<span class="na">pages</span>.<span class="na">bar</span>.<span class="na">buzz</span>, <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">old</span>.<span class="na">author</span>, <span class="kc">undefined</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/db-broker-client" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/db-broker-client">koru/model/db-broker-client</a><h1 class="jsdoc-module-title searchable">dbBroker</h1><abstract><div><p>dbBroker allows for multiple databases and server connections within one browser instance.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/db-broker-client.makeFactory" tabindex="-1" name="makeFactory" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">dbBroker.<span class="highlight"><span class="nf">makeFactory</span>(<span class="nv">DBRunner</span>, ...<span class="nv">args</span>)</span></h1><abstract><div><p>Make a factory that will create runners as needed for the current thread DB. Runners are
useful to keep state information on a per DB basis</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>DBRunner</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">[any-type]</a></td><td class="jsdoc-info"><div><p>arbitrary arguments to pass to the constructor</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">dbBroker</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/db-broker-client"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">defId</span> <span class="o">=</span> <span class="nx">dbBroker</span>.<span class="na">dbId</span>;
<span class="kd">const</span> <span class="no">altId</span> <span class="o">=</span> <span class="s">"alt"</span>;

<span class="k">class</span> <span class="nc">DBRunner</span> <span class="k">extends</span> <span class="nx">dbBroker</span>.<span class="na">DBRunner</span> {
  <span class="k">constructor</span>(<span class="nv">a</span>, <span class="nv">b</span>) {
    <span class="k">super</span>();
    <span class="k">this</span>.<span class="na">a</span> <span class="o">=</span> <span class="nx">a</span>; <span class="k">this</span>.<span class="na">b</span> <span class="o">=</span> <span class="nx">b</span>;
    <span class="k">this</span>.<span class="na">hasStopped</span> <span class="o">=</span> <span class="kc">false</span>;
  }

  <span class="nf">stopped</span>() {<span class="k">this</span>.<span class="na">hasStopped</span> <span class="o">=</span> <span class="kc">true</span>}
}

<span class="kd">const</span> <span class="no">DBS</span> <span class="o">=</span> <span class="nx">dbBroker</span>.<span class="na">makeFactory</span>(<span class="nx">DBRunner</span>, <span class="m">1</span>, <span class="m">2</span>);

<span class="kd">const</span> <span class="no">defRunner</span> <span class="o">=</span> <span class="nx">DBS</span>.<span class="na">current</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">defRunner</span>.<span class="na">a</span>, <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">defRunner</span>.<span class="na">b</span>, <span class="m">2</span>);


<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">defRunner</span>.<span class="na">constructor</span>, <span class="nx">DBRunner</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">defRunner</span>.<span class="na">dbId</span>, <span class="nx">defId</span>);

<span class="nx">dbBroker</span>.<span class="na">dbId</span> <span class="o">=</span> <span class="nx">altId</span>;

<span class="kd">const</span> <span class="no">altRunner</span> <span class="o">=</span> <span class="nx">DBS</span>.<span class="na">current</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">altRunner</span>.<span class="na">dbId</span>, <span class="nx">altId</span>);

<span class="nx">dbBroker</span>.<span class="na">dbId</span> <span class="o">=</span> <span class="nx">defId</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">DBS</span>.<span class="na">current</span>, <span class="nx">defRunner</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Object</span>.<span class="na">keys</span>(<span class="nx">DBS</span>.<span class="na">list</span>).<span class="na">sort</span>(), [<span class="s">'alt'</span>, <span class="s">'default'</span>]);

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">defRunner</span>.<span class="na">hasStopped</span>);

<span class="nx">DBS</span>.<span class="na">stop</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">DBS</span>.<span class="na">list</span>, {});

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">defRunner</span>.<span class="na">hasStopped</span>);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">altRunner</span>.<span class="na">hasStopped</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/db-broker-server" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/db-broker-server">koru/model/db-broker-server</a><h1 class="jsdoc-module-title searchable">dbBroker</h1><abstract><div><p>dbBroker allows for multiple databases to be connected to one nodejs instance</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">db</td><td><a href="#koru/pg/driver::Client">Client</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info" data-env="server"><div><p>The database for the current thread</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/db-broker-server.makeFactory" tabindex="-1" name="makeFactory" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">dbBroker.<span class="highlight"><span class="nf">makeFactory</span>(<span class="nv">DBRunner</span>, ...<span class="nv">args</span>)</span></h1><abstract><div><p>Make a factory that will create runners as needed for the current thread DB. Runners are
useful to keep state information on a per DB basis</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>DBRunner</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">[any-type]</a></td><td class="jsdoc-info"><div><p>arbitrary arguments to pass to the constructor</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">dbBroker</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/db-broker-server"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">DBRunner</span> <span class="k">extends</span> <span class="nx">dbBroker</span>.<span class="na">DBRunner</span> {
  <span class="k">constructor</span>(<span class="nv">a</span>, <span class="nv">b</span>) {
    <span class="k">super</span>();
    <span class="k">this</span>.<span class="na">a</span> <span class="o">=</span> <span class="nx">a</span>; <span class="k">this</span>.<span class="na">b</span> <span class="o">=</span> <span class="nx">b</span>;
    <span class="k">this</span>.<span class="na">hasStopped</span> <span class="o">=</span> <span class="kc">false</span>;
  }

  <span class="nf">stopped</span>() {<span class="k">this</span>.<span class="na">hasStopped</span> <span class="o">=</span> <span class="kc">true</span>}
}

<span class="kd">const</span> <span class="no">DBS</span> <span class="o">=</span> <span class="nx">sut</span>.<span class="na">makeFactory</span>(<span class="nx">DBRunner</span>, <span class="m">1</span>, <span class="m">2</span>);

<span class="kd">const</span> <span class="no">defRunner</span> <span class="o">=</span> <span class="nx">DBS</span>.<span class="na">current</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">defRunner</span>.<span class="na">a</span>, <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">defRunner</span>.<span class="na">b</span>, <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">defRunner</span>.<span class="na">constructor</span>, <span class="nx">DBRunner</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">defRunner</span>.<span class="na">db</span>, <span class="nx">defDb</span>);

<span class="nx">sut</span>.<span class="na">db</span> <span class="o">=</span> <span class="nx">altDb</span>;

<span class="kd">const</span> <span class="no">altRunner</span> <span class="o">=</span> <span class="nx">DBS</span>.<span class="na">current</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">altRunner</span>.<span class="na">db</span>, <span class="nx">altDb</span>);

<span class="nx">sut</span>.<span class="na">db</span> <span class="o">=</span> <span class="nx">defDb</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">DBS</span>.<span class="na">current</span>, <span class="nx">defRunner</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Object</span>.<span class="na">keys</span>(<span class="nx">DBS</span>.<span class="na">list</span>).<span class="na">sort</span>(), [<span class="s">'alt'</span>, <span class="s">'default'</span>]);

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">defRunner</span>.<span class="na">hasStopped</span>);

<span class="nx">DBS</span>.<span class="na">stop</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">DBS</span>.<span class="na">list</span>, {});

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">defRunner</span>.<span class="na">hasStopped</span>);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">altRunner</span>.<span class="na">hasStopped</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/doc-change" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/doc-change">koru/model/doc-change</a><h1 class="jsdoc-module-title searchable">DocChange</h1><abstract><div><p>DocChange encapsulates a change to a <a class="jsdoc-link" href="#koru/model/base-model">BaseModel</a> instance. Used with
<a class="jsdoc-link" href="#koru/model/base-model.onChange">BaseModel.onChange</a> and other observe methods. The main properties are:</p>
<ul>
<li><code>type</code> is either "add", "chg", "del"</li>
<li><code>doc</code> is the document that has changed.</li>
<li><code>undo</code> is: "del" when <code>type</code> is "add", "add" when <code>type</code> is "del". When<code>type</code> is "chg" <code>undo</code> is
a <a href="#koru/changes">change</a> object that will undo the change.</li>
<li><code>flag</code> is only present on client and a truthy value indicates change was not a
simulation. Some truthy values include: "fromServer", "idbLoad", "simComplete" and "stopped"
NOTE: DocChange should be treated immutable and not stored as it is recycled by koru. If you
need to mutate or store the change use <a class="jsdoc-link" href="#koru/model/doc-change#clone">clone</a>.</li>
</ul>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#changes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>Retrieve the changes that were made to <code>doc</code>. See <a class="jsdoc-link" href="#koru/model/base-model#$invertChanges">BaseModel#$invertChanges</a></p>
</div></td></tr><tr><td class="searchable">#isAdd</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>Is this change a <a class="jsdoc-link" href="#koru/model/doc-change.add">add</a></p>
</div></td></tr><tr><td class="searchable">#isChange</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>Is this change from a {#.change</p>
</div></td></tr><tr><td class="searchable">#isDelete</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>Is this change from a <a class="jsdoc-link" href="#koru/model/doc-change.delete">delete</a></p>
</div></td></tr><tr><td class="searchable">#model</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>Retrieve the model of the <code>doc</code>.</p>
</div></td></tr><tr><td class="searchable">#was</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info" data-env="both"><div><p>Retrieve the doc with the <code>undo</code> set as changes.  See <a class="jsdoc-link" href="#koru/model/base-model#$withChanges">BaseModel#$withChanges</a></p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/doc-change.add" tabindex="-1" name="add" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DocChange.<span class="highlight"><span class="nf">add</span>(<span class="nv">doc</span>, <span class="nv">flag</span>)</span></h1><abstract><div><p>Create a model change representing an add.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>flag</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DocChange</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/doc-change"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>({<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">title</span>: <span class="s">'Animal Farm'</span>});

<span class="kd">const</span> <span class="no">change</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">add</span>(<span class="nx">doc</span>, <span class="s">'serverUpdate'</span>);

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">change</span>.<span class="na">isAdd</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">change</span>.<span class="na">isDelete</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">change</span>.<span class="na">isChange</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">change</span>.<span class="na">type</span>, <span class="s">'add'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">change</span>.<span class="na">doc</span>, <span class="nx">doc</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">change</span>.<span class="na">undo</span>, <span class="s">'del'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">change</span>.<span class="na">flag</span>, <span class="s">'serverUpdate'</span>);</div></div></pre></div></section><section id="koru/model/doc-change.change" tabindex="-1" name="change" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DocChange.<span class="highlight"><span class="nf">change</span>(<span class="nv">doc</span>, <span class="nv">undo</span>, <span class="nv">flag</span>)</span></h1><abstract><div><p>Create a model change representing a change.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>undo</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>flag</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DocChange</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/doc-change"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">DocChange</span>.<span class="na">change</span>(<span class="ge nx">Model.Book("book1")</span>, <span class="ge nx">{title: "Fanimal Arm"}</span>, <span class="s">"serverUpdate"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">DocChange.change(Model.Book("book1"), {title: 'Fanimal Arm'}, 'serverUpdate')</span></span></div></pre></div></section><section id="koru/model/doc-change.delete" tabindex="-1" name="delete" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DocChange.<span class="highlight"><span class="nf">delete</span>(<span class="nv">doc</span>, <span class="nv">flag</span>)</span></h1><abstract><div><p>Create a model change representing a delete.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>flag</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DocChange</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/doc-change"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">DocChange</span>.<span class="na">delete</span>(<span class="ge nx">Model.Book("book1")</span>, <span class="s">"simComplete"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">DocChange.delete(Model.Book("book1"), 'simComplete')</span></span></div></pre></div></section><section id="koru/model/doc-change#clone" tabindex="-1" name="#clone" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DocChange#<span class="highlight"><span class="nf">clone</span>()</span></h1><abstract><div><p>Clone the change. This is a shallow copy of the change---doc and undo are assigned; not
copied.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DocChange</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/doc-change"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">change</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">change</span>(
  <span class="k">new</span> <span class="nx">Book</span>({<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">title</span>: <span class="s">'Animal Farm'</span>}), {<span class="na">title</span>: <span class="s">'Fanimal Arm'</span>});
<span class="kd">const</span> <span class="no">copy</span> <span class="o">=</span> <span class="nx">change</span>.<span class="na">clone</span>();
<span class="nx">refute</span>.<span class="na">same</span>(<span class="nx">copy</span>, <span class="nx">change</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">copy</span>.<span class="na">doc</span>, <span class="nx">change</span>.<span class="na">doc</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">copy</span>.<span class="na">undo</span>, <span class="nx">change</span>.<span class="na">undo</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">copy</span>.<span class="na">was</span>, <span class="nx">change</span>.<span class="na">was</span>); <span class="cs">// was is cached</span></div></div></pre></div></section><section id="koru/model/doc-change#hasField" tabindex="-1" name="#hasField" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DocChange#<span class="highlight"><span class="nf">hasField</span>(<span class="nv">field</span>)</span></h1><abstract><div><p>Test if a field has been changed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DocChange</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/doc-change"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">dc</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">change</span>(
  <span class="k">new</span> <span class="nx">Book</span>({<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">title</span>: <span class="s">'Animal Farm'</span>, <span class="na">pages</span>: <span class="m">112</span>}), {<span class="na">title</span>: <span class="s">'Fanimal Arm'</span>});
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">dc</span>.<span class="na">hasField</span>(<span class="s">'title'</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">dc</span>.<span class="na">hasField</span>(<span class="s">'pages'</span>));

<span class="cs">// does not need to be a Model document</span>
<span class="kd">const</span> <span class="no">add</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">add</span>({<span class="na">name</span>: <span class="s">'Simon'</span>});
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">add</span>.<span class="na">hasField</span>(<span class="s">'name'</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">add</span>.<span class="na">hasField</span>(<span class="s">'location'</span>));

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">DocChange</span>.<span class="na">delete</span>({<span class="na">name</span>: <span class="s">'Simon'</span>}).<span class="na">hasField</span>(<span class="s">'name'</span>));

<span class="kd">const</span> <span class="no">change</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">change</span>({<span class="na">name</span>: <span class="s">'Simon'</span>, <span class="na">location</span>: <span class="s">'home'</span>}, {<span class="na">location</span>: <span class="s">'work'</span>});
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">change</span>.<span class="na">hasField</span>(<span class="s">'name'</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">change</span>.<span class="na">hasField</span>(<span class="s">'location'</span>));</div></div></pre></div></section><section id="koru/model/doc-change#hasSomeFields" tabindex="-1" name="#hasSomeFields" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DocChange#<span class="highlight"><span class="nf">hasSomeFields</span>(...<span class="nv">fields</span>)</span></h1><abstract><div><p>Test if any of the <code>fields</code> have been changed</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>fields</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DocChange</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/doc-change"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">dc</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">change</span>(
  <span class="k">new</span> <span class="nx">Book</span>({
    <span class="na">_id</span>: <span class="s">'book1'</span>,
    <span class="na">title</span>: <span class="s">'Animal Farm'</span>,
    <span class="na">Author</span>: <span class="s">'George Orwell'</span>,
    <span class="na">pages</span>: <span class="m">112</span>,
  }), {<span class="na">title</span>: <span class="s">'Fanimal Arm'</span>, <span class="na">pages</span>: <span class="m">432</span>});
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">dc</span>.<span class="na">hasSomeFields</span>(<span class="s">'author'</span>, <span class="s">'title'</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">dc</span>.<span class="na">hasSomeFields</span>(<span class="s">'pages'</span>, <span class="s">'title'</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">dc</span>.<span class="na">hasSomeFields</span>(<span class="s">'author'</span>, <span class="s">'pages'</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">dc</span>.<span class="na">hasSomeFields</span>(<span class="s">'author'</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">dc</span>.<span class="na">hasSomeFields</span>(<span class="s">'author'</span>, <span class="s">'index'</span>));</div></div></pre></div></section><section id="koru/model/doc-change#subDocKeys" tabindex="-1" name="#subDocKeys" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DocChange#<span class="highlight"><span class="nf">*subDocKeys</span>(<span class="nv">field</span>)</span></h1><abstract><div><p>Create a iterator over the property names for each property that is different between two
objects.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DocChange</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/doc-change"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>({<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">title</span>: <span class="s">'Animal Farm'</span>, <span class="na">index</span>: {
  <span class="na">d</span>: {<span class="na">dog</span>: [<span class="m">123</span>, <span class="m">234</span>], <span class="na">donkey</span>: [<span class="m">56</span>, <span class="m">456</span>]},
  <span class="na">p</span>: {<span class="na">pig</span>: [<span class="m">3</span>, <span class="m">34</span>]},
}});

<span class="kd">const</span> <span class="no">undo</span> <span class="o">=</span> <span class="nx">Changes</span>.<span class="na">applyAll</span>(<span class="nx">book</span>.<span class="na">attributes</span>, {<span class="na">index</span>: {
  <span class="na">d</span>: {<span class="na">dog</span>: [<span class="m">123</span>, <span class="m">234</span>]},
  <span class="na">h</span>: {<span class="na">horse</span>: [<span class="m">23</span>, <span class="m">344</span>]},
  <span class="na">p</span>: {<span class="na">pig</span>: [<span class="m">3</span>, <span class="m">34</span>]},
}});

<span class="nx">change</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">book</span>, <span class="nx">undo</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">change</span>.<span class="na">subDocKeys</span>(<span class="s">'index'</span>)).<span class="na">sort</span>(), [<span class="s">'d'</span>, <span class="s">'h'</span>]);</div></div></pre></div></section><section id="koru/model/doc-change#subDocs" tabindex="-1" name="#subDocs" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">DocChange#<span class="highlight"><span class="nf">*subDocs</span>(<span class="nv">field</span>, <span class="nv">flag</span>)</span></h1><abstract><div><p>Create a iterator over the <code>DocChange</code>s for each property that is different between two
objects</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[flag]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">DocChange</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/doc-change"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>({<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">title</span>: <span class="s">'Animal Farm'</span>, <span class="na">index</span>: {
  <span class="na">d</span>: {<span class="na">dog</span>: [<span class="m">123</span>, <span class="m">234</span>], <span class="na">donkey</span>: [<span class="m">56</span>, <span class="m">456</span>]},
  <span class="na">p</span>: {<span class="na">pig</span>: [<span class="m">3</span>, <span class="m">34</span>]},
}});
<span class="kd">const</span> <span class="no">undo</span> <span class="o">=</span> <span class="nx">Changes</span>.<span class="na">applyAll</span>(<span class="nx">book</span>.<span class="na">attributes</span>, {<span class="na">index</span>: {
  <span class="na">d</span>: {<span class="na">dog</span>: [<span class="m">123</span>, <span class="m">234</span>], <span class="na">deer</span>: [<span class="m">34</span>]},
  <span class="na">h</span>: {<span class="na">horse</span>: [<span class="m">23</span>, <span class="m">344</span>]},
  <span class="na">p</span>: {<span class="na">pig</span>: [<span class="m">3</span>, <span class="m">34</span>]},
}});

<span class="nx">change</span> <span class="o">=</span> <span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">book</span>, <span class="nx">undo</span>);

<span class="kd">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="m">0</span>;
<span class="k">for</span> (<span class="kd">const</span> <span class="no">dc</span> <span class="k">of</span> <span class="nx">change</span>.<span class="na">subDocs</span>(<span class="s">'index'</span>)) {
  <span class="k">if</span> (<span class="nx">dc</span>.<span class="na">_id</span> <span class="o">===</span> <span class="s">'d'</span>) {
    <span class="o">++</span><span class="nx">count</span>;
    <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">dc</span>.<span class="na">isChange</span>);
    <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">dc</span>.<span class="na">doc</span>, <span class="nx">book</span>.<span class="na">index</span>.<span class="na">d</span>);
    <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">dc</span>.<span class="na">undo</span>, {<span class="na">$partial</span>: {
      <span class="na">deer</span>: <span class="kc">null</span>,
      <span class="na">donkey</span>: [<span class="s">'$replace'</span>, [<span class="m">56</span>, <span class="m">456</span>]],
    }});
  } <span class="k">else</span> {
    <span class="o">++</span><span class="nx">count</span>;
    <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">dc</span>.<span class="na">_id</span>, <span class="s">'h'</span>);
    <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">dc</span>.<span class="na">isAdd</span>);
    <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">dc</span>.<span class="na">doc</span>, <span class="nx">book</span>.<span class="na">index</span>.<span class="na">h</span>);
  }
}
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">count</span>, <span class="m">2</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/main-client" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/main-client">koru/model/main-client</a><h1 class="jsdoc-module-title searchable">Model</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div></div></div></section><section id="koru/model/mq-factory" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/mq-factory">koru/model/mq-factory</a><h1 class="jsdoc-module-title searchable">MQFactory</h1><abstract><div><p>Manage durable Message queues.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/mq-factory#getQueue" tabindex="-1" name="#getQueue" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">MQFactory#<span class="highlight"><span class="nf">getQueue</span>(<span class="nv">name</span>)</span></h1><abstract><div><p>Get a message queue for current database</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the queue</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/mq-factory::MQ">MQ</a></td><td class="jsdoc-info"><div><p>the message queue</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MQFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/mq-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">mqFactory</span>.<span class="na">registerQueue</span>({<span class="na">module</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">action</span>: <span class="nx">stub</span>()});

<span class="kd">const</span> <span class="no">queue</span> <span class="o">=</span> <span class="nx">mqFactory</span>.<span class="na">getQueue</span>(<span class="s">'foo'</span>);
<span class="nx">assert</span>(<span class="nx">queue</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">mqFactory</span>.<span class="na">getQueue</span>(<span class="s">'foo'</span>), <span class="nx">queue</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">mqFactory</span>.<span class="na">getQueue</span>(<span class="s">'bar'</span>), <span class="kc">undefined</span>);

<span class="nx">dbBroker</span>.<span class="na">db</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">altDb</span>;

<span class="kd">const</span> <span class="no">altQ</span> <span class="o">=</span> <span class="nx">mqFactory</span>.<span class="na">getQueue</span>(<span class="s">'foo'</span>);
<span class="nx">refute</span>.<span class="na">same</span>(<span class="nx">altQ</span>, <span class="nx">queue</span>);

<span class="nx">dbBroker</span>.<span class="na">db</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">defDb</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">mqFactory</span>.<span class="na">getQueue</span>(<span class="s">'foo'</span>), <span class="nx">queue</span>);</div></div></pre></div></section><section id="koru/model/mq-factory#registerQueue" tabindex="-1" name="#registerQueue" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">MQFactory#<span class="highlight"><span class="nf">registerQueue</span>({<span class="nv">module</span>, <span class="nv">name</span>, <span class="nv">action</span>, <span class="nv">retryInterval</span>, <span class="nv">local</span><span class="o">=</span><span class="kc">false</span>})</span></h1><abstract><div><p>Register an action with a queue</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[module]</td><td><a href="#Module">Module</a></td><td class="jsdoc-info"><div><p>unregister if module is unloaded. Not available if local is true</p>
</div></td></tr><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the queue</p>
</div></td></tr><tr class="jsdoc-arg"><td>action</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the action to run when a queued message is ready</p>
</div></td></tr><tr class="jsdoc-arg"><td>[retryInterval]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>number of ms to wait before retrying a failed action.
       Defaults to 60000. A value of -1 means don't retry</p>
</div></td></tr><tr class="jsdoc-arg"><td>[local]</td><td></td><td class="jsdoc-info"><div><p>defaults to false. If true register queue just the current database;
otherwise register the queue for all current and future databases.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MQFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/mq-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">mqFactory</span>.<span class="na">registerQueue</span>({<span class="na">name</span>: <span class="s">'foo'</span>, <span class="nf">action</span>(<span class="nv">msg</span>) {<span class="nx">doSomethingWith</span>(<span class="nx">msg</span>)}});
<span class="nx">mqFactory</span>.<span class="na">registerQueue</span>({
  <span class="na">module</span>, <span class="na">name</span>: <span class="s">'bar'</span>, <span class="na">retryInterval</span>: <span class="o">-</span><span class="m">1</span>, <span class="nf">action</span>(<span class="nv">msg</span>) {<span class="nx">doSomethingWith</span>(<span class="nx">msg</span>)}});</div></div></pre></div></section><section id="koru/model/mq-factory#start" tabindex="-1" name="#start" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">MQFactory#async start()</h1><abstract><div><p>Start timers on all queues within current database with existing messages</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MQFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/mq-factory"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">mQFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MQFactory</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">mQFactory</span>.<span class="na">start</span>();</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">undefined</span></span></div></pre></div></section></div></div></div></section><section id="koru/model/mq-factory::MQ" data-env="server" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/mq-factory::MQ">koru/model/mq-factory::MQ</a><h1 class="jsdoc-module-title searchable">MQ</h1><abstract><div><p>The class for queue instances.</p>
<p>See <a class="jsdoc-link" href="#koru/model/mq-factory#getQueue">MQFactory#getQueue</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/mq-factory::MQ#add" tabindex="-1" name="#add" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">MQ#async add({dueAt=util.newDate(), message})</h1><abstract><div><p>Add a message to the queue. The message is persisted.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dueAt</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>message</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the message to action</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MQFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/mq-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">queue</span>.<span class="na">add</span>({<span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">30</span>), <span class="na">message</span>: {<span class="na">my</span>: <span class="s">'message'</span>}});
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">koru</span>.<span class="na">setTimeout</span>, <span class="nx">m</span>.<span class="na">func</span>, <span class="m">30</span>);
<span class="k">await</span> <span class="nx">queue</span>.<span class="na">add</span>({<span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">10</span>), <span class="na">message</span>: {<span class="na">another</span>: <span class="s">'message'</span>}});
<span class="nx">assert</span>.<span class="na">calledOnceWith</span>(<span class="nx">koru</span>.<span class="na">clearTimeout</span>, <span class="m">121</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">koru</span>.<span class="na">setTimeout</span>, <span class="nx">m</span>.<span class="na">func</span>, <span class="m">10</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">v</span>.<span class="na">defDb</span>.<span class="na">query</span>(<span class="s">'select * from "_test_MQ" order by "dueAt"'</span>), [{
  <span class="na">_id</span>: <span class="m">2</span>,
  <span class="na">name</span>: <span class="s">'foo'</span>,
  <span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">10</span>),
  <span class="na">message</span>: {<span class="na">another</span>: <span class="s">'message'</span>},
}, {
  <span class="na">_id</span>: <span class="m">1</span>,
  <span class="na">name</span>: <span class="s">'foo'</span>,
  <span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">30</span>),
  <span class="na">message</span>: {<span class="na">my</span>: <span class="s">'message'</span>},
}]);</div></div></pre></div></section><section id="koru/model/mq-factory::MQ#peek" tabindex="-1" name="#peek" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">MQ#async peek(maxResults=1, dueBefore)</h1><abstract><div><p>Look at messages at the front of the queue without removing them</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[maxResults]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the maximum number of messages to return. Defaults to 1.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[dueBefore]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Promise(Array)</a></td><td class="jsdoc-info"><div><p>an array of messages in queue order</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MQFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/mq-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">queue</span>.<span class="na">add</span>({<span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">30</span>), <span class="na">message</span>: {<span class="na">my</span>: <span class="s">'message'</span>}});
<span class="k">await</span> <span class="nx">queue</span>.<span class="na">add</span>({<span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">10</span>), <span class="na">message</span>: {<span class="na">another</span>: <span class="s">'message'</span>}});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">queue</span>.<span class="na">peek</span>(), [{
  <span class="na">_id</span>: <span class="m">2</span>,
  <span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">10</span>),
  <span class="na">message</span>: {<span class="na">another</span>: <span class="s">'message'</span>},
}]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">queue</span>.<span class="na">peek</span>(<span class="m">3</span>), [{
  <span class="na">_id</span>: <span class="m">2</span>,
  <span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">10</span>),
  <span class="na">message</span>: {<span class="na">another</span>: <span class="s">'message'</span>},
}, {
  <span class="na">_id</span>: <span class="m">1</span>,
  <span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">30</span>),
  <span class="na">message</span>: {<span class="na">my</span>: <span class="s">'message'</span>},
}]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">queue</span>.<span class="na">peek</span>(<span class="m">5</span>, <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">10</span>)), [{
  <span class="na">_id</span>: <span class="m">2</span>,
  <span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">10</span>),
  <span class="na">message</span>: {<span class="na">another</span>: <span class="s">'message'</span>},
}]);</div></div></pre></div></section><section id="koru/model/mq-factory::MQ#remove" tabindex="-1" name="#remove" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">MQ#async remove(_id)</h1><abstract><div><p>Remove a message.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>_id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the id of the message to remove.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">Promise(number)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MQFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/mq-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">queue</span>.<span class="na">add</span>({<span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">10</span>), <span class="na">message</span>: {<span class="na">my</span>: <span class="s">'message'</span>}});
<span class="k">await</span> <span class="nx">queue</span>.<span class="na">add</span>({<span class="na">dueAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span> <span class="m">20</span>), <span class="na">message</span>: {<span class="na">another</span>: <span class="s">'message'</span>}});

<span class="k">await</span> <span class="nx">queue</span>.<span class="na">remove</span>(<span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">queue</span>.<span class="na">peek</span>(<span class="m">5</span>), [<span class="nx">m</span>.<span class="na">field</span>(<span class="s">'_id'</span>, <span class="m">1</span>)]);</div></div></pre></div></section><section id="koru/model/mq-factory::MQ#sendNow" tabindex="-1" name="#sendNow" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">MQ#async sendNow()</h1><abstract><div><p>Skip any retry interval and send the message now if dueAt has passed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MQFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/mq-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">queue</span> <span class="o">=</span> <span class="nx">mqFactory</span>.<span class="na">getQueue</span>(<span class="s">'foo'</span>);
<span class="nx">v</span>.<span class="na">action</span> <span class="o">=</span> <span class="k">async</span> (<span class="nv">args</span>) <span class="o">=&gt;</span> {
  <span class="k">throw</span> {<span class="na">retryAfter</span>: <span class="m">12345</span>};
};

<span class="k">await</span> <span class="nx">queue</span>.<span class="na">add</span>({<span class="na">message</span>: [<span class="m">1</span>, <span class="m">2</span>]});
<span class="k">await</span> <span class="nx">koru</span>.<span class="na">setTimeout</span>.<span class="na">yieldAndReset</span>();
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">koru</span>.<span class="na">setTimeout</span>, <span class="nx">m</span>.<span class="na">func</span>, <span class="m">12345</span>);

<span class="nx">koru</span>.<span class="na">setTimeout</span>.<span class="na">reset</span>();
<span class="k">await</span> <span class="nx">queue</span>.<span class="na">sendNow</span>();
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">koru</span>.<span class="na">setTimeout</span>, <span class="nx">m</span>.<span class="na">func</span>, <span class="m">0</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/ps-sql" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/ps-sql">koru/model/ps-sql</a><h1 class="jsdoc-module-title searchable">PsSql</h1><abstract><div><p>A Prepared query that is automatticaly named for reused on DB connections.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/ps-sql.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">queryStr</span>, <span class="nv">model</span>)</span></h1><abstract><div><p>Create a prepared query.</p>
<p>Note: The query is lazily prepared including parsing the string and deriving parameter types.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>queryStr</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The sql query string, with symbolic parameters, to prepare</p>
</div></td></tr><tr class="jsdoc-arg"><td>model</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div><p>models used to resolve symbolic parameter types</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PsSql</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/ps-sql"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">bigBooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PsSql</span>(<span class="s">`SELECT sum("pageCount") FROM "Book" WHERE "pageCount" &gt; {$pageCount}`</span>, <span class="nx">Book</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">bigBooks</span>.<span class="na">fetchOne</span>({<span class="na">pageCount</span>: <span class="m">300</span>}), {<span class="na">sum</span>: <span class="m">1214</span>});</div></div></pre></div></section><section id="koru/model/ps-sql#execute" tabindex="-1" name="#execute" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">PsSql#<span class="highlight"><span class="nf">execute</span>(<span class="nv">params</span>)</span></h1><abstract><div><p>execute statement returning the tag count and closing the portal.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">Promise(number)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PsSql</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/ps-sql"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">byAuthor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PsSql</span>(<span class="s">`UPDATE "Book" set "pageCount" = -1 WHERE "author" = {$author}`</span>, <span class="nx">Book</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">byAuthor</span>.<span class="na">execute</span>({<span class="na">author</span>: <span class="s">'Dima Zales'</span>}), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="k">new</span> <span class="nx">PsSql</span>(<span class="s">`SELECT count(1) FROM "Book" WHERE "pageCount" = -1`</span>, <span class="nx">Book</span>).<span class="na">value</span>(), <span class="m">2</span>);</div></div></pre></div></section><section id="koru/model/ps-sql#fetch" tabindex="-1" name="#fetch" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">PsSql#<span class="highlight"><span class="nf">fetch</span>(<span class="nv">params</span>)</span></h1><abstract><div><p>Fetch zero or more rows from the query and close the portal.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Promise(Array)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PsSql</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/ps-sql"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">byAuthor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PsSql</span>(<span class="s">`SELECT title FROM "Book" WHERE "author" = {$author} order by "pageCount"`</span>, <span class="nx">Book</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">byAuthor</span>.<span class="na">fetch</span>({<span class="na">author</span>: <span class="s">'Dima Zales'</span>}), [{<span class="na">title</span>: <span class="s">'Limbo'</span>}, {<span class="na">title</span>: <span class="s">'Oasis'</span>}]);</div></div></pre></div></section><section id="koru/model/ps-sql#fetchOne" tabindex="-1" name="#fetchOne" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">PsSql#<span class="highlight"><span class="nf">fetchOne</span>(<span class="nv">params</span>)</span></h1><abstract><div><p>Fetch one or zero rows from the query and close the portal.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">Promise(object)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PsSql</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/ps-sql"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">byAuthor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PsSql</span>(<span class="s">`SELECT title FROM "Book" WHERE "author" = {$author} order by "pageCount"`</span>, <span class="nx">Book</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">byAuthor</span>.<span class="na">fetchOne</span>({<span class="na">author</span>: <span class="s">'Dima Zales'</span>}), {<span class="na">title</span>: <span class="s">'Limbo'</span>});</div></div></pre></div></section><section id="koru/model/ps-sql#value" tabindex="-1" name="#value" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">PsSql#async value(params, defValue)</h1><abstract><div><p>Convience wrapper around <a class="jsdoc-link" href="#koru/model/ps-sql#fetchOne">fetchOne</a> which returns one value from the row if found else the default value</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[defValue]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">Promise(number)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">Promise(string)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PsSql</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/ps-sql"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">countByAuthor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PsSql</span>(<span class="s">`SELECT count(1) FROM "Book" WHERE "author" = {$author}`</span>, <span class="nx">Book</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">countByAuthor</span>.<span class="na">value</span>({<span class="na">author</span>: <span class="s">'Dima Zales'</span>}), <span class="m">2</span>);

<span class="kd">const</span> <span class="no">bigBooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PsSql</span>(
  <span class="s">`SELECT title FROM "Book" WHERE "pageCount" &gt; {$pageCount} ORDER BY "pageCount" DESC`</span>, <span class="nx">Book</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">bigBooks</span>.<span class="na">value</span>({<span class="na">pageCount</span>: <span class="m">3000</span>}, <span class="s">'No book is that big'</span>), <span class="s">'No book is that big'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">bigBooks</span>.<span class="na">value</span>({<span class="na">pageCount</span>: <span class="m">300</span>}, <span class="s">'No book is that big'</span>), <span class="s">'The Eye of the World'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/query" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/query">koru/model/query</a><h1 class="jsdoc-module-title searchable">Query</h1><abstract><div><p>Database CRUD API.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/query.notify" tabindex="-1" name="notify" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Query.<span class="highlight"><span class="nf">notify</span>(<span class="nv">docChange</span>)</span></h1><abstract><div><p>Notify observers of an update to a database record. This is
called automatically but it is exposed here incase it needs
to be called manually.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>docChange</td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Query</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Query</span>.<span class="na">notify</span>(<span class="ge nx">DocChange.change(Model.TestModel("foo123", "foo"), {age: 1}, 'stopped')</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">Query</span>.<span class="na">notify</span>(<span class="ge nx">DocChange.delete(Model.TestModel("foo123", "foo"), undefined)</span>);</div><div></div></div></pre></div></section><section id="koru/model/query.onAnyChange" tabindex="-1" name="onAnyChange" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Query.<span class="highlight"><span class="nf">onAnyChange</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Observe any change to any model.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>is called a <a class="jsdoc-link" href="#koru/model/doc-change">DocChange</a> instance.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>contains a stop method to stop observering</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Query</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Query</span>.<span class="na">onAnyChange</span>(<span class="ge nx">EMPTY_FUNC</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{callback: function stub(){}, stop: function (){}}</span></span></div></pre></div></section><section id="koru/model/query#exists" tabindex="-1" name="#exists" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Query#<span class="highlight"><span class="nf">exists</span>()</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">Promise(boolean)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Query</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="k">new</span> <span class="nx">Query</span>(<span class="nx">TestModel</span>).<span class="na">exists</span>(), <span class="kc">true</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="k">new</span> <span class="nx">Query</span>(<span class="nx">TestModel</span>).<span class="na">where</span>({<span class="na">_id</span>: <span class="s">'notfound'</span>}).<span class="na">exists</span>(), <span class="kc">false</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="k">new</span> <span class="nx">Query</span>(<span class="nx">TestModel</span>).<span class="na">exists</span>({<span class="na">_id</span>: <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_id</span>}), <span class="kc">true</span>);</div></div></pre></div></section><section id="koru/model/query#notExists" tabindex="-1" name="#notExists" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Query#<span class="highlight"><span class="nf">notExists</span>()</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">Promise(boolean)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Query</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="k">new</span> <span class="nx">Query</span>(<span class="nx">TestModel</span>).<span class="na">notExists</span>(), <span class="kc">false</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="k">new</span> <span class="nx">Query</span>(<span class="nx">TestModel</span>).<span class="na">where</span>({<span class="na">_id</span>: <span class="s">'notfound'</span>}).<span class="na">notExists</span>(), <span class="kc">true</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="k">new</span> <span class="nx">Query</span>(<span class="nx">TestModel</span>).<span class="na">notExists</span>({<span class="na">_id</span>: <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_id</span>}), <span class="kc">false</span>);</div></div></pre></div></section><section id="koru/model/query#onChange" tabindex="-1" name="#onChange" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Query#<span class="highlight"><span class="nf">onChange</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Observe changes to documents matching query.</p>
<p>See <a class="jsdoc-link" href="#koru/observable#add">Observable#add</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called with one argument <a class="jsdoc-link" href="#koru/model/doc-change">DocChange</a> detailing the change.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Query</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">query</span> <span class="o">=</span> <span class="nx">TestModel</span>.<span class="na">query</span>.<span class="na">where</span>((<span class="nv">doc</span>) <span class="o">=&gt;</span> <span class="nx">doc</span>.<span class="na">name</span>.<span class="na">startsWith</span>(<span class="s">'F'</span>));
<span class="kd">let</span> <span class="nv">ocdone</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="kd">const</span> <span class="no">oc</span> <span class="o">=</span> <span class="nx">stub</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="k">await</span> <span class="m">1</span>;
  <span class="nx">ocdone</span> <span class="o">=</span> <span class="kc">true</span>;
});
<span class="kd">const</span> <span class="no">handle</span> <span class="o">=</span> <span class="nx">query</span>.<span class="na">onChange</span>(<span class="nx">oc</span>);

<span class="kd">const</span> <span class="no">fred</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">TestModel</span>.<span class="na">create</span>({<span class="na">name</span>: <span class="s">'Fred'</span>});

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">oc</span>, <span class="nx">DocChange</span>.<span class="na">add</span>(<span class="nx">fred</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">ocdone</span>);
<span class="nx">oc</span>.<span class="na">reset</span>();
<span class="nx">ocdone</span> <span class="o">=</span> <span class="kc">false</span>;

<span class="kd">const</span> <span class="no">emma</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">TestModel</span>.<span class="na">create</span>({<span class="na">name</span>: <span class="s">'Emma'</span>});
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">oc</span>);

<span class="k">await</span> <span class="nx">emma</span>.<span class="na">$update</span>(<span class="s">'name'</span>, <span class="s">'Fiona'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">oc</span>, <span class="nx">DocChange</span>.<span class="na">add</span>(<span class="nx">emma</span>.<span class="na">$reload</span>()));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">ocdone</span>);
<span class="k">await</span> <span class="nx">emma</span>.<span class="na">$update</span>(<span class="s">'name'</span>, <span class="s">'Fi'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">oc</span>, <span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">emma</span>.<span class="na">$reload</span>(), {<span class="na">name</span>: <span class="s">'Fiona'</span>}));

<span class="k">await</span> <span class="nx">fred</span>.<span class="na">$update</span>(<span class="s">'name'</span>, <span class="s">'Eric'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">oc</span>, <span class="nx">DocChange</span>.<span class="na">delete</span>(<span class="nx">fred</span>.<span class="na">$reload</span>()));

<span class="cm">/** stop cancels observer **/</span>
<span class="nx">handle</span>.<span class="na">stop</span>();

<span class="nx">oc</span>.<span class="na">reset</span>();
<span class="k">await</span> <span class="nx">fred</span>.<span class="na">$update</span>(<span class="s">'name'</span>, <span class="s">'Freddy'</span>);

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">oc</span>);</div></div></pre></div></section><section id="koru/model/query#where" tabindex="-1" name="#where" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Query#<span class="highlight"><span class="nf">where</span>(<span class="nv">params</span>, <span class="nv">value</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[value]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/query">Query</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Query</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Query</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="s">"age"</span>, <span class="ge nx">{$ne: 5}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="s">"age"</span>, <span class="ge nx">{$nin: [5, 6]}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="ge nx">{age: {$ne: 5}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="s">"age"</span>, <span class="ge nx">{$in: [10, 5]}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="s">"age"</span>, <span class="ge nx">{$in: [5, 6]}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="s">"age"</span>, <span class="ge nx">[5, 6]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="s">"name"</span>, <span class="ge nx">{$regex: "fo+$"}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="s">"name"</span>, <span class="ge nx">{$regex: "FO", $options: "i"}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">where</span>(<span class="s">"name"</span>, <span class="ge nx">{$regex: /R$/i}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div></pre></div></section><section id="koru/model/query#whereNot" tabindex="-1" name="#whereNot" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Query#<span class="highlight"><span class="nf">whereNot</span>(<span class="nv">params</span>, <span class="nv">value</span>)</span></h1><abstract><div><p>Add one or more where-nots to the query.  If any where-not
test matches then the query does not match record</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>field or directive to match
on. If is object then whereNot is called for each key.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[value]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Glossary/Primitive" target="_blank">primitive</a></td><td class="jsdoc-info"><div><p>corresponding to <code>params</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/query">Query</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Query</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Query</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">whereNot</span>(<span class="ge nx">{age: 5}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">whereNot</span>(<span class="s">"age"</span>, <span class="ge nx">[5, 7]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">whereNot</span>(<span class="s">"age"</span>, <span class="ge nx">[5, 10]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">query</span>.<span class="na">whereNot</span>(<span class="s">"name"</span>, <span class="s">"foo"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Query(TestModel)</span></span></div></pre></div></section><section id="koru/model/query#whereSql" tabindex="-1" name="#whereSql" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Query#<span class="highlight"><span class="nf">whereSql</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Add a where condition to the query which is written in sql.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td></td><td class="jsdoc-info"><div><p>Four formats are supported:</p>
<ol>
<li><code>whereSql(queryString, params)</code> queryString is a sql where-clause where <code>$n</code> parameters
corresponds to the nth-1 position in params.</li>
<li><code>whereSql(queryString, properties)</code> queryString is a sql where-clause where <code>{$varName}</code>
expressions within the string get converted to parameters corresponding the the
<code>properties</code>.</li>
<li><code>whereSql(sqlStatement, properties)</code> sqlStatment is a pre-compiled
<a class="jsdoc-link" href="#koru/pg/sql-statement">SQLStatement</a> and properties are referenced in the statement.</li>
<li>`` whereSql<code>queryTemplate</code> queryTemplate a sql where-clause where <code>${varName}</code>
expressions within the template get converted to parameters.</li>
</ol>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Query</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>((<span class="k">await</span> <span class="nx">TestModel</span>.<span class="na">query</span>.<span class="na">whereSql</span>(
  <span class="s">`name = $1 and age &gt; $2`</span>, [<span class="s">'foo2'</span>, <span class="m">3</span>]).<span class="na">fetchOne</span>()).<span class="na">name</span>, <span class="s">'foo2'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>((<span class="k">await</span> <span class="nx">TestModel</span>.<span class="na">query</span>.<span class="na">whereSql</span>(
  <span class="s">`name = {$name} and age &gt; {$age}`</span>, {<span class="na">name</span>: <span class="s">'foo2'</span>, <span class="na">age</span>: <span class="m">3</span>}).<span class="na">fetchOne</span>()).<span class="na">name</span>, <span class="s">'foo2'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLStatement</span>(<span class="s">`name = {$name} and age &gt; {$age}`</span>);
<span class="nx">assert</span>.<span class="na">same</span>((<span class="k">await</span> <span class="nx">TestModel</span>.<span class="na">query</span>.<span class="na">whereSql</span>(
  <span class="nx">statement</span>, {<span class="na">name</span>: <span class="s">'foo2'</span>, <span class="na">age</span>: <span class="m">3</span>}).<span class="na">fetchOne</span>()).<span class="na">name</span>, <span class="s">'foo2'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">name</span> <span class="o">=</span> <span class="s">'foo2'</span>;
<span class="nx">assert</span>.<span class="na">same</span>((<span class="k">await</span> <span class="nx">TestModel</span>.<span class="na">query</span>.<span class="na">whereSql</span><span class="s">`name = ${</span><span class="nx">name</span><span class="s">} and age &gt; ${</span><span class="m">3</span><span class="s">}`</span>.<span class="na">fetchOne</span>()).<span class="na">name</span>, <span class="s">'foo2'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/query-idb" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/query-idb">koru/model/query-idb</a><h1 class="jsdoc-module-title searchable">QueryIDB</h1><abstract><div><p>Support client side persistence using indexedDB</p>
<p>For testing one can use <a class="jsdoc-link" href="#koru/model/mockIndexedDB">mockIndexedDB</a> in replacement of <code>indexedDB</code></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#isIdle</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="client"><div><p>true if db has completed initializing and is not closed and has no outstanding updates,
otherwise false</p>
</div></td></tr><tr><td class="searchable">#isReady</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="client"><div><p>true if db has completed initializing and is not closed, otherwise false</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/query-idb.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>({<span class="nv">name</span>, <span class="nv">version</span>, <span class="nv">upgrade</span>, <span class="nv">catchAll</span>})</span></h1><abstract><div><p>Open a indexedDB database</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the database</p>
</div></td></tr><tr class="jsdoc-arg"><td>[version]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>expected version of database</p>
</div></td></tr><tr class="jsdoc-arg"><td>[upgrade]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p><code>function({db, oldVersion})</code>
where <code>db</code> is the <code>QueryIDB</code> instance and <code>oldVersion</code> is the
current version of the database</p>
</div></td></tr><tr class="jsdoc-arg"><td>[catchAll]</td><td></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div><div class="highlight"><span class="k">new</span> <span class="nx">QueryIDB</span>({<span class="na">name</span>: <span class="s">"foo"</span>, <span class="na">version</span>: <span class="m">2</span>, <span class="na">upgrade</span>: <span class="nx">upgrade</span>});</div></div></pre></div></section><section id="koru/model/query-idb.deleteDatabase" tabindex="-1" name="deleteDatabase" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB.<span class="highlight"><span class="nf">deleteDatabase</span>(<span class="nv">name</span>)</span></h1><abstract><div><p>delete an entire database</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">Promise(object)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">done</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="nx">QueryIDB</span>.<span class="na">deleteDatabase</span>(<span class="s">'foo'</span>).<span class="na">then</span>(() <span class="o">=&gt;</span> <span class="nx">done</span> <span class="o">=</span> <span class="kc">true</span>);

<span class="k">await</span> <span class="nx">db</span>.<span class="na">whenIdle</span>();
<span class="nx">assert</span>(<span class="nx">done</span>);</div></div></pre></div></section><section id="koru/model/query-idb#close" tabindex="-1" name="#close" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">close</span>()</span></h1><abstract><div><p>Close a database. Once closed it may not be used anymore.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">close</span>();</div><div></div></div></pre></div></section><section id="koru/model/query-idb#count" tabindex="-1" name="#count" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">count</span>(<span class="nv">modelName</span>, <span class="nv">query</span>)</span></h1><abstract><div><p>count records in a <a class="jsdoc-link" href="#koru/model/main">Model</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>query</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">Promise(number)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">count</span>(<span class="s">"TestModel"</span>, <span class="ge nx">{}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">3</span></span></div></pre></div></section><section id="koru/model/query-idb#cursor" tabindex="-1" name="#cursor" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">cursor</span>(<span class="nv">modelName</span>, <span class="nv">query</span>, <span class="nv">direction</span>, <span class="nv">action</span>)</span></h1><abstract><div><p>Open cursor on an ObjectStore</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>query</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>direction</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>action</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">cursor</span>(<span class="s">"TestModel"</span>, <span class="ge nx">{}</span>, <span class="kc">null</span>, <span class="ge nx">(cursor)</span>);</div><div></div></div></pre></div></section><section id="koru/model/query-idb#delete" tabindex="-1" name="#delete" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">delete</span>(<span class="nv">modelName</span>, <span class="nv">id</span>)</span></h1><abstract><div><p>Delete a record from indexedDB</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">delete</span>(<span class="s">"TestModel"</span>, <span class="s">"foo123"</span>);</div><div></div></div></pre></div></section><section id="koru/model/query-idb#deleteObjectStore" tabindex="-1" name="#deleteObjectStore" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">deleteObjectStore</span>(<span class="nv">name</span>)</span></h1><abstract><div><p>Drop an objectStore and its indexes</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">deleteObjectStore</span>(<span class="s">"TestModel"</span>);</div><div></div></div></pre></div></section><section id="koru/model/query-idb#get" tabindex="-1" name="#get" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">get</span>(<span class="nv">modelName</span>, <span class="nv">_id</span>)</span></h1><abstract><div><p>Find a record in a <a class="jsdoc-link" href="#koru/model/main">Model</a> by its <code>_id</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>_id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">Promise(object)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">get</span>(<span class="s">"TestModel"</span>, <span class="s">"foo123"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{_id: "foo123", name: "foo", age: 5, gender: "m"}</span></span></div></pre></div></section><section id="koru/model/query-idb#getAll" tabindex="-1" name="#getAll" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">getAll</span>(<span class="nv">modelName</span>, <span class="nv">query</span>)</span></h1><abstract><div><p>Find all records in a <a class="jsdoc-link" href="#koru/model/main">Model</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[query]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Promise(Array)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">getAll</span>(<span class="s">"TestModel"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[{_id: 'foo123', age: 5, gender: 'm', name: 'foo'}, {_id: 'foo124', age: 10, gender: 'f', name: 'foo2'}]</span></span></div></pre></div></section><section id="koru/model/query-idb#index" tabindex="-1" name="#index" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">index</span>(<span class="nv">modelName</span>, <span class="nv">name</span>)</span></h1><abstract><div><p>Retreive a named index for an objectStore</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">index</span>(<span class="s">"TestModel"</span>, <span class="s">"name"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{_queryIDB: QueryIDB({name: 'foo', dbId: 'default', catchAll: undefined}), _withIndex: function (){}}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">index</span>(<span class="s">"TestModel"</span>, <span class="s">"name"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{_queryIDB: QueryIDB({name: 'foo', dbId: 'default', catchAll: undefined}), _withIndex: function (){}}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">index</span>(<span class="s">"TestModel"</span>, <span class="s">"name"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{_queryIDB: QueryIDB({name: 'foo', dbId: 'default', catchAll: undefined}), _withIndex: function (){}}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">index</span>(<span class="s">"TestModel"</span>, <span class="s">"name"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{_queryIDB: QueryIDB({name: 'foo', dbId: 'default', catchAll: undefined}), _withIndex: function (){}}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">index</span>(<span class="s">"TestModel"</span>, <span class="s">"name"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{_queryIDB: QueryIDB({name: 'foo', dbId: 'default', catchAll: undefined}), _withIndex: function (){}}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">index</span>(<span class="s">"TestModel"</span>, <span class="s">"name"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{_queryIDB: QueryIDB({name: 'foo', dbId: 'default', catchAll: undefined}), _withIndex: function (){}}</span></span></div></pre></div></section><section id="koru/model/query-idb#loadDoc" tabindex="-1" name="#loadDoc" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">loadDoc</span>(<span class="nv">modelName</span>, <span class="nv">rec</span>)</span></h1><abstract><div><p>Insert a record into a model but ignore #queueChange for same record and do nothing if
record already in model unless model[stopGap$] symbol is true;</p>
<p>If record is simulated make from change from client point-of-view else server POV.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>rec</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">called</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="nx">after</span>(<span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">onChange</span>(<span class="nv">dc</span> <span class="o">=&gt;</span> {
  <span class="nx">v</span>.<span class="na">db</span>.<span class="na">queueChange</span>(<span class="nx">dc</span>);
  <span class="nx">called</span> <span class="o">=</span> <span class="kc">true</span>;
}));
<span class="kd">const</span> <span class="no">rec</span> <span class="o">=</span> {<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>, <span class="na">$sim</span>: [<span class="s">'del'</span>, <span class="kc">undefined</span>]};

<span class="nx">db</span>.<span class="na">loadDoc</span>(<span class="s">'TestModel'</span>, <span class="nx">rec</span>);

<span class="k">await</span> <span class="nx">db</span>.<span class="na">whenReady</span>();

<span class="kd">const</span> {<span class="no">foo</span>} <span class="o">=</span> <span class="nx">mockIndexedDB</span>.<span class="na">_dbs</span>;
<span class="kd">const</span> {<span class="no">foo123</span>} <span class="o">=</span> <span class="nx">TestModel</span>.<span class="na">docs</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">foo123</span>.<span class="na">attributes</span>, <span class="nx">rec</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">rec</span>.<span class="na">$sim</span>, <span class="kc">undefined</span>);
<span class="nx">assert</span>(<span class="nx">called</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">v</span>.<span class="na">simDocs</span>(), {<span class="na">foo123</span>: [<span class="s">'del'</span>, <span class="kc">undefined</span>]});</div></div></pre></div></section><section id="koru/model/query-idb#loadDocs" tabindex="-1" name="#loadDocs" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">loadDocs</span>(<span class="nv">n</span>, <span class="nv">recs</span>)</span></h1><abstract><div><p>Insert a list of records into a model. See <a class="jsdoc-link" href="#koru/model/query-idb#loadDoc">loadDoc</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>n</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>recs</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">called</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="nx">TestModel</span>.<span class="na">onChange</span>(<span class="nv">dc</span> <span class="o">=&gt;</span>{<span class="nx">db</span>.<span class="na">queueChange</span>(<span class="nx">dc</span>); <span class="nx">called</span> <span class="o">=</span> <span class="kc">true</span>;});
<span class="kd">const</span> <span class="no">recs</span> <span class="o">=</span> [
  {<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>},
  {<span class="na">_id</span>: <span class="s">'foo456'</span>, <span class="na">name</span>: <span class="s">'bar'</span>, <span class="na">age</span>: <span class="m">10</span>, <span class="na">gender</span>: <span class="s">'f'</span>},
];
<span class="nx">db</span>.<span class="na">loadDocs</span>(<span class="s">'TestModel'</span>, <span class="nx">recs</span>);
<span class="k">await</span> <span class="nx">db</span>.<span class="na">whenReady</span>();
<span class="kd">const</span> <span class="no">foo</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">idb</span>.<span class="na">_dbs</span>.<span class="na">foo</span>;

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>.<span class="na">attributes</span>, <span class="nx">recs</span>[<span class="m">0</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">TestModel</span>.<span class="na">docs</span>.<span class="na">foo456</span>.<span class="na">attributes</span>, <span class="nx">recs</span>[<span class="m">1</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>, {});
<span class="nx">assert</span>(<span class="nx">called</span>);</div></div></pre></div></section><section id="koru/model/query-idb#promisify" tabindex="-1" name="#promisify" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">promisify</span>(<span class="nv">body</span>)</span></h1><abstract><div><p>perform a database action returning a promise</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>body</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the returns an <code>IDBRequest</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank">Promise</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">id</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span>.<span class="na">promisify</span>(
  ()<span class="o">=&gt;</span><span class="nx">db</span>.<span class="na">transaction</span>([<span class="s">'TestModel'</span>], <span class="s">'readwrite'</span>)
    .<span class="na">objectStore</span>(<span class="s">'TestModel'</span>).<span class="na">put</span>({<span class="na">_id</span>: <span class="s">"id1"</span>, <span class="na">name</span>: <span class="s">"foo"</span>})
);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">id</span>, <span class="s">"id1"</span>);</div></div></pre></div></section><section id="koru/model/query-idb#put" tabindex="-1" name="#put" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">put</span>(<span class="nv">modelName</span>, <span class="nv">rec</span>)</span></h1><abstract><div><p>Insert or update a record in indexedDB</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>rec</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">put</span>(<span class="s">"TestModel"</span>, <span class="ge nx">{_id: "foo123", name: "foo", age: 5, gender: "m"}</span>);</div><div></div></div></pre></div></section><section id="koru/model/query-idb#queueChange" tabindex="-1" name="#queueChange" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">queueChange</span>(<span class="nv">dc</span>)</span></h1><abstract><div><p>Queue a model change to update indexedDB when the current
<a class="jsdoc-link" href="#trans-queue">trans-queue</a> successfully completes. Changes to model
instances with stopGap$ symbol true are ignored.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dc</td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight">{
  <span class="nx">v</span>.<span class="na">foo</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">idb</span>.<span class="na">_dbs</span>.<span class="na">foo</span>;
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_version</span>, <span class="m">2</span>);
  <span class="nx">after</span>(<span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">onChange</span>(<span class="nx">v</span>.<span class="na">db</span>.<span class="na">queueChange</span>.<span class="na">bind</span>(<span class="nx">v</span>.<span class="na">db</span>)));
  <span class="nx">v</span>.<span class="na">f1</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>});
  <span class="nx">v</span>.<span class="na">fIgnore</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">createStopGap</span>({
    <span class="na">_id</span>: <span class="s">'fooIgnore'</span>, <span class="na">name</span>: <span class="s">'foo ignore'</span>, <span class="na">age</span>: <span class="m">10</span>, <span class="na">gender</span>: <span class="s">'f'</span>});
}
<span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>();
{
  <span class="nx">refute</span>(<span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">fooIgnore</span>);
  <span class="kd">const</span> <span class="no">iDoc</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>;
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iDoc</span>, {
    <span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>, <span class="na">$sim</span>: [<span class="s">'del'</span>, <span class="kc">undefined</span>]});

  <span class="nx">v</span>.<span class="na">f1</span>.<span class="na">$update</span>(<span class="s">'age'</span>, <span class="m">10</span>);
}
<span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>();
{
  <span class="kd">const</span> <span class="no">iDoc</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>;
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iDoc</span>, {
    <span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">10</span>, <span class="na">gender</span>: <span class="s">'m'</span>, <span class="na">$sim</span>: [<span class="s">'del'</span>, <span class="kc">undefined</span>]});

  <span class="nx">v</span>.<span class="na">f1</span>.<span class="na">$remove</span>();
}
<span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>();
{
  <span class="kd">const</span> <span class="no">iDoc</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>;
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iDoc</span>, <span class="kc">undefined</span>);
}</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>(); {
  <span class="nx">v</span>.<span class="na">foo</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">idb</span>.<span class="na">_dbs</span>.<span class="na">foo</span>;
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_version</span>, <span class="m">2</span>);
  <span class="nx">after</span>(<span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">onChange</span>(<span class="nx">v</span>.<span class="na">db</span>.<span class="na">queueChange</span>.<span class="na">bind</span>(<span class="nx">v</span>.<span class="na">db</span>)).<span class="na">stop</span>);
  <span class="nx">Query</span>.<span class="na">insertFromServer</span>(<span class="nx">v</span>.<span class="na">TestModel</span>, {<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>});
  <span class="nx">v</span>.<span class="na">f1</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">findById</span>(<span class="s">'foo123'</span>);
}
<span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>(); {
  <span class="kd">const</span> <span class="no">iDoc</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>;
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iDoc</span>, {<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>});
  <span class="nx">v</span>.<span class="na">f1</span>.<span class="na">$remove</span>();
  <span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>();
}
<span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>(); {
  <span class="kd">const</span> <span class="no">iDoc</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>;
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iDoc</span>, {<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">$sim</span>: [{
    <span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>}, <span class="kc">undefined</span>]});
}</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>(); {
  <span class="nx">v</span>.<span class="na">foo</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">idb</span>.<span class="na">_dbs</span>.<span class="na">foo</span>;
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_version</span>, <span class="m">2</span>);
  <span class="nx">after</span>(<span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">onChange</span>(<span class="nx">v</span>.<span class="na">db</span>.<span class="na">queueChange</span>.<span class="na">bind</span>(<span class="nx">v</span>.<span class="na">db</span>)).<span class="na">stop</span>);
  <span class="nx">v</span>.<span class="na">f1</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>});
  <span class="nx">v</span>.<span class="na">fIgnore</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">TestModel</span>.<span class="na">createStopGap</span>({
    <span class="na">_id</span>: <span class="s">'fooIgnore'</span>, <span class="na">name</span>: <span class="s">'foo ignore'</span>, <span class="na">age</span>: <span class="m">10</span>, <span class="na">gender</span>: <span class="s">'f'</span>});
}
<span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>(); {
  <span class="nx">refute</span>(<span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">fooIgnore</span>);
  <span class="kd">const</span> <span class="no">iDoc</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>;
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iDoc</span>, {<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">5</span>, <span class="na">gender</span>: <span class="s">'m'</span>});

  <span class="nx">v</span>.<span class="na">f1</span>.<span class="na">$update</span>(<span class="s">'age'</span>, <span class="m">10</span>);
}

<span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>(); {
  <span class="kd">const</span> <span class="no">iDoc</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>;
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iDoc</span>, {<span class="na">_id</span>: <span class="s">'foo123'</span>, <span class="na">name</span>: <span class="s">'foo'</span>, <span class="na">age</span>: <span class="m">10</span>, <span class="na">gender</span>: <span class="s">'m'</span>});

  <span class="nx">v</span>.<span class="na">f1</span>.<span class="na">$remove</span>();
  <span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>();
}
<span class="k">await</span> <span class="nx">v</span>.<span class="na">db</span>.<span class="na">whenReady</span>(); {
  <span class="kd">const</span> <span class="no">iDoc</span> <span class="o">=</span> <span class="nx">v</span>.<span class="na">foo</span>.<span class="na">_store</span>.<span class="na">TestModel</span>.<span class="na">docs</span>.<span class="na">foo123</span>;
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">iDoc</span>, <span class="kc">undefined</span>);
}</div></div></pre></div></section><section id="koru/model/query-idb#transaction" tabindex="-1" name="#transaction" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">transaction</span>(<span class="nv">tables</span>, <span class="nv">mode</span>, {<span class="nv">oncomplete</span>, <span class="nv">onabort</span>}<span class="o">=</span>{})</span></h1><abstract><div><p>Access to indexeddb transaction</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>tables</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>mode</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>oncomplete</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>onabort</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">transaction</span>(<span class="s">"TestModel"</span>, <span class="s">"readwrite"</span>, <span class="ge nx">{oncomplete: EMPTY_FUNC, onabort: EMPTY_FUNC}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{db: Database({_store: {TestModel: ObjectStore({db: {...more}, name: 'TestModel', docs: {...more}, indexes: {...more}})}, _mockdb: MockIndexedDB({_vers}</span></span></div></pre></div></section><section id="koru/model/query-idb#whenIdle" tabindex="-1" name="#whenIdle" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">whenIdle</span>()</span></h1><abstract><div><p>Return a promise that is resolved when the DB is ready and has commited all outstanding
updates.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/query-idb">Promise(QueryIDB)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">whenIdle</span>();</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">null</span></span></div></pre></div></section><section id="koru/model/query-idb#whenReady" tabindex="-1" name="#whenReady" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">QueryIDB#<span class="highlight"><span class="nf">whenReady</span>(<span class="nv">noArgs</span>)</span></h1><abstract><div><p>Return a promise that is resolved when the DB is ready to query</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[noArgs]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">QueryIDB</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/query-idb"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">queryIDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">QueryIDB</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">queryIDB</span>.<span class="na">whenReady</span>();</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">undefined</span></span></div></pre></div></section></div></div></div></section><section id="koru/model/rich-text-validator" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/rich-text-validator">koru/model/rich-text-validator</a><h1 class="jsdoc-module-title searchable">RichTextValidator</h1><abstract><div><p><a class="jsdoc-link" href="#/koru/dom/rich-Text">rich-Text</a> validators.</p>
<p>Enable with <a class="jsdoc-link" href="#koru/model/validation.register">Val.register(module, RichTextValidator)</a> which is
conventionally done in <code>app/models/model.js</code></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/rich-text-validator.richText" tabindex="-1" name="richText" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">RichTextValidator.<span class="highlight"><span class="nf">richText</span>(<span class="nv">doc</span>, <span class="nv">field</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Validate field is rich text. Field error set to <code>'invalid_html'</code> if invalid.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>options</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>use <code>'filter'</code> to remove any invalid markup.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">RichTextValidator</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/rich-text-validator"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// Valid RichText</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richText</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: <span class="nx">RichText</span>.<span class="na">fromHtml</span>(<span class="nx">Dom</span>.<span class="na">h</span>([{<span class="na">b</span>: <span class="s">'once'</span>}, <span class="s">'\nupon'</span>]))});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">content</span>, [<span class="s">'once\nupon'</span>, [<span class="m">11</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">4</span>]]);

<span class="nx">book</span>.<span class="na">content</span> <span class="o">=</span> [<span class="s">'invalid'</span>, [<span class="m">22</span>, <span class="o">-</span><span class="m">1</span>]];
<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">content</span>, [[<span class="s">'invalid_html'</span>]]);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// valid text (string; not array)</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richText</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: <span class="s">'just\ntext'</span>});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">content</span>, <span class="s">'just\ntext'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// Valid RichText</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richText</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: [[<span class="s">'one'</span>, <span class="s">'two'</span>], <span class="kc">null</span>]});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">content</span>, <span class="s">'one\ntwo'</span>); <span class="cs">// converts array to plain text</span></div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// only checks changes</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richText</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
<span class="nx">book</span>.<span class="na">attributes</span>.<span class="na">content</span> <span class="o">=</span> [[<span class="s">'one'</span>, <span class="s">'two'</span>], [<span class="o">-</span><span class="m">1</span>, <span class="o">-</span><span class="m">1</span>]];
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// invalid markup</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richText</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: [<span class="m">11</span>, <span class="m">2</span>]});

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">content</span>, [[<span class="s">'invalid_html'</span>]]);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// filter html to expected format</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richText</span>: <span class="s">'filter'</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: <span class="nx">RichText</span>.<span class="na">fromHtml</span>(<span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">div</span>: {<span class="na">ol</span>: [{<span class="na">li</span>: <span class="s">'a'</span>}, {<span class="na">li</span>: <span class="s">'b'</span>}]}, <span class="na">style</span>: <span class="s">'text-align:right;'</span>}))});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">content</span>, [<span class="s">'a\nb'</span>, [<span class="m">7</span>, <span class="m">0</span>, <span class="m">1</span>, <span class="m">1</span>, <span class="m">0</span>, <span class="m">1</span>, <span class="m">20</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">20</span>, <span class="m">1</span>, <span class="m">0</span>]]);

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">content</span>, [<span class="s">'a\nb'</span>, [<span class="m">1</span>, <span class="m">0</span>, <span class="m">1</span>, <span class="m">20</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">7</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">20</span>, <span class="m">1</span>, <span class="m">0</span>, <span class="m">7</span>, <span class="m">0</span>, <span class="m">0</span>]]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Dom</span>.<span class="na">htmlToJson</span>(<span class="nx">RichText</span>.<span class="na">toHtml</span>(<span class="nx">book</span>.<span class="na">content</span>[<span class="m">0</span>], <span class="nx">book</span>.<span class="na">content</span>[<span class="m">1</span>])), [{
  <span class="na">ol</span>: [
    {<span class="na">li</span>: {<span class="na">style</span>: <span class="s">'text-align: right;'</span>, <span class="na">div</span>: <span class="s">'a'</span>}},
    {<span class="na">li</span>: {<span class="na">style</span>: <span class="s">'text-align: right;'</span>, <span class="na">div</span>: <span class="s">'b'</span>}},
  ]}]);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// filter no markup</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richText</span>: <span class="s">'filter'</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: [<span class="s">'bold'</span>, <span class="kc">null</span>]});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">content</span>, <span class="s">'bold'</span>);</div></div></pre></div></section><section id="koru/model/rich-text-validator.richTextMarkup" tabindex="-1" name="richTextMarkup" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">RichTextValidator.<span class="highlight"><span class="nf">richTextMarkup</span>(<span class="nv">doc</span>, <span class="nv">field</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Validate field (suffixed with <code>'Markup'</code>) contains rich text markup. The corresponding
plain text should be in adjacent field named without suffix. An error is set for field
(with <code>'HTML'</code> suffix instead of <code>'Markup'</code> suffix) to <code>'invalid_html'</code> if invalid.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>options</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>use <code>'filter'</code> to remove any invalid markup.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">RichTextValidator</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/rich-text-validator"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// Valid</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>},
  <span class="na">contentMarkup</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richTextMarkup</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">rt</span> <span class="o">=</span> <span class="nx">RichText</span>.<span class="na">fromHtml</span>(<span class="nx">Dom</span>.<span class="na">h</span>([{<span class="na">b</span>: <span class="s">'once'</span>}, <span class="s">'\nupon'</span>]));

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: <span class="nx">rt</span>[<span class="m">0</span>], <span class="na">contentMarkup</span>: <span class="nx">rt</span>[<span class="m">1</span>]});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">content</span>, <span class="s">'once\nupon'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">contentMarkup</span>, [<span class="m">11</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">4</span>]);

<span class="nx">book</span>.<span class="na">contentMarkup</span> <span class="o">=</span> [<span class="m">22</span>, <span class="o">-</span><span class="m">1</span>];
<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">contentHTML</span>, [[<span class="s">'invalid_html'</span>]]);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// filter html to expected format</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>},
  <span class="na">contentMarkup</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richTextMarkup</span>: <span class="s">'filter'</span>},
});

<span class="kd">const</span> <span class="no">rt</span> <span class="o">=</span> <span class="nx">RichText</span>.<span class="na">fromHtml</span>(<span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">div</span>: {<span class="na">ol</span>: [{<span class="na">li</span>: <span class="s">'a'</span>}, {<span class="na">li</span>: <span class="s">'b'</span>}]}, <span class="na">style</span>: <span class="s">'text-align:right;'</span>}));

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: <span class="nx">rt</span>[<span class="m">0</span>], <span class="na">contentMarkup</span>: <span class="nx">rt</span>[<span class="m">1</span>]});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">content</span>, <span class="s">'a\nb'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">contentMarkup</span>, [<span class="m">1</span>, <span class="m">0</span>, <span class="m">1</span>, <span class="m">20</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">7</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">20</span>, <span class="m">1</span>, <span class="m">0</span>, <span class="m">7</span>, <span class="m">0</span>, <span class="m">0</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Dom</span>.<span class="na">htmlToJson</span>(<span class="nx">RichText</span>.<span class="na">toHtml</span>(<span class="nx">book</span>.<span class="na">content</span>, <span class="nx">book</span>.<span class="na">contentMarkup</span>)), [{
  <span class="na">ol</span>: [
    {<span class="na">li</span>: {<span class="na">style</span>: <span class="s">'text-align: right;'</span>, <span class="na">div</span>: <span class="s">'a'</span>}},
    {<span class="na">li</span>: {<span class="na">style</span>: <span class="s">'text-align: right;'</span>, <span class="na">div</span>: <span class="s">'b'</span>}},
  ]}]);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// only checks changes</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>},
  <span class="na">contentMarkup</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richTextMarkup</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
<span class="nx">book</span>.<span class="na">attributes</span>.<span class="na">content</span> <span class="o">=</span> [<span class="s">'one'</span>, <span class="s">'two'</span>];
<span class="nx">book</span>.<span class="na">attributes</span>.<span class="na">contentMarkup</span> <span class="o">=</span> [<span class="o">-</span><span class="m">1</span>, <span class="o">-</span><span class="m">1</span>];
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// only checks changes</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">content</span>: {<span class="na">type</span>: <span class="s">'text'</span>},
  <span class="na">contentMarkup</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">richTextMarkup</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">content</span>: [<span class="s">'one'</span>, <span class="s">'two'</span>], <span class="na">contentMarkup</span>: <span class="kc">null</span>});
<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">contentHTML</span>, [[<span class="s">'invalid_html'</span>]]);

<span class="nx">book</span>.<span class="na">content</span> <span class="o">=</span> <span class="s">'one\ntwo'</span>;
<span class="nx">book</span>.<span class="na">contentMarkup</span> <span class="o">=</span> <span class="nx">book</span>.<span class="na">attributes</span>.<span class="na">contentMarkup</span>;
<span class="nx">book</span>.<span class="na">attributes</span>.<span class="na">contentMarkup</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="o">-</span><span class="m">3</span>];

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">contentHTML</span>, [[<span class="s">'invalid_html'</span>]]);</div></div></pre></div></section></div></div></div></section><section id="koru/model/sql-query" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/sql-query">koru/model/sql-query</a><h1 class="jsdoc-module-title searchable">SqlQuery</h1><abstract><div><p>An optimized Model query using sql for where statement.</p>
<p>Note: all queries must be ran from withing a transaction</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/sql-query.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">model</span>, <span class="nv">queryStr</span>)</span></h1><abstract><div><p>Create a prepared query.</p>
<p>Note: The query is lazily prepared including parsing the string and deriving parameter
types.</p>
<p>Can also be called as <code>Model#sqlWhere(queryStr)</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>model</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>models used to resolve symbolic parameter types</p>
</div></td></tr><tr class="jsdoc-arg"><td>queryStr</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The sql query string, with symbolic parameters, to prepare</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SqlQuery</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/sql-query"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">bigBooks</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SqlQuery</span>(<span class="nx">Book</span>, <span class="s">`"pageCount" &gt; {$pageCount} ORDER BY "pageCount"`</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">await</span> <span class="nx">bigBooks</span>.<span class="na">fetchOne</span>({<span class="na">pageCount</span>: <span class="m">300</span>}), <span class="k">await</span> <span class="nx">Book</span>.<span class="na">findBy</span>(<span class="s">'title'</span>, <span class="s">'Pride and Prejudice'</span>));</div></div></pre></div></section><section id="koru/model/sql-query#fetch" tabindex="-1" name="#fetch" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">SqlQuery#async fetch(params)</h1><abstract><div><p>Fetch zero or more rows from the query and close the portal.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Promise(Array)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SqlQuery</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/sql-query"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">byAuthor</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">sqlWhere</span>(<span class="s">`"author" = {$author} ORDER BY "pageCount"`</span>);

<span class="nx">assert</span>.<span class="na">equals</span>((<span class="k">await</span> <span class="nx">byAuthor</span>.<span class="na">fetch</span>({<span class="na">author</span>: <span class="s">'Dima Zales'</span>})).<span class="na">map</span>((<span class="nv">d</span>) <span class="o">=&gt;</span> <span class="nx">d</span>.<span class="na">summary</span>),
              [<span class="s">'Limbo by Dima Zales'</span>, <span class="s">'Oasis by Dima Zales'</span>]);</div></div></pre></div></section><section id="koru/model/sql-query#fetchOne" tabindex="-1" name="#fetchOne" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">SqlQuery#async fetchOne(params)</h1><abstract><div><p>Fetch one or zero rows from the query and close the portal.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">Promise(BaseModel)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SqlQuery</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/sql-query"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">byAuthor</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">sqlWhere</span>(<span class="s">`"author" = {$author} ORDER BY "pageCount"`</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">byAuthor</span>.<span class="na">fetchOne</span>({<span class="na">author</span>: <span class="s">'Dima Zales'</span>}), <span class="k">await</span> <span class="nx">Book</span>.<span class="na">findBy</span>(<span class="s">'title'</span>, <span class="s">'Limbo'</span>));</div></div></pre></div></section><section id="koru/model/sql-query#forEach" tabindex="-1" name="#forEach" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">SqlQuery#async forEach(params, callback)</h1><abstract><div><p>call callback for each row returned from the query.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SqlQuery</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/sql-query"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">byAuthor</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">sqlWhere</span>(<span class="s">`"author" = {$author} ORDER BY "pageCount"`</span>);

<span class="kd">const</span> <span class="no">titles</span> <span class="o">=</span> [];

<span class="k">await</span> <span class="nx">byAuthor</span>.<span class="na">forEach</span>({<span class="na">author</span>: <span class="s">'Dima Zales'</span>}, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">titles</span>.<span class="na">push</span>(<span class="nx">row</span>.<span class="na">summary</span>));

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">titles</span>, [<span class="s">'Limbo by Dima Zales'</span>, <span class="s">'Oasis by Dima Zales'</span>]);</div></div></pre></div></section><section id="koru/model/sql-query#values" tabindex="-1" name="#values" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">SqlQuery#async *values(params)</h1><abstract><div><p>return an asyncIterator over the rows returned from the query.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SqlQuery</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/sql-query"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">byAuthor</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">sqlWhere</span>(<span class="s">`author = {$author} ORDER BY "pageCount"`</span>);

<span class="kd">const</span> <span class="no">titles</span> <span class="o">=</span> [];

<span class="k">for</span> <span class="k">await</span> (<span class="kd">const</span> <span class="no">row</span> <span class="k">of</span> <span class="nx">byAuthor</span>.<span class="na">values</span>({<span class="na">author</span>: <span class="s">'Dima Zales'</span>})) {
  <span class="nx">titles</span>.<span class="na">push</span>(<span class="nx">row</span>.<span class="na">summary</span>);
}

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">titles</span>, [<span class="s">'Limbo by Dima Zales'</span>, <span class="s">'Oasis by Dima Zales'</span>]);</div></div></pre></div></section></div></div></div></section><section id="koru/model/test-factory" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/test-factory">koru/model/test-factory</a><h1 class="jsdoc-module-title searchable">TestFactory</h1><abstract><div><p>TestFactory is used to facilitate building and persisting document <a class="jsdoc-link" href="#koru/model/base-model">models</a> for
use within unit tests. A koru system should have a file <code>app/test/factory.js</code> which defines the
models which TestFactory can use.</p>
<p>Model documents are created in the DB using, say, <code>createBook</code> for a <code>Book</code> or <code>createAuthor</code>
for an <code>Author</code> and are built without saving using, say, <code>buildBook</code> for a <code>Book</code>. By default
documents bypass the validation when created but validation can be done using
<a class="jsdoc-link" href="#koru/model/test-factory::Builder#useSave">Builder</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/test-factory.defines" tabindex="-1" name="defines" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestFactory.<span class="highlight"><span class="nf">defines</span>(<span class="nv">models</span>)</span></h1><abstract><div><p>Defines the models to build and create.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>models</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>Each function in <code>models</code> has the name of a model, takes an <code>options</code>
parameter and returns a <a class="jsdoc-link" href="#koru/model/test-factory.Builder">Builder</a>. The <code>options</code> parameter will contains an object with
field property values and other useful options.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/test-factory">TestFactory</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">TestFactory</span>.<span class="na">defines</span>({
  <span class="nf">Author</span>(<span class="nv">options</span>) {
    <span class="k">return</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Author'</span>, <span class="nx">options</span>);
  },

  <span class="nf">Book</span>(<span class="nv">options</span>) {
    <span class="k">return</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>, <span class="nx">options</span>)
      .<span class="na">genName</span>(<span class="s">'title'</span>)
      .<span class="na">addField</span>(<span class="s">'pages'</span>, <span class="m">100</span>)
    ;
  },
});
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="nx">TestFactory</span>.<span class="na">buildBook</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book1</span>.<span class="na">title</span>, <span class="s">'Book 1'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book1</span>.<span class="na">author</span>, <span class="o">void</span> <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book1</span>.<span class="na">pages</span>, <span class="m">100</span>);

<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="nx">TestFactory</span>.<span class="na">buildBook</span>({<span class="na">pages</span>: <span class="m">200</span>, <span class="na">author</span>: <span class="s">'A. A. Milne'</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book2</span>.<span class="na">author</span>, <span class="s">'A. A. Milne'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book2</span>.<span class="na">pages</span>, <span class="m">200</span>);</div></div></pre></div></section><section id="koru/model/test-factory.generateSeq" tabindex="-1" name="generateSeq" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestFactory.<span class="highlight"><span class="nf">generateSeq</span>(<span class="nv">key</span>)</span></h1><abstract><div><p>Generate a sequential number for a <code>key</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>key</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>, {<span class="na">title</span>: <span class="s">'Now We Are Six'</span>});

<span class="nx">builder</span>
  .<span class="na">addField</span>(<span class="s">'title'</span>, <span class="s">'When We Were Very Young'</span>)
  .<span class="na">addField</span>(<span class="s">'isbn'</span>, <span class="m">9780140361230</span>)
  .<span class="na">genSeq</span>(<span class="s">'pages'</span>, <span class="s">'book-pages'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder</span>.<span class="na">defaults</span>, {<span class="na">isbn</span>: <span class="m">9780140361230</span>, <span class="na">pages</span>: <span class="m">1</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">TestFactory</span>.<span class="na">generateSeq</span>(<span class="s">'book-pages'</span>), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">TestFactory</span>.<span class="na">generateSeq</span>(<span class="s">'book-chapters'</span>), <span class="m">1</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/test-factory::Builder" data-env="both" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/test-factory::Builder">koru/model/test-factory::Builder</a><h1 class="jsdoc-module-title searchable">Builder</h1><abstract><div><p>A Builder instance is responsible for constructing a model document.
See <a class="jsdoc-link" href="#koru/model/test-factory::Builder.defines">defines</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/test-factory::Builder.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">modelName</span>, <span class="nv">attributes</span>, <span class="nv">defaults</span><span class="o">=</span>{})</span></h1><abstract><div><p>Create a Builder instance for the specified model.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The name of the model to build.</p>
</div></td></tr><tr class="jsdoc-arg"><td>attributes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>The field values to assign to the model</p>
</div></td></tr><tr class="jsdoc-arg"><td>defaults</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>The field values to use if the field is not in <code>attributes</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(
  <span class="s">'Book'</span>, {<span class="na">title</span>: <span class="s">'Now We Are Six'</span>}, {<span class="na">author</span>: <span class="s">'A. A. Milne'</span>})
      .<span class="na">addField</span>(<span class="s">'title'</span>, <span class="s">'When We Were Very Young'</span>)
      .<span class="na">addField</span>(<span class="s">'pages'</span>, <span class="m">112</span>)
;

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder</span>.<span class="na">defaults</span>, {
  <span class="na">author</span>: <span class="s">'A. A. Milne'</span>,
  <span class="na">pages</span>: <span class="m">112</span>,
});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder</span>.<span class="na">attributes</span>, {<span class="na">title</span>: <span class="s">'Now We Are Six'</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder</span>.<span class="na">makeAttributes</span>(), {
  <span class="na">author</span>: <span class="s">'A. A. Milne'</span>, <span class="na">pages</span>: <span class="m">112</span>, <span class="na">title</span>: <span class="s">'Now We Are Six'</span>});</div></div></pre></div></section><section id="koru/model/test-factory::Builder#addField" tabindex="-1" name="#addField" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Builder#<span class="highlight"><span class="nf">addField</span>(<span class="nv">field</span>, <span class="nv">value</span>)</span></h1><abstract><div><p>Add a field to <code>Builder.defaults</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The name of the field to add.</p>
</div></td></tr><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>The default value for the field. If value is a function the function will be
executed if-and-only-if a default value is needed and its return result will be the value
used.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/test-factory::Builder">Builder</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>, {<span class="na">title</span>: <span class="s">'Now We Are Six'</span>});

<span class="nx">builder</span>
  .<span class="na">addField</span>(<span class="s">'title'</span>, <span class="s">'When We Were Very Young'</span>)
  .<span class="na">addField</span>(<span class="s">'isbn'</span>, () <span class="o">=&gt;</span> <span class="nx">Promise</span>.<span class="na">resolve</span>(<span class="s">'9780140361230'</span>))

<span class="cs">// addField waits for promises</span>
  .<span class="na">addField</span>(<span class="s">'pages'</span>, () <span class="o">=&gt;</span> <span class="nx">builder</span>.<span class="na">field</span>(<span class="s">'isbn'</span>).<span class="na">length</span> <span class="o">*</span> <span class="m">10</span> <span class="o">-</span> <span class="m">18</span>);

<span class="k">await</span> <span class="nx">builder</span>.<span class="na">waitPromises</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder</span>.<span class="na">defaults</span>, {<span class="na">isbn</span>: <span class="s">'9780140361230'</span>, <span class="na">pages</span>: <span class="m">112</span>});</div></div></pre></div></section><section id="koru/model/test-factory::Builder#addPromise" tabindex="-1" name="#addPromise" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Builder#<span class="highlight"><span class="nf">addPromise</span>(<span class="nv">p</span>)</span></h1><abstract><div><p>Add a promise to list of outstanding promises</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>p</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/test-factory::Builder">Builder</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> [];
<span class="kd">const</span> <span class="no">fut1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Future</span>();
<span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>)
      .<span class="na">addPromise</span>(<span class="nx">fut1</span>.<span class="na">promise</span>.<span class="na">then</span>(() <span class="o">=&gt;</span> {<span class="nx">list</span>.<span class="na">push</span>(<span class="m">1</span>)}))
      .<span class="na">addPromise</span>(<span class="nx">Promise</span>.<span class="na">resolve</span>().<span class="na">then</span>(() <span class="o">=&gt;</span> {<span class="nx">list</span>.<span class="na">push</span>(<span class="m">2</span>)}));

<span class="kd">const</span> <span class="no">p</span> <span class="o">=</span> <span class="nx">builder</span>.<span class="na">waitPromises</span>().<span class="na">then</span>(() <span class="o">=&gt;</span> {<span class="nx">list</span>.<span class="na">push</span>(<span class="m">3</span>)});

<span class="nx">fut1</span>.<span class="na">resolve</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>, []);

<span class="k">await</span> <span class="nx">fut1</span>.<span class="na">promise</span>;

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>, [<span class="m">2</span>, <span class="m">1</span>]);

<span class="kd">const</span> <span class="no">fut2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Future</span>();

<span class="k">await</span> <span class="nx">p</span>;

<span class="nx">builder</span>.<span class="na">addPromise</span>(<span class="nx">fut2</span>.<span class="na">promise</span>.<span class="na">then</span>(() <span class="o">=&gt;</span> {<span class="nx">list</span>.<span class="na">push</span>(<span class="m">4</span>)}));
<span class="nx">builder</span>.<span class="na">addPromise</span>(<span class="nx">Promise</span>.<span class="na">resolve</span>().<span class="na">then</span>(() <span class="o">=&gt;</span> {<span class="nx">fut2</span>.<span class="na">resolve</span>(); <span class="nx">list</span>.<span class="na">push</span>(<span class="m">5</span>)}));
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>, [<span class="m">2</span>, <span class="m">1</span>, <span class="m">3</span>]);

<span class="k">await</span> <span class="nx">builder</span>.<span class="na">waitPromises</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>, [<span class="m">2</span>, <span class="m">1</span>, <span class="m">3</span>, <span class="m">5</span>, <span class="m">4</span>]);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">builder</span>.<span class="na">waitPromises</span>(), <span class="o">void</span> <span class="m">0</span>);</div></div></pre></div></section><section id="koru/model/test-factory::Builder#addRef" tabindex="-1" name="#addRef" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Builder#<span class="highlight"><span class="nf">addRef</span>(<span class="nv">ref</span>, <span class="nv">doc</span>)</span></h1><abstract><div><p>Add a default reference to another model.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>ref</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[doc]</td><td><a href="#koru/model/base-model">Promise(BaseModel)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>The default document for the field. if-and-only-if a default value is
needed then:</p>
<ul>
<li>if doc is a function the function will be executed and its return result will be used
   to replace <code>doc</code>.  Then;</li>
<li>if <code>undefined</code> use the last document created for the reference model.</li>
<li>otherwise create a factory default document for the reference.</li>
</ul>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/test-factory::Builder">Builder</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">builder1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Chapter'</span>, {<span class="na">number</span>: <span class="m">1</span>})
      .<span class="na">addRef</span>(<span class="s">'book'</span>)
;

<span class="nx">builder1</span>.<span class="na">addField</span>(<span class="s">'pages'</span>, () <span class="o">=&gt;</span> <span class="nx">TestFactory</span>.<span class="na">last</span>.<span class="na">book</span>?.<span class="nx">pages</span> <span class="o">??</span> <span class="m">50</span>);

<span class="k">await</span> <span class="nx">builder1</span>.<span class="na">waitPromises</span>();

<span class="kd">const</span> {<span class="no">book</span>} <span class="o">=</span> <span class="nx">TestFactory</span>.<span class="na">last</span>;

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder1</span>.<span class="na">defaults</span>, {<span class="na">book_id</span>: <span class="nx">book</span>.<span class="na">_id</span>, <span class="na">pages</span>: <span class="m">100</span>});

<span class="kd">let</span> <span class="nv">waitingForBook</span>;

<span class="cs">// we are waiting on a lot of promises until we get the book</span>
<span class="nx">builder1</span>.<span class="na">addPromise</span>(<span class="nx">Promise</span>.<span class="na">resolve</span>().<span class="na">then</span>(<span class="nx">waitingForBook</span> <span class="o">=</span> <span class="nx">Promise</span>.<span class="na">resolve</span>(<span class="nx">book</span>)));

<span class="kd">const</span> <span class="no">builder2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Chapter'</span>, {<span class="na">book_id</span>: <span class="o">void</span> <span class="m">0</span>})
      .<span class="na">addRef</span>(<span class="s">'book'</span>, <span class="nx">waitingForBook</span>) <span class="cs">// addRef will wait for promise</span>
;

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder2</span>.<span class="na">defaults</span>, {});

<span class="kd">const</span> <span class="no">builder3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Chapter'</span>, {<span class="na">number</span>: <span class="m">1</span>})
      .<span class="na">addRef</span>(<span class="s">'book'</span>, () <span class="o">=&gt;</span> <span class="nx">TestFactory</span>.<span class="na">createBook</span>({<span class="na">_id</span>: <span class="s">'book123'</span>}));

<span class="k">await</span> <span class="nx">builder3</span>.<span class="na">waitPromises</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder3</span>.<span class="na">defaults</span>, {<span class="na">book_id</span>: <span class="s">'book123'</span>});</div></div></pre></div></section><section id="koru/model/test-factory::Builder#build" tabindex="-1" name="#build" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Builder#<span class="highlight"><span class="nf">build</span>()</span></h1><abstract><div><p>build an unsaved document. Called by, say, <code>Factory.buildBook</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>)
      .<span class="na">addField</span>(<span class="s">'title'</span>, <span class="s">'Winnie-the-Pooh'</span>)
;

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">builder</span>.<span class="na">build</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">attributes</span>, {});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">changes</span>, {<span class="na">title</span>: <span class="s">'Winnie-the-Pooh'</span>});</div></div></pre></div></section><section id="koru/model/test-factory::Builder#create" tabindex="-1" name="#create" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Builder#<span class="highlight"><span class="nf">create</span>()</span></h1><abstract><div><p>Create the document. Called by, say, <code>Factory.createBook</code>. See <a class="jsdoc-link" href="#koru/model/test-factory::Builder.constructor">constructor</a>, <a class="jsdoc-link" href="#koru/model/test-factory::Builder#useSave">useSave</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/base-model">Promise(BaseModel)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>)
;

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">builder</span>.<span class="na">create</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">attributes</span>, {<span class="na">_id</span>: <span class="nx">m</span>.<span class="na">id</span>});</div></div></pre></div></section><section id="koru/model/test-factory::Builder#genSeq" tabindex="-1" name="#genSeq" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Builder#<span class="highlight"><span class="nf">genSeq</span>(<span class="nv">field</span>, <span class="nv">key</span>)</span></h1><abstract><div><p>Generate a sequential number for a <code>field</code> and a <code>key</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>key</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/test-factory::Builder">Builder</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>, {<span class="na">title</span>: <span class="s">'Now We Are Six'</span>});

<span class="nx">builder</span>
  .<span class="na">addField</span>(<span class="s">'title'</span>, <span class="s">'When We Were Very Young'</span>)
  .<span class="na">addField</span>(<span class="s">'isbn'</span>, <span class="m">9780140361230</span>)
  .<span class="na">genSeq</span>(<span class="s">'pages'</span>, <span class="s">'book-pages'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">builder</span>.<span class="na">defaults</span>, {<span class="na">isbn</span>: <span class="m">9780140361230</span>, <span class="na">pages</span>: <span class="m">1</span>});</div></div></pre></div></section><section id="koru/model/test-factory::Builder#useSave" tabindex="-1" name="#useSave" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Builder#<span class="highlight"><span class="nf">useSave</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Determine if the normal Model save code should be run.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p><code>false</code> is for the (default) method of bypassing the model validation and
inserting document directly into the DB. <code>true</code> or <code>"assert"</code> is for using
<a class="jsdoc-link" href="#koru/model/base-model#$save">BaseModel#$save("assert")</a> and <code>"force"</code> is for using
<a class="jsdoc-link" href="#koru/model/base-model#$save">BaseModel#$save("force")</a></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/model/test-factory::Builder">Builder</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">intercept</span>(<span class="nx">Book</span>.<span class="na">prototype</span>, <span class="s">'validate'</span>, <span class="kd">function</span> () {
  <span class="k">if</span> (<span class="k">this</span>.<span class="na">author</span> <span class="o">===</span> <span class="o">void</span> <span class="m">0</span>) {
    <span class="k">this</span>.<span class="na">author</span> <span class="o">=</span> <span class="s">'Anon'</span>;
  }
});

{
  <span class="cs">// no validation</span>
  <span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>)
        .<span class="na">useSave</span>(<span class="kc">false</span>) <span class="cs">// the default</span>
  ;

  <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">builder</span>.<span class="na">create</span>();
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">attributes</span>, {<span class="na">_id</span>: <span class="nx">m</span>.<span class="na">id</span>});
}

{
  <span class="cs">// throw exception if invalid (useSave(true))</span>
  <span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>)
        .<span class="na">useSave</span>(<span class="kc">true</span>)
  ;

  <span class="k">await</span> <span class="nx">assert</span>.<span class="na">exception</span>(
    () <span class="o">=&gt;</span> <span class="nx">builder</span>.<span class="na">create</span>(), {<span class="na">error</span>: <span class="m">400</span>, <span class="na">reason</span>: {<span class="na">title</span>: [[<span class="s">'is_required'</span>]]}});
}

{
  <span class="cs">// force save (useSave('force'))</span>
  <span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>)
        .<span class="na">useSave</span>(<span class="s">'force'</span>)
  ;

  <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">builder</span>.<span class="na">create</span>();
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">attributes</span>, {<span class="na">_id</span>: <span class="nx">m</span>.<span class="na">id</span>, <span class="na">author</span>: <span class="s">'Anon'</span>});
}</div></div></pre></div></section><section id="koru/model/test-factory::Builder#waitPromises" tabindex="-1" name="#waitPromises" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Builder#<span class="highlight"><span class="nf">waitPromises</span>()</span></h1><abstract><div><p>Return a promise that whats for all <code>addPromise</code> to complete</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/test-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> [];
<span class="kd">const</span> <span class="no">fut1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Future</span>();
<span class="kd">const</span> <span class="no">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestFactory</span>.<span class="na">Builder</span>(<span class="s">'Book'</span>)
      .<span class="na">addPromise</span>(<span class="nx">fut1</span>.<span class="na">promise</span>.<span class="na">then</span>(() <span class="o">=&gt;</span> {<span class="nx">list</span>.<span class="na">push</span>(<span class="m">1</span>)}))
      .<span class="na">addPromise</span>(<span class="nx">Promise</span>.<span class="na">resolve</span>().<span class="na">then</span>(() <span class="o">=&gt;</span> {<span class="nx">list</span>.<span class="na">push</span>(<span class="m">2</span>)}));

<span class="kd">const</span> <span class="no">p</span> <span class="o">=</span> <span class="nx">builder</span>.<span class="na">waitPromises</span>().<span class="na">then</span>(() <span class="o">=&gt;</span> {<span class="nx">list</span>.<span class="na">push</span>(<span class="m">3</span>)});

<span class="nx">fut1</span>.<span class="na">resolve</span>();
<span class="k">await</span> <span class="nx">p</span>;
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>, [<span class="m">2</span>, <span class="m">1</span>, <span class="m">3</span>]);</div></div></pre></div></section></div></div></div></section><section id="koru/model/trans-queue" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/trans-queue">koru/model/trans-queue</a><h1 class="jsdoc-module-title searchable">TransQueue</h1><abstract><div><p>Run code within a transaction.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/trans-queue.finally" tabindex="-1" name="finally" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TransQueue.<span class="highlight"><span class="nf">finally</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Register a callback to be run when the transaction finishes either
successfully or by aborting.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the function to run on transaction end.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TransQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/trans-queue"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">func1</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">func2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="k">try</span> {
  <span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
    <span class="nx">TransQueue</span>.<span class="na">finally</span>(<span class="nx">func2</span>);
    <span class="k">try</span> {
      <span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
        <span class="nx">TransQueue</span>.<span class="na">finally</span>(<span class="nx">func1</span>);
        <span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func1</span>);   <span class="cs">// not called until outer transaction finishes</span>
        <span class="k">throw</span> <span class="s">'abort'</span>;
      });
    } <span class="k">finally</span> {
      <span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func1</span>);
      <span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func2</span>);
    }
  });
} <span class="k">catch</span> (<span class="nv">ex</span>) {
  <span class="k">if</span> (<span class="nx">ex</span> <span class="o">!==</span> <span class="s">'abort'</span>) <span class="k">throw</span> <span class="nx">ex</span>;
}
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func1</span>);
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func2</span>);

<span class="nx">func1</span>.<span class="na">reset</span>();
<span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
  <span class="nx">TransQueue</span>.<span class="na">finally</span>(<span class="nx">func1</span>);
});
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func1</span>);</div></div></pre></div></section><section id="koru/model/trans-queue.isInTransaction" tabindex="-1" name="isInTransaction" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TransQueue.<span class="highlight"><span class="nf">isInTransaction</span>()</span></h1><abstract><div><p>Test if currently in a transaction.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TransQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/trans-queue"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">TransQueue</span>.<span class="na">isInTransaction</span>());
<span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">TransQueue</span>.<span class="na">isInTransaction</span>());
});
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">TransQueue</span>.<span class="na">isInTransaction</span>());</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">TransQueue</span>.<span class="na">isInTransaction</span>());
<span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">transaction</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="k">await</span> <span class="m">1</span>;
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">TransQueue</span>.<span class="na">isInTransaction</span>());
});
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">TransQueue</span>.<span class="na">isInTransaction</span>());</div></div></pre></div></section><section id="koru/model/trans-queue.nonNested" tabindex="-1" name="nonNested" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TransQueue.<span class="highlight"><span class="nf">nonNested</span>(<span class="nv">db</span>, <span class="nv">body</span>)</span></h1><abstract><div><p>Ensure we a in a transaction. If a DB is supplied ensure we a wrapped in a DB transaction</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[db]</td><td><a href="#koru/model/base-model">BaseModel</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>An optional dataBase client or Model to start transaction in</p>
</div></td></tr><tr class="jsdoc-arg"><td>[body]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the function to run within the transaction</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TransQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/trans-queue"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// No existing transaction</span>
<span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">nonNested</span>(<span class="nx">TestModel</span>, <span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">TransQueue</span>.<span class="na">inTransaction</span>);
  <span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">nonNested</span>(<span class="nx">TestModel</span>, () <span class="o">=&gt;</span> {
    <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">isClient</span> <span class="o">?</span> <span class="m">0</span> <span class="o">:</span> <span class="nx">TestModel</span>.<span class="na">db</span>.<span class="na">existingTran</span>.<span class="na">savepoint</span>, <span class="m">0</span>);
  });
});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// No wrapped DB transaction</span>
<span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">transaction</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">TransQueue</span>.<span class="na">inTransaction</span>);
  <span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">nonNested</span>(<span class="nx">TestModel</span>, <span class="k">async</span> () <span class="o">=&gt;</span> {
    <span class="nx">TransQueue</span>.<span class="na">onSuccess</span>(() <span class="o">=&gt;</span> {
      <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">isClient</span> <span class="o">?</span> <span class="m">0</span> <span class="o">:</span> <span class="nx">TestModel</span>.<span class="na">db</span>.<span class="na">existingTran</span>.<span class="na">savepoint</span>, <span class="m">0</span>);
    });
    <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">isClient</span> <span class="o">?</span> <span class="m">0</span> <span class="o">:</span> <span class="nx">TestModel</span>.<span class="na">db</span>.<span class="na">existingTran</span>.<span class="na">savepoint</span>, <span class="m">0</span>);
    <span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">nonNested</span>(<span class="nx">TestModel</span>, <span class="k">async</span> () <span class="o">=&gt;</span> {
      <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">isClient</span> <span class="o">?</span> <span class="m">0</span> <span class="o">:</span> <span class="nx">TestModel</span>.<span class="na">db</span>.<span class="na">existingTran</span>.<span class="na">savepoint</span>, <span class="m">0</span>);
      <span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">nonNested</span>(() <span class="o">=&gt;</span> {
        <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">isClient</span> <span class="o">?</span> <span class="m">0</span> <span class="o">:</span> <span class="nx">TestModel</span>.<span class="na">db</span>.<span class="na">existingTran</span>.<span class="na">savepoint</span>, <span class="m">0</span>);
      });
    });
  });
});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// Server Only: existing DB transaction</span>
<span class="k">await</span> <span class="nx">TestModel</span>.<span class="na">db</span>.<span class="na">transaction</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">nonNested</span>(<span class="nx">TestModel</span>, <span class="k">async</span> () <span class="o">=&gt;</span> {
    <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">TestModel</span>.<span class="na">db</span>.<span class="na">existingTran</span>.<span class="na">savepoint</span>, <span class="m">0</span>);
  });
});</div></div></pre></div></section><section id="koru/model/trans-queue.onAbort" tabindex="-1" name="onAbort" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TransQueue.<span class="highlight"><span class="nf">onAbort</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Register a callback to be run if the transaction aborts.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the function to run only if aborted.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TransQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/trans-queue"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">func1</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">func2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="k">try</span> {
  <span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
    <span class="nx">TransQueue</span>.<span class="na">onAbort</span>(<span class="nx">func2</span>);
    <span class="k">try</span> {
      <span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
        <span class="k">try</span> {
          <span class="nx">TransQueue</span>.<span class="na">onAbort</span>(<span class="nx">func1</span>);
          <span class="k">throw</span> <span class="s">'abort'</span>;
        } <span class="k">finally</span> {
          <span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func1</span>);   <span class="cs">// not called until outer transaction finishes</span>
        }
      });
    } <span class="k">catch</span> (<span class="nv">err</span>) {
      <span class="k">throw</span> <span class="nx">err</span>;
    } <span class="k">finally</span> {
      <span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func1</span>);
      <span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func2</span>);
    }
  });
} <span class="k">catch</span> (<span class="nv">ex</span>) {
  <span class="k">if</span> (<span class="nx">ex</span> <span class="o">!==</span> <span class="s">'abort'</span>) <span class="k">throw</span> <span class="nx">ex</span>;
}
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func1</span>);
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func2</span>);

<span class="nx">func1</span>.<span class="na">reset</span>();
<span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
  <span class="nx">TransQueue</span>.<span class="na">onAbort</span>(<span class="nx">func1</span>);
});
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func1</span>);</div></div></pre></div></section><section id="koru/model/trans-queue.onSuccess" tabindex="-1" name="onSuccess" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TransQueue.<span class="highlight"><span class="nf">onSuccess</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Register a callback to be run if the transaction finishes successfully or if
no transaction is running.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the function to run on success.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TransQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/trans-queue"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">func1</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">func2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
  <span class="nx">TransQueue</span>.<span class="na">onSuccess</span>(<span class="nx">func2</span>);
  <span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
    <span class="nx">TransQueue</span>.<span class="na">onSuccess</span>(<span class="nx">func1</span>);
    <span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func1</span>);   <span class="cs">// not called until outer transaction finishes</span>
  });
  <span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func1</span>);
  <span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func2</span>);
});
<span class="k">return</span>;
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func2</span>);

<span class="nx">func1</span>.<span class="na">reset</span>();
<span class="nx">TransQueue</span>.<span class="na">onSuccess</span>(<span class="nx">func1</span>); <span class="cs">// called now since no transaction</span>
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">func1</span>);

<span class="nx">func1</span>.<span class="na">reset</span>();
<span class="k">try</span> {
  <span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
    <span class="nx">TransQueue</span>.<span class="na">onSuccess</span>(<span class="nx">func1</span>);
    <span class="k">throw</span> <span class="s">'abort'</span>;
  });
} <span class="k">catch</span> (<span class="nv">ex</span>) {
  <span class="k">if</span> (<span class="nx">ex</span> <span class="o">!==</span> <span class="s">'abort'</span>) <span class="k">throw</span> <span class="nx">ex</span>;
}
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func1</span>);     <span class="cs">// not called since transaction aborted</span></div></div></pre></div></section><section id="koru/model/trans-queue.transaction" tabindex="-1" name="transaction" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TransQueue.<span class="highlight"><span class="nf">transaction</span>(<span class="nv">db</span>, <span class="nv">body</span>)</span></h1><abstract><div><p>Start a transaction.  On server the transaction is linked to <code>util.thread</code> and a DB
transaction can also be attached. On client only one transaction can be running.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[db]</td><td><a href="#koru/pg/driver::Client">Client</a></td><td class="jsdoc-info"><div><p>an optional database connection which has a
<code>transaction</code> method.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[body]</td><td></td><td class="jsdoc-info"><div><p>the function to run within the transaction.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TransQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/trans-queue"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">inTrans</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
  <span class="nx">inTrans</span> <span class="o">=</span> <span class="nx">TransQueue</span>.<span class="na">isInTransaction</span>();
});
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">inTrans</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/validation" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/validation">koru/model/validation</a><h1 class="jsdoc-module-title searchable">Val</h1><abstract><div><p>Utilities to help validate models.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/validation.addError" tabindex="-1" name="addError" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Val.<span class="highlight"><span class="nf">addError</span>(<span class="nv">doc</span>, <span class="nv">field</span>, ...<span class="nv">args</span>)</span></h1><abstract><div><p>Add an error to an object; usually a <a class="jsdoc-link" href="#koru/model/base-model">model</a> document.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Val</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validation"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> {};
<span class="nx">Val</span>.<span class="na">addError</span>(<span class="nx">doc</span>, <span class="s">'foo'</span>, <span class="s">'is_too_big'</span>, <span class="m">400</span>);
<span class="nx">Val</span>.<span class="na">addError</span>(<span class="nx">doc</span>, <span class="s">'foo'</span>, <span class="s">'is_wrong_color'</span>, <span class="s">'red'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">doc</span>[<span class="na">error$</span>], {<span class="na">foo</span>: [[<span class="s">'is_too_big'</span>, <span class="m">400</span>], [<span class="s">'is_wrong_color'</span>, <span class="s">'red'</span>]]});</div></div></pre></div></section><section id="koru/model/validation.assertDocChanges" tabindex="-1" name="assertDocChanges" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Val.<span class="highlight"><span class="nf">assertDocChanges</span>(<span class="nv">doc</span>, <span class="nv">spec</span>, <span class="nv">new_spec</span><span class="o">=</span><span class="nx">ID_SPEC</span>)</span></h1><abstract><div><p>Assert doc changes are allowed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#BaseModel">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>spec</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[new_spec]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Val</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validation"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">spy</span>(<span class="nx">Val</span>, <span class="s">'assertCheck'</span>);
<span class="kd">const</span> <span class="no">existing</span> <span class="o">=</span> {<span class="na">changes</span>: {<span class="na">name</span>: <span class="s">'new name'</span>}, <span class="nf">$isNewRecord</span>() {<span class="k">return</span> <span class="kc">false</span>}};
<span class="nx">Val</span>.<span class="na">assertDocChanges</span>(<span class="nx">existing</span>, {<span class="na">name</span>: <span class="s">'string'</span>});

<span class="nx">assert</span>.<span class="na">calledWithExactly</span>(<span class="nx">Val</span>.<span class="na">assertCheck</span>, <span class="nx">existing</span>.<span class="na">changes</span>, {<span class="na">name</span>: <span class="s">'string'</span>});

<span class="nx">Val</span>.<span class="na">assertCheck</span>.<span class="na">reset</span>();
<span class="kd">const</span> <span class="no">newDoc</span> <span class="o">=</span> {<span class="na">changes</span>: {<span class="na">_id</span>: <span class="s">'123'</span>, <span class="na">name</span>: <span class="s">'new name'</span>}, <span class="nf">$isNewRecord</span>() {<span class="k">return</span> <span class="kc">true</span>}};
<span class="nx">Val</span>.<span class="na">assertDocChanges</span>(<span class="nx">newDoc</span>, {<span class="na">name</span>: <span class="s">'string'</span>});

<span class="nx">assert</span>.<span class="na">calledWithExactly</span>(
  <span class="nx">Val</span>.<span class="na">assertCheck</span>, <span class="nx">newDoc</span>.<span class="na">changes</span>, {<span class="na">name</span>: <span class="s">'string'</span>}, {<span class="na">altSpec</span>: {<span class="na">_id</span>: <span class="s">'id'</span>}});

<span class="nx">Val</span>.<span class="na">assertCheck</span>.<span class="na">reset</span>();
<span class="nx">Val</span>.<span class="na">assertDocChanges</span>(<span class="nx">newDoc</span>, {<span class="na">name</span>: <span class="s">'string'</span>}, {<span class="na">_id</span>: <span class="s">'any'</span>});

<span class="nx">assert</span>.<span class="na">calledWithExactly</span>(
  <span class="nx">Val</span>.<span class="na">assertCheck</span>, <span class="nx">newDoc</span>.<span class="na">changes</span>, {<span class="na">name</span>: <span class="s">'string'</span>}, {<span class="na">altSpec</span>: {<span class="na">_id</span>: <span class="s">'any'</span>}});

<span class="nx">TH</span>.<span class="na">noInfo</span>();
<span class="nx">Val</span>.<span class="na">assertCheck</span>.<span class="na">reset</span>();
<span class="nx">assert</span>.<span class="na">accessDenied</span>(() <span class="o">=&gt;</span> {
  <span class="nx">Val</span>.<span class="na">assertDocChanges</span>(<span class="nx">newDoc</span>, {<span class="na">name</span>: <span class="s">'string'</span>}, <span class="kc">null</span>);
});

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">Val</span>.<span class="na">assertCheck</span>);</div></div></pre></div></section><section id="koru/model/validation.register" tabindex="-1" name="register" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Val.<span class="highlight"><span class="nf">register</span>(<span class="nv">module</span>, <span class="nv">map</span>)</span></h1><abstract><div><p>Register one or more collections of validators. This is conventionally done in
<code>app/models/model.js</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>module</td><td><a href="#Module">Module</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>map</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a collection of validation functions or a collection of collection of
validation functions.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Val</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validation"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">stub</span>(<span class="nx">module</span>, <span class="s">'onUnload'</span>);
<span class="nx">Val</span>.<span class="na">register</span>(<span class="nx">module</span>, {<span class="na">TextValidator</span>, <span class="na">RequiredValidator</span>});
<span class="nx">Val</span>.<span class="na">register</span>(<span class="nx">module</span>, <span class="nx">InclusionValidator</span>);

<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">Val</span>.<span class="na">validators</span>(<span class="s">'normalize'</span>));
<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">Val</span>.<span class="na">validators</span>(<span class="s">'inclusion'</span>));
<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">Val</span>.<span class="na">validators</span>(<span class="s">'required'</span>));

<span class="nx">module</span>.<span class="na">onUnload</span>.<span class="na">yieldAll</span>();

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Val</span>.<span class="na">validators</span>(<span class="s">'normalize'</span>), <span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Val</span>.<span class="na">validators</span>(<span class="s">'inclusion'</span>), <span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Val</span>.<span class="na">validators</span>(<span class="s">'required'</span>), <span class="kc">undefined</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/validation::Error" data-env="both" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/validation::Error">koru/model/validation::Error</a><h1 class="jsdoc-module-title searchable">Error</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/validation::Error.msgFor" tabindex="-1" name="msgFor" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Error.<span class="highlight"><span class="nf">msgFor</span>(<span class="nv">doc</span>, <span class="nv">field</span>, <span class="nv">other_error</span>)</span></h1><abstract><div><p>Extract the translated error message for a field</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[field]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[other_error]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Val</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validation"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> {[<span class="na">error$</span>]: {<span class="na">foo</span>: [[<span class="s">'too_long'</span>, <span class="m">34</span>]]}};

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Val</span>.<span class="na">Error</span>.<span class="na">msgFor</span>(<span class="nx">doc</span>, <span class="s">'foo'</span>), <span class="s">'34 characters is the maximum allowed'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Val</span>.<span class="na">Error</span>.<span class="na">msgFor</span>(<span class="nx">doc</span>[<span class="na">error$</span>], <span class="s">'foo'</span>), <span class="s">'34 characters is the maximum allowed'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Val</span>.<span class="na">Error</span>.<span class="na">msgFor</span>(<span class="s">'error one'</span>), <span class="s">'error one'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Val</span>.<span class="na">Error</span>.<span class="na">msgFor</span>([[<span class="s">'error 1'</span>], <span class="s">'error 2'</span>]), <span class="s">'error 1, error 2'</span>);</div></div></pre></div></section><section id="koru/model/validation::Error.toString" tabindex="-1" name="toString" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Error.<span class="highlight"><span class="nf">toString</span>(<span class="nv">doc</span>)</span></h1><abstract><div><p>Translate all errors</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Val</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validation"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> {[<span class="na">error$</span>]: {<span class="na">foo</span>: [[<span class="s">'too_long'</span>, <span class="m">34</span>]], <span class="na">bar</span>: [[<span class="s">'is_invalid'</span>]]}};

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Val</span>.<span class="na">Error</span>.<span class="function toString() { [native code] }">toString</span>(<span class="nx">doc</span>), <span class="s">'foo: 34 characters is the maximum allowed; '</span> <span class="o">+</span>
            <span class="s">'bar: is not valid'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/model/validators/main" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/validators/main">koru/model/validators/main</a><h1 class="jsdoc-module-title searchable">Overview</h1><abstract><div><p>The validators restrict the values of fields in a <a class="jsdoc-link" href="#koru/model/base-model">Model</a>; either by setting
an error or converting the field values. Validators are invoked when a Model document is saved
or <a class="jsdoc-link" href="#koru/model/base-model#$isValid">BaseModel#$isValid()</a> is called.</p>
<p>See <a class="jsdoc-link" href="#koru/model/validation">Val</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div></div></div></section><section id="koru/model/validators/associated-validator" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/validators/associated-validator">koru/model/validators/associated-validator</a><h1 class="jsdoc-module-title searchable">AssociatedValidator</h1><abstract><div><p>Validate the association between two model documents.</p>
<p>Enable with <a class="jsdoc-link" href="#koru/model/validation.register">Val.register(module, AssociatedValidator)</a> which is conventionally
done in <code>app/models/model.js</code></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/validators/associated-validator.associated" tabindex="-1" name="associated" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">AssociatedValidator.<span class="highlight"><span class="nf">associated</span>(<span class="nv">doc</span>, <span class="nv">field</span>, <span class="nv">options</span>, {<span class="nv">type</span>, <span class="nv">changesOnly</span>, <span class="nv">model</span>})</span></h1><abstract><div><p>Ensure field contains the id of another model document given certain constraints.</p>
<p></p><p>Duplicates are not allowed. Ids will be arranged in ascending order.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>]);
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: <span class="kc">true</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a789'</span>, <span class="s">'a123'</span>]});
<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">author_ids</span>, [[<span class="s">'duplicates'</span>]]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">author_ids</span>, [<span class="s">'a123'</span>, <span class="s">'a123'</span>, <span class="s">'a789'</span>]);</div></pre><p></p>
<p>If <code>filter</code> is true duplicates will be removed</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>]);
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: {<span class="na">filter</span>: <span class="kc">true</span>}},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a789'</span>, <span class="s">'a123'</span>]});
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">author_ids</span>, [<span class="s">'a123'</span>, <span class="s">'a789'</span>]);</div></pre><p></p>
<p></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>options</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>true</code> is the same as an empty object (<code>{}</code>). The following properties are
supported:</p>
<ul>
<li><p><code>filter</code> will remove any invalid ids rather than invalidating the document.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>]);

<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: {<span class="na">filter</span>: <span class="kc">true</span>}},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a456'</span>, <span class="s">'a789'</span>]});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">author_ids</span>, [<span class="s">'a123'</span>, <span class="s">'a789'</span>]);</div></pre><p></p>
</li>
<li><p><code>finder</code> is a function that is called with the document as <code>this</code> and the ids to check as
the first argument.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>], {<span class="na">unpublished</span>: [<span class="s">'a456'</span>]});
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: {<span class="nf">finder</span>(<span class="nv">values</span>) {
    <span class="k">return</span> <span class="nx">Author</span>.<span class="na">where</span>(<span class="s">'published'</span>, <span class="k">this</span>.<span class="na">published</span>).<span class="na">where</span>(<span class="s">'_id'</span>, <span class="nx">values</span>);
  }}},
  <span class="na">published</span>: {<span class="na">type</span>: <span class="s">'boolean'</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a456'</span>]});
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());

<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a456'</span>], <span class="na">published</span>: <span class="kc">true</span>});
<span class="nx">refute</span>(<span class="nx">book2</span>.<span class="na">$isValid</span>());</div></pre><p></p>
 <p>If the document has a prototype method named <code>&lt;field-name-sans/_ids?/&gt;Find</code> then it will
be used to scope the query unless <code>finder</code> is present.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>], {<span class="na">unpublished</span>: [<span class="s">'a456'</span>]});

<span class="kd">function</span> <span class="nf">authorFind</span>(<span class="nv">values</span>) {
  <span class="k">return</span> <span class="nx">Author</span>.<span class="na">where</span>(<span class="s">'published'</span>, <span class="k">this</span>.<span class="na">published</span>).<span class="na">where</span>(<span class="s">'_id'</span>, <span class="nx">values</span>);
}

<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: <span class="kc">true</span>},
  <span class="na">published</span>: {<span class="na">type</span>: <span class="s">'boolean'</span>},
});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a456'</span>]});
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">book</span>.<span class="na">authorFind</span> <span class="o">=</span> <span class="nx">authorFind</span>;
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());

<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a456'</span>], <span class="na">published</span>: <span class="kc">true</span>});
<span class="nx">assert</span>(<span class="nx">book2</span>.<span class="na">$isValid</span>());
<span class="nx">book2</span>.<span class="na">authorFind</span> <span class="o">=</span> <span class="nx">authorFind</span>;
<span class="nx">refute</span>(<span class="nx">book2</span>.<span class="na">$isValid</span>());</div></pre><p></p>
</li>
</ul>
</div></td></tr><tr class="jsdoc-arg"><td>type</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p></p><p>When the field <code>type</code> is <code>'belongs_to'</code> the field value must be a string containing the
id of an association document.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>]);

<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_id</span>: {<span class="na">type</span>: <span class="s">'belongs_to'</span>, <span class="na">associated</span>: <span class="kc">true</span>},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_id</span>: <span class="s">'wrongId'</span>});

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">author_id</span>, [[<span class="s">'not_found'</span>]]);

<span class="nx">book</span>.<span class="na">author_id</span> <span class="o">=</span> <span class="s">'a123'</span>;
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());</div></pre><p></p>
<p></p>
<p>Otherwise the field is expected to be an array of ids
</p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>]);

<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: <span class="kc">true</span>},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a456'</span>, <span class="s">'a789'</span>]});

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">author_ids</span>, [[<span class="s">'not_found'</span>]]);</div></pre><p></p>
</div></td></tr><tr class="jsdoc-arg"><td>[changesOnly]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p></p><p>When this <code>fieldOption</code> is true association only checks for ids which have changed.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>]);
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: <span class="kc">true</span>, <span class="na">changesOnly</span>: <span class="kc">true</span>},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
<span class="nx">book</span>.<span class="na">attributes</span>.<span class="na">author_ids</span> <span class="o">=</span> [<span class="s">'a123'</span>, <span class="s">'badId1'</span>, <span class="s">'badId2'</span>];
<span class="nx">book</span>.<span class="na">author_ids</span> <span class="o">=</span> [<span class="s">'badId1'</span>, <span class="s">'a123'</span>, <span class="s">'a789'</span>];

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>()); <span class="cs">// new id 'a789' exists</span>

<span class="nx">book</span>.<span class="na">author_ids</span> <span class="o">=</span> [<span class="s">'badId3'</span>, <span class="s">'a123'</span>, <span class="s">'a789'</span>];

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>()); <span class="cs">// new id 'badId3' not found</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">author_ids</span>, [[<span class="s">'not_found'</span>]]);</div></pre><p></p>
<p></p>
</div></td></tr><tr class="jsdoc-arg"><td>[model]</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div><p></p><p>A <code>model</code> will override the associated model.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>]);

<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">authors</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: <span class="kc">true</span>, <span class="na">model</span>: <span class="nx">Author</span>},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">authors</span>: [<span class="s">'a123'</span>]});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());

<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">authors</span>: [<span class="s">'a456'</span>]});
<span class="nx">refute</span>(<span class="nx">book2</span>.<span class="na">$isValid</span>());</div></pre><p></p>
<p></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AssociatedValidator</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validators/associated-validator"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">addAuthors</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>]);

<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: <span class="kc">true</span>},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a456'</span>, <span class="s">'a789'</span>]});

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">author_ids</span>, [[<span class="s">'not_found'</span>]]);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">addAuthorsAsync</span>([<span class="s">'a123'</span>, <span class="s">'a789'</span>]);

<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: <span class="kc">true</span>},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: [<span class="s">'a123'</span>, <span class="s">'a456'</span>, <span class="s">'a789'</span>]});

<span class="nx">refute</span>(<span class="k">await</span> <span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">author_ids</span>, [[<span class="s">'not_found'</span>]]);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// is_invalid</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">author_ids</span>: {<span class="na">type</span>: <span class="s">'has_many'</span>, <span class="na">associated</span>: <span class="kc">true</span>},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">author_ids</span>: <span class="s">'a123'</span>}); <span class="cs">// not an array</span>

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">author_ids</span>, [[<span class="s">'is_invalid'</span>]]);</div></div></pre></div></section></div></div></div></section><section id="koru/model/validators/length-validator" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/validators/length-validator">koru/model/validators/length-validator</a><h1 class="jsdoc-module-title searchable">LengthValidator</h1><abstract><div><p>Validate the length of an object.</p>
<p>Enable with <a class="jsdoc-link" href="#koru/model/validation.register">Val.register(module, LengthValidator)</a> which is conventionally done
in <code>app/models/model.js</code></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/validators/length-validator.maxLength" tabindex="-1" name="maxLength" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">LengthValidator.<span class="highlight"><span class="nf">maxLength</span>(<span class="nv">doc</span>, <span class="nv">field</span>, <span class="nv">length</span>)</span></h1><abstract><div><p>Ensure field is not greater than length.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>length</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">LengthValidator</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validators/length-validator"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">title</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">maxLength</span>: <span class="m">10</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">title</span>: <span class="s">'Animal Farm'</span>});

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">title</span>, [[<span class="s">"too_long"</span>, <span class="m">10</span>]]);</div></div></pre></div></section></div></div></div></section><section id="koru/model/validators/text-validator" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/validators/text-validator">koru/model/validators/text-validator</a><h1 class="jsdoc-module-title searchable">TextValidator</h1><abstract><div><p>Text validators and convertors.</p>
<p>Enable with <a class="jsdoc-link" href="#koru/model/validation.register">Val.register(module, TextValidator)</a> which is conventionally done
in <code>app/models/model.js</code></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/validators/text-validator.boolean" tabindex="-1" name="boolean" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TextValidator.<span class="highlight"><span class="nf">boolean</span>(<span class="nv">doc</span>, <span class="nv">field</span>, <span class="nv">boolType</span>)</span></h1><abstract><div><p>Ensure field is a boolean. Strings of trimmed lower case <code>'true'</code>, <code>'on'</code>, <code>'1'</code> and <code>'t'</code>
are converted to <code>true</code>. Strings of trimmed lower case <code>'false'</code>, <code>'off'</code>, <code>'0'</code> and <code>'f'</code>
are converted to <code>false</code>. If converted value is not of type <code>boolean</code>, <code>undefined</code> or
<code>null</code> a <code>'not_a_boolean'</code> error is added.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>boolType</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TextValidator</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validators/text-validator"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// trueOnly</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">inPrint</span>: {<span class="na">type</span>: <span class="s">'boolean'</span>, <span class="na">boolean</span>: <span class="s">'trueOnly'</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">inPrint</span>: <span class="kc">false</span>});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">inPrint</span>, <span class="o">void</span> <span class="m">0</span>);

<span class="nx">book</span>.<span class="na">inPrint</span> <span class="o">=</span> <span class="kc">true</span>;

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">inPrint</span>, <span class="kc">true</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// accepted true values</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">inPrint</span>: {<span class="na">type</span>: <span class="s">'boolean'</span>, <span class="na">boolean</span>: <span class="kc">true</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
<span class="k">for</span> (<span class="kd">const</span> <span class="no">val</span> <span class="k">of</span> [<span class="s">'trUe  '</span>, <span class="s">'T'</span>, <span class="s">' 1'</span>, <span class="s">'on'</span>, <span class="kc">true</span>]) {
  <span class="nx">book</span>.<span class="na">inPrint</span> <span class="o">=</span> <span class="nx">val</span>;

  <span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">book</span>.<span class="na">inPrint</span>);
}</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// accepted false values</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">inPrint</span>: {<span class="na">type</span>: <span class="s">'boolean'</span>, <span class="na">boolean</span>: <span class="kc">true</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
<span class="k">for</span> (<span class="kd">const</span> <span class="no">val</span> <span class="k">of</span> [<span class="s">' FALSE  '</span>, <span class="s">'f'</span>, <span class="s">' 0'</span>, <span class="s">'off'</span>, <span class="kc">false</span>]) {
  <span class="nx">book</span>.<span class="na">inPrint</span> <span class="o">=</span> <span class="nx">val</span>;

  <span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
  <span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">book</span>.<span class="na">inPrint</span>);
}</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// invalid values</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">inPrint</span>: {<span class="na">type</span>: <span class="s">'boolean'</span>, <span class="na">boolean</span>: <span class="kc">true</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
<span class="k">for</span> (<span class="kd">const</span> <span class="no">val</span> <span class="k">of</span> [<span class="s">' FALS  '</span>, <span class="s">'tru'</span>, <span class="s">'  '</span>, <span class="m">0</span>, <span class="m">1</span>]) {
  <span class="nx">book</span>.<span class="na">inPrint</span> <span class="o">=</span> <span class="nx">val</span>;

  <span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">inPrint</span>, <span class="nx">val</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>][<span class="s">'inPrint'</span>],[[<span class="s">'not_a_boolean'</span>]]);
}</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// null or undefined</span>
<span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">inPrint</span>: {<span class="na">type</span>: <span class="s">'boolean'</span>, <span class="na">boolean</span>: <span class="kc">true</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">inPrint</span>: <span class="kc">null</span>});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">inPrint</span>, <span class="o">void</span> <span class="m">0</span>);

<span class="nx">book</span>.<span class="na">inPrint</span> <span class="o">=</span> <span class="o">void</span> <span class="m">0</span>;

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">inPrint</span>, <span class="o">void</span> <span class="m">0</span>);</div></div></pre></div></section><section id="koru/model/validators/text-validator.normalize" tabindex="-1" name="normalize" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TextValidator.<span class="highlight"><span class="nf">normalize</span>(<span class="nv">doc</span>, <span class="nv">field</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Ensure text is in a normalized form</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>options</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p><code>"upcase"</code> to convert field to upper case. <code>"downcase"</code> to convert field to
lower case. Other values are ignored.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TextValidator</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validators/text-validator"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">title</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">normalize</span>: <span class="s">'downcase'</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">title</span>: <span class="s">'Animal Farm'</span>});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">title</span>, <span class="s">'animal farm'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">title</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">normalize</span>: <span class="s">'upcase'</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">title</span>: <span class="s">'Animal Farm'</span>});
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">title</span>, <span class="s">'ANIMAL FARM'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">title</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="na">normalize</span>: <span class="s">'upcase'</span>}
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">title</span>: <span class="m">12345</span>});

<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">title</span>, <span class="m">12345</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">title</span>,[[<span class="s">'not_a_string'</span>]]);

<span class="nx">book</span>.<span class="na">title</span> <span class="o">=</span> <span class="kc">null</span>;
<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());</div></div></pre></div></section></div></div></div></section><section id="koru/model/validators/validate-validator" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/model/validators/validate-validator">koru/model/validators/validate-validator</a><h1 class="jsdoc-module-title searchable">ValidateValidator</h1><abstract><div><p>Validate field with custom validation function.</p>
<p>Enable with <a class="jsdoc-link" href="#koru/model/validation.register">Val.register(module, ValidateValidator)</a> which is conventionally done
in <code>app/models/model.js</code></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/model/validators/validate-validator.validate" tabindex="-1" name="validate" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">ValidateValidator.<span class="highlight"><span class="nf">validate</span>(<span class="nv">doc</span>, <span class="nv">field</span>, <span class="nv">validator</span>)</span></h1><abstract><div><p>Run <code>validator</code> on <code>field</code> (if changed)</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>field</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>validator</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>A function which has the document as <code>this</code> and takes one argument <code>field</code>
name. If an error is found use <a class="jsdoc-link" href="#koru/model/validation.addError">Val.addError</a> to invalidate document or
return a string containing the error message.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div><p>an optional string which is an error message if invalid. The message will be added
to the documents errors for the <code>field</code>.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ValidateValidator</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/model/validators/validate-validator"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Book</span>.<span class="na">defineFields</span>({
  <span class="na">ISBN</span>: {<span class="na">type</span>: <span class="s">'text'</span>, <span class="nf">validate</span>(<span class="nv">field</span>) {
    <span class="cs">// normalize and validate the ISBN</span>
    <span class="kd">const</span> <span class="no">val</span> <span class="o">=</span> <span class="k">this</span>[<span class="na">field</span>];
    <span class="k">if</span> (<span class="o">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="s">'string'</span>) {
      <span class="kd">const</span> <span class="no">norm</span> <span class="o">=</span> <span class="nx">val</span>.<span class="na">replace</span>(<span class="sr">/-/g</span>, <span class="s">''</span>);
      <span class="k">if</span> (<span class="nx">norm</span>.<span class="na">length</span> <span class="o">==</span> <span class="m">13</span>) {
        <span class="k">if</span> (<span class="nx">checkDigit13Valid</span>(<span class="nx">norm</span>)) {
          <span class="k">if</span> (<span class="nx">norm</span> <span class="o">!==</span> <span class="nx">val</span>) <span class="k">this</span>[<span class="na">field</span>] <span class="o">=</span> <span class="nx">norm</span>;
          <span class="k">return</span>; <span class="cs">// is valid</span>
        }
      }
    }

    <span class="k">return</span> <span class="s">'is_invalid'</span>;
  }},
});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>({<span class="na">ISBN</span>: <span class="s">'978-3-16-148410-0'</span>});

<span class="nx">assert</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">ISBN</span>, <span class="s">'9783161484100'</span>);

<span class="nx">book</span>.<span class="na">ISBN</span> <span class="o">=</span> <span class="s">'222-3-16-148410-0'</span>;
<span class="nx">refute</span>(<span class="nx">book</span>.<span class="na">$isValid</span>());
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>[<span class="na">error$</span>].<span class="na">ISBN</span>, [[<span class="s">'is_invalid'</span>]]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">ISBN</span>, <span class="s">'222-3-16-148410-0'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/module-graph" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/module-graph">koru/module-graph</a><h1 class="jsdoc-module-title searchable">ModuleGraph</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/module-graph.findPath" tabindex="-1" name="findPath" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">ModuleGraph.<span class="highlight"><span class="nf">findPath</span>(<span class="nv">start</span>, <span class="nv">goal</span>)</span></h1><abstract><div><p>Finds shortest dependency path from one module to another
module that it (indirectly) requires.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>start</td><td><a href="#Module">Module</a></td><td class="jsdoc-info"><div><p>the module to start from</p>
</div></td></tr><tr class="jsdoc-arg"><td>goal</td><td><a href="#Module">Module</a></td><td class="jsdoc-info"><div><p>the module to look for</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#Module">[Module,...]</a></td><td class="jsdoc-info"><div><p>from <code>start</code> to <code>goal</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ModuleGraph</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/module-graph"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">ModuleGraph</span>.<span class="na">findPath</span>(<span class="ge nx">{Module:koru/module-graph-test}</span>, <span class="ge nx">{Module:koru/util-base}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">[{Module:koru/module-graph-test}, {Module:koru/main}, {Module:koru/util}, {Module:koru/util-base}]</span></span></div></pre></div></section><section id="koru/module-graph.isRequiredBy" tabindex="-1" name="isRequiredBy" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">ModuleGraph.<span class="highlight"><span class="nf">isRequiredBy</span>(<span class="nv">supplier</span>, <span class="nv">user</span>)</span></h1><abstract><div><p>Test if <code>supplier</code> is required by <code>user</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>supplier</td><td><a href="#Module">Module</a></td><td class="jsdoc-info"><div><p>the module to look for</p>
</div></td></tr><tr class="jsdoc-arg"><td>user</td><td><a href="#Module">Module</a></td><td class="jsdoc-info"><div><p>the module to start from</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p>true if path found from user to supplier</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ModuleGraph</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/module-graph"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">ModuleGraph</span>.<span class="na">isRequiredBy</span>(<span class="ge nx">{Module:koru/util-base}</span>, <span class="ge nx">{Module:koru/module-graph-test}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">ModuleGraph</span>.<span class="na">isRequiredBy</span>(<span class="ge nx">{Module:koru/module-graph-test}</span>, <span class="ge nx">{Module:koru/util-base}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div></pre></div></section></div></div></div></section><section id="koru/mutex" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/mutex">koru/mutex</a><h1 class="jsdoc-module-title searchable">Mutex</h1><abstract><div><p>Mutex implements a semaphore <a href="https://en.wikipedia.org/wiki/Lock_(computer_science)" target="_blank">lock</a>.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#isLocked</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>true if mutex is locked</p>
</div></td></tr><tr><td class="searchable">#isLockedByMe</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>true if mutex is locked by the current thread. On client there is only one thread so same result as <code>isLocked</code></p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/mutex.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>()</span></h1><abstract><div><p>Construct a Mutex.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Mutex</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/mutex"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mutex</span>();

<span class="kd">let</span> <span class="nv">counter</span> <span class="o">=</span> <span class="m">0</span>;

<span class="k">try</span> {
  <span class="k">await</span> <span class="nx">mutex</span>.<span class="na">lock</span>();

  <span class="nx">koru</span>.<span class="na">runFiber</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
    <span class="k">await</span> <span class="nx">mutex</span>.<span class="na">lock</span>();

    <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);
    <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLockedByMe</span>);

    <span class="nx">koru</span>.<span class="na">runFiber</span>(() <span class="o">=&gt;</span> {
      <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);
      <span class="nx">isServer</span> <span class="o">&amp;&amp;</span> <span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">mutex</span>.<span class="na">isLockedByMe</span>);
    });

    <span class="nx">counter</span> <span class="o">=</span> <span class="m">1</span>;

    <span class="nx">mutex</span>.<span class="na">unlock</span>();

    <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);
    <span class="nx">isServer</span> <span class="o">&amp;&amp;</span> <span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">mutex</span>.<span class="na">isLockedByMe</span>);
  });
} <span class="k">finally</span> {
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);
  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLockedByMe</span>);

  <span class="nx">mutex</span>.<span class="na">unlock</span>();
}

<span class="k">await</span> <span class="nx">mutex</span>.<span class="na">lock</span>();
<span class="k">try</span> {
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">counter</span>, <span class="m">1</span>);
} <span class="k">finally</span> {
  <span class="nx">mutex</span>.<span class="na">unlock</span>();
}

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">mutex</span>.<span class="na">isLockedByMe</span>);</div></div></pre></div></section><section id="koru/mutex#lock" tabindex="-1" name="#lock" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Mutex#<span class="highlight"><span class="nf">lock</span>()</span></h1><abstract><div><p>Aquire a lock on the mutex. Will pause until the mutex is unlocked</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Mutex</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/mutex"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mutex</span>();

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">mutex</span>.<span class="na">isLockedByMe</span>);

<span class="k">await</span> <span class="nx">mutex</span>.<span class="na">lock</span>();
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLockedByMe</span>);</div></div></pre></div></section><section id="koru/mutex#unlock" tabindex="-1" name="#unlock" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Mutex#<span class="highlight"><span class="nf">unlock</span>()</span></h1><abstract><div><p>Release a lock on the mutex. Will allow another fiber to aquire the lock</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Mutex</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/mutex"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mutex</span>();
<span class="k">await</span> <span class="nx">mutex</span>.<span class="na">lock</span>();
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);

<span class="nx">mutex</span>.<span class="na">unlock</span>();
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">mutex</span>.<span class="na">isLocked</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">mutex</span>.<span class="na">isLockedByMe</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/observable" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/observable">koru/observable</a><h1 class="jsdoc-module-title searchable">Observable</h1><abstract><div><p>An observeable object. Observable keeps track of subjects and notifies all of them if asked.
An Observable instance is iteratable.</p>
<p>See also <a class="jsdoc-link" href="#koru/make-subject">makeSubject</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/observable.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">allStopped</span>)</span></h1><abstract><div><p>Make an instance of Observable</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[allStopped]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>method will be called when all observers have stopped.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Observable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/observable"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">allStopped</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Observable</span>(<span class="nx">allStopped</span>);

<span class="kd">const</span> <span class="no">observer1</span> <span class="o">=</span> <span class="nx">stub</span>(), <span class="no">observer2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">handle1</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer1</span>);
<span class="kd">const</span> <span class="no">handle2</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer2</span>);

<span class="nx">handle1</span>.<span class="na">stop</span>();

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">allStopped</span>);
<span class="nx">handle2</span>.<span class="na">stop</span>();
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">allStopped</span>);</div></div></pre></div></section><section id="koru/observable#add" tabindex="-1" name="#add" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Observable#<span class="highlight"><span class="nf">add</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>add an observer a subject</p>
<section class="jsdoc-alias"><h1>Aliases</h1><div><code class="jsdoc-alias-term">onChange</code></div></section></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called with the arguments sent by <code>notify</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a handle that has the methods</p>
<ul>
<li><code>callback</code> the function passed to <code>add</code></li>
<li><code>stop</code> a function to stop observing -- stop can be called without a <code>this</code></li>
</ul>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Observable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/observable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Observable</span>();

<span class="kd">const</span> <span class="no">observer1</span> <span class="o">=</span> <span class="nx">stub</span>(), <span class="no">observer2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">handle1</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer1</span>);
<span class="kd">const</span> <span class="no">handle2</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">handle1</span>.<span class="na">callback</span>, <span class="nx">observer1</span>);

<span class="nx">subject</span>.<span class="na">notify</span>(<span class="m">123</span>, <span class="s">'abc'</span>),

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observer1</span>, <span class="m">123</span>, <span class="s">'abc'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observer2</span>, <span class="m">123</span>, <span class="s">'abc'</span>);

<span class="nx">handle1</span>.<span class="na">stop</span>();

<span class="nx">subject</span>.<span class="na">notify</span>(<span class="s">'call2'</span>);

<span class="nx">refute</span>.<span class="na">calledWith</span>(<span class="nx">observer1</span>, <span class="s">'call2'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observer2</span>, <span class="s">'call2'</span>);</div></div></pre></div></section><section id="koru/observable#forEach" tabindex="-1" name="#forEach" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Observable#<span class="highlight"><span class="nf">forEach</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>visit each observer</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Observable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/observable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Observable</span>();

<span class="kd">const</span> <span class="no">observer1</span> <span class="o">=</span> <span class="nx">stub</span>(), <span class="no">observer2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">exp</span> <span class="o">=</span> [
  <span class="nx">m</span>.<span class="na">is</span>(<span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer1</span>)),
  <span class="nx">m</span>.<span class="na">is</span>(<span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer2</span>)),
];

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> [];

<span class="nx">subject</span>.<span class="na">forEach</span>((<span class="nv">h</span>) <span class="o">=&gt;</span> {<span class="nx">ans</span>.<span class="na">push</span>(<span class="nx">h</span>)});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, <span class="nx">exp</span>);</div></div></pre></div></section><section id="koru/observable#notify" tabindex="-1" name="#notify" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Observable#<span class="highlight"><span class="nf">notify</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Notify all observers. Observers are notified in order they were added; first added, first
notified. If any of the observers return a promise then notify will wait for it to resolve
before calling the next observer and will return a promise that will resolve once all
observers have completed their callbacks.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">...any-type</a></td><td class="jsdoc-info"><div><p>arguments to send to observers (see <a class="jsdoc-link" href="#koru/observable#add">add</a>)</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the first argument. Wrapped in a promise if any observers are async.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Observable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/observable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Observable</span>();

<span class="kd">const</span> <span class="no">observer1</span> <span class="o">=</span> <span class="nx">stub</span>(), <span class="no">observer2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer1</span>);
<span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(
  <span class="nx">subject</span>.<span class="na">notify</span>(<span class="m">123</span>, <span class="s">'abc'</span>),
  <span class="m">123</span>,
);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observer1</span>, <span class="m">123</span>, <span class="s">'abc'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observer2</span>, <span class="m">123</span>, <span class="s">'abc'</span>);

<span class="nx">assert</span>(<span class="nx">observer1</span>.<span class="na">calledBefore</span>(<span class="nx">observer2</span>));</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Observable</span>();

<span class="kd">const</span> <span class="no">stub1</span> <span class="o">=</span> <span class="nx">stub</span>(), <span class="no">stub2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">subject</span>.<span class="na">add</span>(<span class="k">async</span> (<span class="nv">a</span>, <span class="nv">b</span>) <span class="o">=&gt;</span> {<span class="k">await</span> <span class="m">1</span>; <span class="nx">stub1</span>(<span class="nx">a</span>, <span class="nx">b</span>)});
<span class="nx">subject</span>.<span class="na">add</span>(<span class="k">async</span> (<span class="nv">a</span>, <span class="nv">b</span>) <span class="o">=&gt;</span> {<span class="nx">stub2</span>(<span class="nx">a</span>, <span class="nx">b</span>); <span class="k">await</span> <span class="m">2</span>});

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">subject</span>.<span class="na">notify</span>(<span class="m">123</span>, <span class="s">'abc'</span>);

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">stub1</span>);

<span class="nx">assert</span>(<span class="nx">isPromise</span>(<span class="nx">ans</span>));

<span class="nx">assert</span>.<span class="na">same</span>(
  <span class="k">await</span> <span class="nx">ans</span>,
  <span class="m">123</span>,
);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">stub1</span>, <span class="m">123</span>, <span class="s">'abc'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">stub2</span>, <span class="m">123</span>, <span class="s">'abc'</span>);

<span class="nx">assert</span>(<span class="nx">stub1</span>.<span class="na">calledBefore</span>(<span class="nx">stub2</span>));</div></div></pre></div></section><section id="koru/observable#stopAll" tabindex="-1" name="#stopAll" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Observable#<span class="highlight"><span class="nf">stopAll</span>()</span></h1><abstract><div><p>Stop all observers</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Observable</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/observable"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Observable</span>();

<span class="kd">const</span> <span class="no">observer1</span> <span class="o">=</span> <span class="nx">stub</span>(), <span class="no">observer2</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer1</span>);
<span class="nx">subject</span>.<span class="na">add</span>(<span class="nx">observer2</span>);

<span class="nx">subject</span>.<span class="na">stopAll</span>();

<span class="nx">subject</span>.<span class="na">notify</span>(<span class="m">123</span>, <span class="s">'abc'</span>);

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">observer1</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">observer2</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/parse/html-parser" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/parse/html-parser">koru/parse/html-parser</a><h1 class="jsdoc-module-title searchable">HtmlParser</h1><abstract><div><p>HTML parsing helpers</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/parse/html-parser.parse" tabindex="-1" name="parse" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">HtmlParser.<span class="highlight"><span class="nf">parse</span>(<span class="nv">code</span>, {
      <span class="nv">filename</span><span class="o">=</span><span class="s">'&lt;anonymous&gt;'</span>,
      <span class="nv">onopentag</span><span class="o">=</span><span class="nx">nop</span>, <span class="nv">ontext</span><span class="o">=</span><span class="nx">nop</span>, <span class="nv">oncomment</span><span class="o">=</span><span class="nx">nop</span>, <span class="nv">onclosetag</span><span class="o">=</span><span class="nx">nop</span>,
    }<span class="o">=</span>{})</span></h1><abstract><div><p>Parse a string of HTML markup calling the callbacks when matched. All callbacks are passed
<code>code</code>, <code>spos</code>, <code>epos</code> where <code>spos</code> and <code>epos</code> are indexes marking the correspoinding slice
of <code>code</code>.
Note: Not all markup errors will throw an exception.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>code</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the HTML markup to parse</p>
</div></td></tr><tr class="jsdoc-arg"><td>[filename]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>A filename to use if a markup error is discovered.</p>
</div></td></tr><tr class="jsdoc-arg"><td>onopentag</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called when a start tag is found.
<code>onopentag(&lt;string&gt; name, &lt;object&gt; attrs, &lt;string&gt; code, &lt;int&gt; spos, &lt;int&gt; epos)</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>ontext</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called when plain text is found
<code>ontext(&lt;string&gt; code, &lt;int&gt; spos, &lt;int&gt; epos)</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>oncomment</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called when a comment is found
<code>oncomment(&lt;string&gt; code, &lt;int&gt; spos, &lt;int&gt; epos)</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>onclosetag</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called when a tag scope has concluded (even when no end tag)
<code>onclosetag(&lt;string&gt; name, &lt;string&gt; type, &lt;string&gt; code, &lt;int&gt; spos, &lt;int&gt; epos)</code></p>
<ul>
<li><code>type</code> is; <code>end</code> for an end tag, <code>self</code> for self closing start tag or <code>missing</code> for no
end tag.</li>
</ul>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">HtmlParser</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/parse/html-parser"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">code</span> <span class="o">=</span> <span class="s">`
&lt;div id="top" class="one two" disabled&gt;
  &lt;input name="title" value="
&amp;quot;hello"&gt;
  &lt;!-- I'm a comment --&gt;
  &lt;p&gt;
    &lt;b&gt;bold&lt;/b&gt;
  &lt;p&gt;
    &lt;br&gt;
    &lt;span&gt;content &amp;lt;inside&amp;gt;&lt;/span&gt;
  &lt;!--
    &lt;p&gt;
    comment 2
  --&gt;
&lt;/div&gt;
`</span>;

<span class="kd">const</span> <span class="no">mapAttrs</span> <span class="o">=</span> (<span class="nv">attrs</span>) <span class="o">=&gt;</span> {
  <span class="kd">let</span> <span class="nv">ans</span> <span class="o">=</span> <span class="s">''</span>;
  <span class="k">for</span> (<span class="kd">const</span> <span class="no">n</span> <span class="k">in</span> <span class="nx">attrs</span>)
    <span class="nx">ans</span> <span class="o">+=</span> <span class="s">' '</span> <span class="o">+</span> (<span class="nx">attrs</span>[<span class="na">n</span>] <span class="o">===</span> <span class="nx">n</span> <span class="o">?</span> <span class="nx">n</span> <span class="o">:</span> <span class="s">`${</span><span class="nx">n</span><span class="s">}="${</span><span class="nx">attrs</span>[<span class="na">n</span>]<span class="s">}"`</span>);
  <span class="k">return</span> <span class="nx">ans</span>;
};

<span class="kd">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="s">''</span>;
<span class="kd">const</span> <span class="no">tags</span> <span class="o">=</span> [], <span class="no">comments</span> <span class="o">=</span> [];
<span class="kd">let</span> <span class="nv">level</span> <span class="o">=</span> <span class="m">0</span>;
<span class="nx">HTMLParser</span>.<span class="na">parse</span>(<span class="nx">code</span>, {
  <span class="na">onopentag</span>: (<span class="nv">name</span>, <span class="nv">attrs</span>, <span class="nv">code</span>, <span class="nv">spos</span>, <span class="nv">epos</span>) <span class="o">=&gt;</span> {
    <span class="nx">tags</span>.<span class="na">push</span>(<span class="nx">util</span>.<span class="na">isObjEmpty</span>(<span class="nx">attrs</span>) <span class="o">?</span> [<span class="o">++</span><span class="nx">level</span>, <span class="nx">name</span>] <span class="o">:</span> [<span class="o">++</span><span class="nx">level</span>, <span class="nx">name</span>, <span class="nx">attrs</span>]);
    <span class="nx">result</span> <span class="o">+=</span> <span class="nx">code</span>.<span class="na">slice</span>(<span class="nx">spos</span>, <span class="nx">epos</span>);
  },
  <span class="na">ontext</span>: (<span class="nv">code</span>, <span class="nv">spos</span>, <span class="nv">epos</span>) <span class="o">=&gt;</span> {
    <span class="nx">result</span> <span class="o">+=</span> <span class="nx">code</span>.<span class="na">slice</span>(<span class="nx">spos</span>, <span class="nx">epos</span>);
  },
  <span class="na">oncomment</span>: (<span class="nv">code</span>, <span class="nv">spos</span>, <span class="nv">epos</span>) <span class="o">=&gt;</span> {
    <span class="kd">const</span> <span class="no">text</span> <span class="o">=</span> <span class="nx">code</span>.<span class="na">slice</span>(<span class="nx">spos</span>, <span class="nx">epos</span>);
    <span class="nx">comments</span>.<span class="na">push</span>(<span class="nx">text</span>);
    <span class="nx">result</span> <span class="o">+=</span> <span class="nx">text</span>;
  },
  <span class="na">onclosetag</span>: (<span class="nv">name</span>, <span class="nv">type</span>, <span class="nv">code</span>, <span class="nv">spos</span>, <span class="nv">epos</span>) <span class="o">=&gt;</span> {
    <span class="o">--</span><span class="nx">level</span>;
    <span class="nx">tags</span>.<span class="na">push</span>([<span class="s">'end '</span> <span class="o">+</span> <span class="nx">name</span>, <span class="nx">type</span>]);
    <span class="k">if</span> (<span class="nx">type</span> <span class="o">===</span> <span class="s">'end'</span>) {
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">code</span>.<span class="na">slice</span>(<span class="nx">spos</span>, <span class="nx">epos</span>);
    }
  },
});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">tags</span>, [
  [<span class="m">1</span>, <span class="s">'div'</span>, {<span class="na">id</span>: <span class="s">'top'</span>, <span class="na">class</span>: <span class="s">'one two'</span>, <span class="na">disabled</span>: <span class="s">''</span>}],
  [<span class="m">2</span>, <span class="s">'input'</span>, {<span class="na">name</span>: <span class="s">'title'</span>, <span class="na">value</span>: <span class="s">'\n&amp;quot;hello'</span>}],
  [<span class="s">'end input'</span>, <span class="s">'self'</span>],
  [<span class="m">2</span>, <span class="s">'p'</span>],
  [<span class="m">3</span>, <span class="s">'b'</span>],
  [<span class="s">'end b'</span>, <span class="s">'end'</span>],
  [<span class="s">'end p'</span>, <span class="s">'missing'</span>],
  [<span class="m">2</span>, <span class="s">'p'</span>],
  [<span class="m">3</span>, <span class="s">'br'</span>],
  [<span class="s">'end br'</span>, <span class="s">'self'</span>],
  [<span class="m">3</span>, <span class="s">'span'</span>],
  [<span class="s">'end span'</span>, <span class="s">'end'</span>],
  [<span class="s">'end p'</span>, <span class="s">'missing'</span>],
  [<span class="s">'end div'</span>, <span class="s">'end'</span>],
]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">comments</span>, [<span class="s">"&lt;!-- I'm a comment --&gt;"</span>, <span class="s">'&lt;!--\n    &lt;p&gt;\n    comment 2\n  --&gt;'</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">code</span>, <span class="nx">result</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/parse/js-printer" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/parse/js-printer">koru/parse/js-printer</a><h1 class="jsdoc-module-title searchable">JsPrinter</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/parse/js-printer.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>({<span class="nv">input</span>, <span class="nv">write</span>, <span class="nv">ast</span><span class="o">=</span><span class="nx">parse</span>(<span class="nx">input</span>)})</span></h1><abstract><div><p>Create a new javascript printer</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>input</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>write</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[ast]</td><td></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">JsPrinter</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/parse/js-printer"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">example</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="k">return</span> <span class="m">1</span><span class="o">+</span><span class="m">2</span>;
};
<span class="kd">let</span> <span class="nv">output</span> <span class="o">=</span> <span class="s">''</span>;
<span class="kd">const</span> <span class="no">simple</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JsPrinter</span>({
  <span class="na">input</span>: <span class="nx">example</span>.<span class="function toString() { [native code] }">toString</span>(),
  <span class="na">write</span>: (<span class="nv">token</span>) <span class="o">=&gt;</span> {
    <span class="nx">output</span> <span class="o">+=</span> <span class="nx">token</span>;
  },
});

<span class="nx">simple</span>.<span class="na">print</span>(<span class="nx">simple</span>.<span class="na">ast</span>);

<span class="nx">simple</span>.<span class="na">catchup</span>(<span class="nx">simple</span>.<span class="na">ast</span>.<span class="na">end</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">output</span>, <span class="nx">example</span>.<span class="function toString() { [native code] }">toString</span>());</div></div></pre></div></section></div></div></div></section><section id="koru/pg/driver" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pg/driver">koru/pg/driver</a><h1 class="jsdoc-module-title searchable">pg</h1><abstract><div><p>Interface to PostgreSQL.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><table class="jsdoc-config"><tr><td colspan="2"><h1>Config</h1></td></tr><tr class="jsdoc-config-item"><td>url</td><td><div><p>The default url to connect to; see <a href="http://www.postgresql.org/docs/current/static/libpq-connect.html#LIBPQ-CONNSTRING" target="_blank">libpq - Connection<br>Strings</a> for
examples. Note ssl is not support at this time.</p>
</div></td></tr></table><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">defaultDb</td><td><a href="#koru/pg/driver::Client">Client</a></td><td class="jsdoc-info" data-env="server"><div><p>Return the default Client database connection.</p>
</div></td></tr><tr><td class="searchable">#connectionCount</td><td></td><td class="jsdoc-info" data-env="server"><div><p>The number of connections to database server</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pg/driver.connect" tabindex="-1" name="connect" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">pg.<span class="highlight"><span class="nf">connect</span>(<span class="nv">url</span>, <span class="nv">name</span>)</span></h1><abstract><div><p>Create a new database Client connected to the <code>url</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>url</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[name]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The name to give to the connection. By default
it is the schema name.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/pg/driver::Client">Client</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">pg</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/driver"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">pg</span>.<span class="na">connect</span>(<span class="s">"host=/var/run/postgresql dbname=korutest options='-c search_path=public,pg_catalog'"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Pg.Driver("undefined")</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">pg</span>.<span class="na">connect</span>(<span class="s">"postgresql://localhost/korutest"</span>, <span class="s">"conn2"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Pg.Driver("conn2")</span></span></div></pre></div></section></div></div></div></section><section id="koru/pg/driver::Client" data-env="server" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pg/driver::Client">koru/pg/driver::Client</a><h1 class="jsdoc-module-title searchable">Client</h1><abstract><div><p>A connection to a database.</p>
<p>See <a class="jsdoc-link" href="#koru/pg/driver.connect">pg.connect</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#inTransaction</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="server"><div><p>determine if client is in a transaction</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pg/driver::Client.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">url</span>, <span class="nv">name</span>, <span class="nv">formatOptions</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>url</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[formatOptions]</td><td></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">pg</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/driver"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">Client</span> <span class="o">=</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">constructor</span>;
<span class="kd">const</span> <span class="no">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span>(<span class="s">'host=/var/run/postgresql dbname=korutest'</span>, <span class="s">'public'</span>);
<span class="kd">const</span> <span class="no">client2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span>(<span class="kc">undefined</span>, <span class="s">'my name'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">client</span>.<span class="na">_url</span>, <span class="s">'host=/var/run/postgresql dbname=korutest'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">client</span>.<span class="na">name</span>, <span class="s">'public'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">client2</span>.<span class="na">name</span>, <span class="s">'my name'</span>);</div></div></pre></div></section><section id="koru/pg/driver::Client#explainQuery" tabindex="-1" name="#explainQuery" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Client#async explainQuery(...args)</h1><abstract><div><p>Run an EXPLAIN ANALYZE on given query and return result text.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">Promise(string)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">pg</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/driver"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">client</span> <span class="o">=</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>;</div><div class="jsdoc-example-call highlight"><div><span class="nx">client</span>.<span class="na">explainQuery</span>(<span class="s">"SELECT {$a}::int + {$b}::int as ans"</span>, <span class="ge nx">{a: 1, b: 2}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Result  (cost=0.00..0.01 rows=1 width=4) (actual time=0.000..0.000 rows=1 loops=1)
Planning Time: 0.007 ms
Execution Time: 0.003 ms</span></span></div></pre></div></section><section id="koru/pg/driver::Client#jsFieldToPg" tabindex="-1" name="#jsFieldToPg" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Client#<span class="highlight"><span class="nf">jsFieldToPg</span>(<span class="nv">col</span>, <span class="nv">type</span>, <span class="nv">conn</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>col</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[type]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[conn]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">pg</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/driver"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">await</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">withConn</span>((<span class="nv">conn</span>) <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'foo'</span>, <span class="s">'text'</span>), <span class="s">'"foo" text'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'foo'</span>, <span class="s">'id'</span>), <span class="s">'"foo" text collate "C"'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'foo'</span>, <span class="s">'color'</span>), <span class="s">'"foo" text collate "C"'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'foo'</span>, <span class="s">'belongs_to'</span>), <span class="s">'"foo" text collate "C"'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'foo'</span>, <span class="s">'has_many'</span>), <span class="s">'"foo" text[] collate "C"'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'runs'</span>, <span class="s">'number'</span>), <span class="s">'"runs" double precision'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'name'</span>), <span class="s">'"name" text'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'dob'</span>, {<span class="na">type</span>: <span class="s">'date'</span>}), <span class="s">'"dob" date'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(
    <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">jsFieldToPg</span>(<span class="s">'map'</span>, {<span class="na">type</span>: <span class="s">'object'</span>, <span class="na">default</span>: {<span class="na">treasure</span>: <span class="s">'lost'</span>}}),
    <span class="s">`"map" jsonb DEFAULT '{"treasure":"lost"}'::jsonb`</span>);
});</div></div></pre></div></section><section id="koru/pg/driver::Client#query" tabindex="-1" name="#query" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Client#<span class="highlight"><span class="nf">query</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Query the database with a SQL instruction. Five formats are supported (most performant
first):</p>
<ol>
<li><code>query(text)</code> where no parameters are in the query text</li>
<li><code>query(text, params)</code> where parameters correspond to array position (1 is first
position)</li>
<li><code>query(sqlStatment, params)</code> where <code>sqlStatment</code> is a pre-compiled <a class="jsdoc-link" href="#koru/pg/sql-statement">SQLStatement</a>
and params is a key-value object.</li>
<li><code>query(text, params)</code> where params is a key-value object</li>
<li><code>query`queryTemplate`</code></li>
</ol>
<section class="jsdoc-alias"><h1>Aliases</h1><div><code class="jsdoc-alias-term">exec</code></div></section></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="#koru/pg/sql-statement">SQLStatement</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">[object]</a></td><td class="jsdoc-info"><div><p>a list of result records</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">pg</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/driver"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">a</span> <span class="o">=</span> <span class="m">3</span>, <span class="no">b</span> <span class="o">=</span> <span class="m">2</span>;

<span class="nx">assert</span>.<span class="na">equals</span>(
  (<span class="k">await</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">query</span>(<span class="s">`SELECT {$a}::int + {$b}::int as ans`</span>, {<span class="na">a</span>, <span class="na">b</span>}))[<span class="m">0</span>].<span class="na">ans</span>, <span class="m">5</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(
  (<span class="k">await</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">query</span>(<span class="s">`SELECT $1::int + $2::int as ans`</span>, [<span class="nx">a</span>, <span class="nx">b</span>]))[<span class="m">0</span>].<span class="na">ans</span>, <span class="m">5</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(
  (<span class="k">await</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">query</span><span class="s">`SELECT ${</span><span class="nx">a</span><span class="s">}::int + ${</span><span class="nx">b</span><span class="s">}::int as ans`</span>)[<span class="m">0</span>].<span class="na">ans</span>, <span class="m">5</span>);

<span class="kd">const</span> <span class="no">statment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLStatement</span>(<span class="s">`SELECT {$a}::int + {$b}::int as ans`</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(
  (<span class="k">await</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">query</span>(<span class="nx">statment</span>, {<span class="na">a</span>, <span class="na">b</span>}))[<span class="m">0</span>].<span class="na">ans</span>, <span class="m">5</span>);</div></div></pre></div></section><section id="koru/pg/driver::Client#timeLimitQuery" tabindex="-1" name="#timeLimitQuery" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Client#<span class="highlight"><span class="nf">timeLimitQuery</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Same as <a class="jsdoc-link" href="#koru/pg/driver::Client#query">query</a> but limit to time the query can run for. This method will wrap the
query in a transaction/savepoint. Does not support queryTemplate.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Promise(Array)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">pg</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/driver"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">try</span> {
  <span class="nx">assert</span>.<span class="na">same</span>((<span class="k">await</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">timeLimitQuery</span>(<span class="s">`SELECT 'a' || $1 as a`</span>, [<span class="s">'b'</span>], {}))[<span class="m">0</span>].<span class="na">a</span>, <span class="s">'ab'</span>);

  <span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pg</span>.<span class="na">defaultDb</span>.<span class="na">timeLimitQuery</span>(
    <span class="s">`SELECT pg_sleep($1)`</span>, [<span class="m">1.002</span>], {<span class="na">timeout</span>: <span class="m">1</span>, <span class="na">timeoutMessage</span>: <span class="s">'My message'</span>});
  <span class="nx">assert</span>.<span class="na">fail</span>(<span class="s">'Expected timeout '</span>);
} <span class="k">catch</span> (<span class="nv">e</span>) {
  <span class="k">if</span> (<span class="nx">e</span>.<span class="na">error</span> <span class="o">!==</span> <span class="m">504</span>) <span class="k">throw</span> <span class="nx">e</span>;
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">e</span>.<span class="na">reason</span>, <span class="s">'My message'</span>);
}</div></div></pre></div></section></div></div></div></section><section id="koru/pg/sql-statement" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pg/sql-statement">koru/pg/sql-statement</a><h1 class="jsdoc-module-title searchable">SQLStatement</h1><abstract><div><p>A SQL statement with embedded parameters pre compiled to improve efficiency. Not to be confused
with an SQL prepared statement; this is a client side optimization only.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#text</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info" data-env="server"><div><p>The converted query text with inserted numeric parameters; changes when <a class="jsdoc-link" href="#koru/pg/sql-statement#convertArgs">convertArgs</a> is
called.</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pg/sql-statement.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">text</span><span class="o">=</span><span class="s">''</span>)</span></h1><abstract><div><p>Compile a SQLStatement.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>text</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>a SQL statement with embedded parameters in the form <code>{$name}</code> where name will
be replaced by a corresponding key-value object entry.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SQLStatement</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/sql-statement"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">statment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLStatement</span>(
  <span class="s">`SELECT {$foo}::int+{$bar}::int as a, {$foo}::text || '0' as b`</span>);

<span class="nx">assert</span>.<span class="na">equals</span>((<span class="k">await</span> <span class="nx">Driver</span>.<span class="na">defaultDb</span>.<span class="na">query</span>(<span class="nx">statment</span>, {<span class="na">foo</span>: <span class="m">10</span>, <span class="na">bar</span>: <span class="m">5</span>}))[<span class="m">0</span>], {<span class="na">a</span>: <span class="m">15</span>, <span class="na">b</span>: <span class="s">'100'</span>});

<span class="nx">assert</span>.<span class="na">equals</span>((<span class="k">await</span> <span class="nx">Driver</span>.<span class="na">defaultDb</span>.<span class="na">query</span>(<span class="k">new</span> <span class="nx">SQLStatement</span>(<span class="s">'select 1 as a'</span>)))[<span class="m">0</span>], {<span class="na">a</span>: <span class="m">1</span>});</div></div></pre></div></section><section id="koru/pg/sql-statement#append" tabindex="-1" name="#append" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">SQLStatement#<span class="highlight"><span class="nf">append</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Append an SQLStatement to this SQLStatement. Converts this statement.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="#koru/pg/sql-statement">SQLStatement</a></td><td class="jsdoc-info"><div><p>the statement to append.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/pg/sql-statement">SQLStatement</a></td><td class="jsdoc-info"><div><p>this statement.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SQLStatement</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/sql-statement"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLStatement</span>(<span class="s">`SELECT {$foo}::int`</span>);
<span class="kd">const</span> <span class="no">s2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLStatement</span>(<span class="s">', {$bar}::int+{$foo}::int'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">s1</span>.<span class="na">append</span>(<span class="nx">s2</span>), <span class="nx">s1</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">s1</span>.<span class="na">text</span>, <span class="s">'SELECT $1::int, $2::int+$1::int'</span>);</div></div></pre></div></section><section id="koru/pg/sql-statement#appendText" tabindex="-1" name="#appendText" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">SQLStatement#<span class="highlight"><span class="nf">appendText</span>(<span class="nv">text</span>)</span></h1><abstract><div><p>Append text to this SQLStatement. Converts this statement.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>text</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/pg/sql-statement">SQLStatement</a></td><td class="jsdoc-info"><div><p>this statement.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SQLStatement</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/sql-statement"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLStatement</span>(<span class="s">`SELECT {$foo}::int`</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">s1</span>.<span class="na">appendText</span>(<span class="s">', 123'</span>), <span class="nx">s1</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">s1</span>.<span class="na">text</span>, <span class="s">'SELECT $1::int, 123'</span>);</div></div></pre></div></section><section id="koru/pg/sql-statement#clone" tabindex="-1" name="#clone" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">SQLStatement#<span class="highlight"><span class="nf">clone</span>()</span></h1><abstract><div><p>Clone this SQLStatement.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/pg/sql-statement">SQLStatement</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SQLStatement</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/sql-statement"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLStatement</span>(<span class="s">`SELECT {$foo}::int`</span>);
<span class="kd">const</span> <span class="no">s2</span> <span class="o">=</span> <span class="nx">s1</span>.<span class="na">clone</span>();
<span class="nx">s2</span>.<span class="na">convertArgs</span>({<span class="na">foo</span>: <span class="m">1</span>}, [<span class="m">1</span>, <span class="m">2</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">s1</span>.<span class="na">text</span>, <span class="s">'SELECT $1::int'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">s2</span>.<span class="na">text</span>, <span class="s">'SELECT $3::int'</span>);</div></div></pre></div></section><section id="koru/pg/sql-statement#convertArgs" tabindex="-1" name="#convertArgs" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">SQLStatement#<span class="highlight"><span class="nf">convertArgs</span>(<span class="nv">params</span>, <span class="nv">initial</span><span class="o">=</span>[])</span></h1><abstract><div><p>Convert key-value param to a corresponding paramter array for this statement. If an
<code>initial</code> parameter is supplied then parameters will be appended to that array. This
determines what <code>$n</code> parameters will be returned in the <code>#text</code> property.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>params</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[initial]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>An existing list of parameters. Defaults to empty list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p><code>initial</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SQLStatement</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pg/sql-statement"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">statment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SQLStatement</span>(<span class="s">`SELECT {$foo}::int+{$bar}::int as a, {$foo}::text || '0' as b`</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">statment</span>.<span class="na">convertArgs</span>({<span class="na">foo</span>: <span class="m">10</span>, <span class="na">bar</span>: <span class="m">9</span>}), [<span class="m">10</span>, <span class="m">9</span>]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">statment</span>.<span class="na">text</span>, <span class="s">"SELECT $1::int+$2::int as a, $1::text || '0' as b"</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">statment</span>.<span class="na">convertArgs</span>({<span class="na">foo</span>: <span class="m">30</span>, <span class="na">bar</span>: <span class="m">40</span>}, [<span class="m">1</span>, <span class="m">2</span>]), [<span class="m">1</span>, <span class="m">2</span>, <span class="m">30</span>, <span class="m">40</span>]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">statment</span>.<span class="na">text</span>, <span class="s">"SELECT $3::int+$4::int as a, $3::text || '0' as b"</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/promise-queue" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/promise-queue">koru/promise-queue</a><h1 class="jsdoc-module-title searchable">PromiseQueue</h1><abstract><div><p>Queue callbacks to happen after previous queued callbacks using promises.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/promise-queue.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>()</span></h1><abstract><div><p>Construct a PromiseQueue</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PromiseQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/promise-queue"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PromiseQueue</span>();
<span class="kd">let</span> <span class="nv">i</span> <span class="o">=</span> <span class="m">4</span>;
<span class="nx">queue</span>.<span class="na">add</span>(()<span class="o">=&gt;</span>{ <span class="nx">i</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">*</span> <span class="m">2</span>});
<span class="nx">queue</span>.<span class="na">add</span>(()<span class="o">=&gt;</span>{ <span class="o">++</span><span class="nx">i</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">i</span>, <span class="m">4</span>);

<span class="k">await</span> <span class="nx">queue</span>.<span class="na">empty</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">i</span>, <span class="m">9</span>);</div></div></pre></div></section><section id="koru/promise-queue#add" tabindex="-1" name="#add" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">PromiseQueue#<span class="highlight"><span class="nf">add</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>add a callback to the queue. Callback is called even if a previous callback throws an
exception. The previous callbacks output is available as an argument to this callback.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PromiseQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/promise-queue"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PromiseQueue</span>();
<span class="kd">let</span> <span class="nv">i</span> <span class="o">=</span> <span class="m">4</span>;
<span class="nx">queue</span>.<span class="na">add</span>(()<span class="o">=&gt;</span>{ <span class="k">throw</span> <span class="s">"err"</span>});
<span class="nx">queue</span>.<span class="na">add</span>((<span class="nv">err</span>) <span class="o">=&gt;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">err</span> <span class="o">===</span> <span class="s">"err"</span> <span class="o">?</span> <span class="m">2</span> <span class="o">:</span> <span class="o">-</span><span class="m">2</span>);
<span class="nx">queue</span>.<span class="na">add</span>(()<span class="o">=&gt;</span>{ <span class="o">++</span><span class="nx">i</span>});
<span class="k">await</span> <span class="nx">queue</span>.<span class="na">empty</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">i</span>, <span class="m">7</span>);</div></div></pre></div></section><section id="koru/promise-queue#empty" tabindex="-1" name="#empty" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">PromiseQueue#async empty()</h1><abstract><div><p>wait for the queue to be empty</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PromiseQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/promise-queue"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PromiseQueue</span>();
<span class="k">await</span> <span class="nx">queue</span>.<span class="na">empty</span>();

<span class="kd">let</span> <span class="nv">i</span> <span class="o">=</span> <span class="m">4</span>;
<span class="nx">queue</span>.<span class="na">add</span>(()<span class="o">=&gt;</span>{ <span class="nx">i</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">*</span> <span class="m">2</span>});
<span class="kd">const</span> <span class="no">p</span> <span class="o">=</span> <span class="nx">queue</span>.<span class="na">empty</span>(); <span class="cs">// p won't resolve until queue empty</span>

      <span class="nx">queue</span>.<span class="na">add</span>(()<span class="o">=&gt;</span>{ <span class="o">++</span><span class="nx">i</span>});

      <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">i</span>, <span class="m">4</span>);

      <span class="nx">queue</span>.<span class="na">add</span>(()<span class="o">=&gt;</span>{ <span class="nx">i</span> <span class="o">*=</span> <span class="m">5</span>});

      <span class="k">await</span> <span class="nx">p</span>;
      <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">i</span>, <span class="m">45</span>);

      <span class="nx">queue</span>.<span class="na">add</span>(()<span class="o">=&gt;</span>{ <span class="nx">i</span> <span class="o">*=</span> <span class="m">10</span>});

      <span class="k">await</span> <span class="nx">queue</span>.<span class="na">empty</span>();
      <span class="k">await</span> <span class="nx">queue</span>.<span class="na">empty</span>();

      <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">i</span>, <span class="m">450</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/pubsub/main" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pubsub/main">koru/pubsub/main</a><h1 class="jsdoc-module-title searchable">Overview</h1><abstract><div><p>The publish subscribe systems allows clients to be informed of changes on the server.  The
usual scenario is when a client is interested in one or more <a class="jsdoc-link" href="#koru/model/main">Models</a>.</p>
<p>To get reactive changes to server models. A client subscribes to a publication either using
the simplistic <a class="jsdoc-link" href="#koru/pubsub/all-pub">AllPub</a> and <a class="jsdoc-link" href="#koru/pubsub/all-sub">AllSub</a> classes or custom classes
like the following:</p>
<table>
<thead>
<tr>
<th>Client</th>
<th>Server</th>
</tr>
</thead>
<tbody><tr>
<td><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">// Step 1 - Register the subscription</span>
<span class="k">class</span> <span class="nc">LibrarySub</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
  <span class="k">constructor</span>(<span class="nv">args</span>) {
    <span class="k">super</span>(<span class="nx">args</span>);
    <span class="kd">const</span> {<span class="no">shelf</span>} <span class="o">=</span> <span class="k">this</span>.<span class="na">args</span>;
    <span class="k">this</span>.<span class="na">match</span>(<span class="nx">Book</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> <span class="nx">doc</span>.<span class="na">shelf</span> <span class="o">===</span> <span class="nx">self</span>);
  }
  <span class="k">async</span> <span class="nf">connect</span>() {
    <span class="cs">// step 2 from below calls this</span>
    <span class="k">this</span>.<span class="na">lastSubscribed</span> <span class="o">=</span>
      <span class="k">await</span> <span class="nx">lookupLastSubscribed</span>(<span class="k">this</span>);
    <span class="cs">// connect to server</span>
    <span class="k">super</span>.<span class="na">connect</span>();
  }

  <span class="nf">reconnecting</span>() {
    <span class="nx">Book</span>.<span class="na">query</span>.<span class="na">forEach</span>(<span class="nx">Subscription</span>.<span class="na">markForRemove</span>);
  }
}
<span class="nx">LibrarySub</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;</div></pre></td>
<td><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">// Step 1 - Register the publication</span>
<span class="k">class</span> <span class="nc">LibraryPub</span> <span class="k">extends</span> <span class="nx">Publication</span> {
  <span class="k">constructor</span>(<span class="nv">options</span>) {
    <span class="k">super</span>(<span class="nx">options</span>);
  }
  <span class="k">async</span> <span class="nf">init</span>({<span class="na">shelf</span>}) {
    <span class="cs">// step 3 from below calls this</span>
    <span class="nx">Val</span>.<span class="na">ensureString</span>(<span class="nx">shelf</span>);
    <span class="cs">// Send relavent documents to client</span>
    <span class="k">await</span> <span class="nx">Book</span>.<span class="na">where</span>({<span class="na">shelf</span>})
      .<span class="na">forEach</span>((<span class="nv">doc</span>) <span class="o">=&gt;</span> <span class="nx">conn</span>.<span class="na">added</span>(<span class="s">'Book'</span>, <span class="nx">doc</span>.<span class="na">attributes</span>));

    <span class="cs">// Listen for relavent document changes</span>
    <span class="k">this</span>.<span class="na">listeners</span> <span class="o">=</span> [
      <span class="nx">Book</span>.<span class="na">onChange</span>(<span class="nx">Publication</span>.<span class="na">buildUpdate</span>)];
  }

  <span class="nf">stop</span>() {
    <span class="k">super</span>.<span class="na">stop</span>();
    <span class="k">for</span> (<span class="kd">const</span> <span class="no">listener</span> <span class="k">of</span> <span class="k">this</span>.<span class="na">listeners</span>)
      <span class="nx">listener</span>.<span class="na">stop</span>();
  }
}
<span class="nx">LibraryPub</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>; <span class="cs">// Server listens from Library Subscriptions</span>
<span class="cs">// Can also use: LibraryPub.module = module</span></div></pre></td>
</tr>
<tr>
<td><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">// Step 2 - subscribe</span>
<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">LibrarySub</span>.<span class="na">subscribe</span>({<span class="na">shelf</span>: <span class="s">'mathematics'</span>}, (<span class="nv">error</span>) <span class="o">=&gt;</span> {
  <span class="cs">// Step 4 - server has sent responses</span>
  <span class="k">if</span> (<span class="nx">error</span>) {
    <span class="cs">// handle error</span>
  } <span class="k">else</span> {
    <span class="nx">assert</span>(<span class="nx">Book</span>.<span class="na">where</span>(<span class="s">'shelf'</span>, <span class="s">'mathematics'</span>).<span class="na">exists</span>());
  }
});</div></pre></td>
<td></td>
</tr>
<tr>
<td></td>
<td><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">// Step 3 receive connect request from client</span>
<span class="cs">// with data: 's123', 1, 'Library', args, lastSubscribed;</span>
<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LibraryPub</span>({<span class="na">id</span>: <span class="s">'s123'</span>, <span class="na">conn</span>, <span class="na">lastSubscribed</span>});
<span class="k">await</span> <span class="nx">sub</span>.<span class="na">init</span>(<span class="k">...</span><span class="nx">args</span>);
<span class="cs">// after init, server informs client of success and updates lastSubscribed</span>
<span class="cs">// ['s123', 1, 200, new Date(thirtyDaysAgo)]</span></div></pre></td>
</tr>
<tr>
<td><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">// Listening for book changes</span>
<span class="kd">const</span> <span class="no">bookHandle</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">onChange</span>((<span class="nv">dc</span>) <span class="o">=&gt;</span> {
  <span class="cs">// Step 6 - receive book change</span>
  <span class="k">if</span> (<span class="nx">dc</span>.<span class="na">doc</span>.<span class="na">name</span> <span class="o">===</span> <span class="s">"Euclid's Elements"</span>) {
    <span class="nx">dc</span>.<span class="na">doc</span>.<span class="na">readBook</span>();
  }
});</div></pre></td>
<td></td>
</tr>
<tr>
<td></td>
<td><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">// Step 5 - another client adds a book</span>
<span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">shelf</span>: <span class="s">'mathematics'</span>, <span class="na">name</span>: <span class="s">"Euclid's Elements"</span>});
<span class="cs">// book is sent to subscribed clients</span></div></pre></td>
</tr>
<tr>
<td><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">// Step 7 - send close to server</span>
<span class="nx">sub</span>.<span class="na">stop</span>();</div></pre></td>
<td></td>
</tr>
<tr>
<td></td>
<td><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">// Step 8 close recieved from client</span>
<span class="nx">sub</span>.<span class="na">stop</span>();</div></pre></td>
</tr>
</tbody></table>
<p>The example above is deficient in several ways:</p>
<ol>
<li>It does not send updated related only to the shelf requested</li>
<li>It does not coordinate with other publications which may be publishing the same documents.</li>
<li>It does not use <code>lastSubscribed</code> to reduce server-to-client traffic.</li>
</ol>
<p>It is non-trivial to fix these deficiencies; however:</p>
<ol>
<li>{../publication.discreteLastSubscribed} can be used to only send updates.  When sending only
updates it is important the <code>lastSubscribedMaximumAge</code> is set and that no records are actually
deleted until the document has been unchanged for the duration of
<a class="jsdoc-link" href="#koru/pubsub/publication">Publication.lastSubscribedMaximumAge</a>. In this way clients will not miss any data
changes.</li>
<li><a class="jsdoc-link" href="#koru/pubsub/union">Union</a> can be used to combine subscriptions to reduce traffic.</li>
</ol>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div></div></div></section><section id="koru/pubsub/all-pub" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pubsub/all-pub">koru/pubsub/all-pub</a><h1 class="jsdoc-module-title searchable">AllPub</h1><abstract><div><p>AllPub is an extended <a class="jsdoc-link" href="#koru/pubsub/publication">Publication</a> which publicizes all documents in every defined
<a class="jsdoc-link" href="#koru/model/main">Model</a>.
By default all client subscriptions are handled by one unified observer and an identical
message is sent to all subscribers. When extending AllPub individual observations can go in the
<a class="jsdoc-link" href="#koru/pubsub/all-pub#init">init</a> method and union observations can go in the <a class="jsdoc-link" href="#koru/pubsub/all-pub#initUnion">initUnion</a> method.</p>
<p>See also <a class="jsdoc-link" href="#koru/pubsub/all-sub">AllSub</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">requireUserId</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="server"><div><p>require user to be signed in</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pubsub/all-pub.excludeModel" tabindex="-1" name="excludeModel" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">AllPub.<span class="highlight"><span class="nf">excludeModel</span>(...<span class="nv">names</span>)</span></h1><abstract><div><p>Exclude <a class="jsdoc-link" href="#koru/model/main">Model</a>s from being published. UserLogin is always excluded. This will
clear <a class="jsdoc-link" href="#koru/pubsub/all-pub.includeModel">includeModel</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>names</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AllPub</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/all-pub"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">models</span> <span class="o">=</span> <span class="s">'Book Author UserLogin ErrorLog AuditLog'</span>.<span class="na">split</span>(<span class="s">' '</span>);
<span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>(<span class="nx">models</span>);
<span class="kd">const</span> <span class="no">mc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockConn</span>(<span class="nx">conn</span>);
      

<span class="kd">const</span> {<span class="no">Book</span>, <span class="no">Author</span>, <span class="no">UserLogin</span>, <span class="no">AuditLog</span>, <span class="no">ErrorLog</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">author</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Author</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">userLogin</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">UserLogin</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">auditLog</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">AuditLog</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">errorLog</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ErrorLog</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyAllPub</span> <span class="k">extends</span> <span class="nx">AllPub</span> {}
<span class="nx">MyAllPub</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'All'</span>; <span class="cs">// register publication All</span>
      
<span class="nx">MyAllPub</span>.<span class="na">excludeModel</span>(<span class="s">'AuditLog'</span>, <span class="s">'ErrorLog'</span>);

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'s123'</span>, <span class="m">1</span>, <span class="s">'All'</span>);
      
<span class="nx">mc</span>.<span class="na">assertAdded</span>(<span class="nx">book</span>);
<span class="nx">mc</span>.<span class="na">assertAdded</span>(<span class="nx">author</span>);
<span class="nx">mc</span>.<span class="na">refuteAdded</span>(<span class="nx">userLogin</span>);
<span class="nx">mc</span>.<span class="na">refuteAdded</span>(<span class="nx">auditLog</span>);
<span class="nx">mc</span>.<span class="na">refuteAdded</span>(<span class="nx">errorLog</span>);

<span class="kd">let</span> <span class="nv">bookChange</span>, <span class="nv">auditLogChange</span>;
<span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">transaction</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="nx">bookChange</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span>.<span class="na">change</span>(<span class="nx">book</span>);
  <span class="nx">auditLogChange</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span>.<span class="na">change</span>(<span class="nx">auditLog</span>);
});
<span class="nx">mc</span>.<span class="na">assertChange</span>(<span class="nx">bookChange</span>);
<span class="nx">mc</span>.<span class="na">refuteChange</span>(<span class="nx">auditLogChange</span>);</div></div></pre></div></section><section id="koru/pubsub/all-pub.includeModel" tabindex="-1" name="includeModel" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">AllPub.<span class="highlight"><span class="nf">includeModel</span>(...<span class="nv">names</span>)</span></h1><abstract><div><p>Explicitly include the <a class="jsdoc-link" href="#koru/model/main">Model</a>s which should be published. All other models are
excluded. This clears <a class="jsdoc-link" href="#koru/pubsub/all-pub.excludeModel">excludeModel</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>names</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AllPub</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/all-pub"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">models</span> <span class="o">=</span> <span class="s">'Book Author UserLogin ErrorLog AuditLog'</span>.<span class="na">split</span>(<span class="s">' '</span>);
<span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>(<span class="nx">models</span>);
<span class="kd">const</span> <span class="no">mc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockConn</span>(<span class="nx">conn</span>);

<span class="kd">const</span> {<span class="no">Book</span>, <span class="no">Author</span>, <span class="no">UserLogin</span>, <span class="no">AuditLog</span>, <span class="no">ErrorLog</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">author</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Author</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">userLogin</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">UserLogin</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">auditLog</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">AuditLog</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">errorLog</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ErrorLog</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyAllPub</span> <span class="k">extends</span> <span class="nx">AllPub</span> {}
<span class="nx">MyAllPub</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'All'</span>; <span class="cs">// register publication All</span>
      
<span class="nx">MyAllPub</span>.<span class="na">includeModel</span>(<span class="s">'UserLogin'</span>, <span class="s">'Author'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">MyAllPub</span>.<span class="na">includedModels</span>()).<span class="na">map</span>((<span class="nv">m</span>) <span class="o">=&gt;</span> <span class="nx">m</span>.<span class="na">modelName</span>).<span class="na">sort</span>(), [
  <span class="s">'Author'</span>, <span class="s">'UserLogin'</span>]);

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'s123'</span>, <span class="m">1</span>, <span class="s">'All'</span>);
      
<span class="nx">mc</span>.<span class="na">refuteAdded</span>(<span class="nx">book</span>);
<span class="nx">mc</span>.<span class="na">assertAdded</span>(<span class="nx">author</span>);
<span class="nx">mc</span>.<span class="na">assertAdded</span>(<span class="nx">userLogin</span>);
<span class="nx">mc</span>.<span class="na">refuteAdded</span>(<span class="nx">auditLog</span>);
<span class="nx">mc</span>.<span class="na">refuteAdded</span>(<span class="nx">errorLog</span>);

<span class="kd">let</span> <span class="nv">bookChange</span>, <span class="nv">authorChange</span>;
<span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">transaction</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="nx">bookChange</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span>.<span class="na">change</span>(<span class="nx">book</span>);
  <span class="nx">authorChange</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span>.<span class="na">change</span>(<span class="nx">author</span>);
});
<span class="nx">mc</span>.<span class="na">refuteChange</span>(<span class="nx">bookChange</span>);
<span class="nx">mc</span>.<span class="na">assertChange</span>(<span class="nx">authorChange</span>);</div></div></pre></div></section><section id="koru/pubsub/all-pub.includedModels" tabindex="-1" name="includedModels" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">AllPub.<span class="highlight"><span class="nf">*includedModels</span>()</span></h1><abstract><div><p>Return an iterator over the models that are included in the subscription</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AllPub</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/all-pub"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>([<span class="s">'Book'</span>, <span class="s">'Author'</span>]);
<span class="kd">const</span> {<span class="no">Book</span>, <span class="no">Author</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">AllPub</span>.<span class="na">includedModels</span>()).<span class="na">map</span>((<span class="nv">m</span>) <span class="o">=&gt;</span> <span class="nx">m</span>.<span class="na">modelName</span>).<span class="na">sort</span>(), [
  <span class="s">'Author'</span>, <span class="s">'Book'</span>]);</div></div></pre></div></section><section id="koru/pubsub/all-pub#init" tabindex="-1" name="#init" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">AllPub#async init()</h1><abstract><div><p>init will send the contents of the database to each client that subscribes. This method is
called automatically and only needs to be overridden if additionaly setup is required.</p>
<p>When multiple clients connect, within the same time period, only one pass of the DB is
made and the result is sent to all waiting clients.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AllPub</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/all-pub"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>([<span class="s">'Book'</span>]);
<span class="kd">const</span> <span class="no">mc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockConn</span>(<span class="nx">conn</span>);

<span class="kd">const</span> {<span class="no">Book</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyAllPub</span> <span class="k">extends</span> <span class="nx">AllPub</span> {}
      
<span class="kd">const</span> <span class="no">sub1p</span> <span class="o">=</span> <span class="nx">koru</span>.<span class="na">runFiber</span>(() <span class="o">=&gt;</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'s123'</span>, <span class="m">1</span>, <span class="s">'All'</span>));
<span class="kd">const</span> <span class="no">sub2p</span> <span class="o">=</span> <span class="nx">koru</span>.<span class="na">runFiber</span>(() <span class="o">=&gt;</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'s124'</span>, <span class="m">1</span>, <span class="s">'All'</span>));

<span class="nx">future</span>.<span class="na">resolve</span>();

<span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sub1p</span>;
<span class="kd">const</span> <span class="no">sub2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sub2p</span>;

<span class="nx">assert</span>.<span class="na">calledTwice</span>(<span class="nx">mc</span>.<span class="na">sendEncoded</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">mc</span>.<span class="na">sendEncoded</span>.<span class="na">firstCall</span>.<span class="na">args</span>[<span class="m">0</span>], <span class="nx">mc</span>.<span class="na">sendEncoded</span>.<span class="na">lastCall</span>.<span class="na">args</span>[<span class="m">0</span>]);

<span class="nx">mc</span>.<span class="na">assertAdded</span>(<span class="nx">book1</span>);
<span class="nx">mc</span>.<span class="na">assertAdded</span>(<span class="nx">book2</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/pubsub/all-sub" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pubsub/all-sub">koru/pubsub/all-sub</a><h1 class="jsdoc-module-title searchable">AllSub</h1><abstract><div><p>AllSub is an extended <a class="jsdoc-link" href="#koru/pubsub/subscription">Subscription</a> which will subscribe to all documents in
every defined <a class="jsdoc-link" href="#koru/model/main">Model</a>.</p>
<p>See Also <a class="jsdoc-link" href="#koru/pubsub/all-pub">AllPub</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pubsub/all-sub.excludeModel" tabindex="-1" name="excludeModel" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AllSub.<span class="highlight"><span class="nf">excludeModel</span>(...<span class="nv">names</span>)</span></h1><abstract><div><p>Exclude <a class="jsdoc-link" href="#koru/model/main">Model</a>s from being subscribed to. UserLogin is always excluded. This will
clear <a class="jsdoc-link" href="#koru/pubsub/all-sub.includeModel">includeModel</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>names</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AllSub</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/all-sub"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">models</span> <span class="o">=</span> <span class="s">'Book Author UserLogin ErrorLog AuditLog'</span>.<span class="na">split</span>(<span class="s">' '</span>);
<span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>(<span class="nx">models</span>);
      

<span class="kd">const</span> {<span class="no">Book</span>, <span class="no">Author</span>, <span class="no">UserLogin</span>, <span class="no">AuditLog</span>, <span class="no">ErrorLog</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">author</span> <span class="o">=</span> <span class="nx">Author</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">userLogin</span> <span class="o">=</span> <span class="nx">UserLogin</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">auditLog</span> <span class="o">=</span> <span class="nx">AuditLog</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">errorLog</span> <span class="o">=</span> <span class="nx">ErrorLog</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyAllSub</span> <span class="k">extends</span> <span class="nx">AllSub</span> {}
<span class="nx">MyAllSub</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'All'</span>; <span class="cs">// register publication All</span>

<span class="nx">MyAllSub</span>.<span class="na">excludeModel</span>(<span class="s">'AuditLog'</span>, <span class="s">'ErrorLog'</span>);

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">MyAllSub</span>.<span class="na">subscribe</span>();

<span class="nx">assert</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">Book</span>);
<span class="nx">assert</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">Author</span>);
<span class="nx">refute</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">UserLogin</span>);
<span class="nx">refute</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">AuditLog</span>);
<span class="nx">refute</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">ErrorLog</span>);</div></div></pre></div></section><section id="koru/pubsub/all-sub.includeModel" tabindex="-1" name="includeModel" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AllSub.<span class="highlight"><span class="nf">includeModel</span>(...<span class="nv">names</span>)</span></h1><abstract><div><p>Explicitly include the <a class="jsdoc-link" href="#koru/model/main">Model</a>s which should be published. All other models are
excluded. This clears <a class="jsdoc-link" href="#koru/pubsub/all-sub.excludeModel">excludeModel</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>names</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AllSub</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/all-sub"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">models</span> <span class="o">=</span> <span class="s">'Book Author UserLogin ErrorLog AuditLog'</span>.<span class="na">split</span>(<span class="s">' '</span>);
<span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>(<span class="nx">models</span>);

<span class="kd">const</span> {<span class="no">Book</span>, <span class="no">Author</span>, <span class="no">UserLogin</span>, <span class="no">AuditLog</span>, <span class="no">ErrorLog</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">author</span> <span class="o">=</span> <span class="nx">Author</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">userLogin</span> <span class="o">=</span> <span class="nx">UserLogin</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">auditLog</span> <span class="o">=</span> <span class="nx">AuditLog</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">errorLog</span> <span class="o">=</span> <span class="nx">ErrorLog</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyAllSub</span> <span class="k">extends</span> <span class="nx">AllSub</span> {}
<span class="nx">MyAllSub</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'All'</span>; <span class="cs">// register publication All</span>

<span class="nx">MyAllSub</span>.<span class="na">includeModel</span>(<span class="s">'UserLogin'</span>, <span class="s">'Author'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">MyAllSub</span>.<span class="na">includedModels</span>()).<span class="na">map</span>((<span class="nv">m</span>) <span class="o">=&gt;</span> <span class="nx">m</span>.<span class="na">modelName</span>).<span class="na">sort</span>(), [
  <span class="s">'Author'</span>, <span class="s">'UserLogin'</span>]);

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">MyAllSub</span>.<span class="na">subscribe</span>();

<span class="nx">refute</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">Book</span>);
<span class="nx">assert</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">Author</span>);
<span class="nx">assert</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">UserLogin</span>);
<span class="nx">refute</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">AuditLog</span>);
<span class="nx">refute</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">ErrorLog</span>);</div></div></pre></div></section><section id="koru/pubsub/all-sub.includedModels" tabindex="-1" name="includedModels" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AllSub.<span class="highlight"><span class="nf">*includedModels</span>()</span></h1><abstract><div><p>Return an iterator over the models that are included in the subscription</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AllSub</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/all-sub"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>([<span class="s">'Book'</span>, <span class="s">'Author'</span>]);
<span class="kd">const</span> {<span class="no">Book</span>, <span class="no">Author</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">AllSub</span>.<span class="na">includedModels</span>()).<span class="na">map</span>((<span class="nv">m</span>) <span class="o">=&gt;</span> <span class="nx">m</span>.<span class="na">modelName</span>).<span class="na">sort</span>(), [
  <span class="s">'Author'</span>, <span class="s">'Book'</span>]);</div></div></pre></div></section><section id="koru/pubsub/all-sub.subscribe" tabindex="-1" name="subscribe" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AllSub.<span class="highlight"><span class="nf">subscribe</span>(<span class="nv">args</span>, <span class="nv">callback</span>)</span></h1><abstract><div><p>Subscribe to all models in <a class="jsdoc-link" href="#koru/models/model-map">model-map</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[args]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[callback]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/pubsub/all-sub">AllSub</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AllSub</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/all-sub"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">AllSub</span>.<span class="na">subscribe</span>();</div></div></pre></div></section></div></div></div></section><section id="koru/pubsub/model-match" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pubsub/model-match">koru/pubsub/model-match</a><h1 class="jsdoc-module-title searchable">ModelMatch</h1><abstract><div><p>A class to create a match registry that compares a <a class="jsdoc-link" href="#koru/model/main">Model</a> document to a set of
match functions.</p>
<p>Used in <a class="jsdoc-link" href="#koru/pubsub/subscription">Subscription</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pubsub/model-match.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>()</span></h1><abstract><div><p>Create a ModelMatch registry.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ModelMatch</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/model-match"</span>);</div><div><div class="highlight"><span class="k">new</span> <span class="nx">ModelMatch</span>();</div></div></pre></div></section><section id="koru/pubsub/model-match#has" tabindex="-1" name="#has" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">ModelMatch#<span class="highlight"><span class="nf">has</span>(<span class="nv">doc</span>)</span></h1><abstract><div><p>Test if a document matches a matcher. See <a class="jsdoc-link" href="#koru/pubsub/model-match#register">register</a>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div><p>the document to test if matches a matcher</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p><code>true</code>, <code>false</code>, or <code>undefined</code>.</p>
<ol>
<li><code>true</code> if the <code>doc</code> matches any matcher. No further matchers are tested.</li>
<li><code>false</code> if at least one matcher returns <code>false</code> and no matcher returns <code>true</code>. <code>false</code>
indicates that this document should be removed both from memory and client persistent
storage.</li>
<li><code>undefined</code> if all matchers return <code>undefined</code> or no matchers are
registered. <code>undefined</code> indicates that this document should be removed from memory but not
from client persistent storage. Incoming changes from a server which match <code>undefined</code> will
notify <a href="#koru/model/base-model">model</a> observers with a <a class="jsdoc-link" href="#koru/model/doc-change.delete">DocChange.delete</a>
flag of "stopped".</li>
</ol>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ModelMatch</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/model-match"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">myMatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ModelMatch</span>();
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">fetch</span>();
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">fetch</span>();
<span class="kd">const</span> <span class="no">book3</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">fetch</span>();

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book1</span>), <span class="o">void</span> <span class="m">0</span>);

<span class="kd">const</span> <span class="no">m1</span> <span class="o">=</span> <span class="nx">myMatch</span>.<span class="na">register</span>(<span class="s">'Book'</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> {});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book1</span>), <span class="o">void</span> <span class="m">0</span>);

<span class="kd">const</span> <span class="no">m2</span> <span class="o">=</span> <span class="nx">myMatch</span>.<span class="na">register</span>(<span class="s">'Book'</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> {
  <span class="k">return</span> <span class="nx">doc</span> <span class="o">===</span> <span class="nx">book1</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="o">void</span> <span class="m">0</span>;
});

<span class="kd">const</span> <span class="no">m3</span> <span class="o">=</span> <span class="nx">myMatch</span>.<span class="na">register</span>(<span class="s">'Book'</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> {
  <span class="k">return</span> <span class="nx">doc</span> <span class="o">===</span> <span class="nx">book2</span>;
});

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book1</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book2</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book3</span>));

<span class="nx">m3</span>.<span class="na">delete</span>();

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book1</span>));
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book2</span>), <span class="o">void</span> <span class="m">0</span>);</div></div></pre></div></section><section id="koru/pubsub/model-match#register" tabindex="-1" name="#register" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">ModelMatch#<span class="highlight"><span class="nf">register</span>(<span class="nv">modelName</span>, <span class="nv">comparator</span>)</span></h1><abstract><div><p>Register a matcher agains a model.</p>
<p>See also <a class="jsdoc-link" href="#koru/pubsub/model-match#has">has</a>, <a class="jsdoc-link" href="#koru/pubsub/subscription#match">Subscription#match</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>or model</p>
</div></td></tr><tr class="jsdoc-arg"><td>comparator</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>The <code>comparator(doc){}</code> should take one argument <code>doc</code>to test if matches.
Return <code>true</code> to match the document, <code>false</code> to explicitly not match the document and
<code>undefined</code> if no opinion about the document. See <a class="jsdoc-link" href="#koru/pubsub/model-match#has">has</a></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>handle</code> with <code>delete</code> method to unregister the <code>comparator</code>.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ModelMatch</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/model-match"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">myMatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ModelMatch</span>();
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">fetch</span>();
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">fetch</span>();
<span class="kd">const</span> <span class="no">book3</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">fetch</span>();

<span class="kd">const</span> <span class="no">comparator</span> <span class="o">=</span> (<span class="nv">doc</span>) <span class="o">=&gt;</span> <span class="nx">doc</span> <span class="o">===</span> <span class="nx">book1</span> <span class="o">||</span> (<span class="nx">doc</span> <span class="o">===</span> <span class="nx">book2</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="o">void</span> <span class="m">0</span>);
<span class="kd">const</span> <span class="no">m1</span> <span class="o">=</span> <span class="nx">myMatch</span>.<span class="na">register</span>(<span class="s">'Book'</span>, <span class="nx">comparator</span>);

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book1</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book2</span>));
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">myMatch</span>.<span class="na">has</span>(<span class="nx">book3</span>), <span class="o">void</span> <span class="m">0</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/pubsub/preload-subscription" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pubsub/preload-subscription">koru/pubsub/preload-subscription</a><h1 class="jsdoc-module-title searchable">PreloadSubscription</h1><abstract><div><p>PreloadSubscription extends <a class="jsdoc-link" href="#koru/pubsub/subscription">Subscription</a> to facilitate preloading documents from a client
<a class="jsdoc-link" href="#koru/model/query-idb">QueryIDB</a> or similar in addition to fetching from server. This class overrides
the <a class="jsdoc-link" href="#koru/pubsub/subscription#connect">Subscription#connect</a> method with calls to the methods described below.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pubsub/preload-subscription.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">args</span>, <span class="nv">session</span>)</span></h1><abstract><div><p>Used to initialise matchers and any other common synchronous work</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[args]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">...any-type</a></td><td class="jsdoc-info"><div><p>the arguments to send to the publication.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[session]</td><td><a href="#Session">Session</a></td><td class="jsdoc-info"><div><p>The session to subscribe to (defaults to <a class="jsdoc-link" href="#koru/session/main">Session</a>).</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PreloadSubscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/preload-subscription"</span>);</div><div><div class="highlight"><span class="k">class</span> <span class="nc">LibrarySub</span> <span class="k">extends</span> <span class="nx">PreloadSubscription</span> {
  <span class="k">constructor</span>(<span class="nv">args</span>) {
    <span class="k">super</span>(<span class="nx">args</span>);
    <span class="kd">const</span> {<span class="no">shelf</span>} <span class="o">=</span> <span class="nx">args</span>;
    <span class="k">this</span>.<span class="na">match</span>(<span class="nx">Book</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> <span class="nx">doc</span>.<span class="na">shelf</span> <span class="o">===</span> <span class="nx">shelf</span>);
  }
}
<span class="nx">LibrarySub</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;
<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">LibrarySub</span>.<span class="na">subscribe</span>({<span class="na">shelf</span>: <span class="s">'mathematics'</span>});
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> {<span class="na">shelf</span>: <span class="s">'mathematics'</span>};
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">sub</span>.<span class="na">_matches</span>.<span class="na">Book</span>.<span class="na">value</span>(<span class="nx">book1</span>));</div></div></pre></div></section><section id="koru/pubsub/preload-subscription#getQueryIDB" tabindex="-1" name="#getQueryIDB" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">PreloadSubscription#<span class="highlight"><span class="nf">getQueryIDB</span>()</span></h1><abstract><div><p>Override this method to return a <a class="jsdoc-link" href="#koru/model/query-idb">QueryIDB</a> like instance or undefined (if
none). The idb instance is passed to the <a class="jsdoc-link" href="#koru/pubsub/preload-subscription#preload">preload</a> method. If no idb is returned
<a class="jsdoc-link" href="#koru/pubsub/preload-subscription#preload">preload</a> is not called.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PreloadSubscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/preload-subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">LibrarySub</span> <span class="k">extends</span> <span class="nx">PreloadSubscription</span> {
  <span class="nf">getQueryIDB</span>() {<span class="k">return</span> <span class="nx">idb</span>}
  <span class="k">async</span> <span class="nf">preload</span>(<span class="nv">idb</span>) {
    <span class="k">this</span>.<span class="na">shelf</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">idb</span>.<span class="na">get</span>(<span class="s">'last'</span>, <span class="s">'self'</span>);
  }
}</div></div></pre></div></section><section id="koru/pubsub/preload-subscription#preload" tabindex="-1" name="#preload" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">PreloadSubscription#<span class="highlight"><span class="nf">preload</span>(<span class="nv">idb</span>)</span></h1><abstract><div><p>Override this (usally) async method to load client records, using say,
<a class="jsdoc-link" href="#koru/model/query-idb">QueryIDB</a>. Should <code>await</code> for loads to complete before returning. Any
exception thrown during execution will be caught and sent to the
<a class="jsdoc-link" href="#koru/pubsub/subscription#onConnect">Subscription#onConnect</a> observers.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>idb</td><td></td><td class="jsdoc-info"><div><p>returned from <a class="jsdoc-link" href="#koru/pubsub/preload-subscription#getQueryIDB">getQueryIDB</a></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#&quot;skipServer&quot; ">"skipServer" </a> / <a href="# &quot;waitServer&quot; "> "waitServer" </a> / <a href="# undefined"> undefined</a></td><td class="jsdoc-info"><div><p>Unless return is <code>"skipServer"</code> the
server will be called with the subscription request.</p>
<p>If return is <code>"waitServer"</code> <a class="jsdoc-link" href="#koru/pubsub/subscription#onConnect">Subscription#onConnect</a> observers will be called after
server request completes; otherwise observers are called immediately.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PreloadSubscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/preload-subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">LibrarySub</span> <span class="k">extends</span> <span class="nx">PreloadSubscription</span> {
  <span class="nf">getQueryIDB</span>() {<span class="k">return</span> <span class="nx">idb</span>}
  <span class="k">async</span> <span class="nf">preload</span>(<span class="nv">idb</span>) {
    <span class="kd">const</span> <span class="no">shelf</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">idb</span>.<span class="na">get</span>(<span class="s">'last'</span>, <span class="s">'self'</span>);
    <span class="k">if</span> (<span class="nx">self</span> <span class="o">==</span> <span class="kc">null</span>) <span class="k">return</span> <span class="s">'waitServer'</span>;
    <span class="kd">const</span> <span class="no">books</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">idb</span>.<span class="na">index</span>(<span class="s">'Book'</span>, <span class="s">'shelf'</span>).<span class="na">getAll</span>(<span class="nx">IDBKeyRange</span>.<span class="na">only</span>(<span class="nx">shelf</span>.<span class="na">name</span>));
    <span class="nx">idb</span>.<span class="na">loadDocs</span>(<span class="s">'Book'</span>, <span class="nx">books</span>);
    <span class="k">if</span> (<span class="nx">isOffline</span>) <span class="k">return</span> <span class="s">'skipServer'</span>;
  }
}
<span class="nx">LibrarySub</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;</div></div></pre></div></section><section id="koru/pubsub/preload-subscription#serverResponse" tabindex="-1" name="#serverResponse" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">PreloadSubscription#<span class="highlight"><span class="nf">serverResponse</span>(<span class="nv">err</span>, <span class="nv">idb</span>)</span></h1><abstract><div><p>Override this method to intercept the serverResponse to the subscribe.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>err</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="#koru/koru-error">koru.Error</a></td><td class="jsdoc-info"><div><p>null for success else error from server</p>
</div></td></tr><tr class="jsdoc-arg"><td>idb</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a></td><td class="jsdoc-info"><div><p>the object returned from <a class="jsdoc-link" href="#koru/pubsub/preload-subscription#getQueryIDB">getQueryIDB</a></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">PreloadSubscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/preload-subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">callbackNotCalled</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="k">class</span> <span class="nc">LibrarySub</span> <span class="k">extends</span> <span class="nx">PreloadSubscription</span> {
  <span class="nf">getQueryIDB</span>() {<span class="k">return</span> <span class="nx">idb</span>;}
  <span class="nf">serverResponse</span>(<span class="nv">err</span>, <span class="nv">idb</span>) {
    <span class="k">this</span>.<span class="na">serverResponseArgs</span> <span class="o">=</span> [<span class="nx">err</span>, <span class="nx">idb</span>];
    <span class="nx">callbackNotCalled</span> <span class="o">=</span> <span class="nx">callback</span>.<span class="na">firstCall</span> <span class="o">===</span> <span class="o">void</span> <span class="m">0</span>;
  }
}
<span class="kd">let</span> <span class="nv">resolve</span>;
<span class="kd">const</span> <span class="no">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Promise</span>((<span class="nv">_resolve</span>) <span class="o">=&gt;</span> {<span class="nx">resolve</span> <span class="o">=</span> <span class="nx">_resolve</span>});
<span class="kd">const</span> <span class="no">callback</span> <span class="o">=</span> (<span class="nv">err</span>) <span class="o">=&gt;</span> {<span class="nx">resolve</span>(<span class="nx">err</span>)};
<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">LibrarySub</span>.<span class="na">subscribe</span>({<span class="na">shelf</span>: <span class="s">'mathematics'</span>}, <span class="nx">callback</span>);

<span class="k">await</span> <span class="nx">connect</span>.<span class="na">promise</span>;
<span class="nx">sub</span>[<span class="na">connected$</span>]({<span class="na">lastSubscribed</span>: <span class="m">0</span>});
<span class="kd">const</span> <span class="no">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">promise</span>;
<span class="k">if</span> (<span class="nx">err</span>) <span class="k">throw</span> <span class="nx">err</span>;
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">callbackNotCalled</span>); <span class="cs">// assert serverResponse called before callback</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">sub</span>.<span class="na">serverResponseArgs</span>, [<span class="kc">null</span>, <span class="nx">idb</span>]);
<span class="cs">// server error</span>
<span class="k">class</span> <span class="nc">BookSub</span> <span class="k">extends</span> <span class="nx">PreloadSubscription</span> {
  <span class="nf">serverResponse</span>(<span class="nv">err</span>, <span class="nv">idb</span>) {
    <span class="k">this</span>.<span class="na">serverResponseArgs</span> <span class="o">=</span> [<span class="nx">err</span>, <span class="nx">idb</span>];
  }
}
<span class="kd">const</span> <span class="no">sub2</span> <span class="o">=</span> <span class="nx">BookSub</span>.<span class="na">subscribe</span>(<span class="s">'book1'</span>);
<span class="kd">const</span> <span class="no">err2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">koru</span>.<span class="na">Error</span>(<span class="m">500</span>, <span class="s">'server error'</span>);
<span class="nx">sub2</span>.<span class="na">stop</span>(<span class="nx">err2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">sub2</span>.<span class="na">serverResponseArgs</span>, [<span class="nx">err2</span>, <span class="o">void</span> <span class="m">0</span>]);</div></div></pre></div></section></div></div></div></section><section id="koru/pubsub/publication" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pubsub/publication">koru/pubsub/publication</a><h1 class="jsdoc-module-title searchable">Publication</h1><abstract><div><p>A Publication is a abstract interface for handling subscriptions.</p>
<p>See also <a class="jsdoc-link" href="#koru/pubsub/subscription">Subscription</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">lastSubscribedInterval</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="server"><div><p>Allow grouping subscription downloads to an interval bin so that subscriptions wanting
similar data can be satisfied with one pass of the database. Specified in
milliseconds. Defaults to 5mins.</p>
<p>See <a class="jsdoc-link" href="#koru/pubsub/publication.discreteLastSubscribed">discreteLastSubscribed</a></p>
</div></td></tr><tr><td class="searchable">lastSubscribedMaximumAge</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="server"><div><p>Any subscription with a lastSubscribed older than this is aborted with error 400, reason
<code>{lastSubscribed: "too_old"}</code>. Specified in milliseconds. Defaults to 180 days.</p>
<p>Client subscriptions should not send a <code>lastSubscribed</code> value if it is not later than this
value, by at least 10000. It should also mark any current documents as simulated.</p>
</div></td></tr><tr><td class="searchable">#lastSubscribed</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="server"><div><p>The subscriptions last successful subscription time in ms</p>
</div></td></tr><tr><td class="searchable">#userId</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info" data-env="server"><div><p>userId is a short cut to <code>this.conn.userId</code>. See <a class="jsdoc-link" href="#koru/session/server-connection">ServerConnection</a></p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pubsub/publication.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>({<span class="nv">id</span>, <span class="nv">conn</span>, <span class="nv">lastSubscribed</span>})</span></h1><abstract><div><p>Build an incomming subscription.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The id of the subscription</p>
</div></td></tr><tr class="jsdoc-arg"><td>conn</td><td><a href="#koru/session/server-connection">ServerConnection</a></td><td class="jsdoc-info"><div><p>The connection of the subscription</p>
</div></td></tr><tr class="jsdoc-arg"><td>lastSubscribed</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the time in ms when the subscription last connected</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Publication</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/publication"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">lastSubscribed</span> <span class="o">=</span> <span class="nx">Date</span>.<span class="na">now</span>() <span class="o">-</span> <span class="nx">util</span>.<span class="na">DAY</span>;

<span class="kd">let</span> <span class="nv">sub</span>;
<span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Publication</span> {
  <span class="k">constructor</span>(<span class="nv">options</span>) {
    <span class="k">super</span>(<span class="nx">options</span>);
    <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span>;
  }
}
<span class="nx">Library</span>.<span class="na">module</span> <span class="o">=</span> <span class="nx">module</span>;
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Library</span>.<span class="na">pubName</span>, <span class="s">'Library'</span>);

<span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="s">'Library'</span>, {<span class="na">shelf</span>: <span class="s">'mathematics'</span>}, <span class="nx">lastSubscribed</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">constructor</span>, <span class="nx">Library</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">conn</span>, <span class="nx">conn</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">id</span>, <span class="s">'sub1'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">lastSubscribed</span>, <span class="nx">util</span>.<span class="na">dateNow</span>());</div></div></pre></div></section><section id="koru/pubsub/publication.discreteLastSubscribed" tabindex="-1" name="discreteLastSubscribed" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Publication.<span class="highlight"><span class="nf">discreteLastSubscribed</span>(<span class="nv">time</span>)</span></h1><abstract><div><p>Convert <code>time</code> to the lower <code>lastSubscribedInterval</code> boundry.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>time</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the time (in ms) to convert</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Publication</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/publication"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">Publication</span>.<span class="na">lastSubscribedInterval</span> <span class="o">=</span> <span class="m">20</span><span class="o">*</span><span class="m">60</span><span class="o">*</span><span class="m">1000</span>;

<span class="nx">assert</span>.<span class="na">equals</span>(
  <span class="nx">Publication</span>.<span class="na">discreteLastSubscribed</span>(<span class="o">+</span> <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2019</span>, <span class="m">0</span>, <span class="m">4</span>, <span class="m">9</span>, <span class="m">10</span>, <span class="m">11</span>, <span class="m">123</span>)),
  <span class="o">+</span> <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2019</span>, <span class="m">0</span>, <span class="m">4</span>, <span class="m">9</span>, <span class="m">0</span>));</div></div></pre></div></section><section id="koru/pubsub/publication#init" tabindex="-1" name="#init" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Publication#<span class="highlight"><span class="nf">init</span>(<span class="nv">args</span>)</span></h1><abstract><div><p>This is where to fetch and send documents matching the <code>args</code> supplied.
On completion of the init method the server will inform the client the connection is
successful. If an error is thrown then the client will be inform the connection is
unsuccessful.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">...any-type</a></td><td class="jsdoc-info"><div><p>from client</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Publication</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/publication"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">lastSubscribed</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">util</span>.<span class="na">DAY</span>;

<span class="kd">let</span> <span class="nv">sub</span>;
<span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Publication</span> {
  <span class="nf">init</span>({<span class="na">shelf</span>}) {
    <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span>;
    <span class="nx">Val</span>.<span class="na">allowIfValid</span>(<span class="o">typeof</span> <span class="nx">shelf</span> <span class="o">===</span> <span class="s">'string'</span>, <span class="s">'shelf'</span>);
    <span class="k">this</span>.<span class="na">conn</span>.<span class="na">added</span>(<span class="s">'Book'</span>, <span class="s">'b123'</span>, {<span class="na">title</span>: <span class="s">'Principia Mathematica'</span>});
  }
}
<span class="nx">Library</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;

<span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="s">'Library'</span>, {<span class="na">shelf</span>: <span class="s">'mathematics'</span>}, <span class="nx">lastSubscribed</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">conn</span>, <span class="nx">conn</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">id</span>, <span class="s">'sub1'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">lastSubscribed</span>, <span class="nx">util</span>.<span class="na">dateNow</span>());
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">added</span>, <span class="s">'Book'</span>, <span class="s">'b123'</span>, {<span class="na">title</span>: <span class="s">'Principia Mathematica'</span>});
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'Q'</span>, [<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="m">200</span>, <span class="nx">util</span>.<span class="na">dateNow</span>()]);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">sub</span>.<span class="na">isStopped</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// Validation error</span>
<span class="nx">conn</span>.<span class="na">sendBinary</span>.<span class="na">reset</span>();

<span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="s">'Library'</span>, {<span class="na">shelf</span>: <span class="m">123</span>}, <span class="nx">lastSubscribed</span>);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'Q'</span>, [<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="m">400</span>, {<span class="na">shelf</span>: [[<span class="s">'is_invalid'</span>]]}]);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">sub</span>.<span class="na">isStopped</span>);</div></div></pre></div></section><section id="koru/pubsub/publication#onMessage" tabindex="-1" name="#onMessage" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Publication#<span class="highlight"><span class="nf">onMessage</span>(<span class="nv">message</span>)</span></h1><abstract><div><p>Called when a message has been sent from the subscription. Messages are used to alter the
state of a subscription. If an error is thrown the client callback will receive the error.</p>
<p>See <a class="jsdoc-link" href="#koru/pubsub/subscription#postMessage">Subscription#postMessage</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>message</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Publication</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/publication"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">sub</span>;
<span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Publication</span> {
  <span class="nf">init</span>(<span class="nv">args</span>) {
    <span class="k">this</span>.<span class="na">args</span> <span class="o">=</span> <span class="nx">args</span>;
    <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span>;
  }
  <span class="nf">onMessage</span>(<span class="nv">message</span>) {
    <span class="kd">const</span> <span class="no">name</span> <span class="o">=</span> <span class="nx">message</span>.<span class="na">addShelf</span>;
    <span class="k">if</span> (<span class="nx">name</span> <span class="o">!==</span> <span class="kc">undefined</span>) {
      <span class="k">this</span>.<span class="na">args</span>.<span class="na">shelf</span>.<span class="na">push</span>(<span class="nx">name</span>);
      <span class="nx">Book</span>.<span class="na">where</span>({<span class="na">shelf</span>: <span class="nx">name</span>}).<span class="na">forEach</span>((<span class="nv">doc</span>) <span class="o">=&gt;</span> {
        <span class="k">this</span>.<span class="na">conn</span>.<span class="na">sendBinary</span>(<span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="nx">doc</span>.<span class="na">_id</span>, <span class="nx">doc</span>.<span class="na">attributes</span>]);
      });
      <span class="k">return</span> <span class="s">'done :)'</span>;
    }
  }
}
<span class="nx">Library</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;
<span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="s">'Library'</span>, {<span class="na">shelf</span>: [<span class="s">'mathematics'</span>]});

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'Q'</span>, [<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="m">200</span>, <span class="nx">m</span>.<span class="na">number</span>]);
<span class="nx">conn</span>.<span class="na">sendBinary</span>.<span class="na">reset</span>();
<span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">2</span>, <span class="kc">null</span>, {<span class="na">addShelf</span>: <span class="s">'fiction'</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>.<span class="na">firstCall</span>.<span class="na">args</span>, [
  <span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="s">'book2'</span>, {<span class="na">name</span>: <span class="s">'The Bone People'</span>, <span class="na">shelf</span>: <span class="s">'fiction'</span>}]]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>.<span class="na">lastCall</span>.<span class="na">args</span>, [
  <span class="s">'Q'</span>, [<span class="s">'sub1'</span>, <span class="m">2</span>, <span class="m">0</span>, <span class="s">'done :)'</span>]]);</div></div></pre></div></section><section id="koru/pubsub/publication#postMessage" tabindex="-1" name="#postMessage" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Publication#<span class="highlight"><span class="nf">postMessage</span>(<span class="nv">message</span>)</span></h1><abstract><div><p>Post <code>message</code> directly to the subscriber client. See <a class="jsdoc-link" href="#koru/pubsub/subscription#onMessage">Subscription#onMessage</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>message</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Publication</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/publication"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">sub</span>;
<span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Publication</span> {
  <span class="nf">init</span>() {<span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span>}
}
<span class="nx">Library</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;
<span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="s">'Library'</span>, {<span class="na">shelf</span>: [<span class="s">'mathematics'</span>]});

<span class="nx">sub</span>.<span class="na">postMessage</span>({<span class="na">my</span>: <span class="s">'message'</span>});</div></div></pre></div></section><section id="koru/pubsub/publication#stop" tabindex="-1" name="#stop" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Publication#<span class="highlight"><span class="nf">stop</span>()</span></h1><abstract><div><p>Stop a subscription. This method can be called directly on the server to stop a
subscription. It will also be called indirectly by a stop request from the client.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Publication</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/publication"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// server stops the subscription</span>
<span class="nx">sub</span>.<span class="na">stop</span>();
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">sub</span>.<span class="na">isStopped</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'Q'</span>, [<span class="nx">sub</span>.<span class="na">id</span>]); <span class="cs">// tell client we're stopped</span></div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// client stops the subscription</span>
<span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">sub</span>.<span class="na">isStopped</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>); <span class="cs">// no need to send to client</span></div></div></pre></div></section><section id="koru/pubsub/publication#userIdChanged" tabindex="-1" name="#userIdChanged" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Publication#<span class="highlight"><span class="nf">userIdChanged</span>(<span class="nv">newUID</span>, <span class="nv">oldUID</span>)</span></h1><abstract><div><p>The default behavior is to do nothing. Override this if an userId change needs to be handled.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>newUID</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>oldUID</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Publication</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/publication"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Publication</span> {
  <span class="k">async</span> <span class="nf">userIdChanged</span>(<span class="nv">newUID</span>, <span class="nv">oldUID</span>) {
    <span class="k">if</span> (<span class="nx">newUID</span> <span class="o">===</span> <span class="kc">undefined</span>) <span class="k">this</span>.<span class="na">stop</span>();
  }
}
<span class="nx">Library</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="s">'Library'</span>);
<span class="nx">spy</span>(<span class="nx">sub</span>, <span class="s">'stop'</span>);
<span class="k">await</span> <span class="nx">sub</span>.<span class="na">conn</span>.<span class="na">setUserId</span>(<span class="s">'uid123'</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">sub</span>.<span class="na">stop</span>);
<span class="k">await</span> <span class="nx">sub</span>.<span class="na">conn</span>.<span class="na">setUserId</span>(<span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">sub</span>.<span class="na">stop</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/pubsub/subscription" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pubsub/subscription">koru/pubsub/subscription</a><h1 class="jsdoc-module-title searchable">Subscription</h1><abstract><div><p>A Subscription is a abstract interface for subscribing to publications.</p>
<p>See also <a class="jsdoc-link" href="#koru/pubsub/publication">Publication</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">lastSubscribedMaximumAge</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="client"><div><p>Any subscription with a lastSubscribed older than this sends 0 (no last subscribed) to the
server. Specified in milliseconds. Defaults to -1 (always send 0).</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pubsub/subscription.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">args</span>, <span class="nv">session</span><span class="o">=</span><span class="nx">Session</span>)</span></h1><abstract><div><p>Create a subscription</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[args]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">...any-type</a></td><td class="jsdoc-info"><div><p>the arguments to send to the publication.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[session]</td><td></td><td class="jsdoc-info"><div><p>The session to subscribe to (defaults to <a class="jsdoc-link" href="#koru/session/main">Session</a>).</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
}
<span class="nx">Library</span>.<span class="na">module</span> <span class="o">=</span> <span class="nx">module</span>;
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Library</span>.<span class="na">pubName</span>, <span class="s">'Library'</span>);

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>({<span class="na">shelf</span>: <span class="s">'mathematics'</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">_id</span>, <span class="s">'1'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">sub</span>.<span class="na">args</span>, {<span class="na">shelf</span>: <span class="s">'mathematics'</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">subSession</span>, <span class="nx">SubscriptionSession</span>.<span class="na">get</span>(<span class="nx">Session</span>));

<span class="kd">const</span> <span class="no">sub2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>(<span class="nx">Session</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">subSession</span>, <span class="nx">sub2</span>.<span class="na">subSession</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub2</span>.<span class="na">_id</span>, <span class="s">'2'</span>);</div></div></pre></div></section><section id="koru/pubsub/subscription.markForRemove" tabindex="-1" name="markForRemove" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription.<span class="highlight"><span class="nf">markForRemove</span>(<span class="nv">doc</span>)</span></h1><abstract><div><p>Mark the given document as a simulated add which will be removed if not updated by the
server. This method can be called without a <code>this</code> value</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> {<span class="no">markForRemove</span>} <span class="o">=</span> <span class="nx">Subscription</span>;

<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="nx">markForRemove</span>(<span class="nx">book1</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Query</span>.<span class="na">simDocsFor</span>(<span class="nx">Book</span>)[<span class="nx">book1</span>.<span class="na">_id</span>], [<span class="s">'del'</span>, <span class="o">void</span> <span class="m">0</span>]);</div></div></pre></div></section><section id="koru/pubsub/subscription.subscribe" tabindex="-1" name="subscribe" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription.<span class="highlight"><span class="nf">subscribe</span>(<span class="nv">args</span>, <span class="nv">callback</span>)</span></h1><abstract><div><p>A convience method to create a subscription that connects to the publication and calls
callback on connect.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the arguments to send to the server</p>
</div></td></tr><tr class="jsdoc-arg"><td>[callback]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called when connection complete</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/pubsub/subscription">Subscription</a></td><td class="jsdoc-info"><div><p>instance of subscription</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
}
<span class="kd">let</span> <span class="nv">response</span>;
<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">Library</span>.<span class="na">subscribe</span>({<span class="na">shelf</span>: <span class="s">'mathematics'</span>}, (<span class="nv">error</span>) <span class="o">=&gt;</span> {
  <span class="nx">response</span> <span class="o">=</span> {<span class="na">error</span>, <span class="na">state</span>: <span class="nx">sub</span>.<span class="na">state</span>};
});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">state</span>, <span class="s">'connect'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">response</span>, <span class="o">void</span> <span class="m">0</span>);

<span class="nx">responseFromServer</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">response</span>, {<span class="na">error</span>: <span class="kc">null</span>, <span class="na">state</span>: <span class="s">'active'</span>});</div></div></pre></div></section><section id="koru/pubsub/subscription#connect" tabindex="-1" name="#connect" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">connect</span>()</span></h1><abstract><div><p>Connect to the <a class="jsdoc-link" href="#koru/pubsub/publication">Publication</a> when session is ready.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
}
<span class="nx">Library</span>.<span class="na">module</span> <span class="o">=</span> <span class="nx">module</span>;

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>({<span class="na">shelf</span>: <span class="s">'mathematics'</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">state</span>, <span class="s">'new'</span>);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">sub</span>.<span class="na">isClosed</span>);

<span class="nx">sub</span>.<span class="na">connect</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">state</span>, <span class="s">'connect'</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">sub</span>.<span class="na">isClosed</span>);
<span class="nx">waitForServer</span>();

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">state</span>, <span class="s">'active'</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">sub</span>.<span class="na">isClosed</span>);</div></div></pre></div></section><section id="koru/pubsub/subscription#filterDoc" tabindex="-1" name="#filterDoc" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">filterDoc</span>(<span class="nv">doc</span>)</span></h1><abstract><div><p>Remove a model document if it does not match this subscription</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the document to test if matches a matcher</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>();

<span class="nx">sub</span>.<span class="na">filterDoc</span>(<span class="nx">book1</span>);</div></div></pre></div></section><section id="koru/pubsub/subscription#filterModels" tabindex="-1" name="#filterModels" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">filterModels</span>(...<span class="nv">modelNames</span>)</span></h1><abstract><div><p>Remove model documents that do not match this subscription</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelNames</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>();

<span class="nx">sub</span>.<span class="na">filterModels</span>(<span class="s">'Book'</span>, <span class="s">'Catalog'</span>);</div></div></pre></div></section><section id="koru/pubsub/subscription#match" tabindex="-1" name="#match" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">match</span>(<span class="nv">modelName</span>, <span class="nv">test</span>)</span></h1><abstract><div><p>Register a match function used to check if a document should
be in the database.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="#koru/model/base-model">BaseModel</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the model or the model itself</p>
</div></td></tr><tr class="jsdoc-arg"><td>test</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
  <span class="k">constructor</span>(<span class="nv">args</span>) {
    <span class="k">super</span>(<span class="nx">args</span>);
    <span class="k">this</span>.<span class="na">match</span>(<span class="nx">Book</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> <span class="sr">/lord/i</span>.<span class="na">test</span>(<span class="nx">doc</span>.<span class="na">name</span>));
  }
}</div></div></pre></div></section><section id="koru/pubsub/subscription#onConnect" tabindex="-1" name="#onConnect" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">onConnect</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Observe connection completions. The <code>callback</code> is called on success with a null argument,
on error with an <code>error</code> argument, and if stopped before connected with
<code>koru.Error(409, 'stopped')</code>.
Callbacks will only be called once. To be called again after a re-connect they will need to
be set up again inside the callback.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called with an <code>error</code> argument.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>handler with a <code>stop</code> method to cancel the onConnect.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
}
<span class="nx">Library</span>.<span class="na">module</span> <span class="o">=</span> <span class="nx">module</span>;

{ <span class="cm">/** success */</span>
  <span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>({<span class="na">shelf</span>: <span class="s">'mathematics'</span>});
  <span class="kd">let</span> <span class="nv">resonse</span>;
  <span class="nx">sub1</span>.<span class="na">onConnect</span>((<span class="nv">error</span>) <span class="o">=&gt;</span> {
    <span class="nx">resonse</span> <span class="o">=</span> {<span class="na">error</span>, <span class="na">state</span>: <span class="nx">sub1</span>.<span class="na">state</span>};
  });

  <span class="nx">sub1</span>.<span class="na">connect</span>();

  <span class="kd">const</span> <span class="no">lastSubscribed</span> <span class="o">=</span> <span class="nx">Date</span>.<span class="na">now</span>();
  <span class="nx">waitForServerResponse</span>(<span class="nx">sub1</span>, {<span class="na">error</span>: <span class="kc">null</span>, <span class="na">lastSubscribed</span>});

  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">resonse</span>, {<span class="na">error</span>: <span class="kc">null</span>, <span class="na">state</span>: <span class="s">'active'</span>});
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub1</span>.<span class="na">lastSubscribed</span>, <span class="nx">lastSubscribed</span>);

        
}

{ <span class="cm">/** error **/</span>
  <span class="kd">const</span> <span class="no">sub2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>();

  <span class="kd">let</span> <span class="nv">resonse</span>;
  <span class="nx">sub2</span>.<span class="na">onConnect</span>((<span class="nv">error</span>) <span class="o">=&gt;</span> {
    <span class="nx">resonse</span> <span class="o">=</span> {<span class="na">error</span>, <span class="na">state</span>: <span class="nx">sub2</span>.<span class="na">state</span>};
  });

  <span class="nx">sub2</span>.<span class="na">connect</span>({<span class="na">shelf</span>: <span class="m">123</span>});

  <span class="nx">waitForServerResponse</span>(<span class="nx">sub2</span>, {<span class="na">error</span>: {<span class="na">code</span>: <span class="m">400</span>, <span class="na">reason</span>: {<span class="na">self</span>: [[<span class="s">'is_invalid'</span>]]}}});

  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">resonse</span>, {
    <span class="na">error</span>: <span class="nx">m</span>((<span class="nv">err</span>) <span class="o">=&gt;</span> (<span class="nx">err</span> <span class="o">instanceof</span> <span class="nx">koru</span>.<span class="na">Error</span>) <span class="o">&amp;&amp;</span>
             <span class="nx">err</span>.<span class="na">error</span> <span class="o">===</span> <span class="m">400</span> <span class="o">&amp;&amp;</span>
             <span class="nx">util</span>.<span class="na">deepEqual</span>(<span class="nx">err</span>.<span class="na">reason</span>, {<span class="na">self</span>: [[<span class="s">'is_invalid'</span>]]})),
    <span class="na">state</span>: <span class="s">'stopped'</span>});
}

{ <span class="cm">/** stopped early **/</span>
  <span class="kd">const</span> <span class="no">sub3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>();

  <span class="kd">let</span> <span class="nv">resonse</span>;
  <span class="nx">sub3</span>.<span class="na">onConnect</span>((<span class="nv">error</span>) <span class="o">=&gt;</span> {
    <span class="nx">resonse</span> <span class="o">=</span> {<span class="na">error</span>, <span class="na">state</span>: <span class="nx">sub3</span>.<span class="na">state</span>};
  });

  <span class="nx">sub3</span>.<span class="na">connect</span>({<span class="na">shelf</span>: <span class="s">'history'</span>});

  <span class="nx">sub3</span>.<span class="na">stop</span>();

  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">resonse</span>, {
    <span class="na">error</span>: <span class="nx">m</span>((<span class="nv">e</span>) <span class="o">=&gt;</span> <span class="nx">e</span>.<span class="na">error</span> <span class="o">==</span> <span class="m">409</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span>.<span class="na">reason</span> <span class="o">==</span> <span class="s">'stopped'</span>), <span class="na">state</span>: <span class="s">'stopped'</span>});

  <span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">sub3</span>.<span class="na">isClosed</span>);
}</div></div></pre></div></section><section id="koru/pubsub/subscription#onMessage" tabindex="-1" name="#onMessage" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">onMessage</span>(<span class="nv">message</span>)</span></h1><abstract><div><p>Override this method to receive an unsolicited <code>message</code> from the publication server.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>message</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
  <span class="nf">onMessage</span>(<span class="nv">message</span>) {
    <span class="k">this</span>.<span class="na">answer</span> <span class="o">=</span> <span class="nx">message</span>;
  }
}

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">Library</span>.<span class="na">subscribe</span>([<span class="m">123</span>]);

<span class="nx">server</span>.<span class="na">postMessage</span>({<span class="na">hello</span>: <span class="s">'subscriber'</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">sub</span>.<span class="na">answer</span>, {<span class="na">hello</span>: <span class="s">'subscriber'</span>});</div></div></pre></div></section><section id="koru/pubsub/subscription#postMessage" tabindex="-1" name="#postMessage" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">postMessage</span>(<span class="nv">message</span>, <span class="nv">callback</span>)</span></h1><abstract><div><p>Send a message to publication. Messages can be used to alter the state of the publication.</p>
<p>Messages are NOT re-transmitted if the connection is lost; Intead the subscription <code>args</code>
should be modified to reflect the change in state. In such cases the callback will be
added to the <a class="jsdoc-link" href="#koru/pubsub/subscription#onConnect">onConnect</a> queue.</p>
<p>See <a class="jsdoc-link" href="#koru/pubsub/publication#onMessage">Publication#onMessage</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>message</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the message to send</p>
</div></td></tr><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a function with the arguments <code>error</code>, <code>result</code>. This function will be
called when the message has finished or; if connection lost of not yet started, will be
called when the subscription is active with no <code>result</code> (via the <a class="jsdoc-link" href="#koru/pubsub/subscription#onConnect">onConnect</a> queue).</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
}

<span class="kd">const</span> <span class="no">onConnect</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="nx">Library</span>.<span class="na">subscribe</span>([<span class="m">123</span>, <span class="m">456</span>], <span class="nx">onConnect</span>);

<span class="nx">sub</span>.<span class="na">args</span>.<span class="na">push</span>(<span class="m">789</span>);
<span class="kd">let</span> <span class="nv">done</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="nx">sub</span>.<span class="na">postMessage</span>({<span class="na">addArg</span>: <span class="m">789</span>}, (<span class="nv">err</span>, <span class="nv">result</span>) <span class="o">=&gt;</span> {
  <span class="k">if</span> (<span class="nx">err</span>) <span class="nx">sub</span>.<span class="na">stop</span>();
  <span class="nx">done</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">===</span> <span class="s">'added'</span>;
});
<span class="nx">receivePost</span>(<span class="nx">sub</span>);
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">done</span>);</div></div></pre></div></section><section id="koru/pubsub/subscription#reconnecting" tabindex="-1" name="#reconnecting" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">reconnecting</span>()</span></h1><abstract><div><p>Override this method to be called when a subscription reconnect is attempted. Calling
<a class="jsdoc-link" href="#koru/pubsub/subscription#stop">stop</a> within this method will stop the reconnect.</p>
<p>When there is no <code>lastSubscribed</code> time, or lastSubscribed is older than
<code>lastSubscribedMaximumAge</code>, <a class="jsdoc-link" href="#koru/pubsub/subscription.markForRemove">markForRemove</a> should be called on documents matching this
subscription.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
  <span class="cm">/** ⏿ ⮧ here we override reconnecting **/</span>
  <span class="nf">reconnecting</span>() {
    <span class="nx">Book</span>.<span class="na">query</span>.<span class="na">forEach</span>(<span class="nx">Subscription</span>.<span class="na">markForRemove</span>);
  }
}
<span class="kd">const</span> <span class="no">reconnecting</span> <span class="o">=</span> <span class="nx">spy</span>(<span class="nx">Library</span>.<span class="na">prototype</span>, <span class="s">'reconnecting'</span>);

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>();
<span class="nx">sub</span>.<span class="na">connect</span>();
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">reconnecting</span>);

<span class="nx">Session</span>.<span class="na">reconnected</span>(); <span class="cs">// simulate a session reconnect</span>

<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">reconnecting</span>);</div></div></pre></div></section><section id="koru/pubsub/subscription#stop" tabindex="-1" name="#stop" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">stop</span>(<span class="nv">error</span>)</span></h1><abstract><div><p>Stops a subscription. Releases any matchers that were set up and calls <a class="jsdoc-link" href="#koru/pubsub/subscription#stopped">stopped</a>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[error]</td><td></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc1</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'doc1'</span>});
<span class="kd">const</span> <span class="no">doc2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'doc2'</span>});
<span class="kd">const</span> <span class="no">doc3</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'doc3'</span>});

<span class="kd">const</span> <span class="no">mr</span> <span class="o">=</span> <span class="nx">SubscriptionSession</span>.<span class="na">get</span>(<span class="nx">Session</span>).<span class="na">match</span>.<span class="na">register</span>(<span class="s">'Book'</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> {
  <span class="k">return</span> <span class="nx">doc</span> <span class="o">===</span> <span class="nx">doc2</span>;
});
      
<span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
  <span class="nf">stopped</span>(<span class="nv">unmatch</span>) {
    <span class="nx">unmatch</span>(<span class="nx">doc1</span>);
    <span class="nx">unmatch</span>(<span class="nx">doc2</span>);
  }
}
<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>();
<span class="nx">sub</span>.<span class="na">match</span>(<span class="s">'Book'</span>, () <span class="o">=&gt;</span> <span class="kc">true</span>);
<span class="nx">sub</span>.<span class="na">connect</span>();
<span class="nx">assert</span>(<span class="nx">Book</span>.<span class="na">findById</span>(<span class="s">'doc1'</span>));
<span class="nx">assert</span>(<span class="nx">sub</span>.<span class="na">subSession</span>.<span class="na">match</span>.<span class="na">has</span>(<span class="nx">doc1</span>, <span class="s">'stopped'</span>));
<span class="nx">sub</span>.<span class="na">stop</span>();

<span class="nx">refute</span>(<span class="nx">Book</span>.<span class="na">findById</span>(<span class="s">'doc1'</span>));
<span class="nx">assert</span>(<span class="nx">Book</span>.<span class="na">findById</span>(<span class="s">'doc2'</span>));
<span class="nx">assert</span>(<span class="nx">Book</span>.<span class="na">findById</span>(<span class="s">'doc3'</span>));

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">sub</span>.<span class="na">isClosed</span>);</div></div></pre></div></section><section id="koru/pubsub/subscription#stopped" tabindex="-1" name="#stopped" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">stopped</span>(<span class="nv">unmatch</span>)</span></h1><abstract><div><p>Override this method to be called with an <code>unmatch</code> function when the subscription is
stopped.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>unmatch</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>can be called on all documents that no longer match this subscription.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc1</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'doc1'</span>});
<span class="kd">const</span> <span class="no">doc2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'doc2'</span>});
<span class="kd">const</span> <span class="no">doc3</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">_id</span>: <span class="s">'doc3'</span>});

<span class="kd">const</span> <span class="no">mr</span> <span class="o">=</span> <span class="nx">SubscriptionSession</span>.<span class="na">get</span>(<span class="nx">Session</span>).<span class="na">match</span>.<span class="na">register</span>(<span class="s">'Book'</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> {
  <span class="k">return</span> <span class="nx">doc</span> <span class="o">===</span> <span class="nx">doc2</span>;
});
      
<span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
  <span class="nf">stopped</span>(<span class="nv">unmatch</span>) {
    <span class="nx">unmatch</span>(<span class="nx">doc1</span>);
    <span class="nx">unmatch</span>(<span class="nx">doc2</span>);
  }
}
<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Library</span>();
<span class="nx">sub</span>.<span class="na">match</span>(<span class="s">'Book'</span>, () <span class="o">=&gt;</span> <span class="kc">true</span>);
<span class="nx">sub</span>.<span class="na">connect</span>();
<span class="nx">assert</span>(<span class="nx">Book</span>.<span class="na">findById</span>(<span class="s">'doc1'</span>));
<span class="nx">assert</span>(<span class="nx">sub</span>.<span class="na">subSession</span>.<span class="na">match</span>.<span class="na">has</span>(<span class="nx">doc1</span>, <span class="s">'stopped'</span>));
<span class="nx">sub</span>.<span class="na">stop</span>();

<span class="nx">refute</span>(<span class="nx">Book</span>.<span class="na">findById</span>(<span class="s">'doc1'</span>));
<span class="nx">assert</span>(<span class="nx">Book</span>.<span class="na">findById</span>(<span class="s">'doc2'</span>));
<span class="nx">assert</span>(<span class="nx">Book</span>.<span class="na">findById</span>(<span class="s">'doc3'</span>));

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">sub</span>.<span class="na">isClosed</span>);</div></div></pre></div></section><section id="koru/pubsub/subscription#unmatch" tabindex="-1" name="#unmatch" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">unmatch</span>(<span class="nv">modelName</span>)</span></h1><abstract><div><p>Deregister a <a class="jsdoc-link" href="#koru/pubsub/subscription#match">match</a> function.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>modelName</td><td><a href="#koru/model/base-model">BaseModel</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the model or the model itself</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Subscription</span> {
  <span class="k">constructor</span>(<span class="nv">args</span>) {
    <span class="k">super</span>(<span class="nx">args</span>);
    <span class="k">this</span>.<span class="na">match</span>(<span class="nx">Book</span>, (<span class="nv">doc</span>) <span class="o">=&gt;</span> <span class="sr">/lord/i</span>.<span class="na">test</span>(<span class="nx">doc</span>.<span class="na">name</span>));
  }

  <span class="nf">noBooks</span>() {
    <span class="k">this</span>.<span class="na">unmatch</span>(<span class="nx">Book</span>);
  }
}</div></div></pre></div></section><section id="koru/pubsub/subscription#userIdChanged" tabindex="-1" name="#userIdChanged" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Subscription#<span class="highlight"><span class="nf">userIdChanged</span>(<span class="nv">newUID</span>, <span class="nv">oldUID</span>)</span></h1><abstract><div><p>Override this method to change the default behavior of doing nothing when the user id
changes.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>newUID</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>oldUID</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Subscription</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/subscription"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">subscription</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subscription</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">subscription</span>.<span class="na">userIdChanged</span>(<span class="s">"uid123"</span>, <span class="ge nx">undefined</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">subscription</span>.<span class="na">userIdChanged</span>(<span class="s">"uid456"</span>, <span class="s">"uid123"</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">subscription</span>.<span class="na">userIdChanged</span>(<span class="ge nx">undefined</span>, <span class="s">"uid456"</span>);</div><div></div></div></pre></div></section></div></div></div></section><section id="koru/pubsub/union" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/pubsub/union">koru/pubsub/union</a><h1 class="jsdoc-module-title searchable">Union</h1><abstract><div><p>Union is an interface used to combine server subscriptions to minimise work on the server.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#handles</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info" data-env="server"><div><p>An array to store any handles that should be stopped when the union is empty. A handle
is anything that has a <code>stop</code> method.</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/pubsub/union.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>()</span></h1><abstract><div><p>Create a Union instance</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">myHandle</span> <span class="o">=</span> {<span class="na">stop</span>: <span class="nx">stub</span>()};
<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="k">constructor</span>() {
    <span class="k">super</span>();
    <span class="k">this</span>.<span class="na">handles</span>.<span class="na">push</span>(<span class="nx">myHandle</span>);
  }
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">union</span>.<span class="na">handles</span>, [<span class="nx">myHandle</span>]);</div></div></pre></div></section><section id="koru/pubsub/union#addSub" tabindex="-1" name="#addSub" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#async addSub(sub, lastSubscribed=sub.lastSubscribed)</h1><abstract><div><p>Add a subscriber to a union. This will cause <a class="jsdoc-link" href="#koru/pubsub/union#loadInitial">loadInitial</a> to be run for the subscriber.</p>
<p>For performance, if other subscribers are added to the union then they will be added to the
same loadQueue (if still running) as a previous subscriber if and only if their
<a class="jsdoc-link" href="#koru/pubsub/publication.discreteLastSubscribed">Publication.discreteLastSubscribed</a> is the same as a previous subscriber and their
<a class="jsdoc-link" href="#koru/pubsub/publication">Publication#lastSubscribed</a> is greater than the <code>minLastSubscribed</code> passed to
<code>loadInitial</code>; otherwise a new loadInitial will be run.</p>
<p>It is important to note that addSub blocks the thread and queues batchUpdate until
loadInitial has finished. This ensures that the initial load will be sent before any
changes during the load.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>sub</td><td><a href="#koru/pubsub/publication">Publication</a></td><td class="jsdoc-info"><div><p>the subscriber to add</p>
</div></td></tr><tr class="jsdoc-arg"><td>[lastSubscribed]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>when sub last subscribed (in ms). Defaults to
<a class="jsdoc-link" href="#koru/pubsub/publication">Publication#lastSubscribed</a></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="k">constructor</span>(<span class="nv">author_id</span>) {
    <span class="k">super</span>();
    <span class="k">this</span>.<span class="na">author_id</span> <span class="o">=</span> <span class="nx">author_id</span>;
  }
  <span class="k">async</span> <span class="nf">loadInitial</span>(<span class="nv">encoder</span>) {
    <span class="k">await</span> <span class="nx">Book</span>.<span class="na">where</span>(<span class="s">'author_id'</span>, <span class="k">this</span>.<span class="na">author_id</span>).<span class="na">forEach</span>((<span class="nv">doc</span>) <span class="o">=&gt;</span> {<span class="nx">encoder</span>.<span class="na">addDoc</span>(<span class="nx">doc</span>)});
  }
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>(<span class="s">'a123'</span>);

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub1'</span>, <span class="na">conn</span>, <span class="na">lastSubscribed</span>: <span class="o">void</span> <span class="m">0</span>});
<span class="cm">/** ⏿ ⮧ here we add the sub **/</span>
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub</span>);

<span class="kd">const</span> <span class="no">msgs</span> <span class="o">=</span> <span class="nx">mc</span>.<span class="na">decodeLastSend</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">msgs</span>, [
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">name</span>: <span class="s">'Book 1'</span>}]],
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book2'</span>, <span class="na">name</span>: <span class="s">'Book 2'</span>}]],
]);</div></div></pre></div></section><section id="koru/pubsub/union#addSubByToken" tabindex="-1" name="#addSubByToken" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#async addSubByToken(sub, token)</h1><abstract><div><p>Like <a class="jsdoc-link" href="#koru/pubsub/union#addSub">addSub</a> but instead of using lastSubscribed to group for <a class="jsdoc-link" href="#koru/pubsub/union#loadInitial">loadInitial</a> the token
is used to group for <a class="jsdoc-link" href="#koru/pubsub/union#loadByToken">loadByToken</a>. The token can be anything is compared sameness.</p>
<p>This is useful when critera changes such as permisssions which causes a <code>sub</code> to change
unions which requires some records to be removed from the client and some new records to be
added. Usually the client will automatically handle the removes but the adds will need to
be calculated based on the new and old unions. The token should contain the information
needed to calculate the subset.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>sub</td><td><a href="#koru/pubsub/publication">Publication</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>token</td><td><a href="#koru/pubsub/union">Union</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">genre_ids</span>: [<span class="s">'drama'</span>, <span class="s">'comedy'</span>]});
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">genre_ids</span>: [<span class="s">'drama'</span>]});

<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="k">constructor</span>(<span class="nv">genre_id</span>) {
    <span class="k">super</span>();
    <span class="k">this</span>.<span class="na">genre_id</span> <span class="o">=</span> <span class="nx">genre_id</span>;
  }
  <span class="k">async</span> <span class="nf">loadByToken</span>(<span class="nv">encoder</span>, <span class="nv">oldUnion</span>) {
    <span class="k">await</span> <span class="nx">Book</span>
      .<span class="na">where</span>(<span class="s">'genre_ids'</span>, <span class="k">this</span>.<span class="na">genre_id</span>)
      .<span class="na">whereNot</span>(<span class="s">'genre_ids'</span>, <span class="nx">oldUnion</span>.<span class="na">genre_id</span>)
      .<span class="na">forEach</span>((<span class="nv">doc</span>) <span class="o">=&gt;</span> {<span class="nx">encoder</span>.<span class="na">addDoc</span>(<span class="nx">doc</span>)});
  }
}
<span class="kd">const</span> <span class="no">oldUnion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>(<span class="s">'comedy'</span>);
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>(<span class="s">'drama'</span>);

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub1'</span>, <span class="na">conn</span>, <span class="na">lastSubscribed</span>: <span class="o">void</span> <span class="m">0</span>});
<span class="cm">/** ⏿ ⮧ here we add the sub **/</span>
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSubByToken</span>(<span class="nx">sub</span>, <span class="nx">oldUnion</span>);

<span class="kd">const</span> <span class="no">msgs</span> <span class="o">=</span> <span class="nx">mc</span>.<span class="na">decodeLastSend</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">msgs</span>, [
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="nx">book2</span>.<span class="na">attributes</span>]],
]);</div></div></pre></div></section><section id="koru/pubsub/union#batchUpdate" tabindex="-1" name="#batchUpdate" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">batchUpdate</span>()</span></h1><abstract><div><p>The batchUpdate function is built by the <a class="jsdoc-link" href="#koru/pubsub/union#buildBatchUpdate">buildBatchUpdate</a> method on Union
construction. It is used to broadcast document updates to multiple client subscriptions. It
does not need a <code>this</code> argument.</p>
<p>Updates are batched until the successful end of the current transaction and the resulting
message is sent to all subs in the union. If the transaction is aborted no messages are
sent.</p>
<p>See also <a class="jsdoc-link" href="#koru/pubsub/union#initObservers">initObservers</a></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>([<span class="s">'Book'</span>]);
<span class="kd">const</span> <span class="no">mc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockConn</span>(<span class="nx">conn</span>);

<span class="kd">const</span> {<span class="no">Book</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="nf">initObservers</span>() {
    <span class="cm">/**       ⏿ here we pass the batchUpdate ⮧ **/</span>
    <span class="k">this</span>.<span class="na">handles</span>.<span class="na">push</span>(<span class="nx">Book</span>.<span class="na">onChange</span>(<span class="k">this</span>.<span class="na">batchUpdate</span>));
  }
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'s123'</span>, <span class="na">conn</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub</span>);

<span class="k">await</span> <span class="nx">TransQueue</span>.<span class="na">transaction</span>(<span class="k">async</span> () <span class="o">=&gt;</span> {
  <span class="k">await</span> <span class="nx">db</span>.<span class="na">change</span>(<span class="nx">book1</span>);
  <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
  <span class="k">await</span> <span class="nx">db</span>.<span class="na">remove</span>(<span class="nx">book2</span>);
});

<span class="kd">const</span> <span class="no">msgs</span> <span class="o">=</span> <span class="nx">mc</span>.<span class="na">decodeLastSend</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">msgs</span>, [
  [<span class="s">'C'</span>, [<span class="s">'Book'</span>, <span class="s">'book1'</span>, {<span class="na">name</span>: <span class="s">'name change'</span>}]],
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book3'</span>, <span class="na">name</span>: <span class="s">'Book 3'</span>}]],
  [<span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="s">'book2'</span>, <span class="o">void</span> <span class="m">0</span>]],
]);</div></div></pre></div></section><section id="koru/pubsub/union#buildBatchUpdate" tabindex="-1" name="#buildBatchUpdate" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">buildBatchUpdate</span>()</span></h1><abstract><div><p>buildBatchUpdate builds the <a class="jsdoc-link" href="#koru/pubsub/union#batchUpdate">batchUpdate</a> function that can be used to broadcast document
updates to multiple client subscriptions. It is called during Union construction.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();
<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">union</span>.<span class="na">batchUpdate</span>);</div></div></pre></div></section><section id="koru/pubsub/union#buildUpdate" tabindex="-1" name="#buildUpdate" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">buildUpdate</span>(<span class="nv">dc</span>)</span></h1><abstract><div><p>Override this to manipulate the document sent to clients. By default calls
<a class="jsdoc-link" href="#koru/session/server-connection.buildUpdate">ServerConnection.buildUpdate</a>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dc</td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="nf">buildUpdate</span>(<span class="nv">dc</span>) {
    <span class="kd">const</span> <span class="no">upd</span> <span class="o">=</span> <span class="k">super</span>.<span class="na">buildUpdate</span>(<span class="nx">dc</span>);
    <span class="k">if</span> (<span class="nx">upd</span>[<span class="m">0</span>] <span class="o">===</span> <span class="s">'C'</span>) {
      <span class="nx">upd</span>[<span class="m">1</span>][<span class="m">2</span>].<span class="na">name</span> <span class="o">=</span> <span class="s">'filtered'</span>;
    }
    <span class="k">return</span> <span class="nx">upd</span>;
  }
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(
  <span class="nx">union</span>.<span class="na">buildUpdate</span>(<span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">book1</span>, {<span class="na">name</span>: <span class="s">'old name'</span>})),
  [<span class="s">'C'</span>, [<span class="s">'Book'</span>, <span class="s">'book1'</span>, {<span class="na">name</span>: <span class="s">'filtered'</span>}]],
);</div></div></pre></div></section><section id="koru/pubsub/union#encodeUpdate" tabindex="-1" name="#encodeUpdate" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">encodeUpdate</span>(<span class="nv">dc</span>)</span></h1><abstract><div><p>encode a <a class="jsdoc-link" href="#koru/model/doc-change">DocChange</a> ready for sending via <a class="jsdoc-link" href="#koru/pubsub/union#sendEncoded">sendEncoded</a> or
<a class="jsdoc-link" href="#koru/pubsub/union#sendEncodedWhenIdle">sendEncodedWhenIdle</a>.</p>
<p>See <a class="jsdoc-link" href="#koru/session/server-connection#buildUpdate">ServerConnection#buildUpdate</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dc</td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div><p>for the document that has been updated</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array" target="_blank">Uint8Array</a></td><td class="jsdoc-info"><div><p>an encoded (binary) update command</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub123'</span>, <span class="na">conn</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub1</span>);
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();

<span class="kd">const</span> <span class="no">msg</span> <span class="o">=</span> <span class="nx">union</span>.<span class="na">encodeUpdate</span>(<span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">book1</span>, {<span class="na">name</span>: <span class="s">'old name'</span>}));

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">msg</span>[<span class="m">0</span>], <span class="m">67</span>); <span class="cm">/* 'C' */</span> <span class="cs">// is a Change command</span>
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ConnTH</span>.<span class="na">decodeMessage</span>(<span class="nx">msg</span>, <span class="nx">conn</span>), [<span class="s">'Book'</span>, <span class="s">'book1'</span>, {<span class="na">name</span>: <span class="s">'Book 1'</span>}]);</div></div></pre></div></section><section id="koru/pubsub/union#initObservers" tabindex="-1" name="#initObservers" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">initObservers</span>()</span></h1><abstract><div><p>Override this method to start observers when one or more subscribers are added.  the
<a class="jsdoc-link" href="#koru/pubsub/union#onEmpty">onEmpty</a> method should be overriden to stop any handles not stored in the
<code>handles</code> array property.</p>
<p><a class="jsdoc-link" href="#koru/pubsub/union#buildBatchUpdate">buildBatchUpdate</a> can be used to build an updater suitable as an argument for
<a class="jsdoc-link" href="#koru/models/base-model.onChange">base-model.onChange</a></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="nf">onEmpty</span>() {
    <span class="k">super</span>.<span class="na">onEmpty</span>();
    <span class="k">for</span> (<span class="kd">const</span> <span class="no">handle</span> <span class="k">of</span> <span class="k">this</span>.<span class="na">handles</span>)
      <span class="nx">handle</span>.<span class="na">stop</span>();
  }

  <span class="nf">initObservers</span>() {
    <span class="kd">const</span> <span class="no">batchUpdate</span> <span class="o">=</span> <span class="k">this</span>.<span class="na">buildBatchUpdate</span>();

    <span class="k">this</span>.<span class="na">handles</span>.<span class="na">push</span>(<span class="nx">Book</span>.<span class="na">onChange</span>(<span class="nx">batchUpdate</span>));
  }
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();

<span class="kd">const</span> <span class="no">initObservers</span> <span class="o">=</span> <span class="nx">spy</span>(<span class="nx">union</span>, <span class="s">'initObservers'</span>);
<span class="kd">const</span> <span class="no">onEmpty</span> <span class="o">=</span> <span class="nx">spy</span>(<span class="nx">union</span>, <span class="s">'onEmpty'</span>);

<span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub1'</span>, <span class="na">conn</span>: <span class="nx">conn1</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub1</span>);
<span class="kd">const</span> <span class="no">sub2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub2'</span>, <span class="na">conn</span>: <span class="nx">conn2</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub2</span>);

<span class="nx">union</span>.<span class="na">removeSub</span>(<span class="nx">sub1</span>);

<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">initObservers</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">onEmpty</span>);

<span class="nx">union</span>.<span class="na">removeSub</span>(<span class="nx">sub2</span>);
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">onEmpty</span>);</div></div></pre></div></section><section id="koru/pubsub/union#loadByToken" tabindex="-1" name="#loadByToken" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">loadByToken</span>(<span class="nv">encoder</span>, <span class="nv">token</span>)</span></h1><abstract><div><p>Like <a class="jsdoc-link" href="#koru/pubsub/union#loadInitial">loadInitial</a> but instead of using minLastSubscribed passes the token from
<a class="jsdoc-link" href="#koru/pubsub/union#addSubByToken">addSubByToken</a> to calculate which documents to load.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>encoder</td><td></td><td class="jsdoc-info"><div><p>an encoder object; see <a class="jsdoc-link" href="#koru/pubsub/union#loadInitial">loadInitial</a></p>
</div></td></tr><tr class="jsdoc-arg"><td>token</td><td></td><td class="jsdoc-info"><div><p>from <a class="jsdoc-link" href="#koru/pubsub/union#addSubByToken">addSubByToken</a>. Usually an old union the subscriptions belonged to.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// see addSubByToken for better example</span>
<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="cm">/** ⏿ ⮧ here we loadByToken **/</span>
  <span class="k">async</span> <span class="nf">loadByToken</span>(<span class="nv">encoder</span>, <span class="nv">token</span>) {
    <span class="k">if</span> (<span class="nx">token</span> <span class="o">===</span> <span class="s">'myToken'</span>) {
      <span class="nx">encoder</span>.<span class="na">addDoc</span>(<span class="nx">book1</span>);
      <span class="nx">encoder</span>.<span class="na">remDoc</span>(<span class="nx">book2</span>, <span class="s">'stopped'</span>);
    }
  }
}

<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();

<span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub1'</span>, <span class="na">conn</span>});

<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSubByToken</span>(<span class="nx">sub1</span>, <span class="s">'myToken'</span>);

<span class="kd">const</span> <span class="no">msgs</span> <span class="o">=</span> <span class="nx">mc</span>.<span class="na">decodeLastSend</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">msgs</span>, [
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="nx">book1</span>.<span class="na">attributes</span>]],
  [<span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="nx">book2</span>.<span class="na">_id</span>, <span class="s">'stopped'</span>]],
]);</div></div></pre></div></section><section id="koru/pubsub/union#loadInitial" tabindex="-1" name="#loadInitial" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">loadInitial</span>(<span class="nv">encoder</span>, <span class="nv">minLastSubscribed</span>)</span></h1><abstract><div><p>Override this method to select the initial documents to download when a new group of
subscribers is added. Subscribers are partitioned by their
<a class="jsdoc-link" href="#koru/pubsub/publication.discreteLastSubscribed">Publication.discreteLastSubscribed</a> time.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>encoder</td><td></td><td class="jsdoc-info"><div><p>an object that has methods <code>addDoc</code>, <code>remDoc</code> and <code>push</code>:</p>
<ul>
<li><code>addDoc</code> is a function to call with a doc to be added to the subscribers.</li>
<li><code>chgDoc</code> is a function to call with a doc and change object (listing the fields that have
 changed) to be changed to the subscribers.</li>
<li><code>remDoc</code> a function to call with a doc (and optional flag) to be removed from the
subscribers. The flag is sent to the client as a <a class="jsdoc-link" href="#koru/model/doc-change">DocChange#flag</a> which
defaults to "serverUpdate". A Useful value is "stopped" which a client persistence manager
can used to decide to not remove the persitent document.</li>
<li><code>push</code> is for adding any <code>message</code> to the batch. The message format is:
<code>[type, data]</code> (see <a class="jsdoc-link" href="#koru/session/server-connection.buildUpdate">ServerConnection.buildUpdate</a> for examples).</li>
</ul>
</div></td></tr><tr class="jsdoc-arg"><td>minLastSubscribed</td><td></td><td class="jsdoc-info"><div><p>the lastSubscribed time related to the first subscriber for this
load request. Only subscribers with a lastSubscribed &gt;= first subscriber will be added to
the load.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">updatedAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">-</span> <span class="m">80000</span>)});
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">updatedAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">-</span> <span class="m">40000</span>)});
<span class="kd">const</span> <span class="no">book3</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">updatedAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">-</span> <span class="m">50000</span>), <span class="na">state</span>: <span class="s">'D'</span>});
<span class="kd">const</span> <span class="no">book4</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">updatedAt</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">-</span> <span class="m">31000</span>), <span class="na">state</span>: <span class="s">'C'</span>});

<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="k">async</span> <span class="nf">loadInitial</span>(<span class="nv">encoder</span>, <span class="nv">minLastSubscribed</span>) {
    <span class="kd">const</span> <span class="no">addDoc</span> <span class="o">=</span> <span class="nx">encoder</span>.<span class="na">addDoc</span>.<span class="na">bind</span>(<span class="nx">encoder</span>);
    <span class="kd">const</span> <span class="no">chgDoc</span> <span class="o">=</span> <span class="nx">encoder</span>.<span class="na">chgDoc</span>.<span class="na">bind</span>(<span class="nx">encoder</span>);
    <span class="kd">const</span> <span class="no">remDoc</span> <span class="o">=</span> <span class="nx">encoder</span>.<span class="na">remDoc</span>.<span class="na">bind</span>(<span class="nx">encoder</span>);
    <span class="k">if</span> (<span class="nx">minLastSubscribed</span> <span class="o">==</span> <span class="m">0</span>) {
      <span class="k">await</span> <span class="nx">Book</span>.<span class="na">whereNot</span>({<span class="na">state</span>: <span class="s">'D'</span>}).<span class="na">forEach</span>(<span class="nx">addDoc</span>);
    } <span class="k">else</span> {
      <span class="k">await</span> <span class="nx">Book</span>.<span class="na">where</span>({<span class="na">updatedAt</span>: {<span class="na">$gte</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">minLastSubscribed</span>)}}).<span class="na">forEach</span>((<span class="nv">doc</span>) <span class="o">=&gt;</span> {
        <span class="k">switch</span> (<span class="nx">doc</span>.<span class="na">state</span>) {
        <span class="k">case</span> <span class="s">'D'</span>: <span class="nx">remDoc</span>(<span class="nx">doc</span>); <span class="k">break</span>;
        <span class="k">case</span> <span class="s">'C'</span>: <span class="nx">chgDoc</span>(<span class="nx">doc</span>, {<span class="na">state</span>: <span class="nx">doc</span>.<span class="na">state</span>}); <span class="k">break</span>;
        <span class="k">default</span>: <span class="nx">addDoc</span>(<span class="nx">doc</span>);
        }
      });
    }
  }
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();

<span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub1'</span>, <span class="na">conn</span>}); <span class="cs">// no lastSubscribed</span>
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub1</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">mc</span>.<span class="na">decodeLastSend</span>(), [
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="nx">book1</span>.<span class="na">attributes</span>]],
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="nx">book2</span>.<span class="na">attributes</span>]],
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="nx">book4</span>.<span class="na">attributes</span>]],
]);

<span class="kd">const</span> <span class="no">lastSubscribed</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">-</span> <span class="m">600000</span>;

<span class="kd">const</span> <span class="no">sub2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub2'</span>, <span class="na">conn</span>: <span class="nx">conn2</span>, <span class="na">lastSubscribed</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">mc2</span>.<span class="na">decodeLastSend</span>(), [
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="nx">book2</span>.<span class="na">attributes</span>]],
  [<span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="s">'book3'</span>, <span class="o">void</span> <span class="m">0</span>]],
  [<span class="s">'C'</span>, [<span class="s">'Book'</span>, <span class="s">'book4'</span>, {<span class="na">state</span>: <span class="s">'C'</span>}]],
]);</div></div></pre></div></section><section id="koru/pubsub/union#onEmpty" tabindex="-1" name="#onEmpty" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">onEmpty</span>()</span></h1><abstract><div><p>This method is called when all subscribers have been removed from the union. It stops any
handles that have been pushed on to <code>#handles</code> and resets <code>#handles</code> length to 0. If
overriden ensure that <code>super.onEmpty()</code> is run.</p>
<p>See <a class="jsdoc-link" href="#koru/pubsub/union#initObservers">initObservers</a></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Union</span>();
<span class="kd">const</span> <span class="no">onEmpty</span> <span class="o">=</span> <span class="nx">spy</span>(<span class="nx">union</span>, <span class="s">'onEmpty'</span>);
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub</span>);
<span class="nx">union</span>.<span class="na">removeSub</span>(<span class="nx">sub</span>);
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">onEmpty</span>);</div></div></pre></div></section><section id="koru/pubsub/union#removeSub" tabindex="-1" name="#removeSub" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">removeSub</span>(<span class="nv">sub</span>)</span></h1><abstract><div><p>Remove a subscriber from a union. When all subscriber have been removed from the union
<a class="jsdoc-link" href="#koru/pubsub/union#onEmpty">onEmpty</a> will be called</p>
<p>See <a class="jsdoc-link" href="#koru/pubsub/union#addSub">addSub</a>, <a class="jsdoc-link" href="#koru/pubsub/union#initObservers">initObservers</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>sub</td><td><a href="#koru/pubsub/publication">Publication</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockDB</span>([<span class="s">'Book'</span>]);
<span class="kd">const</span> <span class="no">mc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockConn</span>(<span class="nx">conn</span>);

<span class="kd">const</span> {<span class="no">Book</span>} <span class="o">=</span> <span class="nx">db</span>.<span class="na">models</span>;
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();

<span class="kd">let</span> <span class="nv">onEmptyCalled</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="nf">onEmpty</span>() {
    <span class="k">super</span>.<span class="na">onEmpty</span>();
    <span class="nx">onEmptyCalled</span> <span class="o">=</span> <span class="kc">true</span>;
  }
}

<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();

<span class="k">class</span> <span class="nc">MyPub</span> <span class="k">extends</span> <span class="nx">Publication</span> {
  <span class="k">constructor</span>(<span class="nv">options</span>) {
    <span class="k">super</span>(<span class="nx">options</span>);
  }

  <span class="nf">stop</span>() {
    <span class="k">super</span>.<span class="na">stop</span>();
    <span class="cm">/** ⏿ ⮧ here we remove the sub **/</span>
    <span class="nx">union</span>.<span class="na">removeSub</span>(<span class="k">this</span>);
  }
}

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPub</span>({<span class="na">id</span>: <span class="s">'sub1'</span>, <span class="na">conn</span>, <span class="na">lastSubscribed</span>: <span class="o">void</span> <span class="m">0</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub</span>);

<span class="nx">sub</span>.<span class="na">stop</span>();

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">onEmptyCalled</span>);</div></div></pre></div></section><section id="koru/pubsub/union#sendEncoded" tabindex="-1" name="#sendEncoded" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">sendEncoded</span>(<span class="nv">msg</span>)</span></h1><abstract><div><p>Send a pre-encoded <a class="jsdoc-link" href="#koru/session/message">message</a> to all subscribers. Called by <a class="jsdoc-link" href="#koru/pubsub/union#batchUpdate">batchUpdate</a>.</p>
<p>See <a class="jsdoc-link" href="#koru/session/server-connection#sendEncoded">ServerConnection#sendEncoded</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>msg</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the pre-encoded message</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub123'</span>, <span class="na">conn</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub1</span>);
<span class="kd">const</span> <span class="no">sub2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub124'</span>, <span class="na">conn</span>: <span class="nx">conn2</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub1</span>);
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub2</span>);

<span class="nx">union</span>.<span class="na">sendEncoded</span>(<span class="s">'myEncodedMessage'</span>);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendEncoded</span>, <span class="s">'myEncodedMessage'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn2</span>.<span class="na">sendEncoded</span>, <span class="s">'myEncodedMessage'</span>);</div></div></pre></div></section><section id="koru/pubsub/union#sendEncodedWhenIdle" tabindex="-1" name="#sendEncodedWhenIdle" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">sendEncodedWhenIdle</span>(<span class="nv">msg</span>)</span></h1><abstract><div><p>Delays calling <a class="jsdoc-link" href="#koru/pubsub/union#sendEncoded">sendEncoded</a> until <a class="jsdoc-link" href="#koru/pubsub/union#loadInitial">loadInitial</a> and <a class="jsdoc-link" href="#koru/pubsub/union#loadByToken">loadByToken</a> have finished</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>msg</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Union</span>();
<span class="nx">union</span>.<span class="na">sendEncoded</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">let</span> <span class="nv">callCount</span>;

<span class="nx">union</span>.<span class="na">loadInitial</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="nx">union</span>.<span class="na">sendEncodedWhenIdle</span>(<span class="s">'msg1'</span>);
  <span class="nx">callCount</span> <span class="o">=</span> <span class="nx">union</span>.<span class="na">sendEncoded</span>.<span class="na">callCount</span>;
};

<span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub123'</span>, <span class="na">conn</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub1</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">callCount</span>, <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">calledOnceWith</span>(<span class="nx">union</span>.<span class="na">sendEncoded</span>, <span class="s">'msg1'</span>);

<span class="nx">union</span>.<span class="na">sendEncodedWhenIdle</span>(<span class="s">'msg2'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">union</span>.<span class="na">sendEncoded</span>, <span class="s">'msg2'</span>);</div></div></pre></div></section><section id="koru/pubsub/union#subs" tabindex="-1" name="#subs" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Union#<span class="highlight"><span class="nf">subs</span>()</span></h1><abstract><div><p>Return an iterator over the union's subs.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Union</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/pubsub/union"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub123'</span>, <span class="na">conn</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub1</span>);
<span class="kd">const</span> <span class="no">sub2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub124'</span>, <span class="na">conn</span>: <span class="nx">conn2</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub2</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">union</span>.<span class="na">subs</span>()), [<span class="nx">sub1</span>, <span class="nx">sub2</span>]);</div></div></pre></div></section></div></div></div></section><section id="koru/random" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/random">koru/random</a><h1 class="jsdoc-module-title searchable">Random</h1><abstract><div><p>Generate random fractions and ids using a
<a href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator" target="_blank">pseudo-random number generator (PRNG)</a>
or a
<a href="https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator" target="_blank">cryptographically secure PRNG (CSPRNG)</a>.
If a CSRNG is not available on the client then some random like tokens will be used to seed a
PRNG instead.</p>
<p>The PRNG uses <a class="jsdoc-link" href="#koru/crypto/acc-sha256">AccSha256</a> to generate the sequence.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">global</td><td><a href="#koru/random">Random</a></td><td class="jsdoc-info" data-env="both"><div><p>a instance of a CSPRNG</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/random.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(...<span class="nv">tokens</span>)</span></h1><abstract><div><p>Create a new PRNG.</p>
<section class="jsdoc-alias"><h1>Aliases</h1><p><code class="jsdoc-alias-term">create</code> a deprecated alternative static method.</p></section></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[tokens]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>a list of tokens to seed a PRNG or empty for a CSPRNG.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Random</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/random"</span>);</div><div><div class="highlight"><span class="cs">// seeded</span>
<span class="kd">const</span> <span class="no">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span>(<span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">r1</span>.<span class="na">id</span>(), <span class="s">"kFsE9G6DL26jiPd2U"</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">r1</span>.<span class="na">id</span>(), <span class="s">"o8kyB8YoOT2NCM03U"</span>);

<span class="cs">// same seed produces same numbers</span>
<span class="nx">assert</span>.<span class="na">same</span>(<span class="k">new</span> <span class="nx">Random</span>(<span class="m">0</span>).<span class="na">id</span>(), <span class="s">"kFsE9G6DL26jiPd2U"</span>);

<span class="cs">// multiple tokens</span>
<span class="kd">const</span> <span class="no">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span>(<span class="s">"hello"</span>, <span class="s">"world"</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">r2</span>.<span class="na">id</span>(), <span class="s">'NTuiM1uEZR7vz2Nd5'</span>);

<span class="kd">const</span> <span class="no">csprng</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span>();
<span class="nx">refute</span>.<span class="na">same</span>(<span class="nx">csprng</span>.<span class="na">id</span>(), <span class="s">'IwillNeverMatchid'</span>);</div></div></pre></div></section><section id="koru/random.hexString" tabindex="-1" name="hexString" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Random.<span class="highlight"><span class="nf">hexString</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Like <a class="jsdoc-link" href="#koru/random.id">id</a> but generate a <a class="jsdoc-link" href="#koru/random#hexString">hexString</a> instead.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Random</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/random"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">intercept</span>(<span class="nx">Random</span>.<span class="na">global</span>, <span class="s">'hexString'</span>, (<span class="nv">n</span>)<span class="o">=&gt;</span><span class="s">'f007ba11c4a2'</span>.<span class="na">slice</span>(<span class="m">0</span>,<span class="nx">n</span>));
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Random</span>.<span class="na">hexString</span>(<span class="m">8</span>), <span class="s">"f007ba11"</span>);

<span class="kd">const</span> <span class="no">token</span> <span class="o">=</span> <span class="s">"abc123"</span>;
<span class="nx">util</span>.<span class="na">thread</span>.<span class="na">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span>(<span class="nx">token</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Random</span>.<span class="na">hexString</span>(<span class="m">33</span>), <span class="s">'ce8b9dfb29ed185b23fd764c97af4f108'</span>);</div></div></pre></div></section><section id="koru/random.id" tabindex="-1" name="id" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Random.<span class="highlight"><span class="nf">id</span>()</span></h1><abstract><div><p>Generate a new random id using the <a class="jsdoc-link" href="#koru/random#id">id</a> method from firstly: <a class="jsdoc-link" href="#koru/util.thread">util.thread</a><code>.random</code>
if defined; otherwise <code>random.global</code>. Using <code>util.thread.random</code> allows for repeatable and
effecient ids to be produced for a database transaction.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Random</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/random"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">intercept</span>(<span class="nx">Random</span>.<span class="na">global</span>, <span class="s">'id'</span>, ()<span class="o">=&gt;</span><span class="s">'aGlobalId'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Random</span>.<span class="na">id</span>(), <span class="s">"aGlobalId"</span>);

<span class="kd">const</span> <span class="no">id</span> <span class="o">=</span> <span class="s">"abc123"</span>;
<span class="nx">util</span>.<span class="na">thread</span>.<span class="na">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span>(<span class="nx">id</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Random</span>.<span class="na">id</span>(), <span class="s">"kfx4FPotz6UerPhgc"</span>);</div></div></pre></div></section><section id="koru/random#fraction" tabindex="-1" name="#fraction" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Random#<span class="highlight"><span class="nf">fraction</span>()</span></h1><abstract><div><p>Generate a number between 0 and 1.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Random</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/random"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span>(<span class="m">1</span>,<span class="m">2</span>,<span class="m">3</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">random</span>.<span class="na">fraction</span>(), <span class="m">0.26225688261911273</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">random</span>.<span class="na">fraction</span>(), <span class="m">0.5628666188567877</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">random</span>.<span class="na">fraction</span>(), <span class="m">0.09692026115953922</span>);</div></div></pre></div></section><section id="koru/random#hexString" tabindex="-1" name="#hexString" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Random#<span class="highlight"><span class="nf">hexString</span>(<span class="nv">digits</span>)</span></h1><abstract><div><p>Generate a sequence of hexadecimal characters.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>digits</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the number of digits to generate.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Random</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/random"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span>(<span class="m">6</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">random</span>.<span class="na">hexString</span>(<span class="m">2</span>), <span class="s">"c7"</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">random</span>.<span class="na">hexString</span>(<span class="m">7</span>), <span class="s">"e8b19da"</span>);</div></div></pre></div></section><section id="koru/random#id" tabindex="-1" name="#id" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Random#<span class="highlight"><span class="nf">id</span>()</span></h1><abstract><div><p>Generate a sequence of characters suitable for <a class="jsdoc-link" href="#koru/model/main">Model</a> ids.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>token of <a class="jsdoc-link" href="#koru/util">util</a>.idLen characters from the set <code>[0-9A-Za-z]</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Random</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/random"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Random</span>(<span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">random</span>.<span class="na">id</span>(), <span class="s">"kFsE9G6DL26jiPd2U"</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">random</span>.<span class="na">id</span>(), <span class="s">"o8kyB8YoOT2NCM03U"</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">random</span>.<span class="na">id</span>(), <span class="s">"3KkBsZqIxSLG9cNmT"</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/server-pages/main" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/server-pages/main">koru/server-pages/main</a><h1 class="jsdoc-module-title searchable">ServerPages</h1><abstract><div><p>Server side page rendering coordinator.</p>
<p>ServerPages enables apps to serve dynamically created server-side web pages. By convention
ServerPages follow the
<a href="http://guides.rubyonrails.org/routing.html#crud-verbs-and-actions" target="_blank">CRUD, Verbs, and Actions</a>
rules defined in Rails namely:</p>
<table>
<thead>
<tr>
<th align="left">HTTP Verb</th>
<th align="left">Path</th>
<th align="left">Controller#Action</th>
<th align="left">Used for</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">/books</td>
<td align="left">Books#index</td>
<td align="left">display a list of all books</td>
</tr>
<tr>
<td align="left">GET</td>
<td align="left">/books/new</td>
<td align="left">Books#new</td>
<td align="left">return an HTML form for creating a new book</td>
</tr>
<tr>
<td align="left">POST</td>
<td align="left">/books</td>
<td align="left">Books#create</td>
<td align="left">create a new book</td>
</tr>
<tr>
<td align="left">GET</td>
<td align="left">/books/:id</td>
<td align="left">Books#show</td>
<td align="left">display a specific book</td>
</tr>
<tr>
<td align="left">GET</td>
<td align="left">/books/:id/edit</td>
<td align="left">Books#edit</td>
<td align="left">return an HTML form for editing a book</td>
</tr>
<tr>
<td align="left">PATCH/PUT</td>
<td align="left">/books/:id</td>
<td align="left">Books#update</td>
<td align="left">update a specific book</td>
</tr>
<tr>
<td align="left">DELETE</td>
<td align="left">/books/:id</td>
<td align="left">Books#destroy</td>
<td align="left">delete a specific book</td>
</tr>
</tbody></table>
<p>To implement index, new, show and edit actions all that is needed is a corresponding
<a class="jsdoc-link" href="#koru/dom/template">Template</a> like <code>Book.Show</code>. The create, update and destroy actions need the action
method implemented in the <a href="#koru/server-pages/base-controller">controller</a> like
<code>BooksController</code>.</p>
<p>For the show, edit, update and destroy actions the id can be accessed from <code>{{params.id}}</code> in
the template or <code>this.params.id</code> in the controller.</p>
<p>Alternatively Controller actions matching the HTTP verb can be used and these take precedence
over other actions; so if the controller has index, show, new, edit <em>and get</em> action methods
then the get method will override the other four action methods. See
<a class="jsdoc-link" href="#koru/server-pages/base-controller">BaseController</a> for more ways to override the default actions.</p>
<h1 id="creating-a-server-page">Creating a server page</h1>
<p>The simplest way to create a new server-page is to run <code>./scripts/koru generate server-page book</code> (or select from emacs koru menu). This will create the following files under
<code>app/server-pages</code>:</p>
<ul>
<li><code>book.html</code> - The view as an html template file. book.md may be used instead for a markdown
templet file.</li>
<li><code>book.js</code>   - The <a href="#koru/server-pages/base-controller">controller</a> corresponding to the
<code>book.html</code> view used for updates and to control rendering the view.</li>
<li><code>book.less</code> - A <a href="http://lesscss.org/" target="_blank">lessjs</a> (or css) file that is included in the rendered
page (if using default layout).</li>
</ul>
<p>If a default layout does not exist then one will be created in <code>app/server-pages/layouts</code> with
the files: <code>default.html</code>, <code>default.js</code> and <code>default.less</code></p>
<h1 id="configuration">Configuration</h1>
<p>No configuration is needed for server-pages; they are automatically added when the first call
to <code>koru generate server-page</code> is made. This will register a page server for the
<a class="jsdoc-link" href="#koru/web-server">WebServer</a> in the <code>app/startup-server.js</code> file.</p>
<p>Any pages under <code>app/server-pages</code> will be automatically loaded when am HTTP request is made
that corresponds to the page.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/server-pages/main.build" tabindex="-1" name="build" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerPages.async build(WebServer, pageDir='server-pages', pathRoot='DEFAULT')</h1><abstract><div><p>Register a page server with a webServer.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>WebServer</td><td><a href="#koru/web-server">WebServer</a></td><td class="jsdoc-info"><div><p>the web-server to handler pages for.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[pageDir]</td><td></td><td class="jsdoc-info"><div><p>the directory to find views and controllers under relative to the app
directory.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[pathRoot]</td><td></td><td class="jsdoc-info"><div><p>handle pages starting with this path root.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/server-pages/main">Promise(ServerPages)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerPages</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/main"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">WebServer</span> <span class="o">=</span> <span class="nx">require</span>(<span class="s">'koru/web-server'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">sp</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ServerPages</span>.<span class="na">build</span>(<span class="nx">WebServer</span>);</div></div></pre></div></section><section id="koru/server-pages/main#stop" tabindex="-1" name="#stop" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerPages#<span class="highlight"><span class="nf">stop</span>()</span></h1><abstract><div><p>Deregister this page server from <a class="jsdoc-link" href="#koru/web-server">WebServer</a></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerPages</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/main"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">serverPages</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ServerPages</span>.<span class="na">build</span>(<span class="nx">WebServer</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">serverPages</span>.<span class="na">stop</span>();</div><div></div></div></pre></div></section></div></div></div></section><section id="koru/server-pages/base-controller" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/server-pages/base-controller">koru/server-pages/base-controller</a><h1 class="jsdoc-module-title searchable">BaseController</h1><abstract><div><p>BaseController provides the default actions for page requests. Action controllers extend
BaseController to intercept actions. See <a class="jsdoc-link" href="#koru/server-pages/main">ServerPages</a></p>
<p>Controllers are not constructed directly; rather <a class="jsdoc-link" href="#koru/server-pages/main">ServerPages</a> will invoke the
constructor when the user requests a page associated with the controller.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">view</td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info" data-env="server"><div><p>Templete for index action. All other action templates are children of this template.</p>
<h1 id="example-request">Example request</h1>
<pre><code>GET /foo
</code></pre></div></td></tr><tr><td class="searchable">view.Edit</td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info" data-env="server"><div><p>Templete for edit action.</p>
<h1 id="example-request">Example request</h1>
<pre><code>GET /foo/:id/edit
</code></pre></div></td></tr><tr><td class="searchable">view.New</td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info" data-env="server"><div><p>Templete for new action.</p>
<h1 id="example-request">Example request</h1>
<pre><code>GET /foo/new
</code></pre></div></td></tr><tr><td class="searchable">view.Show</td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info" data-env="server"><div><p>Templete for show action.</p>
<h1 id="example-request">Example request</h1>
<pre><code>GET /foo/:id
</code></pre></div></td></tr><tr><td class="searchable">#body</td><td></td><td class="jsdoc-info" data-env="server"><div><p>The body of the request. If the content type is: <code>application/json</code> or
<code>application/x-www-form-urlencoded</code> then the body is converted to an object map otherwise
the raw string is returned.</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/server-pages/base-controller.aroundFilter" tabindex="-1" name="aroundFilter" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">&lt;class extends BaseController&gt;#async aroundFilter(callback)</h1><abstract><div><p>An aroundFiler runs "around" an action controller. It is called are the <a class="jsdoc-link" href="#koru/server-pages/base-controller#$parser">$parser</a> has
run. You can control which action is called by changing the the value of <code>this.action</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div><p>call this function to run the <code>this.action</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Foo</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="k">async</span> <span class="nf">aroundFilter</span>(<span class="nv">callback</span>) {
    <span class="k">this</span>.<span class="na">params</span>.<span class="na">userId</span> <span class="o">=</span> <span class="s">'uid123'</span>;
    <span class="k">if</span> (<span class="k">this</span>.<span class="na">action</span> <span class="o">==</span> <span class="s">'edit'</span> <span class="o">&amp;&amp;</span> <span class="k">this</span>.<span class="na">pathParts</span>[<span class="m">0</span>] <span class="o">==</span> <span class="s">'1234'</span>) {
      <span class="k">this</span>.<span class="na">action</span> <span class="o">=</span> <span class="s">'specialEdit'</span>;
    }
    <span class="k">await</span> <span class="nx">callback</span>(<span class="k">this</span>);
    <span class="nx">testDone</span> <span class="o">=</span> <span class="k">this</span>.<span class="na">rendered</span>;
  }

  <span class="nf">specialEdit</span>() {
    <span class="k">this</span>.<span class="na">renderHTML</span>(<span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: <span class="k">this</span>.<span class="na">params</span>.<span class="na">userId</span>}));
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller.create" tabindex="-1" name="create" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">&lt;class extends BaseController&gt;#<span class="highlight"><span class="nf">create</span>()</span></h1><abstract><div><p>Implement this action to process create requests.</p>
<p><code>POST /books</code></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Books</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="k">async</span> <span class="nf">create</span>() {
    <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>(<span class="k">await</span> <span class="k">this</span>.<span class="na">getBody</span>());
    <span class="k">this</span>.<span class="na">redirect</span>(<span class="s">'/books/'</span> <span class="o">+</span> <span class="nx">book</span>.<span class="na">_id</span>);
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller.destroy" tabindex="-1" name="destroy" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">&lt;class extends BaseController&gt;#<span class="highlight"><span class="nf">destroy</span>()</span></h1><abstract><div><p>Implement this action to process destroy requests.</p>
<p><code>DELETE /books/:id</code></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Books</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="nf">destroy</span>() {
    <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">findById</span>(<span class="k">this</span>.<span class="na">params</span>.<span class="na">id</span>);
    <span class="nx">book</span>.<span class="na">$remove</span>();
    <span class="k">this</span>.<span class="na">redirect</span>(<span class="s">'/books'</span>);
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller.edit" tabindex="-1" name="edit" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">&lt;class extends BaseController&gt;#<span class="highlight"><span class="nf">edit</span>()</span></h1><abstract><div><p>Implement this action to control show requests:</p>
<p><code>GET /books/:id/edit</code></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Books</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="nf">edit</span>() {
    <span class="k">this</span>.<span class="na">params</span>.<span class="na">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">findById</span>(<span class="k">this</span>.<span class="na">params</span>.<span class="na">id</span>);
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller.index" tabindex="-1" name="index" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">&lt;class extends BaseController&gt;#<span class="highlight"><span class="nf">index</span>()</span></h1><abstract><div><p>Implement this action to control index requests:</p>
<p><code>GET /books</code></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Books</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="nf">index</span>() {
    <span class="k">this</span>.<span class="na">params</span>.<span class="na">books</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">query</span>;
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller.new" tabindex="-1" name="new" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">&lt;class extends BaseController&gt;#<span class="highlight"><span class="nf">new</span>()</span></h1><abstract><div><p>Implement this action to control new requests:</p>
<p><code>GET /books/new</code></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Books</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="nf">new</span>() {
    <span class="k">this</span>.<span class="na">params</span>.<span class="na">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">build</span>();
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller.show" tabindex="-1" name="show" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">&lt;class extends BaseController&gt;#<span class="highlight"><span class="nf">show</span>()</span></h1><abstract><div><p>Implement this action to control show requests:</p>
<p><code>GET /books/:id</code></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Books</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="nf">show</span>() {
    <span class="k">this</span>.<span class="na">params</span>.<span class="na">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">findById</span>(<span class="k">this</span>.<span class="na">params</span>.<span class="na">id</span>);
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller.update" tabindex="-1" name="update" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">&lt;class extends BaseController&gt;#<span class="highlight"><span class="nf">update</span>()</span></h1><abstract><div><p>Implement this action to process update requests.</p>
<p><code>PUT /books/:id</code> or <code>PATCH /books/:id</code></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Books</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="nf">update</span>() {
    <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">findById</span>(<span class="k">this</span>.<span class="na">params</span>.<span class="na">id</span>);
    <span class="nx">book</span>.<span class="na">changes</span> <span class="o">=</span> <span class="k">this</span>.<span class="na">body</span>;
    <span class="nx">book</span>.<span class="na">$$save</span>();
    <span class="k">this</span>.<span class="na">redirect</span>(<span class="s">'/books/'</span> <span class="o">+</span> <span class="nx">book</span>.<span class="na">_id</span>);
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller#$parser" tabindex="-1" name="#$parser" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">BaseController#<span class="highlight"><span class="nf">$parser</span>()</span></h1><abstract><div><p>The default request parser. Override this method for full control of the request.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Books</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="nf">$parser</span>() {
    <span class="k">if</span> (<span class="k">this</span>.<span class="na">method</span> <span class="o">===</span> <span class="s">'DELETE'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nx">Auth</span>.<span class="na">canDelete</span>(<span class="k">this</span>)) {
      <span class="k">this</span>.<span class="na">error</span>(<span class="m">403</span>, <span class="s">'You do not have delete access'</span>);
      <span class="k">return</span>;
    }

    <span class="k">super</span>.<span class="na">$parser</span>();
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller#error" tabindex="-1" name="#error" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">BaseController#<span class="highlight"><span class="nf">error</span>(<span class="nv">code</span>, <span class="nv">message</span>)</span></h1><abstract><div><p>Send an error response to the client;</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>code</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the statusCode to send.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[message]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the response body to send.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">baseController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">baseController</span>.<span class="na">error</span>(<span class="m">418</span>, <span class="s">"Short and stout"</span>);</div><div></div></div></pre></div></section><section id="koru/server-pages/base-controller#redirect" tabindex="-1" name="#redirect" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">BaseController#<span class="highlight"><span class="nf">redirect</span>(<span class="nv">url</span>, <span class="nv">code</span><span class="o">=</span><span class="m">302</span>)</span></h1><abstract><div><p>Send a redirect response to the client.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>url</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the location to redirect to.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[code]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the statusCode to send.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">baseController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">baseController</span>.<span class="na">redirect</span>(<span class="s">"/foo/1234"</span>);</div><div></div></div></pre></div></section><section id="koru/server-pages/base-controller#render" tabindex="-1" name="#render" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">BaseController#async render(content, {layout=this.App.defaultLayout}={})</h1><abstract><div><p>Respond to the client with the rendered content wrapped in the specified layoyut.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>content</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>usually rendered html but can be whatever the layout requires.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[layout]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>The layout View to wrap the content. defaults to
<code>ServerPages.defaultLayout</code> or a very basic html page.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">HelloController</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="nf">$parser</span>() {
    <span class="k">this</span>.<span class="na">render</span>(<span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: <span class="s">'Hello world'</span>}), {<span class="na">layout</span>: {<span class="nf">$render</span>({<span class="na">content</span>}) {
      <span class="k">return</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">html</span>: [{<span class="na">head</span>: {<span class="na">title</span>: <span class="s">'My First App'</span>}}, {<span class="na">body</span>: <span class="nx">content</span>}]});
    }}});
  }
}</div></div></pre></div></section><section id="koru/server-pages/base-controller#renderHTML" tabindex="-1" name="#renderHTML" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">BaseController#async renderHTML(html)</h1><abstract><div><p>Respond to the client with the rendered HTML content.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>html</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the html element to render.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">BaseController</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/base-controller"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">HelloController</span> <span class="k">extends</span> <span class="nx">BaseController</span> {
  <span class="k">async</span> <span class="nf">$parser</span>() {
    <span class="k">await</span> <span class="k">this</span>.<span class="na">renderHTML</span>(<span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: <span class="s">'Hello world'</span>}));
  }
}</div></div></pre></div></section></div></div></div></section><section id="koru/server-pages/inline-script" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/server-pages/inline-script">koru/server-pages/inline-script</a><h1 class="jsdoc-module-title searchable">InlineScript</h1><abstract><div><p>Build a script function that contains from various modules that is suitable for insertion into
an html page. It works similar to the AMD module loading but builds just one monolithic script
without any other dependencies.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/server-pages/inline-script.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">dir</span>)</span></h1><abstract><div><p>Create a new InlineScript processor.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dir</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>The local directory used by <a class="jsdoc-link" href="#require">require</a> to normalize the id.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">InlineScript</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/inline-script"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">script</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InlineScript</span>(<span class="nx">module</span>.<span class="na">dir</span>);

<span class="nx">script</span>.<span class="na">require</span>(<span class="s">'./test-inline/simple'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">script</span>.<span class="na">map</span>, {<span class="s">'koru/server-pages/test-inline/simple.js'</span>: <span class="m">0</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">script</span>.<span class="na">modules</span>, [<span class="s">"'simple'"</span>]);</div></div></pre></div></section><section id="koru/server-pages/inline-script#add" tabindex="-1" name="#add" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">InlineScript#<span class="highlight"><span class="nf">add</span>(<span class="nv">id</span>, <span class="nv">object</span>)</span></h1><abstract><div><p>Add a named object to the modules list</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the id to reference the object with a <code>require</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the object to add (will be converted to string using <code>#toString</code>)</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">InlineScript</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/inline-script"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">script</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InlineScript</span>(<span class="nx">module</span>.<span class="na">dir</span>);

<span class="nx">script</span>.<span class="na">add</span>(<span class="s">'obj-1'</span>, <span class="nx">JSON</span>.<span class="na">stringify</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>]));
<span class="nx">script</span>.<span class="na">add</span>(<span class="s">'obj-2'</span>, <span class="s">"new Date()"</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">script</span>.<span class="na">require</span>(<span class="s">'obj-2'</span>), <span class="m">1</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">script</span>.<span class="na">modules</span>[<span class="nx">script</span>.<span class="na">map</span>[<span class="s">'obj-1'</span>]], <span class="s">'[1,2,3]'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">script</span>.<span class="na">modules</span>[<span class="nx">script</span>.<span class="na">map</span>[<span class="s">'obj-2'</span>]], <span class="s">'new Date()'</span>);</div></div></pre></div></section><section id="koru/server-pages/inline-script#generate" tabindex="-1" name="#generate" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">InlineScript#<span class="highlight"><span class="nf">generate</span>()</span></h1><abstract><div><p>Generate a source script ready for instertion into a web page.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">InlineScript</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/inline-script"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">script</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InlineScript</span>(<span class="nx">module</span>.<span class="na">dir</span>);

<span class="nx">script</span>.<span class="na">require</span>(<span class="s">'./test-inline/nested'</span>);

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">vm</span>.<span class="na">runInThisContext</span>(<span class="nx">script</span>.<span class="na">generate</span>(), {
  <span class="na">filename</span>: <span class="s">'inline'</span>, <span class="na">displayErrors</span>: <span class="kc">true</span>, <span class="na">timeout</span>: <span class="m">5000</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>(), <span class="s">'nested, level2, simple, simple'</span>);</div></div></pre></div></section><section id="koru/server-pages/inline-script#require" tabindex="-1" name="#require" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">InlineScript#<span class="highlight"><span class="nf">require</span>(<span class="nv">id</span>)</span></h1><abstract><div><p>Load another module (if not already loaded) and return its body function. require is also
available with a define body.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">InlineScript</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/server-pages/inline-script"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">script</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InlineScript</span>(<span class="nx">module</span>.<span class="na">dir</span>);

<span class="nx">script</span>.<span class="na">require</span>(<span class="s">'./test-inline/nested'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">script</span>.<span class="na">map</span>, {
  <span class="s">'koru/server-pages/test-inline/simple.js'</span>: <span class="m">0</span>,
  <span class="s">'koru/server-pages/test-inline/level2.js'</span>: <span class="m">1</span>,
  <span class="s">'koru/server-pages/test-inline/nested.js'</span>: <span class="m">2</span>,
});

<span class="nx">assert</span>.<span class="na">match</span>(<span class="nx">script</span>.<span class="na">modules</span>[<span class="m">2</span>], <span class="sr">/Simple = modules\[0\];/</span>);
<span class="nx">assert</span>.<span class="na">match</span>(<span class="nx">script</span>.<span class="na">modules</span>[<span class="m">2</span>], <span class="sr">/Level2 = modules\[1\];/</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">script</span>.<span class="na">modules</span>[<span class="m">0</span>], <span class="s">"'simple'"</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/session/main" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/main">koru/session/main</a><h1 class="jsdoc-module-title searchable">Session</h1><abstract><div><p>The main or active session for client server communication.
See <a class="jsdoc-link" href="#koru/session/web-socket-sender-factory">webSocketSenderFactory</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">_id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info" data-env="both"><div><p>The Session _id: "default"</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/main.defineRpc" tabindex="-1" name="defineRpc" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Session.<span class="highlight"><span class="nf">defineRpc</span>(<span class="nv">name</span>, <span class="nv">func</span><span class="o">=</span><span class="nx">util</span>.<span class="na">voidFunc</span>)</span></h1><abstract><div><p>Define a remote proceedure call</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>func</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/session/base">base</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Session</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/main"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">refute</span>(<span class="nx">Session</span>.<span class="na">isRpcGet</span>(<span class="s">"Book.update"</span>));
<span class="nx">refute</span>(<span class="nx">Session</span>.<span class="na">isRpc</span>(<span class="s">"Book.update"</span>));
<span class="nx">Session</span>.<span class="na">defineRpc</span>(<span class="s">'Book.update'</span>, <span class="nx">func</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Session</span>.<span class="na">_rpcs</span>[<span class="s">'Book.update'</span>], <span class="nx">func</span>);
<span class="nx">refute</span>(<span class="nx">Session</span>.<span class="na">isRpcGet</span>(<span class="s">"Book.update"</span>));
<span class="nx">assert</span>(<span class="nx">Session</span>.<span class="na">isRpc</span>(<span class="s">"Book.update"</span>));</div></div></pre></div></section><section id="koru/session/main.defineRpcGet" tabindex="-1" name="defineRpcGet" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Session.<span class="highlight"><span class="nf">defineRpcGet</span>(<span class="nv">name</span>, <span class="nv">func</span><span class="o">=</span><span class="nx">util</span>.<span class="na">voidFunc</span>)</span></h1><abstract><div><p>Define a read-only (GET) remote proceedure call</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>func</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/session/base">base</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Session</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/main"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Session</span>.<span class="na">defineRpcGet</span>(<span class="s">"Book.list"</span>, <span class="ge nx">func</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">koru/session/base</span></span></div></pre></div></section><section id="koru/session/main.openBatch" tabindex="-1" name="openBatch" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">Session.<span class="highlight"><span class="nf">openBatch</span>()</span></h1><abstract><div><p>Build an encoded batch message.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>{push, encode}</code>. Use <code>push</code> to append a message to the batch. Use <code>encode</code> to
return the encoded batch.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Session</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/main"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> {<span class="no">push</span>, <span class="no">encode</span>} <span class="o">=</span> <span class="nx">Session</span>.<span class="na">openBatch</span>();
<span class="nx">push</span>([<span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">title</span>: <span class="s">'Dune'</span>}]]);
<span class="nx">push</span>([<span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="s">'book2'</span>]]);
<span class="kd">const</span> <span class="no">msg</span> <span class="o">=</span> <span class="nx">encode</span>();

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">String</span>.<span class="na">fromCharCode</span>(<span class="nx">msg</span>[<span class="m">0</span>]), <span class="s">'W'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">message</span>.<span class="na">decodeMessage</span>(<span class="nx">msg</span>.<span class="na">subarray</span>(<span class="m">1</span>), <span class="nx">Session</span>.<span class="na">globalDict</span>), [
  [<span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">title</span>: <span class="s">'Dune'</span>}]], [<span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="s">'book2'</span>]]]);</div></div></pre></div></section></div></div></div></section><section id="koru/session/client-rpc-base" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/client-rpc-base">koru/session/client-rpc-base</a><h1 class="jsdoc-module-title searchable">init</h1><abstract><div><p>Attach rpc to a session</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#lastMsgId</td><td></td><td class="jsdoc-info" data-env="client"><div><p>Return lastRpc msgId to use with <a class="jsdoc-link" href="#koru/session/client-rpc-base#cancelRpc">cancelRpc</a></p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/client-rpc-base.init" tabindex="-1" name="init" data-env="client" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">init</span>(<span class="nv">session</span>, {<span class="nv">rpcQueue</span><span class="o">=</span><span class="k">new</span> <span class="nx">RPCQueue</span>()}<span class="o">=</span>{})</span></h1><abstract><div><p>Wire up rpc to a session</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>session</td><td></td><td class="jsdoc-info"><div><p>attach rpc methods to this session</p>
</div></td></tr><tr class="jsdoc-arg"><td>rpcQueue</td><td></td><td class="jsdoc-info"><div><p>queue to store messages yet to have a
response. This can be a persistent queue like
<a class="jsdoc-link" href="#koru/session/rcp-idb-queue">rcp-idb-queue</a></p>
</div></td></tr></tbody></table></div><div></div></section><section id="koru/session/client-rpc-base#cancelRpc" tabindex="-1" name="#cancelRpc" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">init#<span class="highlight"><span class="nf">cancelRpc</span>(<span class="nv">msgId</span>)</span></h1><abstract><div><p>Return lastRpc msgId to use with <a class="jsdoc-link" href="#koru/session/client-rpc-base#cancelRpc">cancelRpc</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>msgId</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">init</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/client-rpc-base"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">init</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">init</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">cancelRpc</span>(<span class="s">"1rid1"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">cancelRpc</span>(<span class="s">"1rid1"</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">cancelRpc</span>(<span class="s">"2rid1"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div></pre></div></section><section id="koru/session/client-rpc-base#checkMsgId" tabindex="-1" name="#checkMsgId" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">init#<span class="highlight"><span class="nf">checkMsgId</span>(<span class="nv">msgId</span>)</span></h1><abstract><div><p>Ensure than next msgId will be greater than this one</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>msgId</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">init</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/client-rpc-base"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">init</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">init</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">checkMsgId</span>(<span class="s">"1rid1"</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">checkMsgId</span>(<span class="s">"14rid1"</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">checkMsgId</span>(<span class="s">"15rid1"</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">checkMsgId</span>(<span class="s">"14rid1"</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">checkMsgId</span>(<span class="s">"16rid1"</span>);</div><div></div></div></pre></div></section><section id="koru/session/client-rpc-base#replaceRpcQueue" tabindex="-1" name="#replaceRpcQueue" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">init#<span class="highlight"><span class="nf">replaceRpcQueue</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Replace the rpc queue with a different one.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">init</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/client-rpc-base"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">init</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">init</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">init</span>.<span class="na">replaceRpcQueue</span>(<span class="ge nx">{push: EMPTY_FUNC}</span>);</div><div></div></div></pre></div></section></div></div></div></section><section id="koru/session/conn-th-server" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/conn-th-server">koru/session/conn-th-server</a><h1 class="jsdoc-module-title searchable">ConnTH</h1><abstract><div><p>A Helper for Publication tests.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/conn-th-server.assert.encodedCall" tabindex="-1" name="assert.encodedCall" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">assert.<span class="highlight"><span class="nf">encodedCall</span>(<span class="nv">conn</span>, <span class="nv">type</span>, <span class="nv">exp</span>)</span></h1><abstract><div><p><code>assert.encodedCall</code> can be used for determining if a <a class="jsdoc-link" href="#koru/session/union">union</a> batchUpdate was called.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>conn</td><td><a href="#koru/session/server-connection">ServerConnection</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>type</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>exp</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ConnTH</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/conn-th-server"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">conn</span> <span class="o">=</span> <span class="nx">ConnTH</span>.<span class="na">mockConnection</span>();
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="k">async</span> <span class="nf">loadInitial</span>(<span class="nv">encoder</span>, <span class="nv">discreteLastSubscribed</span>) {
    <span class="k">await</span> <span class="nx">Book</span>.<span class="na">query</span>.<span class="na">forEach</span>((<span class="nv">doc</span>) <span class="o">=&gt;</span> {<span class="nx">encoder</span>.<span class="na">addDoc</span>(<span class="nx">doc</span>)});
  }
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub1'</span>, <span class="na">conn</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub</span>);

<span class="nx">assert</span>.<span class="na">encodedCall</span>(<span class="nx">conn</span>, <span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">name</span>: <span class="s">'Book 1'</span>}]);</div></div></pre></div></section><section id="koru/session/conn-th-server.decodeEncodedCall" tabindex="-1" name="decodeEncodedCall" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ConnTH.<span class="highlight"><span class="nf">decodeEncodedCall</span>(<span class="nv">conn</span>, <span class="nv">call</span>)</span></h1><abstract><div><p>convert an encoded call back to objects</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>conn</td><td><a href="#koru/session/server-connection">ServerConnection</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>call</td><td><a href="#koru/test/stubber::Stub::Call">Call</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ConnTH</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/conn-th-server"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">conn</span> <span class="o">=</span> <span class="nx">ConnTH</span>.<span class="na">mockConnection</span>();
<span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Book</span>.<span class="na">create</span>();

<span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">extends</span> <span class="nx">Union</span> {
  <span class="k">async</span> <span class="nf">loadInitial</span>(<span class="nv">encoder</span>, <span class="nv">discreteLastSubscribed</span>) {
    <span class="k">await</span> <span class="nx">Book</span>.<span class="na">query</span>.<span class="na">forEach</span>((<span class="nv">doc</span>) <span class="o">=&gt;</span> {<span class="nx">encoder</span>.<span class="na">addDoc</span>(<span class="nx">doc</span>)});
  }
}
<span class="kd">const</span> <span class="no">union</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyUnion</span>();

<span class="kd">const</span> <span class="no">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Publication</span>({<span class="na">id</span>: <span class="s">'sub1'</span>, <span class="na">conn</span>});
<span class="k">await</span> <span class="nx">union</span>.<span class="na">addSub</span>(<span class="nx">sub</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ConnTH</span>.<span class="na">decodeEncodedCall</span>(<span class="nx">conn</span>, <span class="nx">conn</span>.<span class="na">sendEncoded</span>.<span class="na">firstCall</span>), {
  <span class="na">type</span>: <span class="s">'W'</span>,
  <span class="na">data</span>: [
    [<span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">name</span>: <span class="s">'Book 1'</span>}]],
    [<span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book2'</span>, <span class="na">name</span>: <span class="s">'Book 2'</span>}]],
  ]});</div></div></pre></div></section><section id="koru/session/conn-th-server.mockConnection" tabindex="-1" name="mockConnection" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ConnTH.<span class="highlight"><span class="nf">mockConnection</span>(<span class="nv">sessId</span><span class="o">=</span><span class="s">'s123'</span>, <span class="nv">session</span><span class="o">=</span><span class="nx">Session</span>)</span></h1><abstract><div><p>Create a connection useful for testing publications.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>sessId</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[session]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/session/server-connection">ServerConnection</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ConnTH</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/conn-th-server"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">conn</span> <span class="o">=</span> <span class="nx">ConnTH</span>.<span class="na">mockConnection</span>(<span class="s">'sess123'</span>);
<span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Publication</span> {
}
<span class="nx">Library</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;

<span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="s">'Library'</span>);
<span class="nx">after</span>(() <span class="o">=&gt;</span> {<span class="nx">ConnTH</span>.<span class="na">stopAllSubs</span>(<span class="nx">conn</span>)});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub1</span>.<span class="na">conn</span>, <span class="nx">conn</span>);</div></div></pre></div></section><section id="koru/session/conn-th-server.stopAllSubs" tabindex="-1" name="stopAllSubs" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ConnTH.<span class="highlight"><span class="nf">stopAllSubs</span>(<span class="nv">conn</span>)</span></h1><abstract><div><p>Stop all stubs for a connection. Useful in test teardown to ensure observers have stopped.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>conn</td><td><a href="#koru/session/server-connection">ServerConnection</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ConnTH</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/conn-th-server"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">conn</span> <span class="o">=</span> <span class="nx">ConnTH</span>.<span class="na">mockConnection</span>(<span class="s">'sess123'</span>);
<span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nx">Publication</span> {
}
<span class="nx">Library</span>.<span class="na">pubName</span> <span class="o">=</span> <span class="s">'Library'</span>;

<span class="kd">const</span> <span class="no">sub1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">conn</span>.<span class="na">onSubscribe</span>(<span class="s">'sub1'</span>, <span class="m">1</span>, <span class="s">'Library'</span>);
<span class="kd">const</span> <span class="no">stop</span> <span class="o">=</span> <span class="nx">spy</span>(<span class="nx">sub1</span>, <span class="s">'stop'</span>);

<span class="nx">ConnTH</span>.<span class="na">stopAllSubs</span>(<span class="nx">conn</span>);

<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">stop</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/session/reverse-rpc-receiver" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/reverse-rpc-receiver">koru/session/reverse-rpc-receiver</a><h1 class="jsdoc-module-title searchable">ReverseRpcReceiver</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/reverse-rpc-receiver.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">session</span>, <span class="nv">cmd</span><span class="o">=</span><span class="s">'F'</span>)</span></h1><abstract><div><p>Create an reverse rpc handler</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>session</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>used to receive rpc calls on</p>
</div></td></tr><tr class="jsdoc-arg"><td>[cmd]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>session command to tie this rpc service to. Defaults to 'F'.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ReverseRpcReceiver</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/reverse-rpc-receiver"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">reverseRpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReverseRpcReceiver</span>(<span class="nx">sess</span>);

<span class="kd">const</span> <span class="no">foo</span> <span class="o">=</span> <span class="nx">stub</span>().<span class="na">returns</span>(<span class="s">'success'</span>);

<span class="nx">reverseRpc</span>.<span class="na">define</span>(<span class="s">'foo.rpc'</span>, <span class="nx">foo</span>);

<span class="kd">const</span> <span class="no">receive</span> <span class="o">=</span> <span class="nx">sess</span>.<span class="na">_commands</span>.<span class="na">F</span>;
<span class="nx">assert</span>.<span class="na">isFunction</span>(<span class="nx">receive</span>);

<span class="k">await</span> <span class="nx">receive</span>([<span class="s">'1234'</span>, <span class="s">'foo.rpc'</span>, <span class="m">1</span>, <span class="m">2</span>]);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">sess</span>.<span class="na">sendBinary</span>, <span class="s">'F'</span>, [<span class="s">'1234'</span>, <span class="s">'r'</span>, <span class="s">'success'</span>]);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">foo</span>, <span class="m">1</span>, <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">foo</span>.<span class="na">lastCall</span>.<span class="na">thisValue</span>, <span class="nx">sess</span>);</div></div></pre></div></section><section id="koru/session/reverse-rpc-receiver#define" tabindex="-1" name="#define" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ReverseRpcReceiver#<span class="highlight"><span class="nf">define</span>(<span class="nv">name</span>, <span class="nv">func</span>)</span></h1><abstract><div><p>Set the ServerConnection for the queue. And send any queued messages to it.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>func</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/session/reverse-rpc-receiver">ReverseRpcReceiver</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ReverseRpcReceiver</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/reverse-rpc-receiver"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">reverseRpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReverseRpcReceiver</span>(<span class="nx">sess</span>);

<span class="kd">function</span> <span class="nf">myRpc</span>(<span class="nv">arg1</span>, <span class="nv">arg2</span>) {}

<span class="nx">reverseRpc</span>.<span class="na">define</span>(<span class="s">'myRpc'</span>, <span class="nx">myRpc</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">reverseRpc</span>.<span class="na">_rpcs</span>.<span class="na">myRpc</span>, <span class="nx">myRpc</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/session/reverse-rpc-sender" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/reverse-rpc-sender">koru/session/reverse-rpc-sender</a><h1 class="jsdoc-module-title searchable">ReverseRpcSender</h1><abstract><div></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/reverse-rpc-sender.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>({<span class="nv">conn</span>, <span class="nv">cmd</span><span class="o">=</span><span class="s">'F'</span>, <span class="nv">rpcQueue</span><span class="o">=</span><span class="k">new</span> <span class="nx">RPCQueue</span>(<span class="nx">cmd</span>)}<span class="o">=</span>{})</span></h1><abstract><div><p>Create an reverse rpc handler</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[conn]</td><td><a href="#koru/session/server-connection">ServerConnection</a></td><td class="jsdoc-info"><div><p>optional ServerConnection</p>
</div></td></tr><tr class="jsdoc-arg"><td>[cmd]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>session command to tie this rpc service to. Defaults to 'F'.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[rpcQueue]</td><td><a href="#koru/session/rpc-queue">RPCQueue</a></td><td class="jsdoc-info"><div><p>queue to store messages yet to have a response. This can be a persistent
queue. (Defaults to <a class="jsdoc-link" href="#koru/session/RpcQueue">RpcQueue</a>).</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ReverseRpcSender</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/reverse-rpc-sender"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">cmd</span> <span class="o">=</span> <span class="s">'F'</span>;
<span class="kd">const</span> <span class="no">rpcQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RPCQueue</span>(<span class="nx">cmd</span>);
<span class="kd">const</span> <span class="no">reverseRpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReverseRpcSender</span>({<span class="na">conn</span>, <span class="na">cmd</span>, <span class="na">rpcQueue</span>});

<span class="nx">reverseRpc</span>.<span class="na">rpc</span>(<span class="s">'foo.rpc'</span>, <span class="m">1</span>, <span class="m">2</span>);

<span class="kd">const</span> <span class="no">msgId</span> <span class="o">=</span> <span class="s">'1'</span> <span class="o">+</span> <span class="nx">reverseRpc</span>.<span class="na">baseId</span>.<span class="function toString() { [native code] }">toString</span>(<span class="m">36</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">rpcQueue</span>.<span class="na">get</span>(<span class="nx">msgId</span>), [[<span class="nx">msgId</span>, <span class="s">'foo.rpc'</span>, <span class="m">1</span>, <span class="m">2</span>], <span class="kc">null</span>]);</div></div></pre></div></section><section id="koru/session/reverse-rpc-sender.configureSession" tabindex="-1" name="configureSession" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ReverseRpcSender.<span class="highlight"><span class="nf">configureSession</span>(<span class="nv">session</span>, <span class="nv">cmd</span><span class="o">=</span><span class="s">'F'</span>)</span></h1><abstract><div><p>Enable a session to receive reverseRpc callbacks</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>session</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the session that initiates the callbacks</p>
</div></td></tr><tr class="jsdoc-arg"><td>cmd</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>session command to tie this rpc service to. Defaults to 'F'.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ReverseRpcSender</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/reverse-rpc-sender"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">ReverseRpcSender</span>.<span class="na">configureSession</span>(<span class="nx">mySession</span>, <span class="s">'F'</span>);
<span class="nx">assert</span>.<span class="na">calledOnceWith</span>(<span class="nx">mySession</span>.<span class="na">provide</span>, <span class="s">'F'</span>, <span class="nx">m</span>.<span class="na">func</span>);</div></div></pre></div></section><section id="koru/session/reverse-rpc-sender#rpc" tabindex="-1" name="#rpc" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ReverseRpcSender#<span class="highlight"><span class="nf">rpc</span>(<span class="nv">name</span>, ...<span class="nv">args</span>)</span></h1><abstract><div><p>perform a remote procedure call.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>of the method to call</p>
</div></td></tr><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the arguments to pass to the method followed by an optional callback</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ReverseRpcSender</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/reverse-rpc-sender"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">reverseRpc</span>.<span class="na">rpc</span>(<span class="s">'getHealth'</span>, <span class="s">'battery'</span>, <span class="s">'PSU'</span>, (<span class="nv">err</span>, <span class="nv">result</span>) <span class="o">=&gt;</span> {
  <span class="k">if</span> (<span class="nx">err</span> <span class="o">!=</span> <span class="kc">null</span>) {
    <span class="nx">handler</span>.<span class="na">error</span>(<span class="nx">err</span>);
  } <span class="k">else</span> {
    <span class="nx">handler</span>.<span class="na">healthResult</span>(<span class="nx">result</span>);
  }
});
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'F'</span>, [<span class="s">'1'</span> <span class="o">+</span> <span class="nx">reverseRpc</span>.<span class="na">baseId</span>, <span class="s">'getHealth'</span>, <span class="s">'battery'</span>, <span class="s">'PSU'</span>]);</div></div></pre></div></section><section id="koru/session/reverse-rpc-sender#setConn" tabindex="-1" name="#setConn" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ReverseRpcSender#<span class="highlight"><span class="nf">setConn</span>(<span class="nv">conn</span>)</span></h1><abstract><div><p>Set the ServerConnection for the queue. And send any queued messages to it.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>conn</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ReverseRpcSender</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/reverse-rpc-sender"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">reverseRpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReverseRpcSender</span>();

<span class="kd">const</span> <span class="no">conn</span> <span class="o">=</span> {<span class="na">sendBinary</span>: <span class="nx">stub</span>()};

<span class="nx">reverseRpc</span>.<span class="na">rpc</span>(<span class="s">'foo.rpc'</span>, <span class="m">1</span>, <span class="m">2</span>);

<span class="nx">reverseRpc</span>.<span class="na">setConn</span>(<span class="nx">conn</span>);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'F'</span>, [<span class="s">'1'</span> <span class="o">+</span> <span class="nx">reverseRpc</span>.<span class="na">baseId</span>, <span class="s">'foo.rpc'</span>, <span class="m">1</span>, <span class="m">2</span>]);

<span class="nx">reverseRpc</span>.<span class="na">rpc</span>(<span class="s">'another'</span>);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'F'</span>, [<span class="s">'2'</span> <span class="o">+</span> <span class="nx">reverseRpc</span>.<span class="na">baseId</span>, <span class="s">'another'</span>]);</div></div></pre></div></section></div></div></div></section><section id="koru/session/rpc-idb-queue" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/rpc-idb-queue">koru/session/rpc-idb-queue</a><h1 class="jsdoc-module-title searchable">RPCIDBQueue</h1><abstract><div><p>IndexedDB queue for RPC messages to be sent. This queue is for a
persistent indexedDB queue which is suitable for offline support.</p>
<p>Call <a class="jsdoc-link" href="#koru/session/rpc-idb-queue#reload">reload</a> to re-populate the message queue when the app is
loaded and before other messages are preloaded.</p>
<p>RpcGet methods are not persisted.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/rpc-idb-queue.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">qdb</span>)</span></h1><abstract><div><p>Build a new queue</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>qdb</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">RPCIDBQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/rpc-idb-queue"</span>);</div><div><div class="highlight"><span class="k">new</span> <span class="nx">RPCIDBQueue</span>({<span class="na">result</span>: {<span class="na">_mockdb</span>: <span class="nx">MockIndexedDB</span>({<span class="na">_version</span>: <span class="m">0</span>, <span class="nf">restore</span>(){}, <span class="na">_dbs</span>: {<span class="na">foo</span>: <span class="nx">Database</span>({<span class="na">_store</span>: {}, <span class="na">_mockdb</span>: {<span class="k">...</span><span class="nx">more</span>}, <span class="na">_version</span>: <span class="m">0</span>})}, <span class="na">_pending</span>: <span class="kc">null</span>}), <span class="na">_store</span>: {}, }, <span class="na">onupgradeneeded</span>: <span class="kc">undefined</span>, <span class="na">onsuccess</span>: <span class="kc">undefined</span>});</div></div></pre></div></section><section id="koru/session/rpc-idb-queue#reload" tabindex="-1" name="#reload" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">RPCIDBQueue#<span class="highlight"><span class="nf">reload</span>(<span class="nv">session</span>)</span></h1><abstract><div><p>reload all waiting messages into memory for resend</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>session</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">RPCIDBQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/rpc-idb-queue"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">rPCIDBQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RPCIDBQueue</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">rPCIDBQueue</span>.<span class="na">reload</span>(<span class="ge nx">{state: {incPending: function stub(){}}, sendBinary: sendBinary, checkMsgId: EMPTY_FUNC}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">undefined</span></span></div></pre></div></section></div></div></div></section><section id="koru/session/rpc-queue" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/rpc-queue">koru/session/rpc-queue</a><h1 class="jsdoc-module-title searchable">RPCQueue</h1><abstract><div><p>Default queue for RPC messages to be sent. This queue is for an
in memory queue but can be replaced by a persistent queue for
offline-mode.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/rpc-queue.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">cmd</span><span class="o">=</span><span class="s">'M'</span>)</span></h1><abstract><div><p>Build a new queue</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[cmd]</td><td></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">RPCQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/rpc-queue"</span>);</div><div><div class="highlight"><span class="k">new</span> <span class="nx">RPCQueue</span>();</div></div></pre></div></section><section id="koru/session/rpc-queue#resend" tabindex="-1" name="#resend" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">RPCQueue#<span class="highlight"><span class="nf">resend</span>(<span class="nv">session</span>)</span></h1><abstract><div><p>Iterating over the queue returns messages in msgId order.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>session</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">RPCQueue</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/rpc-queue"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">rPCQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RPCQueue</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">rPCQueue</span>.<span class="na">resend</span>(<span class="ge nx">{sendBinary: sendBinary, checkMsgId: checkMsgId}</span>);</div><div></div></div></pre></div></section></div></div></div></section><section id="koru/session/server-connection" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/server-connection">koru/session/server-connection</a><h1 class="jsdoc-module-title searchable">ServerConnection</h1><abstract><div><p>ServerConnection is the server side of a client-server webSocket connection.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/server-connection.buildUpdate" tabindex="-1" name="buildUpdate" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection.<span class="highlight"><span class="nf">buildUpdate</span>(<span class="nv">dc</span>)</span></h1><abstract><div><p>BuildUpdate converts a <a class="jsdoc-link" href="#koru/model/doc-change">DocChange</a> object into a update command to send to
clients.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dc</td><td><a href="#koru/model/doc-change">DocChange</a></td><td class="jsdoc-info"><div><p>for the document that has been updated</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>an update command. Where</p>
<table>
<thead>
<tr>
<th>index 0</th>
<th>index 1</th>
</tr>
</thead>
<tbody><tr>
<td><code>A</code></td>
<td>`[modelName, doc._id, doc.attributes]</td>
</tr>
<tr>
<td><code>C</code></td>
<td>`[modelName, doc._id, dc.changes]</td>
</tr>
<tr>
<td><code>R</code></td>
<td>`[modelName, doc._id]</td>
</tr>
</tbody></table>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ServerConnection</span>.<span class="na">buildUpdate</span>(<span class="nx">DocChange</span>.<span class="na">add</span>(<span class="nx">book1</span>)),
              [<span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">name</span>: <span class="s">'Book 1'</span>}]]);
      
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ServerConnection</span>.<span class="na">buildUpdate</span>(<span class="nx">DocChange</span>.<span class="na">change</span>(<span class="nx">book1</span>, {<span class="na">name</span>: <span class="s">'old name'</span>})),
              [<span class="s">'C'</span>, [<span class="s">'Book'</span>, <span class="s">'book1'</span>, {<span class="na">name</span>: <span class="s">'new name'</span>}]]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ServerConnection</span>.<span class="na">buildUpdate</span>(<span class="nx">DocChange</span>.<span class="na">delete</span>(<span class="nx">book1</span>)),
              [<span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="s">'book1'</span>, <span class="kc">undefined</span>]]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ServerConnection</span>.<span class="na">buildUpdate</span>(<span class="nx">DocChange</span>.<span class="na">delete</span>(<span class="nx">book1</span>, <span class="s">'stopped'</span>)),
              [<span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="s">'book1'</span>, <span class="s">'stopped'</span>]]);</div></div></pre></div></section><section id="koru/session/server-connection.filterDoc" tabindex="-1" name="filterDoc" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection.<span class="highlight"><span class="nf">filterDoc</span>(<span class="nv">doc</span>, <span class="nv">filter</span>)</span></h1><abstract><div><p>Filter out attributes from a doc. The filtered attributes are shallow copied.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the document to be filtered.</p>
</div></td></tr><tr class="jsdoc-arg"><td>filter</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an Object who properties will override the document.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object suitable for sending to client; namely it has an <code>_id</code>, a <code>constructor</code>
model, and a <code>attributes</code> field.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">doc</span> <span class="o">=</span> {
  <span class="na">_id</span>: <span class="s">'book1'</span>, <span class="na">constructor</span>: {<span class="na">modelName</span>: <span class="s">'Book'</span>}, <span class="na">other</span>: <span class="m">123</span>,
  <span class="na">attributes</span>: {<span class="na">name</span>: <span class="s">'The little yellow digger'</span>, <span class="na">wholesalePrice</span>: <span class="m">1095</span>},
};

<span class="kd">const</span> <span class="no">filteredDoc</span> <span class="o">=</span> <span class="nx">ServerConnection</span>.<span class="na">filterDoc</span>(<span class="nx">doc</span>, {<span class="na">wholesalePrice</span>: <span class="kc">true</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">filteredDoc</span>, {
  <span class="na">_id</span>: <span class="s">'book1'</span>,
  <span class="na">constructor</span>: {<span class="na">modelName</span>: <span class="s">'Book'</span>},
  <span class="na">attributes</span>: {<span class="na">name</span>: <span class="s">'The little yellow digger'</span>},
});</div></div></pre></div></section><section id="koru/session/server-connection#added" tabindex="-1" name="#added" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection#<span class="highlight"><span class="nf">added</span>(<span class="nv">name</span>, <span class="nv">attrs</span>, <span class="nv">filter</span>)</span></h1><abstract><div><p>Send a document added message to client with an optional attribute remove filter</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>attrs</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[filter]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> {<span class="na">_id</span>: <span class="s">'id123'</span>, <span class="na">title</span>: <span class="s">'1984'</span>, <span class="na">published</span>: <span class="m">1948</span>};
<span class="nx">conn</span>.<span class="na">added</span>(<span class="s">'Book'</span>, <span class="nx">book</span>);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'A'</span>, [<span class="s">'Book'</span>, <span class="nx">book</span>]);

<span class="nx">conn</span>.<span class="na">added</span>(<span class="s">'Book'</span>, <span class="nx">book</span>, {<span class="na">published</span>: <span class="kc">true</span>});

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'A'</span>, [<span class="s">'Book'</span>, {<span class="na">_id</span>: <span class="s">'id123'</span>, <span class="na">title</span>: <span class="s">'1984'</span>}]);</div></div></pre></div></section><section id="koru/session/server-connection#batchMessage" tabindex="-1" name="#batchMessage" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection#<span class="highlight"><span class="nf">batchMessage</span>(<span class="nv">type</span>, <span class="nv">data</span>)</span></h1><abstract><div><p>Batch a binary message and send once current transaction completes successfully. The
message is encoded immediately.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>type</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the one character type for the message. See <a class="jsdoc-link" href="#koru/session/base#provide">base#provide</a>.</p>
</div></td></tr><tr class="jsdoc-arg"><td>data</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a object or primitive to encode and send as a binary message.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
  <span class="nx">conn</span>.<span class="na">batchMessage</span>(<span class="s">'R'</span>, [<span class="s">'Foo'</span>, {<span class="na">_id</span>: <span class="s">'foo1'</span>}]);
  <span class="nx">conn</span>.<span class="na">batchMessage</span>(<span class="s">'R'</span>, [<span class="s">'Foo'</span>, {<span class="na">_id</span>: <span class="s">'foo2'</span>}]);
  <span class="nx">koru</span>.<span class="na">runFiber</span>(() <span class="o">=&gt;</span> {
    <span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
      <span class="nx">conn</span>.<span class="na">batchMessage</span>(<span class="s">'R'</span>, [<span class="s">'Bar'</span>, {<span class="na">_id</span>: <span class="s">'bar1'</span>}]);
    });
  });
  <span class="nx">koru</span>.<span class="na">runFiber</span>(() <span class="o">=&gt;</span> {
    <span class="k">try</span> {
      <span class="nx">TransQueue</span>.<span class="na">transaction</span>(() <span class="o">=&gt;</span> {
        <span class="nx">conn</span>.<span class="na">batchMessage</span>(<span class="s">'R'</span>, [<span class="s">'Nat'</span>, {<span class="na">_id</span>: <span class="s">'nat1'</span>}]);
        <span class="k">throw</span> <span class="s">'abort'</span>;
      });
    } <span class="k">catch</span> (<span class="nv">ex</span>) {
      <span class="k">if</span> (<span class="nx">ex</span> <span class="o">!==</span> <span class="s">'abort'</span>) <span class="k">throw</span> <span class="nx">ex</span>;
    }
  });
});
<span class="nx">assert</span>.<span class="na">calledTwice</span>(<span class="nx">conn</span>.<span class="na">sendEncoded</span>);
<span class="nx">assert</span>.<span class="na">encodedCall</span>(<span class="nx">conn</span>, <span class="s">'R'</span>, [<span class="s">'Foo'</span>, {<span class="na">_id</span>: <span class="s">'foo1'</span>}]);
<span class="nx">assert</span>.<span class="na">encodedCall</span>(<span class="nx">conn</span>, <span class="s">'R'</span>, [<span class="s">'Foo'</span>, {<span class="na">_id</span>: <span class="s">'foo2'</span>}]);

<span class="nx">assert</span>.<span class="na">encodedCall</span>(<span class="nx">conn</span>, <span class="s">'R'</span>, [<span class="s">'Bar'</span>, {<span class="na">_id</span>: <span class="s">'bar1'</span>}]);
<span class="nx">refute</span>.<span class="na">encodedCall</span>(<span class="nx">conn</span>, <span class="s">'R'</span>, [<span class="s">'Nat'</span>, {<span class="na">_id</span>: <span class="s">'nat1'</span>}]);</div></div></pre></div></section><section id="koru/session/server-connection#changed" tabindex="-1" name="#changed" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection#<span class="highlight"><span class="nf">changed</span>(<span class="nv">name</span>, <span class="nv">id</span>, <span class="nv">attrs</span>, <span class="nv">filter</span>)</span></h1><abstract><div><p>Send a document changed message to client with an optional attribute remove filter.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>attrs</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[filter]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">conn</span>.<span class="na">changed</span>(<span class="s">'Book'</span>, <span class="s">'id123'</span>, {<span class="na">title</span>: <span class="s">'1984'</span>});

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'C'</span>, [<span class="s">'Book'</span>, <span class="s">'id123'</span>, {<span class="na">title</span>: <span class="s">'1984'</span>}]);

<span class="nx">conn</span>.<span class="na">changed</span>(<span class="s">'Book'</span>, <span class="s">'id123'</span>, {<span class="na">title</span>: <span class="s">'1984'</span>, <span class="na">published</span>: <span class="m">1948</span>}, {<span class="na">published</span>: <span class="kc">true</span>});

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'C'</span>, [<span class="s">'Book'</span>, <span class="s">'id123'</span>, {<span class="na">title</span>: <span class="s">'1984'</span>}]);</div></div></pre></div></section><section id="koru/session/server-connection#removed" tabindex="-1" name="#removed" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection#<span class="highlight"><span class="nf">removed</span>(<span class="nv">name</span>, <span class="nv">id</span>, <span class="nv">flag</span>)</span></h1><abstract><div><p>Send a document removed message to client</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[flag]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">serverConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ServerConnection</span>();</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">conn</span>.<span class="na">removed</span>(<span class="s">'Book'</span>, <span class="s">'id123'</span>);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="s">'id123'</span>, <span class="kc">undefined</span>]);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">conn</span>.<span class="na">removed</span>(<span class="s">'Book'</span>, <span class="s">'id123'</span>, <span class="s">'stopped'</span>);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">sendBinary</span>, <span class="s">'R'</span>, [<span class="s">'Book'</span>, <span class="s">'id123'</span>, <span class="s">'stopped'</span>]);</div></div></pre></div></section><section id="koru/session/server-connection#send" tabindex="-1" name="#send" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection#<span class="highlight"><span class="nf">send</span>(<span class="nv">type</span>, <span class="nv">data</span>)</span></h1><abstract><div><p>Send a text message to the client.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>type</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the one character type for the message. See <a class="jsdoc-link" href="#koru/session/base#provide">base#provide</a>.</p>
</div></td></tr><tr class="jsdoc-arg"><td>data</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the text message to send.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">conn</span>.<span class="na">send</span>(<span class="s">'X'</span>, <span class="s">'FOO'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">v</span>.<span class="na">ws</span>.<span class="na">send</span>, <span class="s">'XFOO'</span>);</div></div></pre></div></section><section id="koru/session/server-connection#sendBinary" tabindex="-1" name="#sendBinary" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection#<span class="highlight"><span class="nf">sendBinary</span>(<span class="nv">type</span>, <span class="nv">data</span>)</span></h1><abstract><div><p>Send a object to client as a binary message.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>type</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the one character type for the message. See <a class="jsdoc-link" href="#koru/session/base#provide">base#provide</a>.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[data]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>a object or primitive to encode and send as a binary message.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">conn</span>.<span class="na">sendBinary</span>(<span class="s">'M'</span>, [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>]);</div></div></pre></div></section><section id="koru/session/server-connection#sendEncoded" tabindex="-1" name="#sendEncoded" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">ServerConnection#<span class="highlight"><span class="nf">sendEncoded</span>(<span class="nv">msg</span>)</span></h1><abstract><div><p>Send a pre encoded binary <a class="jsdoc-link" href="#koru/session/message">message</a> to the client.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>msg</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ServerConnection</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/server-connection"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">conn</span>.<span class="na">sendEncoded</span>(<span class="s">'myMessage'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">conn</span>.<span class="na">ws</span>.<span class="na">send</span>, <span class="s">'myMessage'</span>, {<span class="na">binary</span>: <span class="kc">true</span>});</div></div></pre></div></section></div></div></div></section><section id="koru/session/web-socket-sender-factory" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/session/web-socket-sender-factory">koru/session/web-socket-sender-factory</a><h1 class="jsdoc-module-title searchable">webSocketSenderFactory</h1><abstract><div><p>Build WebSocket clients (senders).</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/session/web-socket-sender-factory.webSocketSenderFactory" tabindex="-1" name="webSocketSenderFactory" data-env="both" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">webSocketSenderFactory</span>(
    <span class="nv">_session</span>, <span class="nv">sessState</span>, <span class="nv">execWrapper</span><span class="o">=</span><span class="nx">koru</span>.<span class="na">fiberConnWrapper</span>, <span class="nv">base</span><span class="o">=</span><span class="nx">_session</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>_session</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>sessState</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[execWrapper]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[base]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">webSocketSenderFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/session/web-socket-sender-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">mySession</span> <span class="o">=</span> <span class="nx">webSocketSenderFactory</span>(<span class="k">new</span> <span class="nx">SessionBase</span>(<span class="s">'foo'</span>), <span class="nx">stateFactory</span>());
<span class="kd">const</span> <span class="no">wsConnection</span> <span class="o">=</span> {};
<span class="nx">mySession</span>.<span class="na">newWs</span> <span class="o">=</span> <span class="nx">stub</span>().<span class="na">returns</span>(<span class="nx">wsConnection</span>);

<span class="nx">mySession</span>.<span class="na">start</span>();

<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">mySession</span>.<span class="na">newWs</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">wsConnection</span>.<span class="na">binaryType</span>, <span class="s">'arraybuffer'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/stacktrace" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/stacktrace">koru/stacktrace</a><h1 class="jsdoc-module-title searchable">Stacktrace</h1><abstract><div><p>Stacktrace provides methods to normalize stack frames from different browsers and nodejs. Koru
normalizes error messages before displaying them in logs using <a class="jsdoc-link" href="#koru/util.extractError">util.extractError</a> and
<a class="jsdoc-link" href="#koru/test/core::AssertionError">Core::AssertionError</a>.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/stacktrace.elideFrames" tabindex="-1" name="elideFrames" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stacktrace.<span class="highlight"><span class="nf">elideFrames</span>(<span class="nv">error</span>, <span class="nv">count</span>)</span></h1><abstract><div><p>Elide the top <code>count</code> frames from an <code>error</code>'s <a class="jsdoc-link" href="#koru/stacktrace.normalize">normalized</a> stack frame</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>error</td><td><a href="#koru/test/core::AssertionError">AssertionError</a></td><td class="jsdoc-info"><div><p>the Error to elide from</p>
</div></td></tr><tr class="jsdoc-arg"><td>count</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stacktrace</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/stacktrace"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">inner1</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner2</span>()};
<span class="kd">const</span> <span class="no">inner2</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner3</span>()};
<span class="kd">const</span> <span class="no">inner3</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="k">throw</span> <span class="k">new</span> <span class="nx">AssertionError</span>(<span class="s">'I have a shortened customStack'</span>);
};
<span class="k">try</span> {
  <span class="nx">inner1</span>();
} <span class="k">catch</span> (<span class="nv">err</span>) {
  <span class="nx">Stacktrace</span>.<span class="na">elideFrames</span>(<span class="nx">err</span>, <span class="m">2</span>);

  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err</span>), [
    <span class="nx">m</span>(<span class="sr">/    at .*inner1.* \(koru\/stacktrace-test.js:\d+:\d+\)/</span>),
    <span class="nx">m</span>(<span class="sr">/    at .*((Test\.)?test elideFrames|anonymous).* \(koru\/stacktrace-test.js:\d+:\d+\)/</span>),
  ]);
}</div></div></pre></div></section><section id="koru/stacktrace.normalize" tabindex="-1" name="normalize" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stacktrace.<span class="highlight"><span class="nf">normalize</span>(<span class="nv">error</span>)</span></h1><abstract><div><p>Normalize the stack trace for an <code>error</code>. See <a class="jsdoc-link" href="#koru/stacktrace.elideFrames">elideFrames</a> and <a class="jsdoc-link" href="#koru/stacktrace.replaceStack">replaceStack</a> for
manipulation of the stack trace. By default other frames are elided from the trace when
they are part of Koru's internal workings; to see a full stack trace set
<a class="jsdoc-link" href="#koru/util">util.FULL_STACK</a> to true.</p>
<p>See <a class="jsdoc-link" href="#koru/util.extractError">util.extractError</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>error</td><td><a href="#koru/test/core::AssertionError">AssertionError</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a normalized array of stack frames</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stacktrace</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/stacktrace"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">inner1</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner2</span>()};
<span class="kd">const</span> <span class="no">inner2</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner3</span>()};
<span class="kd">const</span> <span class="no">inner3</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="k">throw</span> <span class="k">new</span> <span class="nx">AssertionError</span>(<span class="s">'I failed'</span>);
};

<span class="k">try</span> {
  <span class="nx">inner1</span>();
} <span class="k">catch</span> (<span class="nv">err</span>) {
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err</span>), [
    <span class="nx">m</span>(<span class="sr">/    at .*inner3.* \(koru\/stacktrace-test.js:\d+:\d+\)/</span>),
    <span class="nx">m</span>(<span class="sr">/    at .*inner2.* \(koru\/stacktrace-test.js:\d+:\d+\)/</span>),
    <span class="nx">m</span>(<span class="sr">/    at .*inner1.* \(koru\/stacktrace-test.js:\d+:\d+\)/</span>),
    <span class="nx">m</span>(<span class="sr">/    at .*((Test\.)?test normalize|anonymous).* \(koru\/stacktrace-test.js:\d+:\d+\)/</span>),
  ]);

  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err</span>), <span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err</span>));
}</div></div></pre></div></section><section id="koru/stacktrace.replaceStack" tabindex="-1" name="replaceStack" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stacktrace.<span class="highlight"><span class="nf">replaceStack</span>(<span class="nv">error</span>, <span class="nv">replacementError</span>)</span></h1><abstract><div><p>Replace the <a class="jsdoc-link" href="#koru/stacktrace.normalize">normalized</a> stack frame.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>error</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" target="_blank">Error</a></td><td class="jsdoc-info"><div><p>the Error who's frame is to be replaced.</p>
</div></td></tr><tr class="jsdoc-arg"><td>replacementError</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" target="_blank">Error</a></td><td class="jsdoc-info"><div><p>the Error with the normalized stack frame to use.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stacktrace</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/stacktrace"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">inner1</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner2</span>()};
<span class="kd">const</span> <span class="no">inner2</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner3</span>()};
<span class="kd">const</span> <span class="no">inner3</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="kd">const</span> <span class="no">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Error</span>(<span class="s">'I failed'</span>);

  <span class="kd">const</span> <span class="no">err2</span> <span class="o">=</span> (() <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Error</span>(<span class="s">'I use another stack'</span>))();
  <span class="nx">Stacktrace</span>.<span class="na">replaceStack</span>(<span class="nx">err2</span>, <span class="nx">err</span>);
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err2</span>), <span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err</span>));
};
<span class="nx">inner1</span>();</div></div></pre></div></section></div></div></div></section><section id="koru/symbols" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/symbols">koru/symbols</a><h1 class="jsdoc-module-title searchable">Symbols</h1><abstract><div><p>Well known koru symbols.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">ctx$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>The <a class="jsdoc-link" href="#koru/dom/ctx">Ctx</a> of a HTML element</p>
</div></td></tr><tr><td class="searchable">endMarker$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>Associate a start with an end; used with HTML elements</p>
</div></td></tr><tr><td class="searchable">error$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>Used to hold errors on a <a href="#koru/model/base-model">model</a></p>
</div></td></tr><tr><td class="searchable">inspect$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>Override the <a class="jsdoc-link" href="#koru/util.inspect">util.inspect</a> value displayed</p>
</div></td></tr><tr><td class="searchable">original$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>store the original value on a <a href="#koru/changes">change</a></p>
</div></td></tr><tr><td class="searchable">private$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>Private values associated with an object</p>
</div></td></tr><tr><td class="searchable">stopGap$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>A interim value for an object; used with model</p>
</div></td></tr><tr><td class="searchable">stubName$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>Used to name stubbed functions in API documentation</p>
</div></td></tr><tr><td class="searchable">withId$</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info" data-env="both"><div><p>Used to associate and id with an object. See <a class="jsdoc-link" href="#koru/util.withId">util.withId</a></p>
</div></td></tr></tbody></table></div><div></div></div></section><section id="koru/test/api" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/api">koru/test/api</a><h1 class="jsdoc-module-title searchable">API</h1><abstract><div><p>API is a semi-automatic API document generator. It uses
unit-tests to determine types and values at test time.</p>
<p>Method document comments need to be inside the test method; not in the production code and not
outside the test method.</p>
<p>Examples can be verbatim from the test method by surrounding the example between <code>//[</code> and
<code>//]</code> comments. The special comment <code>//[no-more-examples]</code> will discard any further examples in
this scope (useful with <a class="jsdoc-link" href="#koru/test/test-case">group tests</a> and <a class="jsdoc-link" href="#koru/test/api.topic">topics</a>).</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test/api.class" tabindex="-1" name="class" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">class</span>(<span class="nv">options</span>)</span></h1><abstract><div><p>Document <code>constructor</code> for the current subject.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[options.sig]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>override the call signature. Sig is used as the subject if it
is a function.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.intro]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the abstract for the method being
documented. Defaults to test comment.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a ProxyClass which is to be used instead of <code>Class</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">Book</span> <span class="o">=</span> <span class="nx">API</span>.<span class="na">class</span>();

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>(<span class="s">'There and back again'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">title</span>, <span class="s">'There and back again'</span>);</div></div></pre></div></section><section id="koru/test/api.comment" tabindex="-1" name="comment" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">comment</span>(<span class="nv">comment</span>)</span></h1><abstract><div><p>Add a comment before the next example</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>comment</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Excercise</span> {
  <span class="kt">static</span> <span class="nf">register</span>(<span class="nv">name</span>, <span class="nv">minutes</span>) {}
  <span class="nf">begin</span>() {}
}

<span class="nx">API</span>.<span class="na">module</span>({<span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod'</span>, <span class="na">exports</span>: <span class="nx">Excercise</span>}});
<span class="nx">API</span>.<span class="na">method</span>(<span class="s">'register'</span>);

<span class="nx">API</span>.<span class="na">comment</span>(<span class="s">'Optionally set the default duration'</span>);
<span class="nx">Excercise</span>.<span class="na">register</span>(<span class="s">'Jogging'</span>, <span class="m">5</span>); <span class="cs">// This call gets the comment</span>
<span class="nx">Excercise</span>.<span class="na">register</span>(<span class="s">'Skipping'</span>); <span class="cs">// This call get no comment</span></div></div></pre></div></section><section id="koru/test/api.custom" tabindex="-1" name="custom" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">custom</span>(<span class="nv">func</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Document a custom function in the current module</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>func</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the function to document</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.name]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>override the name of func</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.sig]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>replace of prefix the function signature. If it ends with a ".", "#"
or a ":" then it will prefix otherwise it will replace.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.intro]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the abstract for the method being documented. Defaults to
test comment.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a ProxyClass which is to be used instead of <code>func</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">function</span> <span class="nf">myCustomFunction</span>(<span class="nv">arg</span>) {
  <span class="k">this</span>.<span class="na">ans</span> <span class="o">=</span> <span class="nx">arg</span>;
  <span class="k">return</span> <span class="s">'success'</span>;
}
      
<span class="kd">const</span> <span class="no">thisValue</span> <span class="o">=</span> {};

<span class="kd">let</span> <span class="nv">proxy</span> <span class="o">=</span> <span class="nx">API</span>.<span class="na">custom</span>(<span class="nx">myCustomFunction</span>);

<span class="nx">proxy</span>.<span class="na">call</span>(<span class="nx">thisValue</span>, <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">thisValue</span>.<span class="na">ans</span>, <span class="m">2</span>);
      
<span class="nx">proxy</span> <span class="o">=</span> <span class="nx">API</span>.<span class="na">custom</span>(<span class="nx">myCustomFunction</span>, {<span class="na">name</span>: <span class="s">'example2'</span>, <span class="na">sig</span>: <span class="s">'foobar = function example2(arg)'</span>});

<span class="nx">proxy</span>.<span class="na">call</span>(<span class="nx">thisValue</span>, <span class="m">4</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">thisValue</span>.<span class="na">ans</span>, <span class="m">4</span>);
      
<span class="nx">proxy</span> <span class="o">=</span> <span class="nx">API</span>.<span class="na">custom</span>(<span class="nx">myCustomFunction</span>, {<span class="na">name</span>: <span class="s">'example3'</span>});
<span class="nx">proxy</span>.<span class="na">call</span>(<span class="nx">thisValue</span>, <span class="m">4</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">API</span>.<span class="na">instance</span>.<span class="na">customMethods</span>.<span class="na">example3</span>.<span class="na">sig</span>, <span class="s">'example3(arg)'</span>);

<span class="nx">proxy</span> <span class="o">=</span> <span class="nx">API</span>.<span class="na">custom</span>(<span class="nx">myCustomFunction</span>, {<span class="na">name</span>: <span class="s">'example4'</span>, <span class="na">sig</span>: <span class="s">'Container#'</span>});
<span class="nx">proxy</span>.<span class="na">call</span>(<span class="nx">thisValue</span>, <span class="m">4</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">API</span>.<span class="na">instance</span>.<span class="na">customMethods</span>.<span class="na">example4</span>.<span class="na">sigPrefix</span>, <span class="s">'Container#'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">API</span>.<span class="na">instance</span>.<span class="na">customMethods</span>.<span class="na">example4</span>.<span class="na">sig</span>, <span class="s">'example4(arg)'</span>);

<span class="nx">proxy</span> <span class="o">=</span> <span class="nx">API</span>.<span class="na">custom</span>(<span class="nx">myCustomFunction</span>, {<span class="na">name</span>: <span class="s">'example5'</span>, <span class="na">sig</span>: <span class="s">'Container.'</span>});
<span class="nx">proxy</span>.<span class="na">call</span>(<span class="nx">thisValue</span>, <span class="m">4</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">API</span>.<span class="na">instance</span>.<span class="na">customMethods</span>.<span class="na">example5</span>.<span class="na">sigPrefix</span>, <span class="s">'Container.'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">API</span>.<span class="na">instance</span>.<span class="na">customMethods</span>.<span class="na">example5</span>.<span class="na">sig</span>, <span class="s">'example5(arg)'</span>);

<span class="nx">proxy</span> <span class="o">=</span> <span class="nx">API</span>.<span class="na">custom</span>(<span class="nx">myCustomFunction</span>, {<span class="na">name</span>: <span class="s">'example6'</span>, <span class="na">sig</span>: <span class="s">'Container.foo()'</span>});
<span class="nx">proxy</span>.<span class="na">call</span>(<span class="nx">thisValue</span>, <span class="m">4</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">API</span>.<span class="na">instance</span>.<span class="na">customMethods</span>.<span class="na">example6</span>.<span class="na">sigPrefix</span>, <span class="s">'Container.'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">API</span>.<span class="na">instance</span>.<span class="na">customMethods</span>.<span class="na">example6</span>.<span class="na">sig</span>, <span class="s">'foo()'</span>);</div></div></pre></div></section><section id="koru/test/api.customIntercept" tabindex="-1" name="customIntercept" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">customIntercept</span>(<span class="nv">object</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Intercept a function and document it like <a class="jsdoc-link" href="#koru/test/api.custom">custom</a>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the container of the function to document</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.name]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of function to intercept defaults to test name</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.sig]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>replace of prefix the function signature. If it ends with a ".", "#"
or a ":" then it will prefix otherwise it will replace.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.intro]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the abstract for the method being
documented. Defaults to test comment.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the original function</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Book</span> {
  <span class="nf">print</span>(<span class="nv">copies</span>) {
    <span class="k">return</span> <span class="nx">printer</span>.<span class="na">print</span>(<span class="k">this</span>, <span class="nx">copies</span>);
  }
}
<span class="nx">API</span>.<span class="na">module</span>({<span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod'</span>, <span class="na">exports</span>: {}}});
<span class="kd">const</span> <span class="no">thisValue</span> <span class="o">=</span> {};

<span class="kd">let</span> <span class="nv">orig</span> <span class="o">=</span> <span class="nx">API</span>.<span class="na">customIntercept</span>(<span class="nx">Book</span>.<span class="na">prototype</span>, {<span class="na">name</span>: <span class="s">'print'</span>, <span class="na">sig</span>: <span class="s">'Book#'</span>});

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="s">'success'</span>, <span class="nx">book</span>.<span class="na">print</span>(<span class="m">2</span>));</div></div></pre></div></section><section id="koru/test/api.example" tabindex="-1" name="example" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">example</span>(<span class="nv">body</span>)</span></h1><abstract><div><p>Run a section of as an example of a method call.</p>
<p>Use <code>API.exampleCont(body)</code> to continue an example.</p>
<p></p><p>Alternately the special comments <code>//[</code>, <code>//[#</code> and <code>//]</code> can be used instead. <code>//[</code> records
a new example, <code>//[#</code> continues an example and <code>//]</code> stops recording.</p>
<p></p><pre class="jsdoc-example highlight"><div class="highlight"><span class="cs">//[</span>
<span class="kd">let</span> <span class="nv">Iam</span> <span class="o">=</span> <span class="s">'example one'</span>;
<span class="cs">//]</span>
<span class="nx">Iam</span> <span class="o">=</span> <span class="s">'outside an example'</span>;
<span class="cs">//[#</span>
<span class="nx">Iam</span> <span class="o">=</span> <span class="s">'continuing example one'</span>;
<span class="cs">//]</span>

<span class="cs">//[</span>
<span class="nx">Iam</span> <span class="o">=</span> <span class="s">'example two'</span>;
<span class="cs">//]</span></div></pre><p></p>
<p></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>body</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Glossary/Primitive" target="_blank">primitive</a></td><td class="jsdoc-info"><div><p>the result of running body</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Color</span> {
  <span class="kt">static</span> <span class="nf">define</span>(<span class="nv">name</span>, <span class="nv">value</span>) {
    <span class="k">return</span> <span class="k">this</span>.<span class="na">colors</span>[<span class="na">name</span>] <span class="o">=</span> <span class="nx">value</span>;
  }
  <span class="cs">// ...</span>
}
<span class="nx">Color</span>.<span class="na">colors</span> <span class="o">=</span> {};

<span class="nx">API</span>.<span class="na">module</span>({<span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod'</span>, <span class="na">exports</span>: <span class="nx">Color</span>}});
<span class="nx">API</span>.<span class="na">method</span>(<span class="s">'define'</span>);

<span class="nx">API</span>.<span class="na">example</span>(<span class="s">'const foo = "can put any valid code here";'</span>);
<span class="nx">API</span>.<span class="na">example</span>(() <span class="o">=&gt;</span> {
  <span class="cs">// this body of code is executed</span>
  <span class="nx">Color</span>.<span class="na">define</span>(<span class="s">'red'</span>, <span class="s">'#f00'</span>);
  <span class="nx">Color</span>.<span class="na">define</span>(<span class="s">'blue'</span>, <span class="s">'#00f'</span>);
});
<span class="nx">API</span>.<span class="na">exampleCont</span>(<span class="s">'// comment\n'</span>);
<span class="nx">API</span>.<span class="na">exampleCont</span>(() <span class="o">=&gt;</span> {<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Color</span>.<span class="na">colors</span>.<span class="na">red</span>, <span class="s">'#f00'</span>)});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">API</span>.<span class="na">example</span>(() <span class="o">=&gt;</span> {<span class="k">return</span> <span class="nx">Color</span>.<span class="na">define</span>(<span class="s">'green'</span>, <span class="s">'#0f0'</span>)}), <span class="s">'#0f0'</span>);</div></div></pre></div></section><section id="koru/test/api.innerSubject" tabindex="-1" name="innerSubject" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">innerSubject</span>(<span class="nv">subject</span>, <span class="nv">subjectName</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Document a subject within a module.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>subject</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>either the actual subject or the property name
of the subject if accessible from the current subject</p>
</div></td></tr><tr class="jsdoc-arg"><td>[subjectName]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div><p>override the subject name</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.info]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>property info line (if subject is a <code>string</code>). Alias 'intro'</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.abstract]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>introduction to the subject. If abstract is a <code>function</code> then the
initial doc comment is used.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.initExample]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>code that can be used to initialize <code>subject</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.initInstExample]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>code that can be used to initialize an instance of
<code>subject</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/api">API</a></td><td class="jsdoc-info"><div><p>an API instance for the given <code>subject</code>. Subsequent
API calls should be made directly on this API instance and
<strong>not</strong> the API Class itself</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Book</span> {
  <span class="k">constructor</span>() {<span class="k">this</span>.<span class="na">_chapters</span> <span class="o">=</span> []}
  <span class="nf">newChapter</span>() {
    <span class="kd">const</span> <span class="no">chapter</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span>.<span class="na">constructor</span>
      .<span class="na">Chapter</span>(<span class="m">10</span>);
    <span class="k">this</span>.<span class="na">_chapters</span>.<span class="na">push</span>(<span class="nx">chapter</span>);
    <span class="k">return</span> <span class="nx">chapter</span>;
  }
}
<span class="nx">Book</span>.<span class="na">Chapter</span> <span class="o">=</span> <span class="k">class</span> {
  <span class="k">constructor</span>(<span class="nv">startPage</span>) {<span class="k">this</span>.<span class="na">page</span> <span class="o">=</span> <span class="nx">startPage</span>}
  <span class="nf">goto</span>() {<span class="k">return</span> <span class="k">this</span>.<span class="na">page</span>}
};

<span class="nx">API</span>.<span class="na">module</span>({
  <span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod1'</span>, <span class="na">exports</span>: <span class="nx">Book</span>},
  <span class="na">subjectName</span>: <span class="s">'myHelper'</span>});
<span class="nx">API</span>.<span class="na">innerSubject</span>(<span class="s">'Chapter'</span>, <span class="kc">null</span>, {
  <span class="na">info</span>: <span class="s">'Chapter info'</span>,
})
  .<span class="na">protoMethod</span>(<span class="s">'goto'</span>);

<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>();
<span class="kd">const</span> <span class="no">chapter</span> <span class="o">=</span> <span class="nx">book</span>.<span class="na">newChapter</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">chapter</span>.<span class="na">goto</span>(), <span class="m">10</span>);</div></div></pre></div></section><section id="koru/test/api.method" tabindex="-1" name="method" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">method</span>(<span class="nv">methodName</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Document <code>methodName</code> for the current subject</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>methodName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[options]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">API</span>.<span class="na">method</span>(<span class="s">"fnord"</span>);</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">API</span>.<span class="na">method</span>(<span class="s">"foo"</span>, <span class="ge nx">{subject: {foo(){}}, intro: "intro"}</span>);</div><div></div></div></pre></div></section><section id="koru/test/api.module" tabindex="-1" name="module" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">module</span>({<span class="nv">subjectModule</span>, <span class="nv">subjectName</span>, <span class="nv">pseudoModule</span>, <span class="nv">initExample</span>, <span class="nv">initInstExample</span>}<span class="o">=</span>{})</span></h1><abstract><div><p>Initiate documentation of the module. Subsequent calls to API
methods will act of the given <code>module</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[subjectModule]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>defaults to the module corresponding
to the current test module.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[subjectName]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>defaults to a hopefully reasonable name</p>
</div></td></tr><tr class="jsdoc-arg"><td>[pseudoModule]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[initExample]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>code that can be used to initialize <code>subject</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>[initInstExample]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>code that can be used to initialize an instance of
<code>subject</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/api">API</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">API</span>.<span class="na">module</span>();</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">API(API)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">API</span>.<span class="na">module</span>(<span class="ge nx">{subjectModule: {exports: {clean(){}}, id: 'myMod1'}, subjectName: "myHelper", initExample: "Init example", initInstExample: "Init inst example"}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">API(myHelper)</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">API</span>.<span class="na">module</span>(<span class="ge nx">{subjectModule: {exports: function Book(){}, id: 'myMod2'}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">API(Book)</span></span></div></pre></div></section><section id="koru/test/api.property" tabindex="-1" name="property" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">property</span>(<span class="nv">name</span>, <span class="nv">options</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[options]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#"></a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">defaults</span> <span class="o">=</span> {
  <span class="nf">logger</span>() {},
  <span class="na">width</span>: <span class="m">800</span>,
  <span class="na">height</span>: <span class="m">600</span>,
  <span class="na">theme</span>: {
    <span class="na">name</span>: <span class="s">'light'</span>,
    <span class="na">primaryColor</span>: <span class="s">'#aaf'</span>,
  },
};
<span class="kd">let</span> <span class="nv">name</span>, <span class="nv">logger</span>;

<span class="nx">API</span>.<span class="na">module</span>({<span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod'</span>, <span class="na">exports</span>: <span class="nx">defaults</span>}, <span class="na">subjectName</span>: <span class="s">'defaults'</span>});
<span class="nx">API</span>.<span class="na">property</span>(<span class="s">'theme'</span>, {
  <span class="na">info</span>: <span class="s">'The default theme'</span>,
  <span class="na">properties</span>: {
    <span class="na">name</span>: (<span class="nv">value</span>) <span class="o">=&gt;</span> {
      <span class="nx">name</span> <span class="o">=</span> <span class="nx">value</span>;
      <span class="k">return</span> <span class="s">'The theme name is ${value}'</span>;
    },
    <span class="na">primaryColor</span>: <span class="s">'The primary color is ${value}'</span>,
  },
});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">name</span>, <span class="s">'light'</span>);

<span class="nx">API</span>.<span class="na">property</span>(<span class="s">'logger'</span>, (<span class="nv">value</span>) <span class="o">=&gt;</span> {
  <span class="nx">logger</span> <span class="o">=</span> <span class="nx">value</span>;
  <span class="k">return</span> <span class="s">'The default logger is ${value}'</span>;
});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">logger</span>, <span class="nx">defaults</span>.<span class="na">logger</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">test</span>({<span class="s">'pageCount'</span>() {
  <span class="cm">/**
   * The number of pages in the book
   **/</span>
  <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> {<span class="na">pageCount</span>: <span class="m">400</span>};
  <span class="nx">API</span>.<span class="na">module</span>({
    <span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod'</span>, <span class="na">exports</span>: <span class="nx">book</span>},
    <span class="na">subjectName</span>: <span class="s">'Book'</span>});
  <span class="nx">API</span>.<span class="na">property</span>(<span class="s">'pageCount'</span>); <span class="cs">// extracts the comment above</span>
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">book</span>.<span class="na">pageCount</span>, <span class="m">400</span>);
}});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> {
  <span class="k">get</span> <span class="nf">title</span>() {<span class="k">return</span> <span class="k">this</span>.<span class="na">_title</span>},
  <span class="k">set</span> <span class="nf">title</span>(<span class="nv">value</span>) {<span class="k">this</span>.<span class="na">_title</span> <span class="o">=</span> <span class="nx">value</span>},
};

<span class="nx">API</span>.<span class="na">module</span>({
  <span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod'</span>, <span class="na">exports</span>: <span class="nx">book</span>},
  <span class="na">subjectName</span>: <span class="s">'Book'</span>});
<span class="nx">API</span>.<span class="na">property</span>(<span class="s">'title'</span>, {
  <span class="na">info</span>: <span class="s">'Get/set the book title'</span>,
});
<span class="nx">API</span>.<span class="na">comment</span>(<span class="s">'sets title'</span>);
<span class="nx">book</span>.<span class="na">title</span> <span class="o">=</span> <span class="s">'Room'</span>;
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">_title</span>, <span class="s">'Room'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">title</span>, <span class="nx">book</span>.<span class="na">_title</span>);</div></div></pre></div></section><section id="koru/test/api.protoMethod" tabindex="-1" name="protoMethod" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">protoMethod</span>(<span class="nv">methodName</span>, <span class="nv">options</span>)</span></h1><abstract><div><p>Document prototype <code>methodName</code> for the current subject</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[methodName]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the prototype method to
document</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.subject]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>override the instance to document. This
defaults to <code>module.exports.prototype</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.intro]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the abstract for the method being
documented. Defaults to test comment.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Tree</span> {
  <span class="k">constructor</span>(<span class="nv">name</span>) {
    <span class="k">this</span>.<span class="na">name</span> <span class="o">=</span> <span class="nx">name</span>;
    <span class="k">this</span>.<span class="na">branches</span> <span class="o">=</span> <span class="m">10</span>;
  }

  <span class="nf">prune</span>(<span class="nv">branchCount</span>) {
    <span class="k">return</span> <span class="k">this</span>.<span class="na">branches</span> <span class="o">-=</span> <span class="nx">branchCount</span>;
  }

  <span class="k">async</span> <span class="nf">graft</span>(<span class="nv">branchCount</span>) {
    <span class="k">return</span> <span class="k">this</span>.<span class="na">branches</span> <span class="o">+=</span> <span class="nx">branchCount</span>;
  }
}

<span class="nx">API</span>.<span class="na">module</span>({<span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod'</span>, <span class="na">exports</span>: <span class="nx">Tree</span>}});
<span class="nx">API</span>.<span class="na">protoMethod</span>(<span class="s">'prune'</span>);

<span class="kd">const</span> <span class="no">plum</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tree</span>(<span class="s">'Plum'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">plum</span>.<span class="na">prune</span>(<span class="m">3</span>), <span class="m">7</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">plum</span>.<span class="na">prune</span>(<span class="m">2</span>), <span class="m">5</span>);

<span class="cm">/** Overriding subject.prototype **/</span>
<span class="kd">const</span> <span class="no">subject</span> <span class="o">=</span> {<span class="nf">anything</span>() {<span class="k">return</span> <span class="s">'I could be anything'</span>}};
<span class="nx">API</span>.<span class="na">protoMethod</span>(<span class="s">'anything'</span>, {<span class="na">subject</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">subject</span>.<span class="na">anything</span>(), <span class="s">'I could be anything'</span>);</div></div></pre></div></section><section id="koru/test/api.protoProperty" tabindex="-1" name="protoProperty" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">protoProperty</span>(<span class="nv">name</span>, <span class="nv">options</span>, <span class="nv">subject</span>)</span></h1><abstract><div><p>Document a property of the current subject's prototype. The
property can be either plain value or a get/set function.</p>
<p>See <a class="jsdoc-link" href="#koru/test/api.property">property</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the property to document</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>see <a class="jsdoc-link" href="#koru/test/api.property">property</a></p>
</div></td></tr><tr class="jsdoc-arg"><td>[subject]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>defaults to subject.prototype</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">class</span> <span class="nc">Book</span> {
  <span class="k">constructor</span>(<span class="nv">title</span>) {
    <span class="k">this</span>.<span class="na">_title</span> <span class="o">=</span> <span class="nx">title</span>;
  }

  get <span class="nf">title</span>() {<span class="k">return</span> <span class="k">this</span>.<span class="na">_title</span>}
}

<span class="nx">API</span>.<span class="na">module</span>({<span class="na">subjectModule</span>: {<span class="na">id</span>: <span class="s">'myMod'</span>, <span class="na">exports</span>: <span class="nx">Book</span>}});
<span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span>(<span class="s">'Jungle Book'</span>, <span class="m">504</span>);
<span class="nx">API</span>.<span class="na">protoProperty</span>(<span class="s">'title'</span>, {<span class="na">info</span>: <span class="s">'The title'</span>});
<span class="nx">book</span>.<span class="na">bookMark</span> <span class="o">=</span> <span class="m">100</span>;
<span class="nx">API</span>.<span class="na">protoProperty</span>(<span class="s">'bookMark'</span>, {<span class="na">info</span>: <span class="s">'record page'</span>}, <span class="nx">book</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">title</span>, <span class="s">'Jungle Book'</span>);</div></div></pre></div></section><section id="koru/test/api.topic" tabindex="-1" name="topic" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">API.<span class="highlight"><span class="nf">topic</span>(<span class="nv">options</span>)</span></h1><abstract><div><p>Record a test as a topic for insertion into a method test document comment using the syntax
<code>{{topic:[&lt;path&gt;:]&lt;topicName&gt;}}</code> and <code>{{example:&lt;number&gt;}}</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[options.name]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>override the name of the topic. Defaults to test name.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[options.intro]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the narrative for the topic being
documented. Defaults to test comment.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">API</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/api"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">test</span>(<span class="s">'borrow book'</span>, () <span class="o">=&gt;</span> {
  'use strict';
  <span class="cm">/**
   * In order to borrow a book it needs to be found in the library; then call the borrow
   * method on it:
   *
   * {{example:0}}
   *
   * When the book has been read it can be returned to the library:
   *
   * {{example:1}}
   **/</span>
  <span class="nx">API</span>.<span class="na">topic</span>();

  <span class="kd">let</span> <span class="nv">receipt</span>;
  <span class="cs">//[</span>
  <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Library</span>.<span class="na">findBook</span>(<span class="s">'Dune'</span>);
  <span class="k">if</span> (<span class="nx">book</span> <span class="o">!==</span> <span class="kc">undefined</span>) {
    <span class="nx">receipt</span> <span class="o">=</span> <span class="nx">book</span>.<span class="na">borrow</span>();
  }
  <span class="cs">//]</span>

  <span class="cs">//[</span>
  <span class="nx">receipt</span>.<span class="na">returnBook</span>();
  <span class="cs">//]</span>

  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">receipt</span>.<span class="na">book</span>, <span class="nx">Library</span>.<span class="na">findBook</span>(<span class="s">'Dune'</span>));
});

<span class="nx">test</span>(<span class="s">'findBook'</span>, () <span class="o">=&gt;</span> {
  <span class="cm">/**
   * After browsing the library you may want to borrow a book.
   *
   * {{topic:borrow book}} (or with path {{topic:models/library:borrow book}})
   **/</span>
  <span class="nx">API</span>.<span class="na">method</span>();
  <span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> <span class="nx">Library</span>.<span class="na">findBook</span>(<span class="s">'Dune'</span>);
  <span class="nx">assert</span>(<span class="nx">book</span>);
});</div></div></pre></div></section></div></div></div></section><section id="koru/test/core" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/core">koru/test/core</a><h1 class="jsdoc-module-title searchable">Core</h1><abstract><div><p>The heart of the test framework.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">AssertionError</td><td><a href="#koru/test/core::AssertionError">AssertionError</a></td><td class="jsdoc-info" data-env="both"><div><p>the <a class="jsdoc-link" href="#koru/test/core::AssertionError">AssertionError</a> class</p>
</div></td></tr><tr><td class="searchable">__elidePoint</td><td><a href="#koru/test/core::AssertionError">AssertionError</a></td><td class="jsdoc-info" data-env="both"><div><p>The current <code>elidePoint</code> in effect (if any) is an <code>AssertionError</code> used to replace the stack
trace of the actual error. Access can be useful to save and restore in custom assertion methods.</p>
</div></td></tr><tr><td class="searchable">match</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info" data-env="both"><div><p>A clone of the <a class="jsdoc-link" href="#koru/match">match</a> framework. This is conventionally assigned to the constant <code>m</code>
because of its widespread use.</p>
</div></td></tr><tr><td class="searchable">test</td><td><a href="#koru/test/test-case::Test">Test</a></td><td class="jsdoc-info" data-env="both"><div><p>The currently running test</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test/core.elide" tabindex="-1" name="elide" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">assert.<span class="highlight"><span class="nf">elide</span>(<span class="nv">body</span>, <span class="nv">adjust</span><span class="o">=</span><span class="m">0</span>)</span></h1><abstract><div><p>Elide stack starting from caller</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>body</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the elided body to excute</p>
</div></td></tr><tr class="jsdoc-arg"><td>[adjust]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the number of additional stack frames to elide.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Core</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/core"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">inner</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">fail</span>(<span class="s">'I failed'</span>);
};

<span class="kd">let</span> <span class="nv">ex</span>;
<span class="k">try</span> {
  (() <span class="o">=&gt;</span> {
    <span class="nx">assert</span>.<span class="na">elide</span>(() <span class="o">=&gt;</span> {
      <span class="nx">inner</span>();
    }, <span class="m">1</span>);
  })();
} <span class="k">catch</span> (<span class="nv">e</span>) {
  <span class="nx">ex</span> <span class="o">=</span> <span class="nx">e</span>;
}
<span class="nx">assert</span>.<span class="na">instanceof</span>(<span class="nx">ex</span>, <span class="nx">AssertionError</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ex</span>.<span class="na">message</span>, <span class="s">'I failed'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ex</span>.<span class="na">customStack</span>, <span class="k">new</span> <span class="nx">AssertionError</span>(<span class="s">'I failed'</span>, <span class="m">1</span>).<span class="na">customStack</span>);</div></div></pre></div></section><section id="koru/test/core.fail" tabindex="-1" name="fail" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">assert.<span class="highlight"><span class="nf">fail</span>(<span class="nv">message</span><span class="o">=</span><span class="s">'failed'</span>, <span class="nv">elidePoint</span><span class="o">=</span><span class="m">0</span>)</span></h1><abstract><div><p>throw assertionError</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[message]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the error message</p>
</div></td></tr><tr class="jsdoc-arg"><td>[elidePoint]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the number of stack frames to elide</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Core</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/core"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">ex</span>;
<span class="kd">const</span> <span class="no">inner1</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner2</span>()};
<span class="kd">const</span> <span class="no">inner2</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="k">try</span> {
    <span class="nx">assert</span>.<span class="na">fail</span>(<span class="s">'I failed'</span>, <span class="m">1</span>);
  } <span class="k">catch</span> (<span class="nv">e</span>) {
    <span class="nx">ex</span> <span class="o">=</span> <span class="nx">e</span>;
  }
};

<span class="nx">inner1</span>();

<span class="nx">assert</span>.<span class="na">instanceof</span>(<span class="nx">ex</span>, <span class="nx">AssertionError</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ex</span>.<span class="na">message</span>, <span class="s">'I failed'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">ex</span>), [
  <span class="nx">m</span>(<span class="sr">/^    at.*inner1.*core-test.js/</span>),
  <span class="nx">m</span>(<span class="sr">/^    at.*core-test.js/</span>),
]);</div></div></pre></div></section><section id="koru/test/core.assert" tabindex="-1" name="assert" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Core.<span class="highlight"><span class="nf">assert</span>(<span class="nv">truth</span>, <span class="nv">msg</span><span class="o">=</span><span class="s">'Expected truthness'</span>)</span></h1><abstract><div><p>Assert is truthy. Contains methods for more convenient assertions in <a class="jsdoc-link" href="#koru/test/core::assert">assert</a>. <code>assert</code>
is a global method.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>truth</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p><code>!! truth === true</code> otherwise an <a class="jsdoc-link" href="#koru/test/core::AssertionError">AssertionError</a> is thrown.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[msg]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>A message to display if the assertion fails</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Core</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/core"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">ex</span>;</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">try</span> {
  <span class="nx">assert</span>(<span class="m">1</span>, <span class="s">'I succeeded'</span>);
  <span class="nx">assert</span>(<span class="kc">true</span>, <span class="s">'So did I'</span>);
  <span class="nx">assert</span>(<span class="m">0</span>, <span class="s">'I failed'</span>);
} <span class="k">catch</span> (<span class="nv">e</span>) {
  <span class="nx">ex</span> <span class="o">=</span> <span class="nx">e</span>;
}</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">instanceof</span>(<span class="nx">ex</span>, <span class="nx">AssertionError</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ex</span>.<span class="na">message</span>, <span class="s">'I failed'</span>);</div></div></pre></div></section><section id="koru/test/core.deepEqual" tabindex="-1" name="deepEqual" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Core.<span class="highlight"><span class="nf">deepEqual</span>(<span class="nv">actual</span>, <span class="nv">expected</span>, <span class="nv">hint</span>, <span class="nv">hintField</span>, <span class="nv">maxLevel</span><span class="o">=</span><span class="nx">util</span>.<span class="na">MAXLEVEL</span>)</span></h1><abstract><div><p>Like <a class="jsdoc-link" href="#koru/util.deepEqual">util.deepEqual</a> except allows a hint to show where values don't match.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>actual</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>expected</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[hint]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[hintField]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[maxLevel]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Core</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/core"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="kc">null</span>, <span class="kc">null</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="kc">null</span>, <span class="ge nx">undefined</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="kc">null</span>, <span class="s">""</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">{}</span>, <span class="ge nx">{}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="m">0</span>, <span class="m">0</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">{a: 0}</span>, <span class="ge nx">{a: 0}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">{a: null}</span>, <span class="ge nx">{b: null}</span>, <span class="ge nx">{}</span>, <span class="s">"keyCheck"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">[1, 2, null]</span>, <span class="ge nx">[1, match((v) =&gt; v % 2 === 0), match.any]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">[1, 1]</span>, <span class="ge nx">[1, match((v) =&gt; v % 2 === 0)]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">[2, 2]</span>, <span class="ge nx">[1, match((v) =&gt; v % 2 === 0)]</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">{a: 1, b: {c: 1, d: [1, {e: [false]}]}}</span>, <span class="ge nx">{a: 1, b: {c: 1, d: [1, {e: [false]}]}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">true</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">{a: 1, b: {c: 1, d: [1, {e: [false]}]}}</span>, <span class="ge nx">{a: 1, b: {c: 1, d: [1, {e: [true]}]}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">{a: 1, b: {c: 0, d: [1, {e: [false]}]}}</span>, <span class="ge nx">{a: 1, b: {c: 0, d: [1, {e: [false]}]}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">{a: 1, b: {c: 1, d: [1, {e: [false]}]}}</span>, <span class="ge nx">{a: 1, b: {c: 1, d: [1, {e: [false], f: undefined}]}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">Core</span>.<span class="na">deepEqual</span>(<span class="ge nx">{a: 1}</span>, <span class="ge nx">{a: "1"}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">false</span></span></div></pre></div></section><section id="koru/test/core.refute" tabindex="-1" name="refute" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Core.<span class="highlight"><span class="nf">refute</span>(<span class="nv">truth</span>, <span class="nv">msg</span>)</span></h1><abstract><div><p>Assert is falsy. Contains methods for more convenient assertions in <a class="jsdoc-link" href="#koru/test/core::assert">assert</a>. <code>refute</code>
is a global method.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>truth</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p><code>!! truth === false</code> otherwise an <a class="jsdoc-link" href="#koru/test/core::AssertionError">AssertionError</a> is thrown.</p>
</div></td></tr><tr class="jsdoc-arg"><td>msg</td><td></td><td class="jsdoc-info"><div><p>A message to display if the assertion fails</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Core</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/core"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">ex</span>;</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="k">try</span> {
  <span class="nx">refute</span>(<span class="m">0</span>, <span class="s">'I succeeded'</span>);
  <span class="nx">refute</span>(<span class="kc">false</span>, <span class="s">'So did I'</span>);
  <span class="nx">refute</span>(<span class="kc">true</span>, <span class="s">'I failed'</span>);
} <span class="k">catch</span> (<span class="nv">e</span>) {
  <span class="nx">ex</span> <span class="o">=</span> <span class="nx">e</span>;
}</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">instanceof</span>(<span class="nx">ex</span>, <span class="nx">AssertionError</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ex</span>.<span class="na">message</span>, <span class="s">'I failed'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/test/core::AssertionError" data-env="both" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/core::AssertionError">koru/test/core::AssertionError</a><h1 class="jsdoc-module-title searchable">AssertionError</h1><abstract><div><p>An error thrown by an assertion methods.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#customStack</td><td></td><td class="jsdoc-info" data-env="both"><div><p>The normalized stack trace with the elided frames and message</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test/core::AssertionError.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">message</span>, <span class="nv">elidePoint</span><span class="o">=</span><span class="m">0</span>)</span></h1><abstract><div><p>Create an AssertionError.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>message</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the message for the error</p>
</div></td></tr><tr class="jsdoc-arg"><td>[elidePoint]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a> / <a href="#koru/test/core::AssertionError">AssertionError</a></td><td class="jsdoc-info"><div><p>if a <code>number</code> the number of stack frames to elide otherwise will show
<code>elidePoint</code>'s normalized stack instead. See <a class="jsdoc-link" href="#koru/util.extractError">util.extractError</a> and <a class="jsdoc-link" href="#koru/stacktrace">Stacktrace</a></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Core</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/core"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">inner1</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner2</span>()};
<span class="kd">const</span> <span class="no">inner2</span> <span class="o">=</span> () <span class="o">=&gt;</span> {<span class="nx">inner3</span>()};
<span class="kd">const</span> <span class="no">inner3</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="kd">const</span> <span class="no">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AssertionError</span>(<span class="s">'I failed'</span>);
  <span class="nx">assert</span>(<span class="nx">err</span> <span class="o">instanceof</span> <span class="nx">Error</span>);
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">err</span>.<span class="na">message</span>, <span class="s">'I failed'</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err</span>), [
    <span class="nx">m</span>(<span class="sr">/    at .*inner3.* \(koru\/test\/core-test.js:\d+:\d+\)/</span>),
    <span class="nx">m</span>(<span class="sr">/    at .*inner2.* \(koru\/test\/core-test.js:\d+:\d+\)/</span>),
    <span class="nx">m</span>(<span class="sr">/    at .*inner1.* \(koru\/test\/core-test.js:\d+:\d+\)/</span>),
    <span class="nx">m</span>(<span class="sr">/    at .* \(koru\/test\/core-test.js:\d+:\d+\)/</span>),
  ]);

  <span class="kd">const</span> <span class="no">err2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AssertionError</span>(<span class="s">'I have a shortened customStack'</span>, <span class="m">2</span>);
  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err</span>).<span class="na">slice</span>(<span class="m">2</span>), <span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err2</span>));

  <span class="kd">const</span> <span class="no">err3</span> <span class="o">=</span> (() <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">AssertionError</span>(<span class="s">'I use another stack'</span>, <span class="nx">err2</span>))();
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err3</span>), <span class="nx">Stacktrace</span>.<span class="na">normalize</span>(<span class="nx">err2</span>));
};
<span class="nx">inner1</span>();</div></div></pre></div></section></div></div></div></section><section id="koru/test/mock-promise" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/mock-promise">koru/test/mock-promise</a><h1 class="jsdoc-module-title searchable">MockPromise</h1><abstract><div><p>Synchronous replacement for native promises. Delays running
promises until <a class="jsdoc-link" href="#koru/test/mock-promise._poll">_poll</a> called rather than waiting for native
event loop.</p>
<p>See <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank">Promise</a> for API</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test/mock-promise._poll" tabindex="-1" name="_poll" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">MockPromise.<span class="highlight"><span class="nf">_poll</span>()</span></h1><abstract><div><p>Synchronously run any outstanding promises.</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">MockPromise</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/mock-promise"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// How to stub a Promise</span>
<span class="nx">TH</span>.<span class="na">stubProperty</span>((<span class="nx">isServer</span> <span class="o">?</span> <span class="nx">global</span> <span class="o">:</span> <span class="nx">self</span>), <span class="s">'Promise'</span>, {<span class="na">value</span>: <span class="nx">MockPromise</span>});
<span class="kd">let</span> <span class="nv">done</span> <span class="o">=</span> <span class="kc">false</span>;
<span class="nx">Promise</span>.<span class="na">resolve</span>(<span class="kc">true</span>).<span class="na">then</span>(<span class="nv">v</span> <span class="o">=&gt;</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">v</span>);
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">done</span>);
<span class="nx">Promise</span>.<span class="na">_poll</span>();
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">done</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/test/stubber" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/stubber">koru/test/stubber</a><h1 class="jsdoc-module-title searchable">Stubber</h1><abstract><div><p>Spies and Stubs are functions which record the call arguments, the <code>this</code> value and the return
of each call made to them. They can intercept calls to Object getter, setter and function
properties.</p>
<p>Spies will just record the interaction whereas Stubs will replace the call with a custom
function.</p>
<p>A Spy is an instance of a Stub.</p>
<p>Stubs are usually called from tests using the specialized version in <a class="jsdoc-link" href="#koru/test/main">test</a>. The
test versions will auto restore after the <a class="jsdoc-link" href="#koru/test/test-case::Test">Test</a> or
<a class="jsdoc-link" href="#koru/test/test-case">TestCase</a> has completed.</p>
<pre><code class="language-js"><div class="highlight"><span class="kd">const</span> {<span class="no">stub</span>, <span class="no">spy</span>, <span class="no">intercept</span>} <span class="o">=</span> <span class="nx">TH</span>;</div>
</code></pre></div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test/stubber.intercept" tabindex="-1" name="intercept" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stubber.<span class="highlight"><span class="nf">intercept</span>(<span class="nv">object</span>, <span class="nv">prop</span>, <span class="nv">replacement</span><span class="o">=</span>() <span class="o">=&gt;</span> {}, <span class="nv">restore</span>)</span></h1><abstract><div><p>Create an intercept. An intercept is a lightweight stub. It does not record any calls.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>prop</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>replacement</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[restore]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">Book</span> <span class="o">=</span> {
  <span class="na">lastReadPage</span>: <span class="m">0</span>,
  <span class="nf">read</span>(<span class="nv">pageNo</span>) {<span class="k">this</span>.<span class="na">lastReadPage</span> <span class="o">=</span> <span class="nx">pageNo</span>},
};

<span class="nx">stubber</span>.<span class="na">intercept</span>(<span class="nx">Book</span>, <span class="s">'read'</span>, <span class="kd">function</span> (<span class="nv">n</span>) {<span class="k">this</span>.<span class="na">lastReadPage</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">-</span> <span class="m">2</span>});
<span class="nx">Book</span>.<span class="na">read</span>(<span class="m">28</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Book</span>.<span class="na">lastReadPage</span>, <span class="m">26</span>);
<span class="nx">Book</span>.<span class="na">read</span>.<span class="na">restore</span>();
<span class="nx">Book</span>.<span class="na">read</span>(<span class="m">28</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Book</span>.<span class="na">lastReadPage</span>, <span class="m">28</span>);</div></div></pre></div></section><section id="koru/test/stubber.isStubbed" tabindex="-1" name="isStubbed" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stubber.<span class="highlight"><span class="nf">isStubbed</span>(<span class="nv">func</span>)</span></h1><abstract><div><p>Determine if a function is stubbed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>func</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a> / <a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> {
  <span class="nf">read</span>() {},
};

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">stubber</span>.<span class="na">isStubbed</span>(<span class="nx">book</span>.<span class="na">read</span>));

<span class="nx">stubber</span>.<span class="na">stub</span>(<span class="nx">book</span>, <span class="s">'read'</span>);

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">stubber</span>.<span class="na">isStubbed</span>(<span class="nx">book</span>.<span class="na">read</span>));</div></div></pre></div></section><section id="koru/test/stubber.spy" tabindex="-1" name="spy" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stubber.<span class="highlight"><span class="nf">spy</span>(<span class="nv">object</span>, <span class="nv">property</span>)</span></h1><abstract><div><p>Create a spy. A spy is a <a class="jsdoc-link" href="#koru/test/stubber::Stub">Stub</a> that calls the original function.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>property</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">Book</span> <span class="o">=</span> {
  <span class="na">lastReadPage</span>: <span class="m">0</span>,
  <span class="nf">read</span>(<span class="nv">pageNo</span>) {<span class="k">this</span>.<span class="na">lastReadPage</span> <span class="o">=</span> <span class="nx">pageNo</span>},
};

<span class="kd">const</span> <span class="no">read</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">spy</span>(<span class="nx">Book</span>, <span class="s">'read'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">read</span>, <span class="nx">Book</span>.<span class="na">read</span>);

<span class="nx">Book</span>.<span class="na">read</span>(<span class="m">28</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Book</span>.<span class="na">lastReadPage</span>, <span class="m">28</span>);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">read</span>, <span class="m">28</span>);</div></div></pre></div></section><section id="koru/test/stubber.stub" tabindex="-1" name="stub" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stubber.<span class="highlight"><span class="nf">stub</span>(<span class="nv">object</span>, <span class="nv">property</span>, <span class="nv">repFunc</span>)</span></h1><abstract><div><p>Create a <a class="jsdoc-link" href="#koru/test/stubber::Stub">Stub</a>. Can stub a object function or be unattached.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[object]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[property]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[repFunc]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">standalone</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="nx">standalone</span>();
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">standalone</span>);

<span class="kd">const</span> <span class="no">privateMethod$</span> <span class="o">=</span> <span class="nx">Symbol</span>();

<span class="kd">const</span> <span class="no">Book</span> <span class="o">=</span> {
  <span class="na">lastReadPage</span>: <span class="m">0</span>,
  <span class="nf">read</span>(<span class="nv">pageNo</span>) {<span class="k">this</span>.<span class="na">lastReadPage</span> <span class="o">=</span> <span class="nx">pageNo</span>},
  [<span class="nf">privateMethod$</span>]() {},
};

<span class="kd">const</span> <span class="no">read</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>(<span class="nx">Book</span>, <span class="s">'read'</span>, (<span class="nv">n</span>) <span class="o">=&gt;</span> <span class="nx">n</span> <span class="o">*</span> <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">read</span>, <span class="nx">Book</span>.<span class="na">read</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Book</span>.<span class="na">read</span>(<span class="m">28</span>), <span class="m">56</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Book</span>.<span class="na">lastReadPage</span>, <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">read</span>, <span class="m">28</span>);

<span class="kd">const</span> <span class="no">pm</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>(<span class="nx">Book</span>, <span class="nx">privateMethod$</span>);
<span class="nx">Book</span>[<span class="na">privateMethod$</span>]();
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">pm</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/test/stubber::Stub" data-env="both" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/stubber::Stub">koru/test/stubber::Stub</a><h1 class="jsdoc-module-title searchable">Stub</h1><abstract><div><p>Stub and Spy methods.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#callCount</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><p>How many times the stub has been called</p>
</div></td></tr><tr><td class="searchable">#called</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>Has the stub been called at least once</p>
</div></td></tr><tr><td class="searchable">#calledOnce</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>Has the stub been called exactly once</p>
</div></td></tr><tr><td class="searchable">#calledThrice</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>Has the stub been called exactly 3 times</p>
</div></td></tr><tr><td class="searchable">#calledTwice</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info" data-env="both"><div><p>Has the stub been called exactly twice</p>
</div></td></tr><tr><td class="searchable">#firstCall</td><td><a href="#koru/test/stubber::Stub::Call">Call</a></td><td class="jsdoc-info" data-env="both"><div><p>The first call to the stub</p>
</div></td></tr><tr><td class="searchable">#lastCall</td><td><a href="#koru/test/stubber::Stub::Call">Call</a></td><td class="jsdoc-info" data-env="both"><div><p>The last call to the stub</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test/stubber::Stub.restore" tabindex="-1" name="restore" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">restore</span>()</span></h1><abstract><div><p>Restore the original function</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">args</span>;
<span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> {<span class="nf">foo</span>() {<span class="nx">args</span> <span class="o">=</span> <span class="s">'aStub'</span>}};
<span class="nx">stubber</span>.<span class="na">stub</span>(<span class="nx">obj</span>, <span class="s">'foo'</span>, (<span class="nv">a</span>, <span class="nv">b</span>, <span class="nv">c</span>) <span class="o">=&gt;</span> {<span class="nx">args</span> <span class="o">=</span> [<span class="nx">a</span>, <span class="nx">b</span>, <span class="nx">c</span>]});</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">obj</span>.<span class="na">foo</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">args</span>, [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>]);

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">obj</span>.<span class="na">foo</span>, <span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);

<span class="nx">obj</span>.<span class="na">foo</span>.<span class="na">restore</span>();
<span class="nx">obj</span>.<span class="na">foo</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">args</span>, <span class="s">'aStub'</span>);</div></div></pre></div></section><section id="koru/test/stubber::Stub#calledAfter" tabindex="-1" name="#calledAfter" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">calledAfter</span>(<span class="nv">before</span>)</span></h1><abstract><div><p>Test this stub is called after <code>before</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>before</td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>a stub to test against</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="cs">//[</span>
<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">aStub</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>);
<span class="cs">//]</span></div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">stub2</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="nx">stub2</span>();
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">stub2</span>.<span class="na">calledAfter</span>(<span class="nx">aStub</span>));</div></div></pre></div></section><section id="koru/test/stubber::Stub#calledBefore" tabindex="-1" name="#calledBefore" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">calledBefore</span>(<span class="nv">after</span>)</span></h1><abstract><div><p>Test this stub is called before <code>after</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>after</td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>a stub to test against</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="cs">//[</span>
<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">aStub</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>);
<span class="cs">//]</span></div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">stub2</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="nx">stub2</span>();
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">aStub</span>.<span class="na">calledBefore</span>(<span class="nx">stub2</span>));</div></div></pre></div></section><section id="koru/test/stubber::Stub#calledWith" tabindex="-1" name="#calledWith" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">calledWith</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Was the stub called with the given <code>args</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the args to test were passed; extra args in the call will be ignored.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p>true when the stub was called with <code>args</code>.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="cs">//[</span>
<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">aStub</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>);
<span class="cs">//]</span></div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();

<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">aStub</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>);

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">aStub</span>.<span class="na">calledWith</span>(<span class="m">1</span>, <span class="m">2</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">aStub</span>.<span class="na">calledWith</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">aStub</span>.<span class="na">calledWith</span>(<span class="m">4</span>));

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">aStub</span>.<span class="na">calledWith</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">aStub</span>.<span class="na">calledWith</span>(<span class="m">5</span>));</div></div></pre></div></section><section id="koru/test/stubber::Stub#calledWithExactly" tabindex="-1" name="#calledWithExactly" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">calledWithExactly</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Was the stub called with the given <code>args</code> and no extra args.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the args to test were passed.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="cs">//[</span>
<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">aStub</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>);
<span class="cs">//]</span></div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();

<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">aStub</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>);

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">aStub</span>.<span class="na">calledWithExactly</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">aStub</span>.<span class="na">calledWithExactly</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>));

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">aStub</span>.<span class="na">calledWithExactly</span>(<span class="m">1</span>, <span class="m">2</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">aStub</span>.<span class="na">calledWithExactly</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">aStub</span>.<span class="na">calledWithExactly</span>(<span class="m">4</span>, <span class="m">5</span>));</div></div></pre></div></section><section id="koru/test/stubber::Stub#cancelYields" tabindex="-1" name="#cancelYields" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">cancelYields</span>()</span></h1><abstract><div><p>remove automatic yield</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>the stub</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="nx">aStub</span>.<span class="na">yields</span>(<span class="m">1</span>);

<span class="nx">aStub</span>.<span class="na">cancelYields</span>();

<span class="kd">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="m">0</span>;
<span class="nx">aStub</span>(() <span class="o">=&gt;</span> {<span class="nx">result</span> <span class="o">=</span> <span class="m">1</span>});

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">result</span>, <span class="m">0</span>);</div></div></pre></div></section><section id="koru/test/stubber::Stub#getCall" tabindex="-1" name="#getCall" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">getCall</span>(<span class="nv">index</span>)</span></h1><abstract><div><p>Get the details of a particular call to stub.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>index</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the nth call to stub; 0 is first call.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub::Call">Call</a></td><td class="jsdoc-info"><div><p>the call object.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="cs">//[</span>
<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">aStub</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>);
<span class="cs">//]</span></div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">aStub</span>.<span class="na">getCall</span>(<span class="m">1</span>).<span class="na">args</span>, [<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>]);</div></div></pre></div></section><section id="koru/test/stubber::Stub#invokes" tabindex="-1" name="#invokes" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">invokes</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Invoke <code>callback</code> when the stub is called. The callback's result will be returned to the
stub caller.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the function to run</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>the stub</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">function</span> <span class="nf">callback</span>(<span class="nv">call</span>) {
  <span class="k">return</span> <span class="k">this</span> <span class="o">===</span> <span class="nx">call</span> <span class="o">&amp;&amp;</span> <span class="nx">call</span>.<span class="na">args</span>[<span class="m">0</span>] <span class="o">===</span> <span class="m">1</span>;
}
<span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();

<span class="nx">aStub</span>.<span class="na">invokes</span>(<span class="nx">callback</span>);

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">aStub</span>(<span class="m">2</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">aStub</span>(<span class="m">1</span>));

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>.<span class="na">firstCall</span>.<span class="na">returnValue</span>, <span class="kc">false</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>.<span class="na">lastCall</span>.<span class="na">returnValue</span>, <span class="kc">true</span>);</div></div></pre></div></section><section id="koru/test/stubber::Stub#onCall" tabindex="-1" name="#onCall" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">onCall</span>(<span class="nv">count</span>)</span></h1><abstract><div><p>Create a refined stub for a particular call repetition.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>count</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the <code>count</code>th call to refine.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>the new stub controlling the <code>count</code>th call.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>().<span class="na">returns</span>(<span class="kc">null</span>);
<span class="kd">const</span> <span class="no">stub0</span> <span class="o">=</span> <span class="nx">aStub</span>.<span class="na">onCall</span>(<span class="m">0</span>).<span class="na">returns</span>(<span class="m">0</span>);

<span class="nx">aStub</span>.<span class="na">withArgs</span>(<span class="m">1</span>)
  .<span class="na">onCall</span>(<span class="m">0</span>).<span class="na">returns</span>(<span class="m">1</span>)
  .<span class="na">onCall</span>(<span class="m">1</span>).<span class="na">returns</span>(<span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>(), <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">4</span>), <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>(<span class="m">1</span>), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">stub0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">stub0</span>.<span class="na">subject</span>, <span class="nx">aStub</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>.<span class="na">callCount</span>, <span class="m">3</span>);

<span class="kd">const</span> <span class="no">call</span> <span class="o">=</span> <span class="nx">aStub</span>.<span class="na">getCall</span>(<span class="m">1</span>);
<span class="nx">assert</span>(<span class="nx">call</span>.<span class="na">calledWith</span>(<span class="m">1</span>, <span class="m">4</span>));</div></div></pre></div></section><section id="koru/test/stubber::Stub#removeSelected" tabindex="-1" name="#removeSelected" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">removeSelected</span>(<span class="nv">selector</span>)</span></h1><abstract><div><p>Search calls using <code>selector</code> function to select which call to remove from calls.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>selector</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the function given a <code>call</code> instance that returns true on the call to
yield. It can return true more than once in which case the last call returned true is selected.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub::Call">Call</a></td><td class="jsdoc-info"><div><p>the call that is removed.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> <span class="nx">stub</span>();

<span class="nx">obj</span>(<span class="m">1</span>);
<span class="nx">obj</span>(<span class="m">3</span>);
<span class="nx">obj</span>(<span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(
  <span class="nx">obj</span>.<span class="na">removeSelected</span>((<span class="nv">c</span>) <span class="o">=&gt;</span> <span class="nx">c</span>.<span class="na">args</span>[<span class="m">0</span>] <span class="o">==</span> <span class="m">4</span>),
  <span class="o">void</span> <span class="m">0</span>,
);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">obj</span>.<span class="na">callCount</span>, <span class="m">3</span>);

<span class="kd">const</span> <span class="no">call</span> <span class="o">=</span> <span class="nx">obj</span>.<span class="na">removeSelected</span>((<span class="nv">c</span>) <span class="o">=&gt;</span> <span class="nx">c</span>.<span class="na">args</span>[<span class="m">0</span>] <span class="o">&lt;</span> <span class="m">3</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">call</span>.<span class="na">args</span>[<span class="m">0</span>], <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">obj</span>.<span class="na">callCount</span>, <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">obj</span>.<span class="na">firstCall</span>.<span class="na">args</span>[<span class="m">0</span>], <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">obj</span>.<span class="na">lastCall</span>.<span class="na">args</span>[<span class="m">0</span>], <span class="m">3</span>);</div></div></pre></div></section><section id="koru/test/stubber::Stub#returns" tabindex="-1" name="#returns" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">returns</span>(<span class="nv">arg</span>)</span></h1><abstract><div><p>Control what value a stub returns.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>arg</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the value to return</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>the stub</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>().<span class="na">returns</span>(<span class="kc">null</span>);
<span class="nx">aStub</span>.<span class="na">returns</span>(<span class="s">'default'</span>).<span class="na">onCall</span>(<span class="m">2</span>).<span class="na">returns</span>(<span class="s">'two'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>(), <span class="s">'default'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>(), <span class="s">'default'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>(), <span class="s">'two'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">aStub</span>(), <span class="s">'default'</span>);</div></div></pre></div></section><section id="koru/test/stubber::Stub#withArgs" tabindex="-1" name="#withArgs" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">withArgs</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Create a refined stub (or spy) that relates to a particular list of call arguments. This
stub will only be invoked if the subject is called with a list of arguments that match.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>each arg is tested against the call to determine if this stub should be
used. Matchers can be used as arguments.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>the new sub-stub</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">stub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stub</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">stub</span>.<span class="na">withArgs</span>(<span class="s">"foo"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">spy</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">stub</span>.<span class="na">withArgs</span>(<span class="s">"bar"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">spy</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">stub</span>.<span class="na">withArgs</span>(<span class="ge nx">match.number</span>, <span class="ge nx">match.string</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">spy</span></span></div></pre></div></section><section id="koru/test/stubber::Stub#yield" tabindex="-1" name="#yield" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">yield</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Call the first callback of the first call to stub.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the arguments to pass to the callback.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the result from the callback.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="kd">let</span> <span class="nv">result</span>;
<span class="nx">aStub</span>((<span class="nv">arg1</span>, <span class="nv">arg2</span>) <span class="o">=&gt;</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">arg2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(
  <span class="nx">aStub</span>.<span class="na">yield</span>(<span class="m">1</span>, <span class="m">2</span>),
  <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">result</span>, <span class="m">2</span>);</div></div></pre></div></section><section id="koru/test/stubber::Stub#yieldAll" tabindex="-1" name="#yieldAll" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">yieldAll</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Like <a class="jsdoc-link" href="#koru/test/stubber::Stub#yield">yield</a> but yields for all calls to stub; not just the first.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the arguments to pass to the callback.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>the stub.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">stub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stub</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">stub</span>.<span class="na">yieldAll</span>(<span class="m">1</span>, <span class="m">2</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">stub</span></span></div></pre></div></section><section id="koru/test/stubber::Stub#yieldAndRemoveSelected" tabindex="-1" name="#yieldAndRemoveSelected" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">yieldAndRemoveSelected</span>(<span class="nv">match</span>, ...<span class="nv">args</span>)</span></h1><abstract><div><p>Like <a class="jsdoc-link" href="#koru/test/stubber::Stub#yieldAndReset">yieldAndReset</a> but search calls using <code>selector</code> function to select which call to
yield and remove from calls.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>match</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the arguments to pass to the callback.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the result from the callback.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">func1</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">func2</span> <span class="o">=</span> (...<span class="nv">args</span>) <span class="o">=&gt;</span> <span class="nx">args</span>.<span class="na">join</span>(<span class="s">','</span>);
<span class="kd">const</span> <span class="no">func3</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> <span class="nx">stub</span>();

<span class="kd">const</span> <span class="no">matches</span> <span class="o">=</span> (<span class="nv">c</span>) <span class="o">=&gt;</span> <span class="nx">c</span>.<span class="na">args</span>[<span class="m">0</span>] <span class="o">&lt;</span> <span class="m">3</span>;

<span class="nx">assert</span>.<span class="na">exception</span>(
  () <span class="o">=&gt;</span> <span class="nx">obj</span>.<span class="na">yieldAndRemoveSelected</span>(<span class="nx">matches</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>),
  {<span class="na">message</span>: <span class="s">'No matching call found'</span>},
);

<span class="nx">obj</span>(<span class="m">1</span>, <span class="nx">func1</span>);
<span class="nx">obj</span>(<span class="m">3</span>, <span class="nx">func3</span>);
<span class="nx">obj</span>(<span class="m">2</span>, <span class="nx">func2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">obj</span>.<span class="na">callCount</span>, <span class="m">3</span>);

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">obj</span>.<span class="na">yieldAndRemoveSelected</span>(<span class="nx">matches</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, <span class="s">'6,7,8'</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func1</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">func3</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">obj</span>.<span class="na">callCount</span>, <span class="m">2</span>);</div></div></pre></div></section><section id="koru/test/stubber::Stub#yieldAndReset" tabindex="-1" name="#yieldAndReset" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">yieldAndReset</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Like <a class="jsdoc-link" href="#koru/test/stubber::Stub#yield">yield</a> but also calls reset on the stub.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[args]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the arguments to pass to the callback.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the result from the callback.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> {<span class="nf">run</span>(<span class="nv">arg</span>) {}};
<span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stub</span>(<span class="nx">obj</span>, <span class="s">'run'</span>);
<span class="kd">let</span> <span class="nv">arg2</span>;
<span class="nx">obj</span>.<span class="na">run</span>((<span class="nv">a1</span>, <span class="nv">a2</span>) <span class="o">=&gt;</span> <span class="nx">arg2</span> <span class="o">=</span> <span class="nx">a2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">aStub</span>.<span class="na">yieldAndReset</span>(<span class="m">1</span>, <span class="m">2</span>), <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">arg2</span>, <span class="m">2</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">aStub</span>);
<span class="nx">obj</span>.<span class="na">run</span>((<span class="nv">_</span>) <span class="o">=&gt;</span> <span class="m">3</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">aStub</span>.<span class="na">yieldAndReset</span>(), <span class="m">3</span>);</div></div></pre></div></section><section id="koru/test/stubber::Stub#yields" tabindex="-1" name="#yields" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Stub#<span class="highlight"><span class="nf">yields</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Trigger the stub automatically to call the first callback.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>will be passed to the callback.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div><p>the stub</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();

<span class="nx">aStub</span>.<span class="na">yields</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);

<span class="kd">let</span> <span class="nv">result</span>;
<span class="nx">aStub</span>(<span class="m">1</span>, (<span class="nv">a</span>, <span class="nv">b</span>, <span class="nv">c</span>) <span class="o">=&gt;</span> <span class="nx">result</span> <span class="o">=</span> [<span class="nx">c</span>, <span class="nx">b</span>, <span class="nx">a</span>], () <span class="o">=&gt;</span> <span class="s">'not me'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">result</span>, [<span class="m">3</span>, <span class="m">2</span>, <span class="m">1</span>]);</div></div></pre></div></section></div></div></div></section><section id="koru/test/stubber::Stub::Call" data-env="both" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/stubber::Stub::Call">koru/test/stubber::Stub::Call</a><h1 class="jsdoc-module-title searchable">Call</h1><abstract><div><p>Details of a Stub call.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info" data-env="both"><div><p>the args of the call</p>
</div></td></tr><tr><td class="searchable">#globalCount</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><p>The index in the sequence of all stub
calls since the start of the program</p>
</div></td></tr><tr><td class="searchable">#thisValue</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>the <code>this</code> value of the call</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test/stubber::Stub::Call#calledWith" tabindex="-1" name="#calledWith" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Call#<span class="highlight"><span class="nf">calledWith</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Was this call called with the given <code>args</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the args to test were passed; extra args in the call will be ignored.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p>the call matches the arg list.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();

<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">aStub</span>(<span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>);

<span class="kd">const</span> {<span class="no">firstCall</span>} <span class="o">=</span> <span class="nx">aStub</span>;

<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">firstCall</span>.<span class="na">calledWith</span>(<span class="m">1</span>, <span class="m">2</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">firstCall</span>.<span class="na">calledWith</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>));

<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">firstCall</span>.<span class="na">calledWith</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">firstCall</span>.<span class="na">calledWith</span>(<span class="m">4</span>));</div></div></pre></div></section><section id="koru/test/stubber::Stub::Call#yield" tabindex="-1" name="#yield" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Call#<span class="highlight"><span class="nf">yield</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>Trigger the stub automatically to call the first callback.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>will be passed to the callback.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Stubber</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/stubber"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">aStub</span> <span class="o">=</span> <span class="nx">stubber</span>.<span class="na">stub</span>();
<span class="kd">let</span> <span class="nv">arg2</span>;

<span class="nx">aStub</span>(<span class="m">1</span>, <span class="m">2</span>, (<span class="nv">a</span>, <span class="nv">b</span>) <span class="o">=&gt;</span> <span class="nx">arg2</span> <span class="o">=</span> <span class="nx">b</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">aStub</span>.<span class="na">firstCall</span>.<span class="na">yield</span>(<span class="m">4</span>, <span class="m">5</span>), <span class="m">5</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">arg2</span>, <span class="m">5</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/test/test-case" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/test-case">koru/test/test-case</a><h1 class="jsdoc-module-title searchable">TestCase</h1><abstract><div><p>A group of tests. Most methods are for internal purposes and are not documented here.</p>
<p>See <a class="jsdoc-link" href="#koru/test-helper">TestHelper</a></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#moduleId</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info" data-env="both"><div><p>the id of the module this test-case is defined in</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test/test-case#fullName" tabindex="-1" name="#fullName" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestCase#<span class="highlight"><span class="nf">fullName</span>(<span class="nv">name</span>)</span></h1><abstract><div><p>Get the name of the test-case prefixed by the parent test-cases (if any).</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[name]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestCase</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/test-case"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">testCase</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestCase</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">testCase</span>.<span class="na">fullName</span>();</div><span class="jsdoc-returns c1"> // returns <span class="s">"koru/test/test-case sub-test-case"</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">testCase</span>.<span class="na">fullName</span>(<span class="s">"sub-test-case"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="s">"koru/test/test-case sub-test-case"</span></span></div></pre></div></section><section id="koru/test/test-case#topTestCase" tabindex="-1" name="#topTestCase" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestCase#<span class="highlight"><span class="nf">topTestCase</span>()</span></h1><abstract><div><p>Retrieve the top most <code>TestCase</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/test-case-test">test-case-test</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestCase</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test/test-case"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">testCase</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestCase</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">testCase</span>.<span class="na">topTestCase</span>();</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">koru/test/test-case-test</span></span></div></pre></div></section></div></div></div></section><section id="koru/test/test-case::Test" data-env="both" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test/test-case::Test">koru/test/test-case::Test</a><h1 class="jsdoc-module-title searchable">Test</h1><abstract><div><p>The Test facilitator responsible for running an individual test. Use
<a class="jsdoc-link" href="#koru/test-helper">TestHelper.test</a> to access it. It can also be accessed from
<code>koru._TEST_.test</code>.</p>
<p>Most methods are for internal purposes and are not documented here. But the name is
useful for debugging.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#moduleId</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info" data-env="both"><div><p>the id of the module this test is defined in</p>
</div></td></tr><tr><td class="searchable">#name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info" data-env="both"><div><p>the full name of the test</p>
</div></td></tr><tr><td class="searchable">#tc</td><td><a href="#koru/test/test-case">TestCase</a></td><td class="jsdoc-info" data-env="both"><div><p>the test-case containing this test</p>
</div></td></tr></tbody></table></div><div></div></div></section><section id="koru/test-helper" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test-helper">koru/test-helper</a><h1 class="jsdoc-module-title searchable">TestHelper</h1><abstract><div><p>The Base TestHelper for all tests.</p>
<p>The standard layout for a test file of say: <code>my-module.js</code> is called <code>my-module-test.js</code> and is
structured as follows:</p>
<pre><code class="language-js"><div class="highlight"><span class="nx">define</span>((<span class="nv">require</span>, <span class="nv">exports</span>, <span class="nv">module</span>)<span class="o">=&gt;</span>{
  'use strict';
  <span class="kd">const</span> <span class="no">TH</span> <span class="o">=</span> <span class="nx">require</span>(<span class="s">'test-helper'</span>); <span class="cs">// prefix test-helper with path to helper</span>

  <span class="kd">const</span> {<span class="no">stub</span>, <span class="no">spy</span>, <span class="no">util</span>, <span class="na">match</span>: <span class="no">m</span>} <span class="o">=</span> <span class="nx">TH</span>;

  <span class="kd">const</span> <span class="no">MyModule</span>  <span class="o">=</span> <span class="nx">require</span>(<span class="s">'./my-module'</span>);

  <span class="nx">TH</span>.<span class="na">testCase</span>(<span class="nx">module</span>, ({<span class="nv">before</span>, <span class="nv">after</span>, <span class="nv">beforeEach</span>, <span class="nv">afterEach</span>, <span class="nv">group</span>, <span class="nv">test</span>})<span class="o">=&gt;</span>{
    <span class="nx">beforeEach</span>(()<span class="o">=&gt;</span>{
    });

    <span class="nx">afterEach</span>(()<span class="o">=&gt;</span>{
    });

    <span class="nx">test</span>(<span class="s">"foo"</span>, ()<span class="o">=&gt;</span>{
      <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">MyModule</span>.<span class="na">foo</span>(), <span class="s">"bar"</span>);
    });


  });
});</div>
</code></pre><p>See the <a href="./test-guide.html">Test Guide</a> for more details about writing tests.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">match</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info" data-env="both"><div><p>A copy of the <a class="jsdoc-link" href="#koru/match">match</a> module for using with tests.
This is normally assigned to <code>m</code> because it is use so often.  The reason it is a copy is so that
the main match module can be stubbed without interfering with test asserts</p>
</div></td></tr><tr><td class="searchable">test</td><td><a href="#koru/test/test-case::Test">Test</a></td><td class="jsdoc-info" data-env="both"><div><p>The current test that is running</p>
</div></td></tr><tr><td class="searchable">util</td><td><a href="#koru/util-base">util-base</a></td><td class="jsdoc-info" data-env="both"><div><p>A convenience reference to <a class="jsdoc-link" href="#koru/util">util</a></p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test-helper.after" tabindex="-1" name="after" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestHelper.<span class="highlight"><span class="nf">after</span>(<span class="nv">callback</span>)</span></h1><abstract><div><p>Run <code>callback</code> after the test/test-case has completed.</p>
<section class="jsdoc-alias"><h1>Aliases</h1><p><code class="jsdoc-alias-term">onEnd</code> [deprecated]</p></section></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>callback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the function to run or an object with a <code>stop</code> function to run.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestHelper</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test-helper"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">Library</span> <span class="o">=</span> {
  <span class="nf">onAdd</span>() {<span class="cs">//...</span>
    <span class="k">return</span> {<span class="cs">//...</span>
      <span class="nf">stop</span>() {<span class="cs">//...</span>
      }};
  },
  <span class="nf">removeAllBooks</span>() {<span class="cs">//...</span>
  },
};
<span class="kd">const</span> <span class="no">listener</span> <span class="o">=</span> <span class="nx">Library</span>.<span class="na">onAdd</span>();
<span class="nx">TH</span>.<span class="na">after</span>(<span class="nx">listener</span>);

<span class="nx">TH</span>.<span class="na">after</span>(()<span class="o">=&gt;</span> {<span class="nx">Library</span>.<span class="na">removeAllBooks</span>()});</div></div></pre></div></section><section id="koru/test-helper.intercept" tabindex="-1" name="intercept" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestHelper.<span class="highlight"><span class="nf">intercept</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>A wrapper around <a class="jsdoc-link" href="#koru/test/stubber.intercept">Stubber.intercept</a> that automatically restores after the
test/test-case has completed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="# "> </a></td><td class="jsdoc-info"><div><p>same as for <a class="jsdoc-link" href="#koru/test/stubber.intercept">Stubber.intercept</a></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestHelper</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test-helper"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">TestHelper</span>.<span class="na">intercept</span>(<span class="ge nx">{bar: bar}</span>, <span class="s">"bar"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">replacement</span></span></div></pre></div></section><section id="koru/test-helper.spy" tabindex="-1" name="spy" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestHelper.<span class="highlight"><span class="nf">spy</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>A wrapper around <a class="jsdoc-link" href="#koru/test/stubber.spy">Stubber.spy</a> that automatically restores after the
test/test-case has completed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="# "> </a></td><td class="jsdoc-info"><div><p>same as for <a class="jsdoc-link" href="#koru/test/stubber.spy">Stubber.spy</a></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestHelper</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test-helper"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">TestHelper</span>.<span class="na">spy</span>(<span class="ge nx">{bar: bar}</span>, <span class="s">"bar"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">stub</span></span></div></pre></div></section><section id="koru/test-helper.stub" tabindex="-1" name="stub" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestHelper.<span class="highlight"><span class="nf">stub</span>(...<span class="nv">args</span>)</span></h1><abstract><div><p>A wrapper around <a class="jsdoc-link" href="#koru/test/stubber.stub">Stubber.stub</a> that automatically restores after the
test/test-case has completed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>args</td><td><a href="# "> </a></td><td class="jsdoc-info"><div><p>same as for <a class="jsdoc-link" href="#koru/test/stubber.stub">Stubber.stub</a></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/stubber::Stub">Stub</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestHelper</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test-helper"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">TestHelper</span>.<span class="na">stub</span>(<span class="ge nx">{bar: bar}</span>, <span class="s">"bar"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">stub</span></span></div></pre></div></section><section id="koru/test-helper.stubProperty" tabindex="-1" name="stubProperty" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestHelper.<span class="highlight"><span class="nf">stubProperty</span>(<span class="nv">object</span>, <span class="nv">prop</span>, <span class="nv">newValue</span>)</span></h1><abstract><div><p>A wrapper around <a class="jsdoc-link" href="#koru/util.setProperty">util.setProperty</a> that automatically restores after the
test/test-case has completed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>prop</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>newValue</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a function to restore property to original setting.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestHelper</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test-helper"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">foo</span> <span class="o">=</span> {<span class="k">get</span> <span class="nf">bar</span>() {<span class="k">return</span> <span class="s">'orig'</span>}};
<span class="kd">const</span> <span class="no">restore</span> <span class="o">=</span> <span class="nx">TH</span>.<span class="na">stubProperty</span>(<span class="nx">foo</span>, <span class="s">'bar'</span>, {<span class="na">value</span>: <span class="s">'new'</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>.<span class="na">bar</span>, <span class="s">'new'</span>);
<span class="nx">restore</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>.<span class="na">bar</span>, <span class="s">'orig'</span>);</div></div></pre></div></section><section id="koru/test-helper.testCase" tabindex="-1" name="testCase" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">TestHelper.<span class="highlight"><span class="nf">testCase</span>(<span class="nv">module</span>, <span class="nv">body</span>)</span></h1><abstract><div><p>Create a <a class="jsdoc-link" href="#koru/test/test-case">TestCase</a> and set the exports for <code>module</code> to the <code>testCase</code>.</p>
<p>See <a href="#koru/test-helper">example</a> above</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>module</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the module for the test file.</p>
</div></td></tr><tr class="jsdoc-arg"><td>body</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>A function that will <a href="#koru/test-case#add">add tests</a>. It is passed an object
with the following properties:</p>
<ul>
<li><p><code>before(body)</code> - a function to run before all tests in the test case.</p>
</li>
<li><p><code>after(body)</code> - a function to run after all tests in the test case.</p>
</li>
<li><p><code>beforeEach(body)</code> - a function to run before each test in the test case.</p>
</li>
<li><p><code>afterEach(body)</code> - a function to run after each test in the test case.</p>
</li>
<li><p><code>group(name, body)</code> - adds a sub <code>TestCase</code> named <code>name</code>. <code>body</code> is again called with
this list of properties: (before, after, beforeEach, afterEach, group, test).</p>
</li>
<li><p><code>test(name, body)</code> - adds a <a class="jsdoc-link" href="#koru/test/test-case::Test">Test</a> named <code>name</code>. <code>body</code> is
called when the test is run.</p>
<p>If the <code>body</code> has a <code>done</code> argument then the test will be asynchronous and done should be
called with no argument on success and with a error on failure.</p>
<p><code>body</code> may also be an async function</p>
</li>
</ul>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/test/test-case">TestCase</a></td><td class="jsdoc-info"><div><p>a <a class="jsdoc-link" href="#koru/test-case">test-case</a> instance.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestHelper</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test-helper"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">TestHelper</span>.<span class="na">testCase</span>(<span class="ge nx">{id: "my-module-test"}</span>, <span class="ge nx">body</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{body(){}, level: 0, name: 'my-module', tc: undefined}</span></span></div></pre></div></section></div></div></div></section><section id="koru/test-helper::MockModule" data-env="both" class="jsdoc-module jsdoc-innerSubject" tabindex="-1"><a class="jsdoc-module-path" href="#koru/test-helper::MockModule">koru/test-helper::MockModule</a><h1 class="jsdoc-module-title searchable">MockModule</h1><abstract><div><p>For when you want to mock a <code>module</code></p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/test-helper::MockModule.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">id</span>, <span class="nv">exports</span><span class="o">=</span>{})</span></h1><abstract><div><p>Create a MockModule.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>exports</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">TestHelper</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/test-helper"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">myMod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MockModule</span>(<span class="s">"my-id"</span>, {<span class="na">my</span>: <span class="s">'content'</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">myMod</span>.<span class="na">id</span>, <span class="s">'my-id'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">myMod</span>.<span class="na">exports</span>, {<span class="na">my</span>: <span class="s">'content'</span>});</div></div></pre></div></section></div></div></div></section><section id="koru/ui/app" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/ui/app">koru/ui/app</a><h1 class="jsdoc-module-title searchable">App</h1><abstract><div><p>App wide features</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/ui/app.flashUncaughtErrors" tabindex="-1" name="flashUncaughtErrors" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">App.<span class="highlight"><span class="nf">flashUncaughtErrors</span>()</span></h1><abstract><div><p>Use flash to display uncaught errors</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">App</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/app"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">after</span>(<span class="nx">App</span>.<span class="na">flashUncaughtErrors</span>());
<span class="nx">stub</span>(<span class="nx">Flash</span>, <span class="s">'error'</span>);
<span class="nx">stub</span>(<span class="nx">Flash</span>, <span class="s">'notice'</span>);
<span class="nx">stub</span>(<span class="nx">koru</span>, <span class="s">'error'</span>);

<span class="nx">koru</span>.<span class="na">unexpectedError</span>(<span class="s">"user message"</span>, <span class="s">"log message"</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">Flash</span>.<span class="na">error</span>, <span class="s">"unexpected_error:user message"</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">koru</span>.<span class="na">error</span>, <span class="s">"Unexpected error"</span>, <span class="s">'log message'</span>);

<span class="nx">Flash</span>.<span class="na">error</span>.<span class="na">reset</span>();
<span class="nx">koru</span>.<span class="na">error</span>.<span class="na">reset</span>();
<span class="nx">koru</span>.<span class="na">globalErrorCatch</span>(<span class="k">new</span> <span class="nx">koru</span>.<span class="na">Error</span>(<span class="m">400</span>, {<span class="na">name</span>: [[<span class="s">'is_invalid'</span>]]}));

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">Flash</span>.<span class="na">error</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">Flash</span>.<span class="na">notice</span>, <span class="s">"Update failed: name: is not valid"</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">koru</span>.<span class="na">error</span>, <span class="nx">m</span>(<span class="sr">/400/</span>));

<span class="nx">koru</span>.<span class="na">globalErrorCatch</span>(<span class="k">new</span> <span class="nx">koru</span>.<span class="na">Error</span>(<span class="m">500</span>, <span class="s">"Something went wrong"</span>));

<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">Flash</span>.<span class="na">error</span>, <span class="s">"Something went wrong"</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">koru</span>.<span class="na">error</span>, <span class="nx">m</span>(<span class="sr">/500/</span>));

<span class="nx">koru</span>.<span class="na">globalCallback</span>(<span class="k">new</span> <span class="nx">koru</span>.<span class="na">Error</span>(<span class="m">404</span>, <span class="s">"Not found"</span>));
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">Flash</span>.<span class="na">notice</span>, <span class="s">'Not found'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/ui/auto-list" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/ui/auto-list">koru/ui/auto-list</a><h1 class="jsdoc-module-title searchable">AutoList</h1><abstract><div><p>Automatically manage a list of Elements matching a <a class="jsdoc-link" href="#koru/model/query">Query</a>.
The list observers changes in the query model and updates the list accordingly.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#limit</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="client"><div><p>A limit of <code>n</code> can be given to only display the first (ordered) <code>n</code> entries.</p>
<p>When visible entries are removed non-visible entries are added to keep list length at <code>n</code>
when <code>n</code> or more rows still match the query. Defaults to <code>Infinity</code></p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/ui/auto-list.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>({
      <span class="nv">template</span>, <span class="nv">container</span>,
      <span class="nv">query</span>,
      <span class="nv">limit</span><span class="o">=</span><span class="m">Infinity</span>,
      <span class="nv">compare</span><span class="o">=</span><span class="nx">query</span>?.<span class="nx">compare</span> <span class="o">??</span> <span class="nx">compareAddOrder</span>,
      <span class="nv">compareKeys</span><span class="o">=</span><span class="nx">compare</span>.<span class="na">compareKeys</span> <span class="o">??</span> <span class="nx">query</span>?.<span class="nx">compareKeys</span>,
      <span class="nv">observeUpdates</span>,
      <span class="nv">overLimit</span>,
      <span class="nv">removeElement</span><span class="o">=</span><span class="nx">Dom</span>.<span class="na">remove</span>,
      <span class="nv">parentCtx</span><span class="o">=</span><span class="nx">$</span>.<span class="na">ctx</span>,
    })</span></h1><abstract><div><p>Build a new AutoList</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>template</td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info"><div><p>to render each row</p>
</div></td></tr><tr class="jsdoc-arg"><td>container</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_blank">Node</a></td><td class="jsdoc-info"><div><p>to render into. Can be a start <code>Comment</code> node with symbol <code>endMarker$</code>
(see <a class="jsdoc-link" href="#koru/symbols">Symbols</a>) pointing to end <code>Comment</code> in which case the rows will be rendered
between the comments.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[query]</td><td><a href="#koru/model/query">Query</a></td><td class="jsdoc-info"><div><p>A <a class="jsdoc-link" href="#koru/model/query">Query</a> or at least has methods <code>compare</code> and <code>forEach</code>. The
method <code>onChange</code> will be used to auto-update the list if present.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[limit]</td><td></td><td class="jsdoc-info"><div><p>maximum number of elements to show. (see <code>limit</code> property)</p>
</div></td></tr><tr class="jsdoc-arg"><td>[compare]</td><td></td><td class="jsdoc-info"><div><p>function to order data. Defaults to <code>query.compare</code> or if no query then
order items are added</p>
</div></td></tr><tr class="jsdoc-arg"><td>[compareKeys]</td><td></td><td class="jsdoc-info"><div><p>Array of keys used for ordering data. Defaults to
<code>compare.compareKeys</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>[observeUpdates]</td><td></td><td class="jsdoc-info"><div><p>The list can be monitored for changes by passing an
<code>observeUpdates</code> function which is called for each change with the arguments <code>(list, doc, action)</code> where:</p>
<ul>
<li><code>list</code> is this <code>AutoList</code></li>
<li><code>doc</code> is the document being added, changed, or removed</li>
<li><code>action</code> is <code>added</code>, <code>changed</code> or <code>removed</code></li>
</ul>
</div></td></tr><tr class="jsdoc-arg"><td>[overLimit]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[removeElement]</td><td></td><td class="jsdoc-info"><div><p>Method used to remove an element. Defaults to
<a class="jsdoc-link" href="#koru/dom-client.remove">dom-client.remove</a></p>
</div></td></tr><tr class="jsdoc-arg"><td>[parentCtx]</td><td></td><td class="jsdoc-info"><div><p>The <a class="jsdoc-link" href="#koru/dom/ctx">Ctx</a> to use for rendering elements. Defaults to the
current context.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AutoList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/auto-list"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">title</span>: <span class="s">'The Eye of the World'</span>});
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">title</span>: <span class="s">'The Great Hunt'</span>});

<span class="kd">const</span> <span class="no">container</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});
<span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>({<span class="na">query</span>: <span class="nx">Book</span>.<span class="na">query</span>.<span class="na">sort</span>(<span class="s">'title'</span>), <span class="na">template</span>: <span class="nx">Row</span>, <span class="na">container</span>});

<span class="nx">assert</span>.<span class="na">dom</span>(<span class="nx">container</span>, () <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">':first-child'</span>, <span class="s">'The Eye of the World'</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">':last-child'</span>, <span class="s">'The Great Hunt'</span>);
});</div></div><div><div class="highlight"><span class="kd">const</span> <span class="no">container</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: [
  <span class="s">'before'</span>, {<span class="na">$comment$</span>: <span class="s">'start'</span>}, {<span class="na">$comment$</span>: <span class="s">'end'</span>}, <span class="s">'after'</span>,
]});

<span class="kd">const</span> <span class="no">startComment</span> <span class="o">=</span> <span class="nx">container</span>.<span class="na">childNodes</span>[<span class="m">1</span>];
<span class="nx">startComment</span>[<span class="na">endMarker$</span>] <span class="o">=</span> <span class="nx">container</span>.<span class="na">childNodes</span>[<span class="m">2</span>];

<span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>({
  <span class="na">query</span>: <span class="nx">Book</span>.<span class="na">query</span>.<span class="na">sort</span>(<span class="s">'title'</span>), <span class="na">template</span>: <span class="nx">Row</span>, <span class="na">container</span>: <span class="nx">startComment</span>});

<span class="nx">assert</span>.<span class="na">dom</span>(<span class="nx">container</span>, (<span class="nv">pn</span>) <span class="o">=&gt;</span> {
  <span class="nx">createBook</span>(<span class="m">4</span>);
  <span class="nx">createBook</span>(<span class="m">1</span>);
  <span class="nx">createBook</span>(<span class="m">5</span>);

  <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">map</span>(
    <span class="nx">pn</span>.<span class="na">childNodes</span>, (<span class="nv">n</span>) <span class="o">=&gt;</span> <span class="s">`${</span><span class="nx">n</span>.<span class="na">nodeType</span><span class="s">}:${</span><span class="nx">n</span>.<span class="na">data</span> <span class="o">??</span> <span class="nx">n</span>.<span class="na">textContent</span><span class="s">}`</span>),
                [<span class="s">'3:before'</span>, <span class="s">'8:start'</span>, <span class="s">'1:b1'</span>, <span class="s">'1:b4'</span>, <span class="s">'1:b5'</span>, <span class="s">'8:end'</span>, <span class="s">'3:after'</span>]);
});</div></div></pre></div></section><section id="koru/ui/auto-list#changeOptions" tabindex="-1" name="#changeOptions" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AutoList#<span class="highlight"><span class="nf">changeOptions</span>({
      <span class="nv">query</span>, <span class="nv">compare</span>, <span class="nv">compareKeys</span>,
      <span class="nv">limit</span>,
      <span class="nv">updateAllTags</span><span class="o">=</span><span class="kc">false</span>,
    }<span class="o">=</span>{})</span></h1><abstract><div><p>Rebuild list based on a different options. It trys to preserve DOM elements where possible.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>query</td><td><a href="#koru/model/query">Query</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[compare]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[compareKeys]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[limit]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[updateAllTags]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p>call updateAllTags on each element that is already rendered. Defaults
to <code>false</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AutoList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/auto-list"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">autoList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>();</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book1</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">title</span>: <span class="s">'The Eye of the World'</span>, <span class="na">pageCount</span>: <span class="m">782</span>});
<span class="kd">const</span> <span class="no">book2</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">title</span>: <span class="s">'The Great Hunt'</span>, <span class="na">pageCount</span>: <span class="m">681</span>});

<span class="kd">const</span> <span class="no">container</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});
<span class="kd">let</span> <span class="nv">query</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">query</span>.<span class="na">sort</span>(<span class="s">'title'</span>);
<span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>({<span class="na">query</span>, <span class="na">template</span>: <span class="nx">Row</span>, <span class="na">container</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>.<span class="na">query</span>, <span class="nx">query</span>);

<span class="nx">assert</span>.<span class="na">dom</span>(<span class="nx">container</span>, () <span class="o">=&gt;</span> {
  <span class="kd">let</span> <span class="nv">book1Elm</span>;
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">':first-child'</span>, {<span class="na">data</span>: <span class="nx">m</span>.<span class="na">model</span>(<span class="nx">book1</span>)}, (<span class="nv">elm</span>) <span class="o">=&gt;</span> {
    <span class="nx">book1Elm</span> <span class="o">=</span> <span class="nx">elm</span>;
  });

  <span class="nx">list</span>.<span class="na">changeOptions</span>({<span class="na">query</span>: <span class="nx">Book</span>.<span class="na">where</span>((<span class="nv">d</span>) <span class="o">=&gt;</span> <span class="o">!</span> <span class="sr">/Shadow/</span>.<span class="na">test</span>(<span class="nx">d</span>.<span class="na">title</span>)).<span class="na">sort</span>(<span class="s">'pageCount'</span>)});

  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">':first-child'</span>, <span class="s">'The Great Hunt'</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">':last-child'</span>, <span class="s">'The Eye of the World'</span>, (<span class="nv">elm</span>) <span class="o">=&gt;</span> {
    <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">elm</span>, <span class="nx">book1Elm</span>);
  });

  <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">title</span>: <span class="s">'The Fires of Heaven'</span>, <span class="na">pageCount</span>: <span class="m">963</span>});
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">':last-child'</span>, <span class="s">'The Fires of Heaven'</span>); <span class="cs">// reverse sort</span>

  <span class="kd">const</span> <span class="no">b4</span> <span class="o">=</span> <span class="nx">Book</span>.<span class="na">create</span>({<span class="na">title</span>: <span class="s">'The Shadow Rising'</span>, <span class="na">pageCount</span>: <span class="m">1001</span>});
  <span class="nx">refute</span>(<span class="nx">list</span>.<span class="na">elm</span>(<span class="nx">b4</span>)); <span class="cs">// filtered out</span>
});</div></div></pre></div></section><section id="koru/ui/auto-list#elm" tabindex="-1" name="#elm" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AutoList#<span class="highlight"><span class="nf">elm</span>(<span class="nv">doc</span>, <span class="nv">force</span>)</span></h1><abstract><div><p>Return the elm for a document.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[force]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>if set to <code>"render"</code> then raise the limit in order for node to be visible</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AutoList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/auto-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>({
  <span class="na">query</span>: <span class="nx">Book</span>.<span class="na">where</span>((<span class="nv">n</span>) <span class="o">=&gt;</span> <span class="nx">n</span>.<span class="na">title</span> <span class="o">!==</span> <span class="s">'b2'</span>).<span class="na">sort</span>(<span class="s">'title'</span>),
  <span class="na">template</span>: <span class="nx">Row</span>, <span class="na">container</span>, <span class="na">limit</span>: <span class="m">1</span>, <span class="na">parentCtx</span>});

<span class="kd">const</span> [<span class="no">book1</span>, <span class="no">book2</span>, <span class="no">book3</span>] <span class="o">=</span> <span class="nx">createBooks</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">list</span>.<span class="na">elm</span>(<span class="nx">book1</span>), <span class="nx">container</span>.<span class="na">firstChild</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Dom</span>.<span class="na">myCtx</span>(<span class="nx">list</span>.<span class="na">elm</span>(<span class="nx">book1</span>)).<span class="na">parentCtx</span>, <span class="nx">parentCtx</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">list</span>.<span class="na">elm</span>(<span class="nx">book2</span>), <span class="kc">null</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">list</span>.<span class="na">elm</span>(<span class="nx">book3</span>), <span class="kc">null</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">list</span>.<span class="na">elm</span>(<span class="kc">null</span>), <span class="kc">null</span>);
<span class="nx">book1</span>.<span class="na">$remove</span>();

<span class="nx">assert</span>(<span class="nx">list</span>.<span class="na">elm</span>(<span class="nx">book3</span>));
<span class="nx">book3</span>.<span class="na">title</span> <span class="o">=</span> <span class="s">'b2'</span>; <span class="cs">// we haved taged this doc so we know we have it</span>
<span class="nx">assert</span>(<span class="nx">list</span>.<span class="na">elm</span>({<span class="na">title</span>: <span class="s">'b3'</span>, <span class="na">_id</span>: <span class="nx">book3</span>.<span class="na">_id</span>}));
<span class="nx">refute</span>(<span class="nx">list</span>.<span class="na">elm</span>({<span class="na">title</span>: <span class="s">'b2'</span>, <span class="na">_id</span>: <span class="nx">book3</span>.<span class="na">_id</span>}));
<span class="nx">assert</span>(<span class="nx">list</span>.<span class="na">elm</span>(<span class="nx">book3</span>));</div></div></pre></div></section><section id="koru/ui/auto-list#nodeElm" tabindex="-1" name="#nodeElm" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AutoList#<span class="highlight"><span class="nf">nodeElm</span>(<span class="nv">node</span>, <span class="nv">force</span>)</span></h1><abstract><div><p>Return the elm for a node.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>node</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[force]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>if set to <code>"render"</code> then raise the limit in order for node to be visible</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AutoList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/auto-list"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">autoList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">autoList</span>.<span class="na">nodeElm</span>(<span class="ge nx">{value: {_id: 'b1', title: 'b1'}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Node`&lt;div&gt;b1&lt;/div&gt;`</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">autoList</span>.<span class="na">nodeElm</span>(<span class="ge nx">{value: {_id: 'b3', title: 'b3'}}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="kc">null</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">autoList</span>.<span class="na">nodeElm</span>(<span class="ge nx">{value: {_id: 'b3', title: 'b3'}}</span>, <span class="s">"render"</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Node`&lt;div&gt;b3&lt;/div&gt;`</span></span></div></pre></div></section><section id="koru/ui/auto-list#stop" tabindex="-1" name="#stop" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AutoList#<span class="highlight"><span class="nf">stop</span>()</span></h1><abstract><div><p>Stop observing model changes.
Removing the container via <a class="jsdoc-link" href="#koru/dom.remove">Dom.remove</a> also stops observering model</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AutoList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/auto-list"</span>);</div><div class="highlight jsdoc-inst-init"><span class="kd">const</span> <span class="no">autoList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>();</div><div class="jsdoc-example-call highlight"><div><span class="nx">autoList</span>.<span class="na">stop</span>();</div><div></div></div><div class="jsdoc-example-call highlight"><div><span class="nx">autoList</span>.<span class="na">stop</span>();</div><div></div></div></pre></div></section><section id="koru/ui/auto-list#thisElm" tabindex="-1" name="#thisElm" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AutoList#<span class="highlight"><span class="nf">thisElm</span>(<span class="nv">doc</span>)</span></h1><abstract><div><p>Return element associated with this instance of <code>doc</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div><p>a document that might be in the list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div><p>the element associated with this list and document; otherwise null</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AutoList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/auto-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>({
  <span class="na">query</span>: <span class="nx">Book</span>.<span class="na">where</span>((<span class="nv">n</span>) <span class="o">=&gt;</span> <span class="nx">n</span>.<span class="na">title</span> <span class="o">!==</span> <span class="s">'b2'</span>).<span class="na">sort</span>(<span class="s">'title'</span>),
  <span class="na">template</span>: <span class="nx">Row</span>, <span class="na">container</span>, <span class="na">limit</span>: <span class="m">1</span>, <span class="na">parentCtx</span>});

<span class="kd">const</span> [<span class="no">book1</span>, <span class="no">book2</span>] <span class="o">=</span> <span class="nx">createBooks</span>(<span class="m">1</span>, <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>.<span class="na">thisElm</span>(<span class="nx">book1</span>).<span class="na">textContent</span>, <span class="s">'b1'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">list</span>.<span class="na">thisElm</span>(<span class="nx">book2</span>), <span class="kc">null</span>);</div></div></pre></div></section><section id="koru/ui/auto-list#thisNode" tabindex="-1" name="#thisNode" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AutoList#<span class="highlight"><span class="nf">thisNode</span>(<span class="nv">doc</span>)</span></h1><abstract><div><p>Return the <a class="jsdoc-link" href="#koru/btree">BTree</a> node associated with this instance of <code>doc</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="#koru/model/base-model">BaseModel</a></td><td class="jsdoc-info"><div><p>a document that might be in the list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the node associated with this list and document; otherwise undefined</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AutoList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/auto-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>({
  <span class="na">query</span>: <span class="nx">Book</span>.<span class="na">where</span>((<span class="nv">n</span>) <span class="o">=&gt;</span> <span class="nx">n</span>.<span class="na">title</span> <span class="o">!==</span> <span class="s">'b2'</span>).<span class="na">sort</span>(<span class="s">'title'</span>),
  <span class="na">template</span>: <span class="nx">Row</span>, <span class="na">container</span>, <span class="na">limit</span>: <span class="m">1</span>, <span class="na">parentCtx</span>});

<span class="kd">const</span> [<span class="no">book1</span>, <span class="no">book2</span>] <span class="o">=</span> <span class="nx">createBooks</span>(<span class="m">1</span>, <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>.<span class="na">thisNode</span>(<span class="nx">book1</span>).<span class="na">value</span>, {<span class="na">title</span>: <span class="s">'b1'</span>, <span class="na">_id</span>: <span class="s">'b1'</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">list</span>.<span class="na">thisNode</span>(<span class="k">new</span> <span class="nx">Book</span>()), <span class="o">void</span> <span class="m">0</span>);</div></div></pre></div></section><section id="koru/ui/auto-list#updateEntry" tabindex="-1" name="#updateEntry" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">AutoList#<span class="highlight"><span class="nf">updateEntry</span>(<span class="nv">doc</span>, <span class="nv">action</span>)</span></h1><abstract><div><p>Explicitly update an entry in the list. This method is called automatically when the
query.onChange callback is is used; i.e. when an entry is changed.</p>
<p>If <code>observeUpdates</code> is set then it is called after the update.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>doc</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the entry to update</p>
</div></td></tr><tr class="jsdoc-arg"><td>[action]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>if value is <code>"remove"</code> then remove entry</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">AutoList</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/auto-list"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">container</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({});

<span class="kd">const</span> <span class="no">observeUpdates</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AutoList</span>({
  <span class="na">template</span>: <span class="nx">Row</span>, <span class="na">container</span>,
  <span class="na">query</span>: {
    <span class="nf">forEach</span>() {},
  },
  <span class="na">compare</span>: <span class="nx">util</span>.<span class="na">compareByField</span>(<span class="s">'title'</span>),
  <span class="na">observeUpdates</span>,
});
<span class="nx">assert</span>.<span class="na">dom</span>(<span class="nx">container</span>, () <span class="o">=&gt;</span> {
  <span class="kd">const</span> <span class="no">b1</span> <span class="o">=</span> {<span class="na">_id</span>: <span class="s">'b1'</span>, <span class="na">title</span>: <span class="s">'Book 1'</span>}, <span class="no">b2</span> <span class="o">=</span> {<span class="na">_id</span>: <span class="s">'b1'</span>, <span class="na">title</span>: <span class="s">'Book 2'</span>};
  <span class="nx">list</span>.<span class="na">updateEntry</span>(<span class="nx">b1</span>);
  <span class="nx">list</span>.<span class="na">updateEntry</span>(<span class="nx">b2</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'div:last-child'</span>, <span class="s">'Book 2'</span>);
  <span class="nx">b2</span>.<span class="na">title</span> <span class="o">=</span> <span class="s">'A book 2'</span>;
  <span class="nx">list</span>.<span class="na">updateEntry</span>(<span class="nx">b2</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'div:first-child'</span>, <span class="s">'A book 2'</span>);

  <span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observeUpdates</span>, <span class="nx">list</span>, <span class="nx">b1</span>, <span class="s">'added'</span>);
  <span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observeUpdates</span>, <span class="nx">list</span>, <span class="nx">b2</span>, <span class="s">'added'</span>);
  <span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observeUpdates</span>, <span class="nx">list</span>, <span class="nx">b2</span>, <span class="s">'changed'</span>);

  <span class="nx">list</span>.<span class="na">updateEntry</span>(<span class="nx">b1</span>, <span class="s">'remove'</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'div'</span>, {<span class="na">count</span>: <span class="m">1</span>});
  <span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">observeUpdates</span>, <span class="nx">list</span>, <span class="nx">b1</span>, <span class="s">'removed'</span>);
});</div></div></pre></div></section></div></div></div></section><section id="koru/ui/list-selector" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/ui/list-selector">koru/ui/list-selector</a><h1 class="jsdoc-module-title searchable">ListSelector</h1><abstract><div><p>Helper for build a selectable list.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/ui/list-selector.attach" tabindex="-1" name="attach" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">ListSelector.<span class="highlight"><span class="nf">attach</span>({
      <span class="nv">ul</span>,
      <span class="nv">ctx</span><span class="o">=</span><span class="nx">Dom</span>.<span class="na">ctx</span>(<span class="nx">ul</span>),
      <span class="nv">keydownElm</span><span class="o">=</span><span class="nx">ul</span>,
      <span class="nv">onClick</span>,
      <span class="nv">onHover</span>,
    })</span></h1><abstract><div><p>Attach events for highlighting and selecting a list element.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>ul</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the parent element for list items (usally a <code>&lt;ul class="ui-ul"&gt;</code> element)</p>
</div></td></tr><tr class="jsdoc-arg"><td>[ctx]</td><td><a href="#koru/dom/ctx">Ctx</a></td><td class="jsdoc-info"><div><p>The events are detached when this <code>ctx</code> is destroyed.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[keydownElm]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLDocument" target="_blank">HTMLDocument</a></td><td class="jsdoc-info"><div><p>the element to listen for <code>keydown</code> events from.</p>
</div></td></tr><tr class="jsdoc-arg"><td>onClick</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called with the current element and the causing event when clicked or enter
pressed on a selectable element.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[onHover]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>called with the <code>target</code> and the causing event when <code>pointerover</code> selectable
element.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ListSelector</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/list-selector"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ul</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">tabindex</span>: <span class="m">0</span>,
  <span class="na">class</span>: <span class="s">'ui-ul'</span>,
  <span class="na">ul</span>: [
    {<span class="na">li</span>: [<span class="s">'one'</span>]},
    {<span class="na">li</span>: [<span class="s">'two'</span>], <span class="na">class</span>: <span class="s">'disabled'</span>},
    {<span class="na">li</span>: [<span class="s">'sep'</span>], <span class="na">class</span>: <span class="s">'sep'</span>},
    {<span class="na">li</span>: [<span class="s">'hidden'</span>], <span class="na">class</span>: <span class="s">'hide'</span>},
    {<span class="na">li</span>: [<span class="s">'three'</span>]},
  ]
});
<span class="kd">const</span> <span class="no">ctx</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">setCtx</span>(<span class="nx">ul</span>);
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">append</span>(<span class="nx">ul</span>);
<span class="kd">const</span> <span class="no">onClick</span> <span class="o">=</span> <span class="nx">stub</span>();

<span class="nx">ListSelector</span>.<span class="na">attach</span>({
  <span class="na">ul</span>,
  <span class="na">onClick</span>,
});

<span class="nx">ul</span>.<span class="na">focus</span>();
<span class="nx">assert</span>.<span class="na">dom</span>(<span class="nx">ul</span>, ()<span class="o">=&gt;</span>{
  <span class="cs">// select via keyboard</span>
  <span class="nx">TH</span>.<span class="na">keydown</span>(<span class="nx">ul</span>, <span class="m">40</span>); <span class="cs">// down</span>
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'.selected'</span>, <span class="s">'one'</span>);
  <span class="nx">TH</span>.<span class="na">keydown</span>(<span class="nx">ul</span>, <span class="m">40</span>); <span class="cs">// down</span>
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'.selected'</span>, <span class="s">'three'</span>);
  <span class="nx">TH</span>.<span class="na">keydown</span>(<span class="nx">ul</span>, <span class="m">38</span>); <span class="cs">// up</span>
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'.selected'</span>, <span class="s">'one'</span>);

  <span class="cs">// onClick via keyboard</span>
  <span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">onClick</span>);
  <span class="nx">TH</span>.<span class="na">keydown</span>(<span class="nx">ul</span>, <span class="m">13</span>);<span class="cs">// enter</span>
  <span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">onClick</span>, <span class="nx">ul</span>.<span class="na">firstChild</span>, <span class="nx">m</span>(<span class="nv">e</span> <span class="o">=&gt;</span> <span class="nx">e</span>.<span class="na">type</span> <span class="o">===</span> <span class="s">'keydown'</span>));

  <span class="cs">// pointerover selects too</span>
  <span class="nx">TH</span>.<span class="na">trigger</span>(<span class="nx">ul</span>.<span class="na">lastChild</span>, <span class="s">'pointerover'</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'.selected'</span>, <span class="s">'three'</span>);
  <span class="nx">TH</span>.<span class="na">trigger</span>(<span class="nx">ul</span>.<span class="na">firstChild</span>, <span class="s">'pointerover'</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'.selected'</span>, <span class="s">'one'</span>);

  <span class="nx">TH</span>.<span class="na">trigger</span>(<span class="nx">ul</span>.<span class="na">firstChild</span>.<span class="na">nextSibling</span>, <span class="s">'pointerover'</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'.selected'</span>, <span class="s">'one'</span>);

  <span class="nx">onClick</span>.<span class="na">reset</span>();
  <span class="cs">// onClick via pointer</span>
  <span class="nx">TH</span>.<span class="na">click</span>(<span class="nx">ul</span>.<span class="na">lastChild</span>);
  <span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">onClick</span>, <span class="nx">ul</span>.<span class="na">lastChild</span>, <span class="nx">m</span>(<span class="nv">e</span> <span class="o">=&gt;</span> <span class="nx">e</span>.<span class="na">type</span> <span class="o">===</span> <span class="s">'click'</span>));
});

<span class="nx">ul</span>.<span class="na">querySelector</span>(<span class="s">'.selected'</span>).<span class="na">classList</span>.<span class="na">remove</span>(<span class="s">'selected'</span>);
<span class="nx">Dom</span>.<span class="na">remove</span>(<span class="nx">ul</span>); <span class="cs">// destroy event listeners</span></div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="cs">// override defaults</span>
<span class="kd">const</span> <span class="no">div</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">div</span>: <span class="nx">ul</span>});
<span class="kd">const</span> <span class="no">divCtx</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">setCtx</span>(<span class="nx">div</span>);
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">append</span>(<span class="nx">div</span>);
<span class="kd">const</span> <span class="no">onHover</span> <span class="o">=</span> <span class="nx">stub</span>();

<span class="nx">ListSelector</span>.<span class="na">attach</span>({
  <span class="na">ul</span>,
  <span class="na">ctx</span>: <span class="nx">divCtx</span>,
  <span class="na">keydownElm</span>: <span class="nx">document</span>,
  <span class="na">onClick</span>,
  <span class="na">onHover</span>,
});
<span class="nx">assert</span>.<span class="na">dom</span>(<span class="nx">ul</span>, ()<span class="o">=&gt;</span>{
  <span class="nx">TH</span>.<span class="na">keydown</span>(<span class="nx">document</span>, <span class="m">38</span>); <span class="cs">// up</span>
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'.selected'</span>, <span class="s">'three'</span>); <span class="cs">// select from bottom of list</span>

  <span class="nx">TH</span>.<span class="na">trigger</span>(<span class="nx">ul</span>.<span class="na">firstChild</span>.<span class="na">firstChild</span>, <span class="s">'pointerover'</span>);
  <span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">onHover</span>, <span class="nx">ul</span>.<span class="na">firstChild</span>, <span class="nx">m</span>(<span class="nv">e</span> <span class="o">=&gt;</span> <span class="nx">e</span>.<span class="na">type</span> <span class="o">===</span> <span class="s">'pointerover'</span>));
});</div></div></pre></div></section><section id="koru/ui/list-selector.keydownHandler" tabindex="-1" name="keydownHandler" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">ListSelector.<span class="highlight"><span class="nf">keydownHandler</span>(<span class="nv">event</span>, <span class="nv">ul</span>, <span class="nv">selected</span><span class="o">=</span><span class="nx">ul</span>.<span class="na">getElementsByClassName</span>(<span class="s">'selected'</span>), <span class="nv">onClick</span>)</span></h1><abstract><div><p>Used by <a class="jsdoc-link" href="#koru/ui/list-selector.attach">attach</a> to listen for <code>Up/Down</code> events to change the selected item and <code>Enter</code>
events to choose the selected item.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>event</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the <code>keydown</code> event to process</p>
</div></td></tr><tr class="jsdoc-arg"><td>ul</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div><p>the list contains <code>li</code> items to select</p>
</div></td></tr><tr class="jsdoc-arg"><td>[selected]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLCollection" target="_blank">HTMLCollection</a></td><td class="jsdoc-info"><div><p>used to determine current selected</p>
</div></td></tr><tr class="jsdoc-arg"><td>[onClick]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>callback for when <code>Enter</code> is pressed with a selected item.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">ListSelector</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/list-selector"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">ul</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">tabindex</span>: <span class="m">0</span>,
  <span class="na">class</span>: <span class="s">'ui-ul'</span>,
  <span class="na">ul</span>: [
    {<span class="na">li</span>: [<span class="s">'one'</span>]},
    {<span class="na">li</span>: [<span class="s">'two'</span>], <span class="na">class</span>: <span class="s">'disabled'</span>},
    {<span class="na">li</span>: [<span class="s">'sep'</span>], <span class="na">class</span>: <span class="s">'sep'</span>},
    {<span class="na">li</span>: [<span class="s">'hidden'</span>], <span class="na">class</span>: <span class="s">'hide'</span>},
    {<span class="na">li</span>: [<span class="s">'three'</span>]},
  ]
});
<span class="kd">const</span> <span class="no">selected</span> <span class="o">=</span> <span class="nx">ul</span>.<span class="na">getElementsByClassName</span>(<span class="s">'selected'</span>);
<span class="kd">const</span> <span class="no">onClick</span> <span class="o">=</span> <span class="nx">stub</span>();

<span class="nx">ListSelector</span>.<span class="na">keydownHandler</span>(
  <span class="nx">Dom</span>.<span class="na">buildEvent</span>(<span class="s">'keydown'</span>, {<span class="na">which</span>: <span class="m">40</span>}),
  <span class="nx">ul</span>
);

<span class="kd">const</span> <span class="no">event2</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">buildEvent</span>(<span class="s">'keydown'</span>, {<span class="na">which</span>: <span class="m">13</span>});
<span class="nx">ListSelector</span>.<span class="na">keydownHandler</span>(
  <span class="nx">event2</span>,
  <span class="nx">ul</span>,
  <span class="nx">selected</span>,
  <span class="nx">onClick</span>
);

<span class="nx">assert</span>.<span class="na">calledOnceWith</span>(<span class="nx">onClick</span>, <span class="nx">ul</span>.<span class="na">firstChild</span>, <span class="nx">event2</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/ui/ripple" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/ui/ripple">koru/ui/ripple</a><h1 class="jsdoc-module-title searchable">Ripple</h1><abstract><div><p>Provide a ripple effect when a button is pressed</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/ui/ripple.start" tabindex="-1" name="start" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Ripple.<span class="highlight"><span class="nf">start</span>()</span></h1><abstract><div><p>Start the ripple effect</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Ripple</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/ripple"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">button</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">button</span>: <span class="s">'press me'</span>, <span class="na">style</span>: <span class="s">'width:100px;height:30px'</span>});
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">button</span>);
<span class="kd">const</span> <span class="no">dim</span> <span class="o">=</span> <span class="nx">button</span>.<span class="na">getBoundingClientRect</span>();

<span class="nx">Ripple</span>.<span class="na">start</span>();

<span class="nx">TH</span>.<span class="na">trigger</span>(<span class="nx">button</span>, <span class="s">'pointerdown'</span>, {
  <span class="na">clientX</span>: <span class="nx">dim</span>.<span class="na">left</span> <span class="o">+</span> <span class="m">45</span>,
  <span class="na">clientY</span>: <span class="nx">dim</span>.<span class="na">top</span> <span class="o">+</span> <span class="m">24</span>,
});

<span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'button&gt;.ripple'</span>, <span class="nv">ripple</span> <span class="o">=&gt;</span>{
  <span class="nx">assert</span>.<span class="na">cssNear</span>(<span class="nx">ripple</span>, <span class="s">'width'</span>, <span class="m">100</span>);
  <span class="nx">assert</span>.<span class="na">cssNear</span>(<span class="nx">ripple</span>, <span class="s">'height'</span>, <span class="m">30</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'&gt;div'</span>, ({<span class="nv">style</span>}) <span class="o">=&gt;</span>{
    <span class="nx">assert</span>.<span class="na">near</span>(<span class="nx">style</span>.<span class="na">getPropertyValue</span>(<span class="s">'transform'</span>),
                <span class="s">"translate(-50%, -50%) translate(45px, 24px) scale(0.0001, 0.0001)"</span>);
  });
});</div></div></pre></div></section><section id="koru/ui/ripple.stop" tabindex="-1" name="stop" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Ripple.<span class="highlight"><span class="nf">stop</span>()</span></h1><abstract><div><p>Stop the ripple effect</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Ripple</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/ripple"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">button</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">button</span>: <span class="s">'press me'</span>, <span class="na">style</span>: <span class="s">'width:100px;height:30px'</span>});
<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">button</span>);
<span class="kd">const</span> <span class="no">dim</span> <span class="o">=</span> <span class="nx">button</span>.<span class="na">getBoundingClientRect</span>();

<span class="nx">Ripple</span>.<span class="na">start</span>();
<span class="nx">Ripple</span>.<span class="na">stop</span>();

<span class="nx">TH</span>.<span class="na">trigger</span>(<span class="nx">button</span>, <span class="s">'pointerdown'</span>, {
  <span class="na">clientX</span>: <span class="nx">dim</span>.<span class="na">left</span> <span class="o">+</span> <span class="m">45</span>,
  <span class="na">clientY</span>: <span class="nx">dim</span>.<span class="na">top</span> <span class="o">+</span> <span class="m">24</span>,
});

<span class="nx">refute</span>.<span class="na">dom</span>(<span class="s">'button&gt;.ripple'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/ui/route" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/ui/route">koru/ui/route</a><h1 class="jsdoc-module-title searchable">Route</h1><abstract><div><p>Route is a paginging system within a one page app. It manages
creating and destroying pages and recording history.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/ui/route.gotoPage" tabindex="-1" name="gotoPage" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Route.<span class="highlight"><span class="nf">gotoPage</span>(<span class="nv">page</span>, <span class="nv">pageRoute</span>)</span></h1><abstract><div><p>Goto the specified <code>page</code> and record in <code>window.history</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>page</td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>pageRoute</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Route</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/route"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Route</span>.<span class="na">gotoPage</span>(<span class="ge nx">Template(Test.AdminProfile)</span>, <span class="ge nx">{append: "my/id"}</span>);</div><div></div></div></pre></div></section><section id="koru/ui/route.pathToPage" tabindex="-1" name="pathToPage" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Route.<span class="highlight"><span class="nf">pathToPage</span>(<span class="nv">path</span>, <span class="nv">pageRoute</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>path</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>pageRoute</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Route</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/route"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">pageRoute</span> <span class="o">=</span> {};
<span class="kd">const</span> <span class="no">page</span> <span class="o">=</span> <span class="nx">Route</span>.<span class="na">pathToPage</span>(<span class="s">'/baz/an-id/root-bar?search=data#tag'</span>, <span class="nx">pageRoute</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">page</span>, <span class="nx">v</span>.<span class="na">RootBar</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">pageRoute</span>, {<span class="na">bazId</span>: <span class="s">'an-id'</span>, <span class="na">pathname</span>: <span class="s">'/baz/an-id/root-bar'</span>,
                          <span class="na">search</span>: <span class="s">'?search=data'</span>, <span class="na">hash</span>: <span class="s">'#tag'</span>});</div></div></pre></div></section><section id="koru/ui/route.replacePage" tabindex="-1" name="replacePage" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Route.<span class="highlight"><span class="nf">replacePage</span>(<span class="nv">page</span>, <span class="nv">pageRoute</span>)</span></h1><abstract><div><p>Like <a class="jsdoc-link" href="#koru/ui/route.gotoPage">gotoPage</a> but replaces to <code>window.history</code>
rather than adding to it.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>page</td><td><a href="#koru/dom/template">Template</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>pageRoute</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Route</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/route"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Route</span>.<span class="na">replacePage</span>(<span class="ge nx">Template(Test.MyPage)</span>, <span class="ge nx">{append: "myId"}</span>);</div><div></div></div></pre></div></section><section id="koru/ui/route.setTitle" tabindex="-1" name="setTitle" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Route.<span class="highlight"><span class="nf">setTitle</span>(<span class="nv">title</span>)</span></h1><abstract><div><p>Set the <code>document.title</code> for the current page.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>title</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Route</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/route"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">Route</span>.<span class="na">setTitle</span>(<span class="s">"my title"</span>);</div><div></div></div></pre></div></section></div></div></div></section><section id="koru/ui/svg-icons" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/ui/svg-icons">koru/ui/svg-icons</a><h1 class="jsdoc-module-title searchable">SvgIcons</h1><abstract><div><p>SvgIcons: is a helper for managing svg icons</p>
<p>By convention the <code>document.body</code> contains an <code>svg</code> with a <code>defs</code> section which contains the
body of a list of icons. Each icon has a id which is prefixed by <code>"icon-"</code>; for example
<code>"icon-account"</code>. These defs are then used by a <code>use</code> element with an <code>xlink:href</code> to the id of
the icon required.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/ui/svg-icons.svgIcon" tabindex="-1" name="svgIcon" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">DomHelper:<span class="highlight"><span class="nf">svgIcon</span>(<span class="nv">name</span>, <span class="nv">attributes</span>)</span></h1><abstract><div><p><code>{{svgIcon "name" attributes...}}</code> inserts an svg into an html document. The icon is only built
once.</p>
<h3 id="example">Example</h3>
<pre><code class="language-html"><div class="highlight">&lt;<span class="nf">button</span>&gt;{{svgIcon "person_add" class="addUser"}}&lt;<span class="nf">span</span>&gt;Add user&lt;/<span class="nf">span</span>&gt;&lt;/<span class="nf">button</span>&gt;</div>
</code></pre></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the icon to use (See <a class="jsdoc-link" href="#koru/ui/svg-icons.use">use</a>)</p>
</div></td></tr><tr class="jsdoc-arg"><td>attributes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>name/value pairs to set as attributes on the svg</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SvgIcons</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/svg-icons"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">SvgIcons</span>.<span class="na">svgIcon</span>(<span class="s">"close"</span>, <span class="ge nx">{class: "svgClose"}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">Node`&lt;svg class="svgClose" name="close"&gt;&lt;use xlink:href="#icon-close"&gt;&lt;/use&gt;&lt;/svg&gt;`</span></span></div></pre></div></section><section id="koru/ui/svg-icons.add" tabindex="-1" name="add" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">SvgIcons.<span class="highlight"><span class="nf">add</span>(<span class="nv">id</span>, <span class="nv">symbol</span>)</span></h1><abstract><div><p>Add an svg to the asset library under id <code>"icon-"+id</code>.</p>
<p>Note: all icons should be drawn for use with a viewBox of "0 0 24 24"</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the id of the icon. It will be prefixed with <code>"icon-"</code>.</p>
</div></td></tr><tr class="jsdoc-arg"><td>symbol</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>An <code>SVGSymbolElement</code> or an object to pass to <a class="jsdoc-link" href="#koru/dom.html">Dom.html</a> as the
contents of a symbol. <code>id</code> will be set on the symbol.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SvgIcons</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/svg-icons"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">id</span>: <span class="s">'SVGIcons'</span>,
  <span class="na">style</span>: <span class="s">'display:hidden'</span>,
  <span class="na">svg</span>: {<span class="na">defs</span>: []},
}));
<span class="kd">const</span> <span class="no">d</span> <span class="o">=</span> <span class="s">'M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z'</span>;
<span class="nx">SVGIcons</span>.<span class="na">add</span>(<span class="s">'hamburger-menu'</span>, {<span class="na">path</span>: [], <span class="na">d</span>});

<span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'#SVGIcons&gt;defs&gt;symbol#icon-hamburger-menu'</span>, (<span class="nv">sym</span>) <span class="o">=&gt;</span> {
  <span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sym</span>.<span class="na">getAttribute</span>(<span class="s">'viewBox'</span>), <span class="s">'0 0 24 24'</span>);
  <span class="nx">assert</span>.<span class="na">dom</span>(<span class="s">'path[d="'</span> <span class="o">+</span> <span class="nx">d</span> <span class="o">+</span> <span class="s">'"]'</span>);
});</div></div></pre></div></section><section id="koru/ui/svg-icons.createIcon" tabindex="-1" name="createIcon" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">SvgIcons.<span class="highlight"><span class="nf">createIcon</span>(<span class="nv">icon</span>, <span class="nv">title</span>)</span></h1><abstract><div><p>Create an svg element that uses a icon definition.</p>
<p>Note: all icons should be drawn for use with a viewBox of "0 0 24 24"</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>icon</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of an icon to use. the <code>use</code> element <code>xlink:href</code> is set to
<code>"#icon-"+icon</code>.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[title]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>adds a title element to the SVG.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SvgIcons</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/svg-icons"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">Dom</span>.<span class="na">h</span>({
  <span class="na">style</span>: <span class="s">'display:hidden'</span>,
  <span class="na">svg</span>: {<span class="na">defs</span>: {
    <span class="na">id</span>: <span class="s">'icon-hamburger-menu'</span>, <span class="na">viewBox</span>: <span class="s">'0 0 24 24'</span>,
    <span class="na">symbol</span>: {
      <span class="na">path</span>: [],
      <span class="na">d</span>: <span class="s">'M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z'</span>,
    },
  }},
}));
<span class="kd">const</span> <span class="no">svg</span> <span class="o">=</span> <span class="nx">SVGIcons</span>.<span class="na">createIcon</span>(<span class="s">'hamburger-menu'</span>, <span class="s">'Main menu'</span>);
<span class="nx">assert</span>(<span class="nx">svg</span>.<span class="na">classList</span>.<span class="na">contains</span>(<span class="s">'icon'</span>));

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">svg</span>.<span class="na">namespaceURI</span>, <span class="nx">Dom</span>.<span class="na">SVGNS</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">svg</span>.<span class="na">querySelector</span>(<span class="s">':scope&gt;title:first-child'</span>).<span class="na">textContent</span>, <span class="s">'Main menu'</span>);

<span class="kd">const</span> <span class="no">use</span> <span class="o">=</span> <span class="nx">svg</span>.<span class="na">querySelector</span>(<span class="s">'use'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">use</span>.<span class="na">getAttributeNS</span>(<span class="nx">Dom</span>.<span class="na">XLINKNS</span>, <span class="s">'href'</span>), <span class="s">'#icon-hamburger-menu'</span>);</div></div></pre></div></section><section id="koru/ui/svg-icons.selectMenuDecorator" tabindex="-1" name="selectMenuDecorator" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">SvgIcons.<span class="highlight"><span class="nf">selectMenuDecorator</span>({<span class="nv">icon</span>}, <span class="nv">elm</span>)</span></h1><abstract><div><p>selectMenuDecorator can be used as a <code>decorator</code> function option to
<a class="jsdoc-link" href="#koru/ui/select-menu.popup">select-menu.popup</a>. Any list item with a icon attribute will be given a svg icon with
a <code>&lt;use xlink:href="#icon"+item.icon /&gt;</code> body.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>icon</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>elm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SvgIcons</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/svg-icons"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">name</span> <span class="o">=</span> <span class="nx">document</span>.<span class="na">createTextNode</span>(<span class="s">'Close'</span>);
<span class="kd">const</span> <span class="no">li</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">h</span>({<span class="na">li</span>: [<span class="nx">name</span>]});
<span class="kd">const</span> <span class="no">item</span> <span class="o">=</span> {<span class="na">id</span>: <span class="s">'close'</span>, <span class="na">name</span>: <span class="s">'Close'</span>, <span class="na">icon</span>: <span class="s">'close-outline'</span>};

<span class="nx">SVGIcons</span>.<span class="na">selectMenuDecorator</span>(<span class="nx">item</span>, <span class="nx">name</span>);

<span class="kd">const</span> <span class="no">svg</span> <span class="o">=</span> <span class="nx">name</span>.<span class="na">previousSibling</span>;
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">svg</span>.<span class="na">querySelector</span>(<span class="s">'use'</span>).<span class="na">getAttributeNS</span>(<span class="nx">Dom</span>.<span class="na">XLINKNS</span>, <span class="s">'href'</span>),
            <span class="s">'#icon-close-outline'</span>);</div></div></pre></div></section><section id="koru/ui/svg-icons.setIcon" tabindex="-1" name="setIcon" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">SvgIcons.<span class="highlight"><span class="nf">setIcon</span>(<span class="nv">useElm</span>, <span class="nv">icon</span>)</span></h1><abstract><div><p>set the icon in a svg use element</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>useElm</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>icon</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SvgIcons</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/svg-icons"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">use</span> <span class="o">=</span> <span class="nx">SVGIcons</span>.<span class="na">use</span>(<span class="s">'hamburger-menu'</span>);

<span class="nx">SVGIcons</span>.<span class="na">setIcon</span>(<span class="nx">use</span>, <span class="s">'circle'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">use</span>.<span class="na">namespaceURI</span>, <span class="nx">Dom</span>.<span class="na">SVGNS</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">use</span>.<span class="na">getAttributeNS</span>(<span class="nx">Dom</span>.<span class="na">XLINKNS</span>, <span class="s">'href'</span>), <span class="s">'#icon-circle'</span>);</div></div></pre></div></section><section id="koru/ui/svg-icons.use" tabindex="-1" name="use" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">SvgIcons.<span class="highlight"><span class="nf">use</span>(<span class="nv">icon</span>, <span class="nv">attrs</span>)</span></h1><abstract><div><p>create a svg use element for an icon</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>icon</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[attrs]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_blank">Element</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">SvgIcons</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/svg-icons"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">use</span> <span class="o">=</span> <span class="nx">SVGIcons</span>.<span class="na">use</span>(<span class="s">'hamburger-menu'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">use</span>.<span class="na">namespaceURI</span>, <span class="nx">Dom</span>.<span class="na">SVGNS</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">use</span>.<span class="na">getAttributeNS</span>(<span class="nx">Dom</span>.<span class="na">XLINKNS</span>, <span class="s">'href'</span>), <span class="s">'#icon-hamburger-menu'</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/ui/time" data-env="client" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/ui/time">koru/ui/time</a><h1 class="jsdoc-module-title searchable">Time</h1><abstract><div><p>Utility methods for displaying date and time and for updating times relative to now</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">[object Object]</td><td></td><td class="jsdoc-info" data-env="client"><div><p>TZ</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/ui/time.fromNow" tabindex="-1" name="fromNow" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Time.<span class="highlight"><span class="nf">fromNow</span>(<span class="nv">date</span>)</span></h1><abstract><div><p>Print relative time in locale format. Also can be used as a template helper:</p>
<pre><code class="language-html"><div class="highlight">{{fromNow updatedAt}}</div>
</code></pre></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>date</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>the date to print relatively</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Time</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/time"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Time</span>.<span class="na">fromNow</span>(<span class="nx">util</span>.<span class="na">dateNow</span>() <span class="o">+</span> <span class="nx">util</span>.<span class="na">DAY</span>), <span class="s">'tomorrow'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Time</span>.<span class="na">fromNow</span>(<span class="k">new</span> <span class="nx">Date</span>(<span class="nx">util</span>.<span class="na">dateNow</span>() <span class="o">-</span> <span class="m">2</span><span class="o">*</span><span class="nx">util</span>.<span class="na">DAY</span>)), <span class="s">'2 days ago'</span>);</div></div></pre></div></section><section id="koru/ui/time.relTime" tabindex="-1" name="relTime" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Time.<span class="highlight"><span class="nf">relTime</span>(<span class="nv">time</span>)</span></h1><abstract><div><p>Print date and time in shortish locale format with times with 24 hours from now also
showing relative time.. Also can be used as a template helper:</p>
<pre><code class="language-html"><div class="highlight">{{relTime updatedAt}}</div>
</code></pre></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>time</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Time</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/time"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Time</span>.<span class="na">relTime</span>(<span class="nx">util</span>.<span class="na">dateNow</span>() <span class="o">-</span> <span class="m">20</span><span class="o">*</span><span class="m">60</span><span class="o">*</span><span class="m">60</span><span class="o">*</span><span class="m">1000</span>),
              <span class="s">'Aug 16, 2018 9:44 PM; 20 hours ago'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Time</span>.<span class="na">relTime</span>(<span class="nx">Date</span>.<span class="na">UTC</span>(<span class="m">2014</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">6</span>, <span class="m">5</span>)), <span class="s">'Apr 4, 2014 6:05 AM'</span>);

<span class="nx">uDate</span>.<span class="na">defaultLang</span> <span class="o">=</span> <span class="s">'fr'</span>;
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Time</span>.<span class="na">relTime</span>(<span class="nx">util</span>.<span class="na">dateNow</span>() <span class="o">+</span> <span class="m">120</span><span class="o">*</span><span class="m">1000</span>), <span class="s">'17 août 2018 17:46; dans 2 minutes'</span>);

<span class="nx">Time</span>.<span class="na">TZ</span> <span class="o">=</span> <span class="s">'America/Chicago'</span>;
<span class="nx">uDate</span>.<span class="na">defaultLang</span> <span class="o">=</span> <span class="s">'en-US'</span>;
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Time</span>.<span class="na">relTime</span>(<span class="nx">util</span>.<span class="na">dateNow</span>() <span class="o">+</span> <span class="m">120</span><span class="o">*</span><span class="m">1000</span>), <span class="s">'Aug 17, 2018 12:46 PM; in 2 minutes'</span>);</div></div></pre></div></section><section id="koru/ui/time.startDynTime" tabindex="-1" name="startDynTime" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Time.<span class="highlight"><span class="nf">startDynTime</span>()</span></h1><abstract><div><p>Start a recurring minute timer to update all elements of class <code>dynTime</code>. Updating is done
by calling <a class="jsdoc-link" href="#koru/ctx#updateElement">ctx#updateElement(element)</a> for each <a class="jsdoc-link" href="#koru/dom.ctx">Dom.ctx(element)</a></p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Time</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/time"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">stopTimeout</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">stub</span>(<span class="nx">koru</span>, <span class="s">'afTimeout'</span>).<span class="na">returns</span>(<span class="nx">stopTimeout</span>);
<span class="kd">let</span> <span class="nv">now</span> <span class="o">=</span> <span class="o">+</span><span class="nx">Date</span>.<span class="na">UTC</span>(<span class="m">2019</span>, <span class="m">10</span>, <span class="m">3</span>, <span class="m">14</span>, <span class="m">35</span>, <span class="m">12</span>); <span class="nx">intercept</span>(<span class="nx">util</span>, <span class="s">'dateNow'</span>, ()<span class="o">=&gt;</span><span class="nx">now</span>);
<span class="nx">Time</span>.<span class="na">startDynTime</span>();

<span class="kd">const</span> <span class="no">html</span> <span class="o">=</span> <span class="s">`
&lt;ul&gt;
  &lt;li class="dynTime"&gt;{{relTime time1}}&lt;/li&gt;
  &lt;li class="dynTime"&gt;{{fromNow time2}}&lt;/li&gt;
&lt;/ul&gt;`</span>;

<span class="kd">const</span> <span class="no">Tpl</span> <span class="o">=</span> <span class="nx">Dom</span>.<span class="na">newTemplate</span>(<span class="nx">TemplateCompiler</span>.<span class="na">toJavascript</span>(<span class="nx">html</span>, <span class="s">'DynTimeTest'</span>).<span class="na">toJson</span>());

<span class="nx">document</span>.<span class="na">body</span>.<span class="na">appendChild</span>(<span class="nx">Tpl</span>.<span class="na">$autoRender</span>({
  <span class="na">time1</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">+</span><span class="m">5</span><span class="o">*</span><span class="m">60</span><span class="o">*</span><span class="m">1000</span>),
  <span class="na">time2</span>: <span class="k">new</span> <span class="nx">Date</span>(<span class="nx">now</span> <span class="o">-</span><span class="m">2</span><span class="o">*</span><span class="m">60</span><span class="o">*</span><span class="m">1000</span>),
}));

<span class="kd">const</span> <span class="no">li1</span> <span class="o">=</span> <span class="nx">Dom</span>(<span class="s">'ul&gt;li:first-child'</span>);
<span class="kd">const</span> <span class="no">li2</span> <span class="o">=</span> <span class="nx">Dom</span>(<span class="s">'ul&gt;li:last-child'</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">li1</span>.<span class="na">textContent</span>, <span class="s">"Nov 3, 2019 2:40 PM; in 5 minutes"</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">li2</span>.<span class="na">textContent</span>, <span class="s">"2 minutes ago"</span>);

<span class="nx">now</span> <span class="o">+=</span> <span class="m">60</span><span class="o">*</span><span class="m">1000</span>;
<span class="nx">koru</span>.<span class="na">afTimeout</span>.<span class="na">yieldAndReset</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">li1</span>.<span class="na">textContent</span>, <span class="s">"Nov 3, 2019 2:40 PM; in 4 minutes"</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">li2</span>.<span class="na">textContent</span>, <span class="s">"3 minutes ago"</span>);

<span class="nx">now</span> <span class="o">+=</span> <span class="m">10</span><span class="o">*</span><span class="m">60</span><span class="o">*</span><span class="m">1000</span>;
<span class="nx">koru</span>.<span class="na">afTimeout</span>.<span class="na">yieldAndReset</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">li1</span>.<span class="na">textContent</span>, <span class="s">"Nov 3, 2019 2:40 PM; 6 minutes ago"</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">li2</span>.<span class="na">textContent</span>, <span class="s">"13 minutes ago"</span>);</div></div></pre></div></section><section id="koru/ui/time.stopDynTime" tabindex="-1" name="stopDynTime" data-env="client" class=" jsdoc-module-section"><h1 class="searchable">Time.<span class="highlight"><span class="nf">stopDynTime</span>()</span></h1><abstract><div><p>Cancel dynamic time updates (See <a class="jsdoc-link" href="#koru/ui/time.startDynTime">startDynTime</a>)</p>
</div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Time</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/ui/time"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">stopTimeout</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">stub</span>(<span class="nx">koru</span>, <span class="s">'afTimeout'</span>).<span class="na">returns</span>(<span class="nx">stopTimeout</span>);
<span class="nx">Time</span>.<span class="na">startDynTime</span>();
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">koru</span>.<span class="na">afTimeout</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">stopTimeout</span>);
<span class="nx">Time</span>.<span class="na">stopDynTime</span>();
<span class="nx">assert</span>.<span class="na">calledOnce</span>(<span class="nx">stopTimeout</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/uint8-array-builder" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/uint8-array-builder">koru/uint8-array-builder</a><h1 class="jsdoc-module-title searchable">Uint8ArrayBuilder</h1><abstract><div><p>Build an Uint8Array with dynamic sizing.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">#dataView</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="both"><div><p>Use a dataView over the interal ArrayBuffer</p>
</div></td></tr><tr><td class="searchable">#length</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><p>The length of <code>#subarray</code>. It can only be reduced; increasing throws an error.</p>
</div></td></tr><tr><td class="searchable">#subarray</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info" data-env="both"><div><p>The Uint8Array containing appended data</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/uint8-array-builder.constructor" name="constructor" tabindex="-1" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">constructor</span>(<span class="nv">initialCapacity</span><span class="o">=</span><span class="m">4</span>)</span></h1><abstract><div><p>Create a Uint8ArrayBuilder</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[initialCapacity]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example highlight"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Uint8ArrayBuilder</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/uint8-array-builder"</span>);</div><div><div class="highlight"><span class="kd">const</span> <span class="no">b1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8ArrayBuilder</span>();
<span class="nx">b1</span>.<span class="na">set</span>(<span class="m">0</span>, <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b1</span>.<span class="na">initialCapacity</span>, <span class="m">4</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b1</span>.<span class="na">currentCapacity</span>, <span class="m">4</span>);
<span class="nx">b1</span>.<span class="na">set</span>(<span class="m">4</span>, <span class="m">2</span>);

<span class="kd">const</span> <span class="no">b2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8ArrayBuilder</span>(<span class="m">2</span>);
<span class="nx">b2</span>.<span class="na">set</span>(<span class="m">0</span>, <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b2</span>.<span class="na">initialCapacity</span>, <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b2</span>.<span class="na">currentCapacity</span>, <span class="m">2</span>);</div></div></pre></div></section><section id="koru/uint8-array-builder#append" tabindex="-1" name="#append" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Uint8ArrayBuilder#<span class="highlight"><span class="nf">append</span>(<span class="nv">data</span>)</span></h1><abstract><div><p>Append a Uint8Array to the builder</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>data</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array" target="_blank">Uint8Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/uint8-array-builder">Uint8ArrayBuilder</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Uint8ArrayBuilder</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/uint8-array-builder"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8ArrayBuilder</span>();

<span class="nx">b</span>.<span class="na">append</span>([]);

<span class="nx">b</span>.<span class="na">set</span>(<span class="m">0</span>, <span class="m">16</span>);

<span class="nx">b</span>.<span class="na">append</span>(<span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>]));

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">b</span>.<span class="na">subarray</span>(), <span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">16</span>, <span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>]));

<span class="nx">b</span>.<span class="na">append</span>(<span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">5</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>, <span class="m">9</span>, <span class="m">10</span>, <span class="m">11</span>, <span class="m">12</span>, <span class="m">13</span>, <span class="m">14</span>]));

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">b</span>.<span class="na">subarray</span>(), <span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">16</span>, <span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>, <span class="m">9</span>, <span class="m">10</span>, <span class="m">11</span>, <span class="m">12</span>, <span class="m">13</span>, <span class="m">14</span>]));
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b</span>.<span class="na">currentCapacity</span>, <span class="m">30</span>);</div></div></pre></div></section><section id="koru/uint8-array-builder#get" tabindex="-1" name="#get" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Uint8ArrayBuilder#<span class="highlight"><span class="nf">get</span>(<span class="nv">index</span>)</span></h1><abstract><div><p>get an existing byte in array.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>index</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Uint8ArrayBuilder</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/uint8-array-builder"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">b1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8ArrayBuilder</span>();
<span class="nx">b1</span>.<span class="na">push</span>(<span class="m">1</span>, <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b1</span>.<span class="na">get</span>(<span class="m">1</span>), <span class="m">2</span>);</div></div></pre></div></section><section id="koru/uint8-array-builder#push" tabindex="-1" name="#push" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Uint8ArrayBuilder#<span class="highlight"><span class="nf">push</span>(...<span class="nv">bytes</span>)</span></h1><abstract><div><p>Push byte(s) to end of array;</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>bytes</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/uint8-array-builder">Uint8ArrayBuilder</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Uint8ArrayBuilder</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/uint8-array-builder"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8ArrayBuilder</span>();

<span class="nx">b</span>.<span class="na">push</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>);
<span class="nx">b</span>.<span class="na">push</span>(<span class="m">4</span>, <span class="m">5</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">b</span>.<span class="na">subarray</span>(), <span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">5</span>]));</div></div></pre></div></section><section id="koru/uint8-array-builder#set" tabindex="-1" name="#set" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Uint8ArrayBuilder#<span class="highlight"><span class="nf">set</span>(<span class="nv">index</span>, <span class="nv">byte</span>)</span></h1><abstract><div><p>Set an existing byte in array.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>index</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>byte</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Uint8ArrayBuilder</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/uint8-array-builder"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">b1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8ArrayBuilder</span>();
<span class="nx">b1</span>.<span class="na">push</span>(<span class="m">1</span>, <span class="m">2</span>);
<span class="nx">b1</span>.<span class="na">set</span>(<span class="m">1</span>, <span class="m">3</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">b1</span>.<span class="na">subarray</span>()), [<span class="m">1</span>, <span class="m">3</span>]);

<span class="nx">b1</span>.<span class="na">set</span>(<span class="m">2</span>, <span class="m">4</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">b1</span>.<span class="na">subarray</span>()), [<span class="m">1</span>, <span class="m">3</span>, <span class="m">4</span>]);</div></div></pre></div></section><section id="koru/uint8-array-builder#setArray" tabindex="-1" name="#setArray" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Uint8ArrayBuilder#<span class="highlight"><span class="nf">setArray</span>(<span class="nv">data</span>, <span class="nv">offset</span> <span class="o">=</span> <span class="m">0</span>)</span></h1><abstract><div><p>Set a Uint8Array into the builder at offset</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>data</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array" target="_blank">Uint8Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[offset]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="#koru/uint8-array-builder">Uint8ArrayBuilder</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Uint8ArrayBuilder</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/uint8-array-builder"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8ArrayBuilder</span>();

<span class="nx">b</span>.<span class="na">append</span>([]);

<span class="nx">b</span>.<span class="na">set</span>(<span class="m">0</span>, <span class="m">16</span>);

<span class="nx">b</span>.<span class="na">setArray</span>(<span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>]), <span class="m">6</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">b</span>.<span class="na">subarray</span>(), <span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">16</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>]));

<span class="nx">b</span>.<span class="na">setArray</span>(<span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">5</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>, <span class="m">9</span>]), <span class="m">3</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">b</span>.<span class="na">subarray</span>(), <span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">16</span>, <span class="m">0</span>, <span class="m">0</span>, <span class="m">5</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>, <span class="m">9</span>, <span class="m">3</span>, <span class="m">4</span>]));

<span class="nx">b</span>.<span class="na">setArray</span>(<span class="nx">b</span>.<span class="na">subarray</span>(<span class="m">4</span>));
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">b</span>.<span class="na">subarray</span>(), <span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>, <span class="m">9</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">8</span>, <span class="m">9</span>, <span class="m">3</span>, <span class="m">4</span>]));

<span class="nx">b</span>.<span class="na">setArray</span>(<span class="nx">b</span>.<span class="na">subarray</span>(<span class="m">0</span>, <span class="m">4</span>), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">b</span>.<span class="na">subarray</span>(), <span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">6</span>, <span class="m">7</span>, <span class="m">6</span>, <span class="m">7</span>, <span class="m">8</span>, <span class="m">9</span>, <span class="m">8</span>, <span class="m">9</span>, <span class="m">3</span>, <span class="m">4</span>]));

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b</span>.<span class="na">currentCapacity</span>, <span class="m">20</span>);</div></div></pre></div></section><section id="koru/uint8-array-builder#subarray" tabindex="-1" name="#subarray" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">Uint8ArrayBuilder#<span class="highlight"><span class="nf">subarray</span>(<span class="nv">spos</span><span class="o">=</span><span class="m">0</span>, <span class="nv">epos</span><span class="o">=</span><span class="k">this</span>.<span class="na">length</span>)</span></h1><abstract><div><p>Return the built array. It contains the same <code>ArrayBuffer</code> store as the interal <code>Uint8Array</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[spos]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[epos]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array" target="_blank">Uint8Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">Uint8ArrayBuilder</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/uint8-array-builder"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">b1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8ArrayBuilder</span>();
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">b1</span>.<span class="na">subarray</span>()), []);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b1</span>.<span class="na">subarray</span>(), <span class="nx">b1</span>.<span class="na">subarray</span>());

<span class="nx">b1</span>.<span class="na">push</span>(<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">5</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">b1</span>.<span class="na">subarray</span>()), [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">5</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Array</span>.<span class="na">from</span>(<span class="nx">b1</span>.<span class="na">subarray</span>(<span class="m">2</span>, <span class="m">4</span>)), [<span class="m">3</span>, <span class="m">4</span>]);

<span class="nx">assert</span>(<span class="nx">b1</span>.<span class="na">subarray</span>() <span class="o">instanceof</span> <span class="nx">Uint8Array</span>);
<span class="nx">refute</span>.<span class="na">same</span>(<span class="nx">b1</span>.<span class="na">subarray</span>(), <span class="nx">b1</span>.<span class="na">subarray</span>());
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">b1</span>.<span class="na">subarray</span>().<span class="na">buffer</span>, <span class="nx">b1</span>.<span class="na">subarray</span>().<span class="na">buffer</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/util" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/util">koru/util</a><h1 class="jsdoc-module-title searchable">util</h1><abstract><div><p>The <code>util</code> module provides commonly performed utility functions.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">DAY</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><p>The number of milliseconds in a day.</p>
</div></td></tr><tr><td class="searchable">EMAIL_RE</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp" target="_blank">RegExp</a></td><td class="jsdoc-info" data-env="both"><div><p>RegExp to match email addresses</p>
</div></td></tr><tr><td class="searchable">idLen</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info" data-env="both"><div><ol start="17">
<li>The length of an <code>_id</code> in characters.</li>
</ol>
</div></td></tr><tr><td class="searchable">thread</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info" data-env="server"><div><p>An object associated with the current
<a href="https://nodejs.org/api/async_context.html#class-asynclocalstorage" target="_blank">AsyncLocalStorage</a>.</p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/util.addItem" tabindex="-1" name="addItem" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">addItem</span>(<span class="nv">list</span>, <span class="nv">item</span>)</span></h1><abstract><div><p>Add <code>item</code> to <code>list</code> if <code>list</code> does not already contain <code>item</code>.
If <code>item</code> is added to <code>list</code>, return <code>undefined</code>. If <code>list</code> already
contains <code>item</code>, return the index of <code>item</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>list</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the list to add <code>item</code> to</p>
</div></td></tr><tr class="jsdoc-arg"><td>item</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the item to add to <code>list</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>Returns <code>undefined</code> if <code>item</code> is added to <code>list</code>.
Returns the index of <code>item</code> if <code>list</code> already contains <code>item</code>.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> [<span class="s">'a'</span>, <span class="s">'b'</span>];

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">addItem</span>(<span class="nx">list</span>, <span class="s">'b'</span>), <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">addItem</span>(<span class="nx">list</span>, <span class="s">'a'</span>), <span class="m">0</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>, [<span class="s">'a'</span>, <span class="s">'b'</span>]);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">addItem</span>(<span class="nx">list</span>, {<span class="na">aa</span>: <span class="m">123</span>}), <span class="kc">undefined</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>, [<span class="s">'a'</span>, <span class="s">'b'</span>, {<span class="na">aa</span>: <span class="m">123</span>}]);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">addItem</span>(<span class="nx">list</span>, {<span class="na">aa</span>: <span class="m">123</span>}), <span class="m">2</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">list</span>, [<span class="s">'a'</span>, <span class="s">'b'</span>, {<span class="na">aa</span>: <span class="m">123</span>}]);</div></div></pre></div></section><section id="koru/util.arrayToMap" tabindex="-1" name="arrayToMap" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">arrayToMap</span>(<span class="nv">list</span>)</span></h1><abstract><div><p>convert an array of strings to an <code>object</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[list]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">[String]</a></td><td class="jsdoc-info"><div><p>the array to convert</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>with its properties named the <code>list</code> elements and values of true.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">arrayToMap</span>(), {});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">arrayToMap</span>([<span class="s">'a'</span>, <span class="s">'b'</span>, <span class="s">'d'</span>]), {<span class="na">a</span>: <span class="kc">true</span>, <span class="na">b</span>: <span class="kc">true</span>, <span class="na">d</span>: <span class="kc">true</span>});</div></div></pre></div></section><section id="koru/util.assignOption" tabindex="-1" name="assignOption" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">assignOption</span>(<span class="nv">obj</span> <span class="o">=</span> {}, <span class="nv">options</span>, <span class="nv">name</span>, <span class="nv">def</span>)</span></h1><abstract><div><p>Assign an option to an object with optional default.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>options</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the options to select from.</p>
</div></td></tr><tr class="jsdoc-arg"><td>name</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the name of the option to set.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[def]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>the default to use if <code>name</code> not in <code>options</code>. If def is a function it will be
called to get the value.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the object.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">options</span> <span class="o">=</span> {<span class="na">a</span>: <span class="m">123</span>, <span class="na">b</span>: <span class="m">456</span>, <span class="na">e</span>: <span class="o">void</span> <span class="m">0</span>};

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">assignOption</span>(<span class="o">void</span> <span class="m">0</span>, <span class="nx">options</span>, <span class="s">'a'</span>), {<span class="na">a</span>: <span class="m">123</span>});

<span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> {<span class="na">a</span>: <span class="m">1</span>, <span class="na">c</span>: <span class="m">777</span>};
<span class="kd">const</span> <span class="no">ao</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">assignOption</span>.<span class="na">bind</span>(<span class="kc">null</span>, <span class="nx">obj</span>, <span class="nx">options</span>);
<span class="nx">ao</span>(<span class="s">'a'</span>);
<span class="nx">ao</span>(<span class="s">'c'</span>);
<span class="nx">ao</span>(<span class="s">'d'</span>, () <span class="o">=&gt;</span> <span class="m">444</span>);
<span class="nx">ao</span>(<span class="s">'d'</span>, () <span class="o">=&gt;</span> <span class="m">555</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">obj</span>, {<span class="na">a</span>: <span class="m">123</span>, <span class="na">c</span>: <span class="m">777</span>, <span class="na">d</span>: <span class="m">444</span>});
<span class="nx">obj</span>.<span class="na">e</span> <span class="o">=</span> <span class="m">222</span>;
<span class="nx">ao</span>(<span class="s">'e'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">obj</span>, {<span class="na">a</span>: <span class="m">123</span>, <span class="na">c</span>: <span class="m">777</span>, <span class="na">d</span>: <span class="m">444</span>, <span class="na">e</span>: <span class="o">void</span> <span class="m">0</span>});</div></div></pre></div></section><section id="koru/util.asyncArrayFrom" tabindex="-1" name="asyncArrayFrom" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.async asyncArrayFrom(asyncIterator)</h1><abstract><div><p>Convert an async iterator into an Array</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>asyncIterator</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">Function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Promise(Array)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight">async <span class="kd">function</span> *<span class="nf">asyncIter</span>() {
  <span class="k">yield</span> <span class="k">await</span> <span class="m">1</span>;
  <span class="k">yield</span> <span class="k">await</span> <span class="m">2</span>;
}

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="k">await</span> <span class="nx">util</span>.<span class="na">asyncArrayFrom</span>(<span class="nx">asyncIter</span>()), [<span class="m">1</span>, <span class="m">2</span>]);</div></div></pre></div></section><section id="koru/util.binarySearch" tabindex="-1" name="binarySearch" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">binarySearch</span>(<span class="nv">list</span>, <span class="nv">compare</span>, <span class="nv">start</span> <span class="o">=</span> <span class="nx">list</span>.<span class="na">length</span> <span class="o">&gt;&gt;</span> <span class="m">1</span>, <span class="nv">lower</span> <span class="o">=</span> <span class="m">0</span>, <span class="nv">upper</span> <span class="o">=</span> <span class="nx">list</span>.<span class="na">length</span>)</span></h1><abstract><div><p>Perform a binary search over a sorted <code>list</code> and return the closest index with a &lt;= 0
<code>compare</code> result.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>list</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>compare</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[start]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[lower]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[upper]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>([], (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">assert</span>(<span class="kc">false</span>)), <span class="o">-</span><span class="m">1</span>);

<span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">3</span>, <span class="m">6</span>, <span class="m">8</span>, <span class="m">10</span>, <span class="m">13</span>, <span class="m">15</span>];
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>], (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="m">1</span>, <span class="m">0</span>), <span class="o">-</span><span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>], (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="o">-</span><span class="m">1</span>, <span class="m">0</span>), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">0</span>), <span class="o">-</span><span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">1</span>), <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">16</span>), <span class="m">6</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">5</span>), <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">6</span>, <span class="m">0</span>), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">10</span>), <span class="m">4</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">14</span>), <span class="m">5</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">8</span>, <span class="o">-</span><span class="m">1</span>), <span class="m">3</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">binarySearch</span>(<span class="nx">list</span>, (<span class="nv">row</span>) <span class="o">=&gt;</span> <span class="nx">row</span> <span class="o">-</span> <span class="m">8</span>, <span class="m">7</span>), <span class="m">3</span>);</div></div></pre></div></section><section id="koru/util.compareNumber" tabindex="-1" name="compareNumber" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">compareNumber</span>(<span class="nv">a</span>, <span class="nv">b</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>a</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>b</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">array</span> <span class="o">=</span> [<span class="m">3</span>, <span class="m">5</span>, <span class="m">2</span>, <span class="m">1</span>];
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">array</span>.<span class="na">sort</span>(<span class="nx">util</span>.<span class="na">compareNumber</span>), [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">5</span>]);</div></div></pre></div></section><section id="koru/util.createDictionary" tabindex="-1" name="createDictionary" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">createDictionary</span>()</span></h1><abstract><div><p>Create an object that hints to the VM that it will be used as a dynamic dictionary
rather than as a class.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a new object with no prototype</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">dict</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">createDictionary</span>();
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Object</span>.<span class="na">getPrototypeOf</span>(<span class="nx">dict</span>), <span class="kc">null</span>);
<span class="nx">assert</span>(<span class="nx">util</span>.<span class="na">isObjEmpty</span>(<span class="nx">dict</span>));
<span class="nx">assert</span>(<span class="nx">dict</span> <span class="o">&amp;&amp;</span> <span class="o">typeof</span> <span class="nx">dict</span> <span class="o">===</span> <span class="s">'object'</span>);</div></div></pre></div></section><section id="koru/util.diff" tabindex="-1" name="diff" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">diff</span>(<span class="nv">list1</span>, <span class="nv">list2</span>)</span></h1><abstract><div><p>Create a list of all the elements of <code>list1</code> that are not also elements of <code>list2</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[list1]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a list</p>
</div></td></tr><tr class="jsdoc-arg"><td>[list2]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>another list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a list of all the elements of <code>list1</code> that are not also elements of <code>list2</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diff</span>(), []);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diff</span>([<span class="m">1</span>, <span class="m">2</span>]), [<span class="m">1</span>, <span class="m">2</span>]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diff</span>([<span class="m">1</span>, <span class="s">'2'</span>, <span class="m">3</span>, <span class="kc">null</span>], [<span class="s">'2'</span>, <span class="m">4</span>]), [<span class="m">1</span>, <span class="m">3</span>, <span class="kc">null</span>]);</div></div></pre></div></section><section id="koru/util.diffString" tabindex="-1" name="diffString" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">diffString</span>(<span class="nv">oldstr</span>, <span class="nv">newstr</span>)</span></h1><abstract><div><p>Find the difference between <code>oldstr</code> and <code>newstr</code>. Return <code>undefined</code> if <code>oldstr</code> and
<code>newstr</code> are the same; otherwise return an array of three numbers:</p>
<ol>
<li>the index of the first non-matching character in oldstr and newstr</li>
<li>the length of the segment of <code>oldstr</code> that doesn't match <code>newstr</code></li>
<li>the length of the segment of <code>newstr</code> that doesn't match <code>oldstr</code></li>
</ol>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>oldstr</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>a string</p>
</div></td></tr><tr class="jsdoc-arg"><td>newstr</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>another string</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">undefined</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p><code>undefined</code> if <code>oldstr</code> and <code>newstr</code> are the same, otherwise an
array of three numbers:</p>
<ol>
<li>the index of the first non-matching character in oldstr and newstr</li>
<li>the length of the segment of <code>oldstr</code> that doesn't match <code>newstr</code></li>
<li>the length of the segment of <code>newstr</code> that doesn't match <code>oldstr</code></li>
</ol>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'it1'</span>, <span class="s">'it21'</span>), [<span class="m">2</span>, <span class="m">0</span>, <span class="m">1</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'it1'</span>, <span class="s">'zit21z'</span>), [<span class="m">0</span>, <span class="m">3</span>, <span class="m">6</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'it21'</span>, <span class="s">'it1'</span>), [<span class="m">2</span>, <span class="m">1</span>, <span class="m">0</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'cl 123.2'</span>, <span class="s">'cl 123'</span>), [<span class="m">6</span>, <span class="m">2</span>, <span class="m">0</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'h💣el💣 world'</span>, <span class="s">'h💣elo wor💣ld'</span>), [<span class="m">5</span>, <span class="m">6</span>, <span class="m">7</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'h💣el💣 world'</span>, <span class="s">'h💣el💤 wor💣ld'</span>), [<span class="m">5</span>, <span class="m">6</span>, <span class="m">8</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'helo worlld'</span>, <span class="s">'hello world'</span>), [<span class="m">3</span>, <span class="m">6</span>, <span class="m">6</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'hello world'</span>, <span class="s">'helo worlld'</span>), [<span class="m">3</span>, <span class="m">6</span>, <span class="m">6</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffString</span>(<span class="s">'hello world'</span>, <span class="s">'hello world'</span>), <span class="kc">undefined</span>);</div></div></pre></div></section><section id="koru/util.diffStringLength" tabindex="-1" name="diffStringLength" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">diffStringLength</span>(<span class="nv">oldstr</span>, <span class="nv">newstr</span>)</span></h1><abstract><div><p>In the longer of <code>oldstr</code> and <code>newstr</code>, find the length of the segment that doesn't
match the other string.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>oldstr</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>a string</p>
</div></td></tr><tr class="jsdoc-arg"><td>newstr</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>another string</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p><code>0</code> if <code>oldstr</code> and <code>newstr</code> are the same, otherwise the length of the segment,
in the longer of <code>oldstr</code> and <code>newstr</code>, that doesn't match the other string</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffStringLength</span>(<span class="s">'h💣elo wor💣ld'</span>, <span class="s">'h💣el💣 world'</span>), <span class="m">7</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffStringLength</span>(<span class="s">'h💣el💣 world'</span>, <span class="s">'h💣elo wor💣ld'</span>), <span class="m">7</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">diffStringLength</span>(<span class="s">'hello world'</span>, <span class="s">'hello world'</span>), <span class="m">0</span>);</div></div></pre></div></section><section id="koru/util.extractError" tabindex="-1" name="extractError" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">extractError</span>(<span class="nv">err</span>)</span></h1><abstract><div><p>Extract the error message and normalized stack trace from an exception. If the error has a
property called <code>toStringPrefix</code> it will prefix the error message</p>
<p>See <a class="jsdoc-link" href="#koru/stacktrace">Stacktrace</a></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>err</td><td><a href="#koru/test/core::AssertionError">AssertionError</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">inner1</span> <span class="o">=</span> () <span class="o">=&gt;</span> <span class="nx">inner2</span>();
<span class="kd">const</span> <span class="no">inner2</span> <span class="o">=</span> () <span class="o">=&gt;</span> {
  <span class="k">return</span> <span class="k">new</span> <span class="nx">AssertionError</span>(<span class="s">'Testing 123'</span>);
};
<span class="kd">const</span> <span class="no">err</span> <span class="o">=</span> <span class="nx">inner1</span>();

<span class="nx">err</span>.<span class="na">toStringPrefix</span> <span class="o">=</span> <span class="s">'A string to prefix the message\n'</span>;

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">extractError</span>(<span class="nx">err</span>).<span class="na">split</span>(<span class="s">'\n'</span>), [
  <span class="s">'A string to prefix the message'</span>,
  <span class="s">'AssertionError: Testing 123'</span>,
  <span class="cs">// the "at - " is to distinguish the first frame for editors</span>
  <span class="nx">m</span>(<span class="sr">/    at - inner2 \(koru\/util-test.js:\d+:16\)/</span>),
  <span class="nx">m</span>(<span class="sr">/    at inner1 \(koru\/util-test.js:\d+:28\)/</span>),
  <span class="nx">m</span>(<span class="sr">/    at .* \(koru\/util-test.js:\d+:19\)/</span>),
]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">extractError</span>(<span class="s">'plain string'</span>), <span class="s">'plain string'</span>);</div></div></pre></div></section><section id="koru/util.extractKeys" tabindex="-1" name="extractKeys" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">extractKeys</span>(<span class="nv">obj</span>, <span class="nv">keys</span>)</span></h1><abstract><div><p>Create an object made up of the properties in <code>obj</code> whose keys are named in <code>keys</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the object from which to collect properties</p>
</div></td></tr><tr class="jsdoc-arg"><td>keys</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a collection of keys or properties whose names identify which properties to collect
from <code>obj</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object made up of the properties in <code>obj</code> whose keys are named in <code>keys</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(
  <span class="nx">util</span>.<span class="na">extractKeys</span>({<span class="na">a</span>: <span class="m">4</span>, <span class="na">b</span>: <span class="s">'abc'</span>, <span class="k">get</span> <span class="nf">c</span>() {<span class="k">return</span> {<span class="na">value</span>: <span class="kc">true</span>}}}, [<span class="s">'a'</span>, <span class="s">'c'</span>, <span class="s">'e'</span>]),
  {<span class="na">a</span>: <span class="m">4</span>, <span class="na">c</span>: {<span class="na">value</span>: <span class="kc">true</span>}},
);
<span class="nx">assert</span>.<span class="na">equals</span>(
  <span class="nx">util</span>.<span class="na">extractKeys</span>({<span class="na">a</span>: <span class="m">4</span>, <span class="na">b</span>: <span class="s">'abc'</span>, <span class="k">get</span> <span class="nf">c</span>() {<span class="k">return</span> {<span class="na">value</span>: <span class="kc">true</span>}}}, {<span class="na">a</span>: <span class="kc">true</span>, <span class="na">c</span>: <span class="kc">false</span>, <span class="na">e</span>: <span class="kc">null</span>}),
  {<span class="na">a</span>: <span class="m">4</span>, <span class="na">c</span>: {<span class="na">value</span>: <span class="kc">true</span>}},
);</div></div></pre></div></section><section id="koru/util.extractNotKeys" tabindex="-1" name="extractNotKeys" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">extractNotKeys</span>(<span class="nv">obj</span>, <span class="nv">keys</span>)</span></h1><abstract><div><p>Create an object made up of the properties in <code>obj</code> whose keys are not named in
<code>keys</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the object from which to collect properties</p>
</div></td></tr><tr class="jsdoc-arg"><td>keys</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a collection of properties whose names identify which properties not to
collect from <code>obj</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object made up of the properties in <code>obj</code> whose keys are not named in <code>keys</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(
  <span class="nx">util</span>.<span class="na">extractNotKeys</span>({<span class="na">a</span>: <span class="m">4</span>, <span class="na">b</span>: <span class="s">'abc'</span>, <span class="k">get</span> <span class="nf">c</span>() {<span class="k">return</span> {<span class="na">value</span>: <span class="kc">true</span>}}}, {<span class="na">a</span>: <span class="kc">true</span>, <span class="na">e</span>: <span class="kc">true</span>}),
  {<span class="na">b</span>: <span class="s">'abc'</span>, <span class="na">c</span>: {<span class="na">value</span>: <span class="kc">true</span>}},
);</div></div></pre></div></section><section id="koru/util.firstParam" tabindex="-1" name="firstParam" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">firstParam</span>(<span class="nv">obj</span>)</span></h1><abstract><div><p>Return the value of the first property in <code>obj</code>. Or if <code>obj</code> is empty return
<code>undefined</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[obj]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the value of the first property in <code>obj</code>, or <code>undefined</code> if
<code>obj</code> is empty</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">firstParam</span>({<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">2</span>}), <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">firstParam</span>({}), <span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">firstParam</span>(), <span class="kc">undefined</span>);</div></div></pre></div></section><section id="koru/util.forEach" tabindex="-1" name="forEach" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">forEach</span>(<span class="nv">list</span>, <span class="nv">visitor</span>)</span></h1><abstract><div><p>Execute <code>visitor</code> once for each element in <code>list</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>list</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div><p>a list</p>
</div></td></tr><tr class="jsdoc-arg"><td>visitor</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a function taking two arguments: the value of the current element in <code>list</code>,
and the index of that current element</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">results</span> <span class="o">=</span> [];
<span class="nx">util</span>.<span class="na">forEach</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>], (<span class="nv">val</span>, <span class="nv">index</span>) <span class="o">=&gt;</span> {<span class="nx">results</span>.<span class="na">push</span>(<span class="nx">val</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="nx">index</span>)});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">results</span>, [<span class="s">'1.0'</span>, <span class="s">'2.1'</span>, <span class="s">'3.2'</span>]);

<span class="cs">// ignores null list</span>
<span class="kd">const</span> <span class="no">callback</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">util</span>.<span class="na">forEach</span>(<span class="kc">null</span>, <span class="nx">callback</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">callback</span>);</div></div></pre></div></section><section id="koru/util.hasOnly" tabindex="-1" name="hasOnly" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">hasOnly</span>(<span class="nv">obj</span>, <span class="nv">keyMap</span>)</span></h1><abstract><div><p>Determine if <code>obj</code> has only keys that are also in <code>keyMap</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object</p>
</div></td></tr><tr class="jsdoc-arg"><td>keyMap</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a set of key-value pairs</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p><code>true</code> if <code>obj</code> has only keys also in <code>keyMap</code>, otherwise <code>false</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">util</span>.<span class="na">hasOnly</span>({<span class="na">a</span>: <span class="m">1</span>}, {<span class="na">b</span>: <span class="kc">true</span>}));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">util</span>.<span class="na">hasOnly</span>({<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">1</span>}, {<span class="na">b</span>: <span class="kc">true</span>}));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">hasOnly</span>({<span class="na">b</span>: <span class="m">1</span>}, {<span class="na">b</span>: <span class="kc">true</span>}));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">hasOnly</span>({}, {<span class="na">b</span>: <span class="kc">true</span>}));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">hasOnly</span>({<span class="na">b</span>: <span class="m">1</span>, <span class="na">c</span>: <span class="m">2</span>}, {<span class="na">b</span>: <span class="kc">true</span>, <span class="na">c</span>: <span class="kc">false</span>}));</div></div></pre></div></section><section id="koru/util.ifPromise" tabindex="-1" name="ifPromise" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">ifPromise</span>(<span class="nv">object</span>, <span class="nv">trueCallback</span>, <span class="nv">falseCallbase</span><span class="o">=</span><span class="nx">trueCallback</span>)</span></h1><abstract><div><p>If <code>object</code> is a promise return <code>object.then(trueCallback)</code> otherwise return <code>falseCallbase(object)</code>.
This function is also on globalThis for convenience.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">Promise(number)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>trueCallback</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[falseCallbase]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">Promise(string)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">trueCallback</span> <span class="o">=</span> <span class="nx">stub</span>().<span class="na">returns</span>(<span class="s">'true called'</span>);
<span class="kd">const</span> <span class="no">falseCallback</span> <span class="o">=</span> <span class="nx">stub</span>().<span class="na">returns</span>(<span class="s">'false called'</span>);

<span class="kd">const</span> <span class="no">promise</span> <span class="o">=</span> <span class="nx">Promise</span>.<span class="na">resolve</span>(<span class="m">123</span>);
<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">ifPromise</span>(<span class="nx">promise</span>, <span class="nx">trueCallback</span>, <span class="nx">falseCallback</span>);
<span class="nx">assert</span>.<span class="na">isPromise</span>(<span class="nx">ans</span>);

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">trueCallback</span>);
<span class="k">await</span> <span class="nx">ans</span>;
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">trueCallback</span>, <span class="m">123</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">ifPromise</span>(<span class="m">456</span>, <span class="nx">trueCallback</span>), <span class="s">'true called'</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">trueCallback</span>, <span class="m">456</span>);

<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">falseCallback</span>);
<span class="nx">trueCallback</span>.<span class="na">reset</span>();

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">ifPromise</span>([<span class="m">789</span>], <span class="nx">trueCallback</span>, <span class="nx">falseCallback</span>), <span class="s">'false called'</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">trueCallback</span>);
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">falseCallback</span>, [<span class="m">789</span>]);</div></div></pre></div></section><section id="koru/util.indexOfRegex" tabindex="-1" name="indexOfRegex" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">indexOfRegex</span>(<span class="nv">list</span>, <span class="nv">value</span>, <span class="nv">fieldName</span>)</span></h1><abstract><div><p>Return the index of the first item in <code>list</code> that has a property <code>fieldName</code>
that contains a match for the regular expression <code>value</code>. Or if no match is
found return -1.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>list</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the list to search</p>
</div></td></tr><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp" target="_blank">RegExp</a></td><td class="jsdoc-info"><div><p>the regular expression to search <code>fieldName</code> for a match</p>
</div></td></tr><tr class="jsdoc-arg"><td>fieldName</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the property name to search for in each item in <code>list</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the index of the first item in <code>list</code> that has a property <code>fieldName</code> that
contains a match for the regular expression <code>value</code>, or -1 if <code>list</code> does not
contain such an item</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> [{<span class="na">foo</span>: <span class="s">'a'</span>}, {<span class="na">foo</span>: <span class="s">'cbc'</span>}];
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">indexOfRegex</span>(<span class="nx">list</span>, <span class="sr">/a/</span>, <span class="s">'foo'</span>), <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">indexOfRegex</span>(<span class="nx">list</span>, <span class="sr">/ab/</span>, <span class="s">'foo'</span>), <span class="o">-</span><span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">indexOfRegex</span>(<span class="nx">list</span>, <span class="sr">/b/</span>, <span class="s">'foo'</span>), <span class="m">1</span>);</div></div></pre></div></section><section id="koru/util.indexTolineColumn" tabindex="-1" name="indexTolineColumn" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">indexTolineColumn</span>(<span class="nv">text</span>, <span class="nv">index</span>)</span></h1><abstract><div><p>Convert <code>index</code> of <code>text</code> to a line number and a column number.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>text</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>index</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>item 0 is the line number (starting from 1) and item 1 is the column number
(starting from 0)</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">text</span> <span class="o">=</span> <span class="s">'line 1\nline 2\nline 3'</span>;

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">indexTolineColumn</span>(<span class="nx">text</span>, <span class="m">0</span>), [<span class="m">1</span>, <span class="m">0</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">indexTolineColumn</span>(<span class="nx">text</span>, <span class="m">4</span>), [<span class="m">1</span>, <span class="m">4</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">indexTolineColumn</span>(<span class="nx">text</span>, <span class="m">10</span>), [<span class="m">2</span>, <span class="m">3</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">indexTolineColumn</span>(<span class="nx">text</span>, <span class="nx">text</span>.<span class="na">length</span>), [<span class="m">3</span>, <span class="m">6</span>]);</div></div></pre></div></section><section id="koru/util.inspect" tabindex="-1" name="inspect" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">inspect</span>(<span class="nv">o</span>, <span class="nv">count</span><span class="o">=</span><span class="m">4</span>, <span class="nv">len</span><span class="o">=</span><span class="m">1000</span>)</span></h1><abstract><div><p>Convert any type to a displayable string. The symbol <code>inspect$</code> can be used to override
the value returned.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>o</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[count]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[len]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> {<span class="s">''</span>: <span class="m">0</span>, <span class="m">123</span>: <span class="m">1</span>, <span class="s">'a"b"`'</span>: <span class="m">2</span>, <span class="s">"a`'"</span>: <span class="m">3</span>, <span class="s">"a\"'`"</span>: <span class="m">4</span>, <span class="s">'\\a'</span>: <span class="m">5</span>};
<span class="nx">assert</span>.<span class="na">equals</span>(
  <span class="nx">util</span>.<span class="na">inspect</span>(<span class="nx">obj</span>),
  <span class="s">`{123: 1, '': 0, 'a"b"\`': 2, "a\`'": 3, "a\\"'\`": 4, '\\\\a': 5}`</span>);

<span class="kd">const</span> <span class="no">array</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>];
<span class="nx">assert</span>.<span class="na">equals</span>(
  <span class="nx">util</span>.<span class="na">inspect</span>(<span class="nx">array</span>),
  <span class="s">'[1, 2, 3]'</span>,
);

<span class="nx">array</span>[<span class="na">inspect$</span>] <span class="o">=</span> () <span class="o">=&gt;</span> <span class="s">'overridden'</span>;

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">inspect</span>(<span class="nx">array</span>), <span class="s">'overridden'</span>);</div></div></pre></div></section><section id="koru/util.intersectp" tabindex="-1" name="intersectp" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">intersectp</span>(<span class="nv">list1</span>, <span class="nv">list2</span>)</span></h1><abstract><div><p>Determine if two lists intersect.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>list1</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a list</p>
</div></td></tr><tr class="jsdoc-arg"><td>list2</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a second list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p><code>true</code> if <code>list1</code> and <code>list2</code> have any element in common, otherwise <code>false</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>(<span class="nx">util</span>.<span class="na">intersectp</span>([<span class="m">1</span>, <span class="m">4</span>], [<span class="m">4</span>, <span class="m">5</span>]));
<span class="nx">refute</span>(<span class="nx">util</span>.<span class="na">intersectp</span>([<span class="m">1</span>, <span class="m">2</span>], [<span class="s">'a'</span>]));</div></div></pre></div></section><section id="koru/util.isObjEmpty" tabindex="-1" name="isObjEmpty" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">isObjEmpty</span>(<span class="nv">obj</span>)</span></h1><abstract><div><p>Determine whether <code>obj</code> is empty.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[obj]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p><code>true</code> if <code>obj</code> is empty, otherwise <code>false</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">isObjEmpty</span>());
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">isObjEmpty</span>({}));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">util</span>.<span class="na">isObjEmpty</span>({<span class="na">a</span>: <span class="m">1</span>}));</div></div></pre></div></section><section id="koru/util.isPromise" tabindex="-1" name="isPromise" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">isPromise</span>(<span class="nv">object</span>)</span></h1><abstract><div><p>Return true is <code>object</code> is an object with a <code>then</code> function.
This function is also on globalThis for convenience.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined" target="_blank">Promise(undefined)</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">isPromise</span>(<span class="nx">Promise</span>.<span class="na">resolve</span>()));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">isPromise</span>({<span class="nf">then</span>() {}}));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">util</span>.<span class="na">isPromise</span>({<span class="na">then</span>: <span class="kc">true</span>}));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">util</span>.<span class="na">isPromise</span>(<span class="kc">null</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">util</span>.<span class="na">isPromise</span>(<span class="o">void</span> <span class="m">0</span>));</div></div></pre></div></section><section id="koru/util.itemIndex" tabindex="-1" name="itemIndex" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">itemIndex</span>(<span class="nv">list</span>, <span class="nv">item</span>)</span></h1><abstract><div><p>Return the index of the first element in <code>list</code> that matches
<code>item</code>. If <code>item</code> is an object, <code>itemIndex</code> returns the index of the first object in
<code>list</code> that contains all the key-value pairs that <code>item</code> contains. If no match is
found, -1 is returned.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>list</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the list to search</p>
</div></td></tr><tr class="jsdoc-arg"><td>item</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the item to search <code>list</code> for</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the index of <code>item</code> if <code>item</code> is in <code>list</code>, otherwise -1</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">list</span> <span class="o">=</span> [<span class="s">'a'</span>, <span class="s">'b'</span>, {<span class="na">one</span>: <span class="s">'c'</span>, <span class="na">two</span>: <span class="s">'d'</span>}];

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">itemIndex</span>(<span class="nx">list</span>, <span class="s">'b'</span>), <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">itemIndex</span>(<span class="nx">list</span>, <span class="s">'d'</span>), <span class="o">-</span><span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">itemIndex</span>(<span class="nx">list</span>, {<span class="na">one</span>: <span class="s">'c'</span>, <span class="na">two</span>: <span class="s">'d'</span>}), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">itemIndex</span>(<span class="nx">list</span>, {<span class="na">two</span>: <span class="s">'d'</span>}), <span class="m">2</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">itemIndex</span>(<span class="nx">list</span>, {<span class="na">one</span>: <span class="s">'e'</span>, <span class="na">two</span>: <span class="s">'d'</span>}), <span class="o">-</span><span class="m">1</span>);</div></div></pre></div></section><section id="koru/util.keyMatches" tabindex="-1" name="keyMatches" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">keyMatches</span>(<span class="nv">obj</span>, <span class="nv">regex</span>)</span></h1><abstract><div><p>Search for a property name in <code>obj</code> that matches <code>regex</code>. Test each enumerable
property name against <code>regex</code> util a match is found. Return the result array
from <code>regex.exec()</code> if a match is found, or <code>null</code> if not.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the object to search</p>
</div></td></tr><tr class="jsdoc-arg"><td>regex</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp" target="_blank">RegExp</a></td><td class="jsdoc-info"><div><p>the regular expression to match</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div><p>the result array from <code>regex.exec()</code> if a match is found, or <code>null</code> if not</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">keyMatches</span>({<span class="na">ab</span>: <span class="m">0</span>, <span class="na">bc</span>: <span class="m">0</span>, <span class="na">de</span>: <span class="m">0</span>}, <span class="sr">/^b(.)/</span>)[<span class="m">1</span>], <span class="s">'c'</span>);
<span class="nx">assert</span>.<span class="na">isNull</span>(<span class="nx">util</span>.<span class="na">keyMatches</span>({<span class="na">ab</span>: <span class="m">0</span>, <span class="na">bc</span>: <span class="m">0</span>, <span class="na">de</span>: <span class="m">0</span>}, <span class="sr">/^dee/</span>));</div></div></pre></div></section><section id="koru/util.keyStartsWith" tabindex="-1" name="keyStartsWith" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">keyStartsWith</span>(<span class="nv">obj</span>, <span class="nv">str</span>)</span></h1><abstract><div><p>Determine whether <code>obj</code> has a key that starts with <code>str</code>. Case sensitive.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the object to search</p>
</div></td></tr><tr class="jsdoc-arg"><td>str</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>the string to search for</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p><code>true</code> if a key is found that starts with <code>str</code>, otherwise <code>false</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">util</span>.<span class="na">keyStartsWith</span>(<span class="kc">null</span>, <span class="s">'foo'</span>));
<span class="nx">assert</span>.<span class="na">isFalse</span>(<span class="nx">util</span>.<span class="na">keyStartsWith</span>({<span class="na">foz</span>: <span class="m">1</span>, <span class="na">fizz</span>: <span class="m">2</span>}, <span class="s">'foo'</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">keyStartsWith</span>({<span class="na">faz</span>: <span class="kc">true</span>, <span class="na">fooz</span>: <span class="kc">undefined</span>, <span class="na">fizz</span>: <span class="m">2</span>}, <span class="s">'foo'</span>));
<span class="nx">assert</span>.<span class="na">isTrue</span>(<span class="nx">util</span>.<span class="na">keyStartsWith</span>({<span class="na">foo</span>: <span class="m">1</span>, <span class="na">fizz</span>: <span class="m">2</span>}, <span class="s">'foo'</span>));</div></div></pre></div></section><section id="koru/util.merge" tabindex="-1" name="merge" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">merge</span>(<span class="nv">dest</span>, <span class="nv">source</span>)</span></h1><abstract><div><p>Merge <code>source</code> into <code>dest</code>. That is, add each enumerable property in <code>source</code> to <code>dest</code>, or where a
property of that name already exists in <code>dest</code>, replace the property in <code>dest</code> with the
property from <code>source</code>. Return the modified <code>dest</code>.</p>
<section class="jsdoc-alias"><h1>Aliases</h1><p><code class="jsdoc-alias-term">extend</code> deprecated</p></section></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dest</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object to modify</p>
</div></td></tr><tr class="jsdoc-arg"><td>[source]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the properties to be added or modified</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>dest</code> modified: each enumerable property in <code>source</code> has been added to <code>dest</code>, or where
a property of that name already existed in <code>dest</code>, the property in <code>dest</code> has been
replaced with the property from <code>source</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call highlight"><div><span class="nx">util</span>.<span class="na">merge</span>(<span class="ge nx">{}</span>, <span class="ge nx">{a: 1, b: 2}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{a: 1, b: 2}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">util</span>.<span class="na">merge</span>(<span class="ge nx">{a: 1}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{a: 1}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">util</span>.<span class="na">merge</span>(<span class="ge nx">{a: 1, b: 2}</span>, <span class="ge nx">{b: 3, c: 4}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{a: 1, b: 3, c: 4}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">util</span>.<span class="na">merge</span>(<span class="ge nx">{a: 1, b: 2}</span>, <span class="ge nx">{b: 3, c: 4}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{b: 3, c: 4, a: 1}</span></span></div><div class="jsdoc-example-call highlight"><div><span class="nx">util</span>.<span class="na">merge</span>(<span class="ge nx">{d: 5}</span>, <span class="ge nx">{b: 3, c: 4, a: 1}</span>);</div><span class="jsdoc-returns c1"> // returns <span class="ge nx">{d: 5, b: 3, c: 4}</span></span></div></pre></div></section><section id="koru/util.mergeExclude" tabindex="-1" name="mergeExclude" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">mergeExclude</span>(<span class="nv">obj</span>, <span class="nv">properties</span>, <span class="nv">exclude</span>)</span></h1><abstract><div><p>Merge <code>properties</code> into <code>obj</code>, excluding properties in <code>exclude</code>.
That is, add each property in <code>properties</code>, excluding those that are in
<code>exclude</code>, to <code>obj</code>, or where a property of that name already exists in <code>obj</code>, replace
the property in <code>obj</code> with the property from <code>properties</code>. Return the modified <code>obj</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object to modify</p>
</div></td></tr><tr class="jsdoc-arg"><td>properties</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>properties to be added to or modified in <code>obj</code>, unless they are in <code>exclude</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>exclude</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>properties which are excluded from being added to or modified in <code>obj</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the modified <code>obj</code>.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">let</span> <span class="nv">item</span> <span class="o">=</span> <span class="m">5</span>,
    <span class="nv">sub</span> <span class="o">=</span> {<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">2</span>},
    <span class="nv">sup</span> <span class="o">=</span> {<span class="na">b</span>: <span class="m">3</span>, <span class="k">get</span> <span class="nf">c</span>() {<span class="k">return</span> <span class="nx">item</span>}, <span class="na">d</span>: <span class="m">4</span>, <span class="na">e</span>: <span class="m">5</span>};

<span class="nx">util</span>.<span class="na">mergeExclude</span>(<span class="nx">sub</span>, <span class="nx">sup</span>, {<span class="na">d</span>: <span class="o">void</span> <span class="m">0</span>, <span class="na">e</span>: <span class="kc">false</span>});

<span class="nx">item</span> <span class="o">=</span> <span class="m">6</span>;

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">a</span>, <span class="m">1</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">b</span>, <span class="m">3</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">sub</span>.<span class="na">c</span>, <span class="m">6</span>);
<span class="nx">refute</span>(<span class="nx">sub</span>.<span class="function hasOwnProperty() { [native code] }">hasOwnProperty</span>(<span class="s">'d'</span>));</div></div></pre></div></section><section id="koru/util.mergeInclude" tabindex="-1" name="mergeInclude" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">mergeInclude</span>(<span class="nv">obj</span>, <span class="nv">properties</span>, <span class="nv">include</span>)</span></h1><abstract><div><p>Merge the properties from <code>properties</code> that are named in <code>include</code> into <code>obj</code>. That is, add each
property in <code>properties</code> that is named in <code>include</code> to <code>obj</code>, or where a property of that name
already exists in <code>obj</code>, replace the property in <code>obj</code> with the property from <code>properties</code>.
Return the modified <code>obj</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object to modify</p>
</div></td></tr><tr class="jsdoc-arg"><td>properties</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>properties to be added to or modified in <code>obj</code> if they are named in <code>include</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>include</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">array</a></td><td class="jsdoc-info"><div><p>properties, or a list of property names, whose names identify
which properties from <code>properties</code> are to be added to or modified in <code>obj</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>obj</code> modified: each property in <code>properties</code> that is named in <code>include</code> has been added
to <code>obj</code>, or where a property of that name already existed in <code>obj</code>, the property in <code>obj</code>
has been replaced with the property from <code>properties</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">obj</span> <span class="o">=</span> {<span class="na">a</span>: <span class="m">1</span>, <span class="na">c</span>: <span class="m">2</span>};
<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">mergeInclude</span>(<span class="nx">obj</span>, {<span class="na">b</span>: <span class="m">2</span>, <span class="na">c</span>: <span class="m">3</span>, <span class="na">d</span>: <span class="m">4</span>}, {<span class="na">c</span>: <span class="kc">true</span>, <span class="na">d</span>: <span class="kc">true</span>, <span class="na">z</span>: <span class="kc">true</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, {<span class="na">a</span>: <span class="m">1</span>, <span class="na">c</span>: <span class="m">3</span>, <span class="na">d</span>: <span class="m">4</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">obj</span>, <span class="nx">ans</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">mergeInclude</span>({<span class="na">a</span>: <span class="m">1</span>, <span class="na">c</span>: <span class="m">2</span>}, {<span class="na">b</span>: <span class="m">2</span>, <span class="na">c</span>: <span class="m">3</span>, <span class="na">d</span>: <span class="m">4</span>}, [<span class="s">'c'</span>, <span class="s">'d'</span>, <span class="s">'z'</span>]),
              {<span class="na">a</span>: <span class="m">1</span>, <span class="na">c</span>: <span class="m">3</span>, <span class="na">d</span>: <span class="m">4</span>});</div></div></pre></div></section><section id="koru/util.mergeNoEnum" tabindex="-1" name="mergeNoEnum" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">mergeNoEnum</span>(<span class="nv">dest</span>, <span class="nv">source</span>)</span></h1><abstract><div><p>Merge <code>source</code> into <code>dest</code> and set <code>enumerable</code> to <code>false</code> for each added or modified
property. That is, add each enumerable property in <code>source</code> to <code>dest</code>, or where a
property of that name already exists in <code>dest</code>, replace the property in <code>dest</code> with the
property from <code>source</code>, and set <code>enumerable</code> to <code>false</code> for each. Return the modified <code>dest</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dest</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object to modify</p>
</div></td></tr><tr class="jsdoc-arg"><td>source</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the properties to be added or modified</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>dest</code> modified: each enumerable property in <code>source</code> has been added to <code>dest</code>, or where
a property of that name already existed in <code>dest</code>, the property in <code>dest</code> has been
replaced with the property from <code>source</code>, in each case with <code>enumerable</code> set to <code>false</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">book</span> <span class="o">=</span> {<span class="na">author</span>: <span class="s">'Austen'</span>};
<span class="kd">let</span> <span class="nv">pages</span> <span class="o">=</span> <span class="m">0</span>;

<span class="nx">util</span>.<span class="na">mergeNoEnum</span>(<span class="nx">book</span>, {
  <span class="na">published</span>: <span class="m">1813</span>,

  <span class="k">get</span> <span class="nf">pages</span>() {<span class="k">return</span> <span class="nx">pages</span>},
});

<span class="nx">pages</span> <span class="o">=</span> <span class="m">432</span>;
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">Object</span>.<span class="na">keys</span>(<span class="nx">book</span>), [<span class="s">'author'</span>]);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">published</span>, <span class="m">1813</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">book</span>.<span class="na">pages</span>, <span class="m">432</span>);</div></div></pre></div></section><section id="koru/util.mergeOwnDescriptors" tabindex="-1" name="mergeOwnDescriptors" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">mergeOwnDescriptors</span>(<span class="nv">dest</span>, <span class="nv">source</span>)</span></h1><abstract><div><p>Merge <code>source</code> into <code>dest</code>, including non-enumerable properties from <code>source</code>. That is, add
each property in <code>source</code>, including non-enumerable properties, to <code>dest</code>, or where a property
of that name already exists in <code>dest</code>, replace the property in <code>dest</code> with the property from
<code>source</code>. Return the modified <code>dest</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dest</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object to modify</p>
</div></td></tr><tr class="jsdoc-arg"><td>source</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the properties to be added or modified</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p><code>dest</code> modified: each property in <code>source</code>, including non-enumerable properties,
has been added to <code>dest</code>, or where a property of that name already existed in <code>dest</code>, the
property in <code>dest</code> has been replaced with the property from <code>source</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">a</span> <span class="o">=</span> {<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">2</span>};
<span class="kd">const</span> <span class="no">b</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">mergeNoEnum</span>({<span class="[object Object]">__proto__</span>: <span class="nx">a</span>, <span class="na">b</span>: <span class="m">3</span>, <span class="na">c</span>: <span class="m">4</span>}, {<span class="na">e</span>: <span class="m">6</span>});
<span class="kd">const</span> <span class="no">c</span> <span class="o">=</span> {<span class="na">d</span>: <span class="m">5</span>};

<span class="kd">const</span> <span class="no">ans</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">mergeOwnDescriptors</span>(<span class="nx">c</span>, <span class="nx">b</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ans</span>, <span class="nx">c</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">ans</span>, {<span class="na">d</span>: <span class="m">5</span>, <span class="na">b</span>: <span class="m">3</span>, <span class="na">c</span>: <span class="m">4</span>});
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">ans</span>.<span class="na">e</span>, <span class="m">6</span>);</div></div></pre></div></section><section id="koru/util.pc" tabindex="-1" name="pc" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">pc</span>(<span class="nv">fraction</span>)</span></h1><abstract><div><p>Return a string comprised of the percent form of <code>fraction</code>, with the percent symbol, %.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>fraction</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>a fraction</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>a string comprised of the percent form of <code>fraction</code>, with the percent symbol, %</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">pc</span>(<span class="m">1.2345678</span>), <span class="s">'123.45678%'</span>);</div></div></pre></div></section><section id="koru/util.qlabel" tabindex="-1" name="qlabel" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">qlabel</span>(<span class="nv">id</span>)</span></h1><abstract><div><p>Quote label. Add quotes only if needed to be used as a property name.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qlabel</span>(<span class="s">'1234'</span>), <span class="s">'1234'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qlabel</span>(<span class="s">'abc123'</span>), <span class="s">'abc123'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qlabel</span>(<span class="s">"a'234"</span>), <span class="s">`"a'234"`</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qlabel</span>(<span class="s">'123a'</span>), <span class="s">`'123a'`</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qlabel</span>(<span class="s">'ab\nc'</span>), <span class="s">`'ab\\nc'`</span>);</div></div></pre></div></section><section id="koru/util.qstr" tabindex="-1" name="qstr" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">qstr</span>(<span class="nv">s</span>)</span></h1><abstract><div><p>Quote string</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>s</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qstr</span>(<span class="s">'1234'</span>), <span class="s">"'1234'"</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qstr</span>(<span class="s">"1'234"</span>), <span class="s">`"1'234"`</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qstr</span>(<span class="s">'12"3a'</span>), <span class="s">`'12"3a'`</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qstr</span>(<span class="s">"\r"</span>), <span class="s">'"\\r"'</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qstr</span>(<span class="s">'12\n3a'</span>), <span class="s">`'12\\n3a'`</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">qstr</span>(<span class="s">'12\\n3a'</span>), <span class="s">`'12\\\\n3a'`</span>);</div></div></pre></div></section><section id="koru/util.removeItem" tabindex="-1" name="removeItem" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">removeItem</span>(<span class="nv">list</span>, <span class="nv">item</span>)</span></h1><abstract><div><p>Remove <code>item</code> from <code>list</code> and return it. <code>list</code> is modified. If <code>item</code> is an object,
<code>removeItem</code> removes the first object in <code>list</code> that contains all the key-value
pairs that <code>item</code> contains. If <code>list</code> does not contain <code>item</code>, <code>undefined</code> is
returned.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>list</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>the list from which to remove <code>item</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>[item]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the item to remove from <code>list</code></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/" target="_blank">any-type</a></td><td class="jsdoc-info"><div><p>the removed item, or <code>undefined</code> if <code>list</code> does not contain <code>item</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">foo</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>];
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">removeItem</span>(<span class="nx">foo</span>, <span class="m">2</span>), <span class="m">2</span>); <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>, [<span class="m">1</span>, <span class="m">3</span>]);

<span class="nx">util</span>.<span class="na">removeItem</span>(<span class="nx">foo</span>); <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>, [<span class="m">1</span>, <span class="m">3</span>]);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">removeItem</span>(<span class="nx">foo</span>, <span class="m">4</span>), <span class="kc">undefined</span>); <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>, [<span class="m">1</span>, <span class="m">3</span>]);

<span class="nx">util</span>.<span class="na">removeItem</span>(<span class="nx">foo</span>, <span class="m">1</span>); <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>, [<span class="m">3</span>]);

<span class="nx">util</span>.<span class="na">removeItem</span>(<span class="nx">foo</span>, <span class="m">3</span>); <span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">foo</span>, []);

<span class="kd">const</span> <span class="no">bar</span> <span class="o">=</span> [{<span class="na">id</span>: <span class="m">4</span>, <span class="na">name</span>: <span class="s">'foo'</span>}, {<span class="na">id</span>: <span class="m">5</span>, <span class="na">name</span>: <span class="s">'bar'</span>}, {<span class="na">x</span>: <span class="m">1</span>}];
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">removeItem</span>(<span class="nx">bar</span>, {<span class="na">name</span>: <span class="s">'bar'</span>, <span class="na">x</span>: <span class="m">1</span>}), <span class="kc">undefined</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">bar</span>, [{<span class="na">id</span>: <span class="m">4</span>, <span class="na">name</span>: <span class="s">'foo'</span>}, {<span class="na">id</span>: <span class="m">5</span>, <span class="na">name</span>: <span class="s">'bar'</span>}, {<span class="na">x</span>: <span class="m">1</span>}]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">removeItem</span>(<span class="nx">bar</span>, {<span class="na">name</span>: <span class="s">'bar'</span>}), {<span class="na">id</span>: <span class="m">5</span>, <span class="na">name</span>: <span class="s">'bar'</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">bar</span>, [{<span class="na">id</span>: <span class="m">4</span>, <span class="na">name</span>: <span class="s">'foo'</span>}, {<span class="na">x</span>: <span class="m">1</span>}]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">removeItem</span>(<span class="nx">bar</span>, {<span class="na">id</span>: <span class="m">4</span>, <span class="na">name</span>: <span class="s">'foo'</span>}), {<span class="na">id</span>: <span class="m">4</span>, <span class="na">name</span>: <span class="s">'foo'</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">bar</span>, [{<span class="na">x</span>: <span class="m">1</span>}]);</div></div></pre></div></section><section id="koru/util.reverseForEach" tabindex="-1" name="reverseForEach" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">reverseForEach</span>(<span class="nv">list</span>, <span class="nv">visitor</span>)</span></h1><abstract><div><p>Visit <code>list</code> in reverse order, executing <code>visitor</code> once for each list element.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>list</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div><p>a list</p>
</div></td></tr><tr class="jsdoc-arg"><td>visitor</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>a function taking two arguments: the value of the current element in <code>list</code>,
and the index of that current element</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">results</span> <span class="o">=</span> [];
<span class="nx">util</span>.<span class="na">reverseForEach</span>(<span class="nx">v</span>.<span class="na">list</span> <span class="o">=</span> [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>], (<span class="nv">val</span>, <span class="nv">index</span>) <span class="o">=&gt;</span> {
  <span class="nx">results</span>.<span class="na">push</span>(<span class="nx">val</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="nx">index</span>);
});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">results</span>, [<span class="s">'3.2'</span>, <span class="s">'2.1'</span>, <span class="s">'1.0'</span>]);

<span class="cs">// ignores null list</span>
<span class="kd">const</span> <span class="no">callback</span> <span class="o">=</span> <span class="nx">stub</span>();
<span class="nx">util</span>.<span class="na">reverseForEach</span>(<span class="kc">null</span>, <span class="nx">callback</span>);
<span class="nx">refute</span>.<span class="na">called</span>(<span class="nx">callback</span>);</div></div></pre></div></section><section id="koru/util.sansPc" tabindex="-1" name="sansPc" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">sansPc</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Return <code>value</code> converted to a number; the suffix '%' is removed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[value]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>a value to be converted</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p><code>value</code> converted to a number; the suffix '%' has been removed</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">sansPc</span>(<span class="s">'123.23%'</span>), <span class="m">123.23</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">sansPc</span>(), <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">sansPc</span>(<span class="m">234</span>), <span class="m">234</span>);</div></div></pre></div></section><section id="koru/util.sansPx" tabindex="-1" name="sansPx" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">sansPx</span>(<span class="nv">value</span>)</span></h1><abstract><div><p>Return <code>value</code> converted to a number; the suffix 'px' is removed.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[value]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>a value to be converted</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p><code>value</code> converted to a number; the suffix 'px' has been removed</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">sansPx</span>(<span class="s">'123.23px'</span>), <span class="m">123.23</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">sansPx</span>(), <span class="m">0</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">sansPx</span>(<span class="m">234</span>), <span class="m">234</span>);</div></div></pre></div></section><section id="koru/util.splitKeys" tabindex="-1" name="splitKeys" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">splitKeys</span>(<span class="nv">obj</span>, <span class="nv">includeKeys</span>)</span></h1><abstract><div><p>Create an object containing two properties, <code>include</code> and <code>exclude</code>. The former
is made up of the properties in <code>obj</code> whose keys are named in <code>includeKeys</code>, and the later
is made up of the other properties in <code>obj</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>obj</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the object from which to collect properties</p>
</div></td></tr><tr class="jsdoc-arg"><td>includeKeys</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>a collection of properties whose names identify which objects to
include in the first object returned</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the <code>include</code> and <code>exclude</code> objects.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> {<span class="no">include</span>, <span class="no">exclude</span>} <span class="o">=</span> <span class="nx">util</span>.<span class="na">splitKeys</span>(
  {<span class="na">a</span>: <span class="m">4</span>, <span class="na">b</span>: <span class="s">'abc'</span>, <span class="k">get</span> <span class="nf">c</span>() {<span class="k">return</span> {<span class="na">value</span>: <span class="kc">true</span>}}}, {<span class="na">a</span>: <span class="kc">true</span>, <span class="na">e</span>: <span class="kc">true</span>});

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">include</span>, {<span class="na">a</span>: <span class="m">4</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">exclude</span>, {<span class="na">b</span>: <span class="s">'abc'</span>, <span class="na">c</span>: {<span class="na">value</span>: <span class="kc">true</span>}});</div></div></pre></div></section><section id="koru/util.symDiff" tabindex="-1" name="symDiff" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">symDiff</span>(<span class="nv">list1</span>, <span class="nv">list2</span>)</span></h1><abstract><div><p>Create a list of all the elements of <code>list1</code> and <code>list2</code> that belong only to <code>list1</code>
or <code>list2</code>, not to both lists.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[list1]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a list</p>
</div></td></tr><tr class="jsdoc-arg"><td>[list2]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a second list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a list of all the elements of <code>list1</code> and <code>list2</code> that belong only to <code>list1</code>
or <code>list2</code>, not to both lists</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">symDiff</span>(), []);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">symDiff</span>([<span class="m">1</span>, <span class="m">2</span>]), [<span class="m">1</span>, <span class="m">2</span>]);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">symDiff</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>], [<span class="m">2</span>, <span class="m">4</span>]).<span class="na">sort</span>(), [<span class="m">1</span>, <span class="m">3</span>, <span class="m">4</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">symDiff</span>([<span class="m">2</span>, <span class="m">4</span>], [<span class="m">1</span>, <span class="m">2</span>, <span class="m">3</span>]).<span class="na">sort</span>(), [<span class="m">1</span>, <span class="m">3</span>, <span class="m">4</span>]);</div></div></pre></div></section><section id="koru/util.titleize" tabindex="-1" name="titleize" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">titleize</span>(<span class="nv">value</span>)</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>value</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">titleize</span>(<span class="s">''</span>), <span class="s">''</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">titleize</span>(<span class="s">'abc'</span>), <span class="s">'Abc'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">titleize</span>(<span class="s">'abc-def_xyz.qqq+foo%bar'</span>), <span class="s">'Abc Def Xyz Qqq Foo Bar'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">titleize</span>(<span class="s">'CarlySimon'</span>), <span class="s">'Carly Simon'</span>);</div></div></pre></div></section><section id="koru/util.toDp" tabindex="-1" name="toDp" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">toDp</span>(<span class="nv">number</span>, <span class="nv">dp</span>, <span class="nv">zeroFill</span> <span class="o">=</span> <span class="kc">false</span>)</span></h1><abstract><div><p>Return <code>number</code> to <code>dp</code> decimal places, converted to a string, padded with
zeros if <code>zeroFill</code> is <code>true</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>number</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>a number to be converted</p>
</div></td></tr><tr class="jsdoc-arg"><td>dp</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the number of decimal places to display <code>number</code> to</p>
</div></td></tr><tr class="jsdoc-arg"><td>[zeroFill]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a></td><td class="jsdoc-info"><div><p>pad with zeros; <code>false</code> by default</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p><code>number</code> to <code>dp</code> decimal places, converted to a string, padded with
zeros if <code>zeroFill</code> is <code>true</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">toDp</span>(<span class="m">10.7</span>, <span class="m">0</span>), <span class="s">'11'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">toDp</span>(<span class="m">2.6</span>, <span class="m">1</span>), <span class="s">'2.6'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">toDp</span>(<span class="m">1.2345</span>, <span class="m">3</span>, <span class="kc">true</span>), <span class="s">'1.235'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">toDp</span>(<span class="m">1.2</span>, <span class="m">3</span>, <span class="kc">true</span>), <span class="s">'1.200'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">toDp</span>(<span class="m">10</span>, <span class="m">3</span>), <span class="s">'10'</span>);</div></div></pre></div></section><section id="koru/util.toHex" tabindex="-1" name="toHex" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">toHex</span>(<span class="nv">array</span>)</span></h1><abstract><div><p>Convert a byte array to a hex string</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>array</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array" target="_blank">Uint8Array</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toHex</span>(<span class="k">new</span> <span class="nx">Uint8Array</span>([<span class="m">3</span>, <span class="m">6</span>, <span class="m">8</span>, <span class="m">129</span>, <span class="m">255</span>])), <span class="s">'03060881ff'</span>);</div></div></pre></div></section><section id="koru/util.toMap" tabindex="-1" name="toMap" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">toMap</span>(<span class="nv">keyName</span>, <span class="nv">valueName</span> <span class="cm">/* lists */</span>)</span></h1><abstract><div><p>convert to a <code>object</code>;</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>[keyName]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[valueName]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">boolean</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(), {});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(<span class="kc">null</span>), {});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>([<span class="s">'a'</span>, <span class="s">'b'</span>]), {<span class="na">a</span>: <span class="kc">true</span>, <span class="na">b</span>: <span class="kc">true</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(<span class="s">'foo'</span>, <span class="kc">true</span>, [{<span class="na">foo</span>: <span class="s">'a'</span>}, {<span class="na">foo</span>: <span class="s">'b'</span>}]),
              {<span class="na">a</span>: <span class="kc">true</span>, <span class="na">b</span>: <span class="kc">true</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(<span class="s">'foo'</span>, <span class="kc">null</span>, [{<span class="na">foo</span>: <span class="s">'a'</span>}, {<span class="na">foo</span>: <span class="s">'b'</span>}]),
              {<span class="na">a</span>: {<span class="na">foo</span>: <span class="s">'a'</span>}, <span class="na">b</span>: {<span class="na">foo</span>: <span class="s">'b'</span>}});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(<span class="s">'foo'</span>, <span class="kc">null</span>, [{<span class="na">foo</span>: <span class="s">'a'</span>}], [{<span class="na">foo</span>: <span class="s">'b'</span>}]),
              {<span class="na">a</span>: {<span class="na">foo</span>: <span class="s">'a'</span>}, <span class="na">b</span>: {<span class="na">foo</span>: <span class="s">'b'</span>}});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(<span class="s">'foo'</span>, <span class="s">'baz'</span>, [{<span class="na">foo</span>: <span class="s">'a'</span>, <span class="na">baz</span>: <span class="m">1</span>},
                                        {<span class="na">foo</span>: <span class="s">'b'</span>, <span class="na">baz</span>: <span class="m">2</span>}]), {<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">2</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(<span class="m">0</span>, <span class="m">1</span>, [[<span class="s">'foo'</span>, <span class="s">'bar'</span>], [<span class="s">'a'</span>, <span class="m">1</span>]]),
              {<span class="na">foo</span>: <span class="s">'bar'</span>, <span class="na">a</span>: <span class="m">1</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(<span class="m">1</span>, <span class="m">0</span>, [[<span class="s">'foo'</span>, <span class="s">'bar'</span>], [<span class="s">'a'</span>, <span class="m">1</span>]]),
              {<span class="m">1</span>: <span class="s">'a'</span>, <span class="na">bar</span>: <span class="s">'foo'</span>});
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">toMap</span>(<span class="s">'foo'</span>, (<span class="nv">c</span>, <span class="nv">i</span>) <span class="o">=&gt;</span> <span class="nx">c</span>.<span class="na">foo</span> <span class="o">+</span> <span class="nx">i</span>, [{<span class="na">foo</span>: <span class="s">'a'</span>}, {<span class="na">foo</span>: <span class="s">'b'</span>}]),
              {<span class="na">a</span>: <span class="s">'a0'</span>, <span class="na">b</span>: <span class="s">'b1'</span>});</div></div></pre></div></section><section id="koru/util.trimMatchingSeq" tabindex="-1" name="trimMatchingSeq" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">trimMatchingSeq</span>(<span class="nv">a</span>, <span class="nv">b</span>)</span></h1><abstract><div><p>Trim the matching start and ends of two sequences</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>a</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>b</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'acd'</span>.<span class="na">split</span>(<span class="s">''</span>), <span class="s">'abcd'</span>.<span class="na">split</span>(<span class="s">''</span>)), [[], [<span class="s">'b'</span>]]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'string'</span>, <span class="s">'substring'</span>), [<span class="s">''</span>, <span class="s">'ubs'</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'substring'</span>, <span class="s">'sub'</span>), [<span class="s">'string'</span>, <span class="s">''</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'1a23'</span>, <span class="s">'1d23'</span>), [<span class="s">'a'</span>, <span class="s">'d'</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'123abc456'</span>, <span class="s">'123def456'</span>), [<span class="s">'abc'</span>, <span class="s">'def'</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'diffStart'</span>, <span class="s">'myStart'</span>), [<span class="s">'diff'</span>, <span class="s">'my'</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'diffEnd'</span>, <span class="s">'diffEnds'</span>), [<span class="s">''</span>, <span class="s">'s'</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'diff'</span>, <span class="s">'strings'</span>), [<span class="s">'diff'</span>, <span class="s">'strings'</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'same'</span>, <span class="s">'same'</span>), [<span class="s">''</span>, <span class="s">''</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">''</span>, <span class="s">''</span>), [<span class="s">''</span>, <span class="s">''</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">'a'</span>, <span class="s">''</span>), [<span class="s">'a'</span>, <span class="s">''</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">trimMatchingSeq</span>(<span class="s">''</span>, <span class="s">'b'</span>), [<span class="s">''</span>, <span class="s">'b'</span>]);</div></div></pre></div></section><section id="koru/util.union" tabindex="-1" name="union" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">union</span>(<span class="nv">first</span>, ...<span class="nv">rest</span>)</span></h1><abstract><div><p>Create a shallow copy of <code>first</code> and add items to the new list, in each case only if the
item does not already exist in the new list.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>first</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div><p>a list to be copied</p>
</div></td></tr><tr class="jsdoc-arg"><td>[rest]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Null" target="_blank">null</a></td><td class="jsdoc-info"><div><p>one or more lists of elements to be added to the new list if they do not
already exist in the new list</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a list containing all the elements in <code>first</code> and one instance of each of the
unique elements in <code>rest</code> that are not also in <code>first</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">union</span>([<span class="m">1</span>, <span class="m">2</span>, <span class="m">2</span>, <span class="m">3</span>], [<span class="m">3</span>, <span class="m">4</span>, <span class="m">4</span>, <span class="m">5</span>], [<span class="m">3</span>, <span class="m">6</span>]), [<span class="m">1</span>, <span class="m">2</span>, <span class="m">2</span>, <span class="m">3</span>, <span class="m">4</span>, <span class="m">5</span>, <span class="m">6</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">union</span>([<span class="m">1</span>, <span class="m">2</span>]), [<span class="m">1</span>, <span class="m">2</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">union</span>([<span class="m">1</span>, <span class="m">2</span>], <span class="kc">null</span>), [<span class="m">1</span>, <span class="m">2</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">union</span>(<span class="kc">null</span>, [<span class="m">1</span>, <span class="m">2</span>]), [<span class="m">1</span>, <span class="m">2</span>]);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">union</span>(<span class="kc">null</span>, <span class="kc">null</span>), []);</div></div></pre></div></section><section id="koru/util.values" tabindex="-1" name="values" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">values</span>(<span class="nv">map</span>)</span></h1><abstract><div><p>Create a list of the values of the enumerable properties of <code>map</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>map</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a></td><td class="jsdoc-info"><div><p>a list made up of the values of the enumerable properties of <code>map</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">util</span>.<span class="na">values</span>({<span class="na">a</span>: <span class="m">1</span>, <span class="na">b</span>: <span class="m">2</span>}), [<span class="m">1</span>, <span class="m">2</span>]);</div></div></pre></div></section><section id="koru/util.voidToNull" tabindex="-1" name="voidToNull" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">voidToNull</span>(<span class="nv">object</span>)</span></h1><abstract><div><p>Convert all void values in Object to null values</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">changes</span> <span class="o">=</span> {<span class="na">a</span>: <span class="o">void</span> <span class="m">0</span>, <span class="na">b</span>: <span class="m">123</span>, <span class="na">c</span>: <span class="s">''</span>, <span class="na">d</span>: <span class="kc">null</span>};
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">voidToNull</span>(<span class="nx">changes</span>), <span class="nx">changes</span>);
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">changes</span>, {<span class="na">a</span>: <span class="kc">null</span>, <span class="na">b</span>: <span class="m">123</span>, <span class="na">c</span>: <span class="s">''</span>, <span class="na">d</span>: <span class="kc">null</span>});</div></div></pre></div></section><section id="koru/util.withId" tabindex="-1" name="withId" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">util.<span class="highlight"><span class="nf">withId</span>(<span class="nv">object</span>, <span class="nv">_id</span>, <span class="nv">key</span> <span class="o">=</span> <span class="nx">withId$</span>)</span></h1><abstract><div><p>Associate <code>object</code> with <code>_id</code>.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>object</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an object to associate with <code>_id</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>_id</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>an id to associate with <code>object</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>[key]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" target="_blank">symbol</a></td><td class="jsdoc-info"><div><p>defaults to <a href="#koru/Symbol">Symbol.withId$</a></p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>an associated object which has the given <code>_id</code> and a prototype of
<code>object</code>. If an association for <code>key</code> is already attached to the <code>object</code> then it is used
otherwise a new one will be created.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">util</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">jane</span> <span class="o">=</span> {<span class="na">name</span>: <span class="s">'Jane'</span>, <span class="na">likes</span>: [<span class="s">'Books'</span>]};
<span class="kd">const</span> <span class="no">myKey$</span> <span class="o">=</span> <span class="nx">Symbol</span>();
<span class="kd">const</span> <span class="no">assoc</span> <span class="o">=</span> <span class="nx">util</span>.<span class="na">withId</span>(<span class="nx">jane</span>, <span class="m">123</span>, <span class="nx">myKey$</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">assoc</span>.<span class="na">likes</span>, <span class="nx">jane</span>.<span class="na">likes</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">Object</span>.<span class="na">getPrototypeOf</span>(<span class="nx">assoc</span>), <span class="nx">jane</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">assoc</span>.<span class="na">_id</span>, <span class="m">123</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">withId</span>(<span class="nx">jane</span>, <span class="m">456</span>, <span class="nx">myKey$</span>), <span class="nx">assoc</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">assoc</span>.<span class="na">_id</span>, <span class="m">456</span>);

<span class="nx">refute</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">withId</span>(<span class="nx">jane</span>, <span class="m">456</span>), <span class="nx">assoc</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">util</span>.<span class="na">withId</span>(<span class="nx">jane</span>, <span class="m">456</span>).<span class="na">likes</span>, <span class="nx">jane</span>.<span class="na">likes</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/util-date" data-env="both" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/util-date">koru/util-date</a><h1 class="jsdoc-module-title searchable">UtilDate</h1><abstract><div><p>Utility date processing methods</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div class="jsdoc-properties"><h1>Properties</h1><table><tbody><tr><td class="searchable">defaultLang</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info" data-env="both"><div><p>The default locale language. On the browser it is <code>navigator.language</code>. On the server it is
env <code>LC_ALL</code> <code>LC_TIME</code> or the default for <code>Intl.DateTimeFormat().resolvedOptions().locale</code></p>
</div></td></tr></tbody></table></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/util-date.atUTCDowHour" tabindex="-1" name="atUTCDowHour" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">atUTCDowHour</span>(<span class="nv">date</span>, <span class="nv">dow</span>, <span class="nv">hour</span>)</span></h1><abstract><div><p>Find the time for a UTC <code>dow</code>, <code>hour</code> (day of week and hour) after <code>date</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>date</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the date to start from</p>
</div></td></tr><tr class="jsdoc-arg"><td>dow</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the desired UTC day of week. <code>sun=0, mon=1, ... sat=6</code></p>
</div></td></tr><tr class="jsdoc-arg"><td>hour</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the desired UTC hour of day</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>a date which is &gt;= <code>date</code> and its <code>getUTCDay()</code> equals <code>dow</code> and <code>getUTCHours</code>
equals <code>hour</code></p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">THU</span> <span class="o">=</span> <span class="m">4</span>;

<span class="kd">let</span> <span class="nv">date</span> <span class="o">=</span> <span class="nx">uDate</span>.<span class="na">atUTCDowHour</span>(<span class="nx">Date</span>.<span class="na">UTC</span>(<span class="m">2014</span>,<span class="m">4</span>,<span class="m">5</span>), <span class="nx">THU</span>, <span class="m">9</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">date</span>.<span class="na">toISOString</span>(), <span class="s">'2014-05-08T09:00:00.000Z'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">atUTCDowHour</span>(<span class="m">123</span> <span class="o">+</span> <span class="o">+</span><span class="nx">date</span>, <span class="nx">THU</span>, <span class="m">8</span>).<span class="na">toISOString</span>(),
            <span class="s">'2014-05-15T08:00:00.123Z'</span>);

<span class="nx">date</span> <span class="o">=</span> <span class="nx">uDate</span>.<span class="na">atUTCDowHour</span>(<span class="nx">Date</span>.<span class="na">UTC</span>(<span class="m">2014</span>,<span class="m">4</span>,<span class="m">10</span>), <span class="nx">THU</span>, <span class="m">9</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">date</span>.<span class="na">toISOString</span>(), <span class="s">'2014-05-15T09:00:00.000Z'</span>);</div></div></pre></div></section><section id="koru/util-date.compileFormat" tabindex="-1" name="compileFormat" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">compileFormat</span>(<span class="nv">format</span>, <span class="nv">lang</span><span class="o">=</span><span class="nx">defaultLang</span>)</span></h1><abstract><div><p>Make a function that converts a date to text given a specified format.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>format</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>If an <code>object</code> then uses
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DateTimeFormat" target="_blank">Intl.DateTimeFormat</a></p>
<p>if a <code>string</code> can contain the following mnemonics:</p>
<ul>
<li><code>D</code> 1 or 2 digit day of month</li>
<li><code>DD</code> 2 digit day of month</li>
<li><code>s</code> 1 digit seconds in minute</li>
<li><code>ss</code> 2 digit seconds in minute</li>
<li><code>MM</code> 2 digit month of year</li>
<li><code>MMM</code> short name for month of year</li>
<li><code>YYYY</code> 4 digit year</li>
<li><code>YY</code> 2 digit year</li>
<li><code>h</code> 1 or 2 digit hour of day</li>
<li><code>hh</code> 2 digit hour of day</li>
<li><code>m</code> 1 or 2 digit minute of hour</li>
<li><code>mm</code> 2 digit minute of hour</li>
<li><code>a</code> am or pm</li>
<li><code>A</code> AM or PM</li>
</ul>
</div></td></tr><tr class="jsdoc-arg"><td>lang</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>A string with a BCP 47 language tag. Defaults to the browser's or nodejs's
default locale.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank">function</a></td><td class="jsdoc-info"><div><p>A function that will format a given Date or epoch</p>
<pre><code class="language-js"><div class="highlight"><span class="nv">date</span> <span class="o">=&gt;</span> <span class="nx">computeString</span>()</div>
</code></pre></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">0</span>, <span class="m">4</span>, <span class="m">14</span>, <span class="m">3</span>, <span class="m">12</span>);
<span class="kd">const</span> <span class="no">format</span> <span class="o">=</span> <span class="nx">uDate</span>.<span class="na">compileFormat</span>(<span class="s">'D MMM YYYY h:mma'</span>, <span class="s">'en'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">format</span>(<span class="nx">d</span>), <span class="s">'4 Jan 2017 2:03pm'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">format</span>(<span class="m">12</span><span class="o">*</span><span class="nx">HOUR</span> <span class="o">+</span> <span class="o">+</span><span class="nx">d</span>), <span class="s">'5 Jan 2017 2:03am'</span>);</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">format</span> <span class="o">=</span> <span class="nx">uDate</span>.<span class="na">compileFormat</span>({<span class="na">weekday</span>: <span class="s">'long'</span>}, <span class="s">'en'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">format</span>(<span class="nx">d</span>), <span class="s">'Wednesday'</span>);</div></div></pre></div></section><section id="koru/util-date.format" tabindex="-1" name="format" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">format</span>(<span class="nv">date</span>, <span class="nv">format</span>, <span class="nv">lang</span><span class="o">=</span><span class="nx">defaultLang</span>)</span></h1><abstract><div><p>Format time with a specified format</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>date</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>format this date</p>
</div></td></tr><tr class="jsdoc-arg"><td>format</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a> / <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div><p>the format use. See <a class="jsdoc-link" href="#koru/util-date.compileFormat">compileFormat</a></p>
</div></td></tr><tr class="jsdoc-arg"><td>[lang]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>A string with a BCP 47 language tag. Defaults to the browser's or nodejs's
default locale.</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">0</span>, <span class="m">4</span>, <span class="m">14</span>, <span class="m">3</span>, <span class="m">12</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">'D MMM YYYY h:mma'</span>), <span class="s">'4 Jan 2017 2:03pm'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="m">12</span><span class="o">*</span><span class="nx">HOUR</span> <span class="o">+</span> <span class="o">+</span><span class="nx">d</span>, <span class="s">'D MMM YYYY h:mma'</span>, <span class="s">'en'</span>), <span class="s">'5 Jan 2017 2:03am'</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">`DD'YY hh`</span>), <span class="s">`04'17 02`</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">`m[m]`</span>), <span class="s">`3m`</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">`MM`</span>), <span class="s">`01`</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">`ss`</span>), <span class="s">`12`</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">`s`</span>), <span class="s">`12`</span>);
<span class="nx">d</span>.<span class="na">setSeconds</span>(<span class="m">9</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">`ss`</span>), <span class="s">`09`</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">`s`</span>), <span class="s">`9`</span>);

<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, <span class="s">'MMM'</span>), <span class="nx">Intl</span>.<span class="na">DateTimeFormat</span>(<span class="o">void</span> <span class="m">0</span>, {<span class="na">month</span>: <span class="s">'short'</span>}).<span class="na">format</span>(<span class="nx">d</span>));</div></div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">0</span>, <span class="m">4</span>, <span class="m">14</span>, <span class="m">3</span>, <span class="m">12</span>);
<span class="kd">const</span> <span class="no">format</span> <span class="o">=</span> <span class="nx">uDate</span>.<span class="na">compileFormat</span>({<span class="na">weekday</span>: <span class="s">'long'</span>}, <span class="s">'en'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">format</span>(<span class="nx">d</span>), <span class="s">'Wednesday'</span>);

<span class="k">if</span> (<span class="nx">isClient</span>) {
  <span class="nx">assert</span>.<span class="na">same</span>( <span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, {}, <span class="s">'de'</span>), <span class="s">`4.1.2017`</span>);
  <span class="nx">assert</span>.<span class="na">same</span>( <span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, {}, <span class="s">'en-us'</span>), <span class="s">`1/4/2017`</span>);
}
<span class="nx">assert</span>.<span class="na">same</span>( <span class="nx">uDate</span>.<span class="na">format</span>(<span class="nx">d</span>, {}), <span class="nx">Intl</span>.<span class="na">DateTimeFormat</span>(<span class="nx">uDate</span>.<span class="na">defaultLang</span>).<span class="na">format</span>(<span class="nx">d</span>));</div></div></pre></div></section><section id="koru/util-date.parse" tabindex="-1" name="parse" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">parse</span>(<span class="nv">dateStr</span>)</span></h1><abstract><div><p>Convert string to date. Like <code>Date.parse</code> except assumes local timezone if none given</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>dateStr</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>A string representing a simplification of the ISO 8601 calendar date
extended format (other formats may be used, but results are implementation-dependent).</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>parsed <code>dateStr</code> with the local timezone.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">parse</span>(<span class="s">'2017-12-26'</span>), <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">11</span>, <span class="m">26</span>));
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">parse</span>(<span class="s">'2017-12-26T00:00:00Z'</span>), <span class="k">new</span> <span class="nx">Date</span>(<span class="s">"2017-12-26T00:00:00Z"</span>));</div></div></pre></div></section><section id="koru/util-date.relative" tabindex="-1" name="relative" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">relative</span>(<span class="nv">delta</span>, <span class="nv">minTime</span><span class="o">=</span><span class="m">60000</span>, <span class="nv">lang</span><span class="o">=</span><span class="nx">defaultLang</span>)</span></h1><abstract><div><p>convert time to a relative text</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>delta</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[minTime]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[lang]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">0</span>, <span class="m">0</span>), <span class="s">'now'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">20000</span>, <span class="m">10000</span>, <span class="s">'en'</span>), <span class="s">'in 20 seconds'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">499</span>, <span class="m">0</span>), <span class="s">'now'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">45000</span>,), <span class="s">'in 1 minute'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="o">-</span><span class="m">45000</span>), <span class="s">'1 minute ago'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">61</span><span class="o">*</span><span class="nx">MIN</span>), <span class="s">'in 1 hour'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">90</span><span class="o">*</span><span class="nx">MIN</span>), <span class="s">'in 2 hours'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">24</span><span class="o">*</span><span class="nx">HOUR</span>), <span class="s">'tomorrow'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">48</span><span class="o">*</span><span class="nx">HOUR</span>), <span class="s">'in 2 days'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">26</span><span class="o">*</span><span class="nx">DAY</span>), <span class="s">'in 26 days'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">46</span><span class="o">*</span><span class="nx">DAY</span>), <span class="s">'in 2 months'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="o">-</span><span class="m">319</span><span class="o">*</span><span class="nx">DAY</span>), <span class="s">'10 months ago'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">530</span><span class="o">*</span><span class="nx">DAY</span>), <span class="s">'in 17 months'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">548</span><span class="o">*</span><span class="nx">DAY</span>), <span class="s">'in 2 years'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">5000</span><span class="o">*</span><span class="nx">DAY</span>), <span class="s">'in 14 years'</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="o">-</span><span class="m">5000</span><span class="o">*</span><span class="nx">DAY</span>), <span class="s">'14 years ago'</span>);

<span class="cs">// Not all browsers do the same thing</span>
<span class="kd">const</span> <span class="no">thismin</span> <span class="o">=</span> <span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">0</span>) <span class="o">===</span> <span class="s">'this minute'</span> <span class="o">?</span> <span class="s">'this minute'</span> <span class="o">:</span> <span class="s">'in 0 minutes'</span>;
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">0</span>), <span class="nx">thismin</span>);
<span class="nx">assert</span>.<span class="na">same</span>(<span class="nx">uDate</span>.<span class="na">relative</span>(<span class="m">29000</span>), <span class="nx">thismin</span>);</div></div></pre></div></section><section id="koru/util-date.shiftToLocale" tabindex="-1" name="shiftToLocale" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">shiftToLocale</span>(<span class="nv">date</span>)</span></h1><abstract><div><p>Treat UTC time as locale time; move the timezone without changing the locale time</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>date</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>The date to shift</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>with the local timezone</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">shiftToLocale</span>(<span class="k">new</span> <span class="nx">Date</span>(<span class="s">'2017-12-26T14:00Z'</span>)),
              <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">11</span>, <span class="m">26</span>, <span class="m">14</span>));</div></div></pre></div></section><section id="koru/util-date.shiftToUTC" tabindex="-1" name="shiftToUTC" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">shiftToUTC</span>(<span class="nv">date</span>)</span></h1><abstract><div><p>Treat locale time as UTC time; move the timezone without changing the locale time</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>date</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>The date to shift</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>with the UTC timezone</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">shiftToUTC</span>(<span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">11</span>, <span class="m">26</span>, <span class="m">14</span>)),
              <span class="k">new</span> <span class="nx">Date</span>(<span class="s">'2017-12-26T14:00Z'</span>));</div></div></pre></div></section><section id="koru/util-date.toDiscrete" tabindex="-1" name="toDiscrete" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">toDiscrete</span>(<span class="nv">date</span>, <span class="nv">unit</span>)</span></h1><abstract><div><p>Return the <code>date</code> at the start of the <code>unit</code></p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>date</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>to discretize</p>
</div></td></tr><tr class="jsdoc-arg"><td>unit</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" target="_blank">number</a></td><td class="jsdoc-info"><div><p>the part to set to zero (and the parts below)</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>with parts set to zero</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">dt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">2</span>, <span class="m">6</span>, <span class="m">13</span>, <span class="m">17</span>, <span class="m">36</span>, <span class="m">123</span>);

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">toDiscrete</span>(<span class="nx">dt</span>, <span class="nx">uDate</span>.<span class="na">DAY</span>), <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">2</span>, <span class="m">6</span>));
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">toDiscrete</span>(<span class="nx">dt</span>, <span class="nx">uDate</span>.<span class="na">HOUR</span>), <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">2</span>, <span class="m">6</span>, <span class="m">13</span>));
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">toDiscrete</span>(<span class="nx">dt</span>, <span class="nx">uDate</span>.<span class="na">MIN</span>), <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">2</span>, <span class="m">6</span>, <span class="m">13</span>, <span class="m">17</span>));
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">toDiscrete</span>(<span class="nx">dt</span>, <span class="nx">uDate</span>.<span class="na">SEC</span>), <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">2</span>, <span class="m">6</span>, <span class="m">13</span>, <span class="m">17</span>, <span class="m">36</span>));</div></div></pre></div></section><section id="koru/util-date.toSunday" tabindex="-1" name="toSunday" data-env="both" class=" jsdoc-module-section"><h1 class="searchable">UtilDate.<span class="highlight"><span class="nf">toSunday</span>(<span class="nv">date</span>)</span></h1><abstract><div><p>Get the last start of sunday.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>date</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>to look for sunday from</p>
</div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a></td><td class="jsdoc-info"><div><p>start of sunday in locale timezone.</p>
</div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">UtilDate</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/util-date"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">dt</span> <span class="o">=</span> <span class="nx">uDate</span>.<span class="na">toSunday</span>(<span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">5</span>, <span class="m">2</span>, <span class="m">15</span>));

<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">dt</span>, <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">4</span>, <span class="m">28</span>));
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">toSunday</span>(<span class="nx">dt</span>), <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">4</span>, <span class="m">28</span>));
<span class="nx">assert</span>.<span class="na">equals</span>(<span class="nx">uDate</span>.<span class="na">toSunday</span>(<span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">4</span>, <span class="m">28</span>)), <span class="k">new</span> <span class="nx">Date</span>(<span class="m">2017</span>, <span class="m">4</span>, <span class="m">28</span>));</div></div></pre></div></section></div></div></div></section><section id="koru/web-server" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/web-server">koru/web-server</a><h1 class="jsdoc-module-title searchable">WebServer</h1><abstract><div><p>The default web-server created from <a class="jsdoc-link" href="#koru/web-server-factory">WebServerFactory</a>.  <a class="jsdoc-link" href="#koru/idle-check">IdleCheck</a> is used to
keep track of active requests.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><table class="jsdoc-config"><tr><td colspan="2"><h1>Config</h1></td></tr><tr class="jsdoc-config-item"><td>defaultPage</td><td><div><p>defaults to <code>/index.html</code>: used when no path is supplied in the url.</p>
</div></td></tr><tr class="jsdoc-config-item"><td>extras</td><td><div><p>any extra root level file mappings in <code>{[topPath]: [filename, root], ...}</code> format</p>
</div></td></tr><tr class="jsdoc-config-item"><td>host</td><td><div><p>listen on the specified address</p>
</div></td></tr><tr class="jsdoc-config-item"><td>indexcss</td><td><div><p>the file to serve for <code>/index.css</code>; defaults to <code>index.css</code></p>
</div></td></tr><tr class="jsdoc-config-item"><td>indexhtml</td><td><div><p>the file to serve for <code>/index.html</code>; defaults to <code>index.html</code></p>
</div></td></tr><tr class="jsdoc-config-item"><td>indexjs</td><td><div><p>the file to serve for <code>/index.js</code> or <code>require.js</code>; defaults to <code>amd-loader</code></p>
</div></td></tr><tr class="jsdoc-config-item"><td>indexjsmap</td><td><div><p>the file to serve for <code>/index.js.map</code>; defaults to <code>index.js.map</code></p>
</div></td></tr><tr class="jsdoc-config-item"><td>port</td><td><div><p>listen on the specified port</p>
</div></td></tr></table><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/web-server.start" tabindex="-1" name="start" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">WebServer.<span class="highlight"><span class="nf">start</span>()</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">Promise(object)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">WebServer</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/web-server"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> {<span class="no">Server</span>} <span class="o">=</span> <span class="nx">requirejs</span>.<span class="na">nodeRequire</span>(<span class="s">'http'</span>);

<span class="kd">const</span> <span class="no">listen</span> <span class="o">=</span> <span class="nx">stub</span>(<span class="nx">Server</span>.<span class="na">prototype</span>, <span class="s">'listen'</span>).<span class="na">yields</span>();
<span class="nx">webServer</span>.<span class="na">start</span>();
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">listen</span>, <span class="nx">webServerModule</span>.<span class="na">config</span>().<span class="na">port</span>);</div></div></pre></div></section></div></div></div></section><section id="koru/web-server-factory" data-env="server" class="jsdoc-module" tabindex="-1"><a class="jsdoc-module-path" href="#koru/web-server-factory">koru/web-server-factory</a><h1 class="jsdoc-module-title searchable">WebServerFactory</h1><abstract><div><p>Factory for creating web-servers.</p>
</div></abstract><aside class="jsdoc-module-sidebar"></aside><div><div></div><div class="jsdoc-methods"><h1>Methods</h1><div><section id="koru/web-server-factory.WebServerFactory" tabindex="-1" name="WebServerFactory" data-env="server" class=" jsdoc-module-section"><h1 class="searchable"><span class="highlight"><span class="nf">WebServerFactory</span>(<span class="nv">host</span>, <span class="nv">port</span>, <span class="nv">root</span>, <span class="nv">DEFAULT_PAGE</span><span class="o">=</span><span class="s">'/index.html'</span>, <span class="nv">SPECIALS</span><span class="o">=</span>{}, <span class="nv">transform</span>)</span></h1><abstract><div><p>Create a new web server. The npm package
<a href="https://www.npmjs.com/package/send" target="_blank">send</a> is used to serve
files.</p>
</div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-arg"><td>host</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>port</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>root</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div><p>Serve files relative to path.</p>
</div></td></tr><tr class="jsdoc-arg"><td>[DEFAULT_PAGE]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String" target="_blank">string</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[SPECIALS]</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-arg"><td>[transform]</td><td></td><td class="jsdoc-info"><div></div></td></tr><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">object</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">WebServerFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/web-server-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> <span class="no">http</span> <span class="o">=</span> <span class="nx">requirejs</span>.<span class="na">nodeRequire</span>(<span class="s">'http'</span>);
<span class="nx">stub</span>(<span class="nx">http</span>, <span class="s">'createServer'</span>);
<span class="nx">webServer</span> <span class="o">=</span> <span class="nx">WebServerFactory</span>(
  <span class="s">'0.0.0.0'</span>, <span class="s">'80'</span>, <span class="s">'/rootDir/'</span>,
  <span class="s">'/index2.html'</span>,
  {<span class="na">gem</span>: (<span class="nv">match</span>) <span class="o">=&gt;</span> [<span class="nx">match</span>[<span class="m">0</span>], <span class="s">'/path-to-gems'</span>]});
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">http</span>.<span class="na">createServer</span>, <span class="nx">webServer</span>.<span class="na">requestListener</span>);</div></div></pre></div></section><section id="koru/web-server-factory#start" tabindex="-1" name="#start" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">WebServerFactory#<span class="highlight"><span class="nf">start</span>()</span></h1><abstract><div></div></abstract><div class="jsdoc-args"><h1>Parameters</h1><table><tbody><tr class="jsdoc-method-returns"><td><h1>Returns</h1></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank">Promise(object)</a></td><td class="jsdoc-info"><div></div></td></tr></tbody></table></div><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">WebServerFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/web-server-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> {<span class="no">Server</span>} <span class="o">=</span> <span class="nx">requirejs</span>.<span class="na">nodeRequire</span>(<span class="s">'http'</span>);
<span class="kd">const</span> <span class="no">listen</span> <span class="o">=</span> <span class="nx">stub</span>(<span class="nx">Server</span>.<span class="na">prototype</span>, <span class="s">'listen'</span>).<span class="na">yields</span>();

<span class="nx">webServer</span>.<span class="na">start</span>();
<span class="nx">assert</span>.<span class="na">calledWith</span>(<span class="nx">listen</span>, <span class="s">'9876'</span>, <span class="s">'localhost'</span>);</div></div></pre></div></section><section id="koru/web-server-factory#stop" tabindex="-1" name="#stop" data-env="server" class=" jsdoc-module-section"><h1 class="searchable">WebServerFactory#<span class="highlight"><span class="nf">stop</span>()</span></h1><abstract><div></div></abstract><div><h1>Example</h1><pre class="jsdoc-example"><div class="jsdoc-require highlight"><span class="kd">const</span> <span class="no">WebServerFactory</span> <span class="o">=</span> <span class="k">require</span>(<span class="s">"koru/web-server-factory"</span>);</div><div class="jsdoc-example-call jsdoc-code-block"><div class="highlight"><span class="kd">const</span> {<span class="no">Server</span>} <span class="o">=</span> <span class="nx">requirejs</span>.<span class="na">nodeRequire</span>(<span class="s">'http'</span>);
<span class="kd">const</span> <span class="no">close</span> <span class="o">=</span> <span class="nx">stub</span>(<span class="nx">Server</span>.<span class="na">prototype</span>, <span class="s">'close'</span>);

<span class="nx">webServer</span>.<span class="na">stop</span>();
<span class="nx">assert</span>.<span class="na">called</span>(<span class="nx">close</span>);</div></div></pre></div></section></div></div></div></section></div>
      </main>
    </section>
    <script src="api.js"></script>
  </body>
</html>
